--------------------------------------------------------------------------------

  ユーザー投稿型鉄道運用データベース「運用観察Hub」設計案    ページ(1)

--------------------------------------------------------------------------------

_/_/_/_/ 構成概要 _/_/_/_/

・サーバサイドをPHP、クライアントサイドを単一HTMLファイルに記述したJavascriptとするシングルページアプリケーション
・データベースエンジンにはSQLiteを採用し、路線系統ごとに独立したデータベースファイルを作成する
・Wakaranaによるユーザー登録機能を実装し、ユーザー投稿データはユーザーIDと紐付けて管理する
・未登録ユーザーによる投稿を認めることも可能とするが、未登録ユーザーの投稿時にはZizai CAPTCHAによる画像認証を実施する
・運用表及び時刻表はクライアント端末のIndexedDBにキャッシュし、通信量を削減する


_/_/_/_/ ファイル構成 _/_/_/_/

/
└ index.html ・・・アプリケーションフロントエンド本体
└ libs/
   └ wakarana/ ・・・Wakarana一式
   └ zizai_captcha/ ・・・Zizai CAPTCHA一式
└ libs_data/
   └ wakarana.db ・・・Wakaranaデータベース
   └ zizai_captcha.db ・・・Zizai CAPTCHAデータベース
└ config/
   └ unyohub.json ・・・運用観察Hub基本設定ファイル
   └ wakarana_config.ini ・・・Wakarana設定ファイル
   └ wakarana_custom_fields.json ・・・Wakaranaカスタムフィールド設定ファイル
   └ zizai_captcha_config.json ・・・Zizai CAPTCHA設定ファイル
└ data/ ・・・路線系統ごとのデータフォルダ
   └ ****/
      └ railroad.db ・・・運用表・時刻表・ユーザー投稿データを格納するデータベース本体
      └ railroad_info.json ・・・路線系統の設定ファイル
      └ train_icons.json ・・・列車アイコン画像埋め込み処理後のアイコン設定ファイル
      └ formations.json ・・・JSONに変換された編成表
      └ standardization.json ・・・ユーザー投稿データの標準化処理設定ファイル
      └ ****_operations.json ・・・JSONに変換された各ダイヤの運用表データ
      └ ****_timetable.json ・・・JSONに変換された各ダイヤの時刻表データ
└ api/
   └ ****.php ・・・クライアント端末と情報をやり取りするエンドポイント(詳細は別記)
└ README.html ・・・ユーザーマニュアル
└ .htaccess

※サーバにアップロードする必要のない各種変換処理スクリプト類は上記に含まれない


_/_/_/_/ 設定ファイル設定値 _/_/_/_/

███ index.html ███

※設定ファイルではないが、編集可能な定数が存在する
  UNYOHUB_APP_NAME  アプリケーション名
  UNYOHUB_VERSION  バージョン文字列
  UNYOHUB_INDEXEDDB_VERSION  IndexedDBのデータベースバージョン数値
  UNYOHUB_LICENSE_TEXT  ライセンス情報文
  UNYOHUB_LICENSE_URL  ライセンスのURL


███ unyohub.json ███

{
    "railroads" : dataフォルダ内の各路線系統のフォルダ名を配列で列挙,
    "allow_sign_up" : 新規ユーザーの登録を認めるか(BOOL値),
    "allow_guest_user" : ログインしていないユーザーの投稿を認めるか(BOOL値)
}


███ railroad_info.json ███

{
    "railroad_name" : 路線系統表示名,
    "main_color" : 路線系統のテーマカラー,
    "lines" : { 個々の路線の情報
        "路線識別名" : {
            "line_name" : 路線名,
            "line_color" : 路線のテーマカラー,
            "inbound_forward_direction" : 上り列車の進行方向と編成の前位側(奇数向き)方向が一致するかどうか(BOOL値),
            "stations" : { 駅一覧
                "駅名" : {
                    "station_initial" : 駅頭文字(始発・終着列車のない非分岐駅では省略可能。他の駅と被る場合は別の文字を使用する),
                    "connecting_lines" : 直通路線の路線識別名を配列で列挙
                }...
            }
        }...
    },
    "operations" : 運用パターンの一覧(ダイヤ識別名を配列で指定可能、この識別名は運用表JSONデータのファイル名に使用),
    "operations_by_day" : [ 曜日と運用パターン(曜日別ダイヤ)の対応関係(0:日曜→6:土曜)
        日曜日と祝日に使用するダイヤ識別名,
        月曜日に使用するダイヤ識別名,
        火曜日に使用するダイヤ識別名,
        水曜日に使用するダイヤ識別名,
        木曜日に使用するダイヤ識別名,
        金曜日に使用するダイヤ識別名,
        土曜日に使用するダイヤ識別名
    ],
    "operations_by_date" : { 特定の日付限定の運用パターン
        "**-**" : キーに"MM-DD"形式の日付、値にダイヤ識別名を指定...
    },
    "train_color_rules" : [ 列車番号の色分け規則(配列で複数指定可能)
        {
            "pattern" : 列車番号の正規表現パターン,
            "color" : 色コード文字列
        }...
    ],
    "deadhead_train_number" : 回送列車の列車番号にマッチする正規表現パターン,
    "longest_running_time" : 始発から終着までの所要時間が最も長い列車の所要時間(分単位の数値、時刻表の変換スクリプトが自動計算する数値のうち、全ダイヤで最も遅いものを入力),
    "license_text" : ライセンス文や謝辞などをまとめた文字列
}


███ train_icons.json ███

※このファイルはスクリプトによりアイコン画像の埋め込み処理を実施してからサーバにアップロードする
[
    {
        "pattern" : 編成名の正規表現パターン,
        "icon" : アイコン画像のファイル名(スクリプトにより、ファイルバイナリのBASE64文字列に置き換えられる)
    }...
]


███ formations.json ███

※このファイルは変換スクリプトにより自動生成されるものである
{
    "形式名" : { 各形式の編成情報
        "編成名": {
            "cars" : 配列で車番を前位側(奇数向きの先頭)から文字列で順に記載
    }...
}


███ standardization.json ███

{
    "delimiter" : 運用番号・列車番号と編成番号の間の区切り文字列を検出する正規表現,
    "operation_prefixes" : 運用番号の接頭辞として用いられる文字列(配列で),
    "standard_operation_prefix" : 運用番号の所定の接頭辞(使用しない場合は空文字列),
    "operation_suffixes" : 運用番号の接尾辞として用いられる文字列(配列で),
    "standard_operation_suffix" : 運用番号の所定の接頭辞(使用しない場合は空文字列),
    "train_prefixes" : 列車番号の接頭辞として用いられる文字列(配列で),
    "standard_train_prefix" : 列車番号の所定の接頭辞(使用しない場合は空文字列),
    "train_suffixes" : 列車番号の接尾辞として用いられる文字列(配列で),
    "standard_train_suffix" : 列車番号の所定の接頭辞(使用しない場合は空文字列),
    "formation_prefixes" : 編成名の接頭辞として用いられる文字列(配列で),
    "standard_formation_prefix" : 編成名の所定の接頭辞(使用しない場合は空文字列),
    "formation_suffixes" : 編成名の接尾辞として用いられる文字列(配列で),
    "standard_formation_suffix" : 編成名の所定の接頭辞(使用しない場合は空文字列)
}


███ ****_operations.json ███

※ファイル名の「****」部分はダイヤ識別名が入る
※このファイルは変換スクリプトにより自動生成されるものである
{
    "運用グループタイトル" : { 各運用グループの情報
        "operations": {
            "運用番号" : { 各運用の情報
                "trains" : { 各列車の情報(折返し等の発車待ちの情報も含む)
                    "列車番号または仮番号" : [
                        { 各区間組成の情報
                            "line_id" : 走行路線の識別名,
                            "first_departure_time" : 「HH:MM」形式の始発時刻,
                            "final_arrival_time" : 「HH:MM」形式の終着時刻,
                            "starting_station" : 始発駅,
                            "terminal_station" : 終着駅,
                            "position_forward" : 担当位置開始両数(進行方向から数えて何両目からがその運用か),
                            "position_rear" : 担当位置終了両数(進行方向から数えて何両目までがその運用か),
                            "direction" : 上り列車か下り列車か(上り列車か上り方面発車待ちなら「inbound」、下り列車か下り方面発車待ちなら「outbound」)
                        }...
                    ]...
                },
                "starting_location" : 出庫場所(車庫または駅番線),
                "terminal_location" : 入庫場所(車庫または駅番線),
                "car_count" : 編成両数,
                "comment" : コメント
            }...
        },
        "color" : テーマカラー
    }...
}


███ ****_timetable.json ███

※ファイル名の「****」部分は「路線名.ダイヤ識別名.方向」が入る
　方向は「inbound」(上り)か「outbound」(下り)のいずれかとする必要がある
※このファイルは変換スクリプトにより自動生成されるものである
{
    "列車番号" : [
        { 各区間組成の情報
            "first_departure_time" : 「HH:MM」形式の始発時刻,
            "train_type" : 列車種別,
            "previous_trains" : [ 直通元の区間組成
                {
                    "line_id" : 走行路線の識別名,
                    "train_number" : 列車番号,
                    "first_departure_time" : 「HH:MM」形式の始発時刻
                }...
            ],
            "next_trains" : [ 直通先の区間組成
                {
                    "line_id" : 走行路線の識別名,
                    "train_number" : 列車番号,
                    "first_departure_time" : 「HH:MM」形式の始発時刻
                }...
            ],
            departure_times : 路線内の各駅発車時刻を配列で(通過駅及び走行区間に含まれていない駅はnullとする)
        }...
    ]...
}
