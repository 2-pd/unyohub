--------------------------------------------------------------------------------

  ユーザー投稿型鉄道運用データベース「鉄道運用Hub」設計案    ページ(11)

--------------------------------------------------------------------------------

_/_/_/_/ ダイヤ情報ファイル入力規則 _/_/_/_/

(1) ファイル形式について
ダイヤ情報ファイルは「JSON」の規格に沿って記述し、ファイル名は「diagram_info.json」とします。
JSONファイルは一般的なテキストエディタで編集可能ですが、編集時は文字コードが「UTF-8(BOMなし)」に設定されていることを確認してください。

なお、ダイヤ情報ファイルでは、英数字を全て半角で入力する必要があります。


(2) 全体の構造について
ダイヤ情報ファイルは単一の連想配列からなり、当該連想配列は以下のキーを有する必要があります。

{
    "diagrams" : 各ダイヤの詳細情報,
    "diagram_order" : 通常ダイヤの一覧,
    "special_diagram_order" : 臨時ダイヤの一覧(臨時ダイヤがない場合は省略可能),
    "diagram_schedules" : ダイヤ判定規則,
    "exceptional_dates" : 判定規則の例外となる日とその日のダイヤ(判定規則の例外となる日が存在しない場合は省略可能)
}


(3) 各ダイヤの詳細情報について
前述のキー "diagrams" には、値として以下の規則に従って各ダイヤの詳細情報を記載した連想配列を設定してください。
ここに記載のないダイヤを、後述の"diagram_order"、"special_diagram_order"、"diagram_schedules"、"exceptional_dates"の値で使用することはできません。

◆ キー
連想配列のキーはダイヤ識別名(「weekday」や「holiday」など)をそのまま使用します。

◆ 値
各キーに対応する値は以下の3つのキーを持つ連想配列です。キーとして使用したダイヤ識別名のダイヤの情報を記載してください。

{
    "diagram_name" : 当該ダイヤの表示名(「平日ダイヤ」など),
    "main_color" : 当該ダイヤの時刻表で使用するテーマカラー(色コードをハッシュ記号に続けて16進数6桁で指定、「#99ddff」など),
    "timetable_id" : 当該ダイヤで使用する時刻表の識別名(「weekday」など)
}


(4) 通常ダイヤの一覧について
キー "diagram_order" には、値として通常ダイヤのダイヤ識別名を列挙した1次元配列を指定します。
例えば、通常ダイヤとして「weekday」と「holiday」が存在する場合は以下のような配列となります。

[ "weekday", "holiday" ]

本アプリケーションのダイヤ選択画面では、ここで記載した順にダイヤが表示されます。


(5) 臨時ダイヤの一覧について
キー "special_diagram_order" には、値として臨時ダイヤのダイヤ識別名を列挙した1次元配列を指定します。臨時ダイヤが存在しない場合はこの項目をキーごと省略しても問題ありません。
"diagram_order"と同様、ダイヤ選択画面ではここで記載した順にダイヤが表示されます。


(6) ダイヤ判定規則について
キー "diagram_schedules" には、値として本アプリケーションが日付からその日のダイヤを判定する際に使用する規則を入力します。
この規則は、配列の中に以下の内容を持つ連想配列(以下、規則ブロック)が1つ以上格納された構造でなければなりません。

{
    "periods" : [
        {
            "start_date" : 有効期間の開始日(YYYY-MM-DD形式、「2023-10-21」など),
            "end_date" : 有効期間の終了日(YYYY-MM-DD形式、無期限とする場合は null を指定)
        }
    ],
    "diagrams_by_day" : [
        当該期間の日曜日と祝日に施行されるダイヤの識別名(「holiday」など),
        当該期間の月曜日に施行されるダイヤの識別名(「weekday」など),
        当該期間の火曜日に施行されるダイヤの識別名(「weekday」など),
        当該期間の水曜日に施行されるダイヤの識別名(「weekday」など),
        当該期間の木曜日に施行されるダイヤの識別名(「weekday」など),
        当該期間の金曜日に施行されるダイヤの識別名(「weekday」など),
        当該期間の土曜日に施行されるダイヤの識別名(「holiday」など)
    ]
}

本アプリケーションは、日付に対応するダイヤを判定する際、配列に含まれる規則ブロックを最初のものから順に検証し、対象の日付が有効期間に含まれる規則ブロックに到達した時点で判定処理を完了します。
例えば、1番目の規則ブロックの有効期間が"2024-03-01"から"2024-03-31"、2番目の規則ブロックの有効期間が"2024-01-20"からnull(無期限)の場合、日付"2024-03-03"(日曜日)はどちらの期間にも該当しますが、先に記載された規則ブロックが優先されるため、1番目の規則ブロックの日曜・祝日に対応するダイヤが施行されるものと判定されます。

有効期間が複数に分かれている場合(例えば、2024年の3月と2025年の3月に施行されるダイヤ)では、以下のように記述することで複数の期間をキー "periods" の値として指定することができます。

[
    {
        "start_date" : "2024-03-01",
        "end_date" : "2024-03-31"
    },
    {
        "start_date" : "2025-03-01",
        "end_date" : "2025-03-31"
    }
]

なお、いずれの規則ブロックの有効期間にも含まれない日付が存在する場合、本アプリケーションは正常に動作しません。
最後の規則ブロックは原則として開始日にダイヤ改正初日、終了日にnull(無期限)を指定し、ダイヤ改正後の全ての日付を有効期間に含めてください。


(7) 判定規則の例外となる日とその日のダイヤについて
キー "exceptional_dates" には、値として、キーに判定規則の例外となる日(YYYY-MM-DD形式)、値にその日のダイヤの識別名を記載した連想配列を指定します。判定規則の例外となる日が存在しない場合はこの項目をキーごと省略しても問題ありません。
例えば、2024年12月30日にダイヤ「holiday」、翌日にダイヤ「omisoka」、2025年1月の1日〜3日にかけてダイヤ「3ganichi」が施行される場合、この連想配列は以下のようになります。

{
    "2024-12-30" : "holiday",
    "2024-12-31" : "omisoka",
    "2025-01-01" : "3ganichi",
    "2025-01-02" : "3ganichi",
    "2025-01-03" : "3ganichi"
}
