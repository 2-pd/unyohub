<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,interactive-widget=resizes-content">
<script>
    const UNYOHUB_APP_NAME = "運用観察Hub";
    const UNYOHUB_VERSION = "23.10-1"
    const UNYOHUB_INDEXEDDB_VERSION = 2310001;
    const UNYOHUB_LICENSE_TEXT = "このアプリケーションは無権利創作宣言に準拠して著作権放棄されています。";
    const UNYOHUB_LICENSE_URL = "https://www.2pd.jp/license/";
</script>
    <title></title>
    <link rel="apple-touch-icon" href="apple-touch-icon.webp">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
<style>
* {
    font-family: "Noto Sans CJK JP", "Meiryo", "Hiragino Kaku Gothic ProN", sans-serif;
    
    outline: 0 !important;
}

*::-webkit-scrollbar {
    display: none;
}

html, body {
    position: relative;
    
    height: 100%;
    margin: 0;
}

.dark_mode {
    background-color: #101010;
    
    color: #ffffff;
}

header {
    position: relative;
    
    height: 40px;
    
    background-size: 30px;
    background-repeat: no-repeat;
    background-position: 5px 5px;
    background-color: #f7f7f7;
    
    line-height: 40px;
    font-size: 18px;
    
    box-shadow: 0 0 3px 3px rgba(0,0,0,0.2);
    
    z-index: 5;
}

.dark_mode header {
    background-color: #181818;
}

#app_name {
    margin-left: 10px;
}

.railroad_select_mode #app_name {
    display: none;
}

#railroad_select {
    display: none;
    
    position: absolute;
    left: 0;
    
    width: calc(100vw - 50px);
    height: 40px;
    
    border: none;
    
    background-image: url(data:image/webp;base64,UklGRpoAAABXRUJQVlA4TI0AAAAvJ8AFEC8gECCo9V9gQyBAUOu/gECAoNZ/ASEBQfPY/QCo/gP8U4er2LadZlMEYIL/lkiIgHb9awmce46FiP6rcds26sVBW9BXsM0AAABI+778krZVeaR9qwJ3e9dFsNalLoI1IgRBSKIEG8GO1WB1GC1Gj5gm+byd/hMPdH3W7mkGmgkxImbE+HfMTAAA);
    background-repeat: no-repeat;
    background-size: 20px 12px;
    background-position: calc(100vw - 80px) 15px;
    background-color: transparent;
    
    line-height: 40px;
    font-size: 18px;
    text-indent: 40px;
    
    appearance: none;
}

.dark_mode #railroad_select {
    background-image: url(data:image/webp;base64,UklGRpoAAABXRUJQVlA4TI4AAAAvJ8AFEC8gECD4X9OkQ0BC8P+aTRKQEPy/ZpOEBATNY/cDoFrtVw0YrmLbdppNEYAJ/lsiIQLa9a8lcO45FiL6r8Zt26gXB21BX8E2AwAAIO378kvaVuWR9q0K3O1dF8Fal7oI1ogQBCGJEmwEO1aD1WG0GD1imuTzdvpPPND1WbunGWgmxIiYEePfMTMB);
}

.railroad_select_mode #railroad_select {
    display: block;
}

#menu_button {
    position: absolute;
    right: 0;
    
    width: 50px;
    height: 40px;
    
    border: none;
    border-radius: 0;
    padding: 0;
    
    background-image: url(data:image/webp;base64,UklGRjYAAABXRUJQVlA4TCoAAAAvY8ATEA8wZmM2ZvMf8DAUwMyaqa7ZFcC+Ef2fgHupQQleaVCCVxqU4Kc=);
    background-size: 50px 40px;
    background-color: transparent;
}

.dark_mode #menu_button {
    background-image: url(data:image/webp;base64,UklGRjYAAABXRUJQVlA4TCoAAAAvY8ATEA8wzMM8zPMf8DAUwMyaqa7ZFcC+Ef2fgHupQQleaVCCVxqU4Kc=);
}

.menu_button_active {
    background-color: #dddddd !important;
}

.dark_mode .menu_button_active {
    background-color: #333333 !important;
}

#menu {
    position: absolute;
    top: 40px;
    right: 0;
    
    width: 250px;
    max-height: 0;
    
    opacity: 0.5;
    
    background-color: #ffffff;
    
    line-height: 40px;
    
    overflow-y: scroll;
    
    z-index: 7;
    
    transition-duration: 0.25s;
    transition-property: all;
}

.dark_mode #menu {
    background-color: #101010;
    
    border-color: #333333;
}

.menu_open {
    max-height: calc(100vh - 72px) !important;
    
    opacity: 1.0 !important;
    
    padding: 9px 0;

    border: 1px solid #dddddd;
    
    box-shadow: 0 4px 4px 0 rgba(0,0,0,0.3);
}

#menu button {
    width: 100%;
    height: 40px;
    
    border: none;
    border-radius: 0;
    
    background-color: transparent;

    color: #333333;
}

.dark_mode #menu button {
    color: #eeeeee;
}

#menu hr {
    width: 90%;
    height: 2px;
    
    margin: 9px auto;
    
    border: none;
    
    background-color: #dddddd;
}

.dark_mode #menu hr {
    background-color: #333333;
}

#splash_screen {
    position: absolute;
    top: 0;
    
    width: 100%;
    height: calc(100vh - 60px);
    
    padding-top: 60px;
    
    background-color: #ffffff;
    
    text-align: center;
    
    z-index: 10;
}

.dark_mode #splash_screen {
    background-color: #101010;
}

.splash_screen_loaded {
    z-index: 3 !important;
}

#splash_screen:after {
    content: "";
    
    display: block;
    
    position: absolute;
    top: 0;
    
    width: 100%;
    height: 100%;
    
    background-image: url("splash_screen_image.webp");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: right bottom;
    
    transition-duration: 1s;
    transition-property: opacity;
}

.splash_screen_loaded:after {
    opacity: 0.25;
}

#splash_screen div {
    position: relative;
    
    z-index: 4;
}

#splash_screen_login_status {
    height: 70px;
}

#splash_screen_login_status b {
    font-size: 20px;
}

#tab_area {
    display: block;
    
    width: 100%;
    height: 50px;
    
    background-color: #eeeeee;
    
    line-height: 50px;
    white-space: nowrap;
    
    overflow: scroll;
    overflow-y: hidden;
    
    box-shadow: 0 -5px 3px -2px rgba(0,0,0,0.1) inset;
}

.dark_mode #tab_area {
    background-color: #181818;
}

#tab_area button {
    position: relative;
    
    box-sizing: content-box;
    
    width: 80px;
    height: 27px;
    
    padding: 0;
    padding-top: 23px;
    
    background-repeat: no-repeat;
    background-size: 40px;
    background-position: 20px 6px;
    background-color: #eeeeee;
    
    border: none;
    border-radius: 0;
    
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    
    box-shadow: 0 -5px 3px -2px rgba(0,0,0,0.1) inset;
}

.dark_mode #tab_area button {
    background-color: #181818;
    
    color: #ffffff;
}

#tab_area .active_tab {
    padding-top: 20px;
    
    background-position-y: 3px;
    background-color: #ffffff !important;
    
    border-top: 3px solid transparent;
    
    box-shadow: 0 0 8px 0 rgba(0,0,0,0.5);
    
    z-index: 6;
}

.dark_mode #tab_area .active_tab {
    background-color: #101010 !important;
}

#tab_area .sub_menu_tab {
    width: 40px;
    
    background-image: url(data:image/webp;base64,UklGRoQAAABXRUJQVlA4THcAAAAvJ8AJEFUwjiSpDflHwC7BEJw8Xr/lLkJRJEnNkhycsVttZLDB8TxrEyChJKLj0z+VR6IESBBeeoE4LhReepHmibtQKkcpbLRSbHcwQNIfoNfH4e5hF7nOardS+DhKYYsshYqCU4blHACxEswl5Uxlo31jqPIAAQA=);
    background-size: 20px;
    background-position: center;
    
    color: transparent !important;
}

article, #blank_article {
    display: none;
    
    width: calc(100vw - 10px);
    height: calc(100vh - 210px);
    
    padding: 10px 5px 60px 5px;
    
    overflow: scroll;
}

#blank_article {
    display: block;
}

.line_select {
    display: block;
    
    width: 300px;
    height: 36px;
    
    margin: 0 auto;
    
    line-height: 36px;
    font-size: 20px;
    text-align: center;
}

.position_row {
    width: 100%;
    height: 82px;
}

.position_inbound, .position_outbound {
    display: inline-block;
    
    height: 80px;
    
    border-bottom: 2px dashed #eeeeee;
    
    vertical-align: top;
}

.dark_mode .position_station, .dark_mode .position_inbound, .dark_mode .position_outbound {
    border-color: #202020;
}

.position_row:last-child .position_station, .position_row:last-child .position_inbound, .position_row:last-child .position_outbound {
    border-bottom: none;
}

.position_station {
    display: inline-block;
    
    position: relative;
    
    width: 75px;
    height: 82px;
}

.position_station h4 {
    position: absolute;
    top: -14px;
    left: -5px;
    
    width: 95px;
    height: 26px;
    
    margin: 0;
    padding-left: 5px;
    
    background-color: #eeeeee;
    
    border-radius: 0 13px 13px 0;
}

.dark_mode .position_station h4 {
    background-color: #202020;
}

.train_icon {
    float: left;
    
    max-width: 40px;
    max-height: 40px;
    
    margin-left: 5px;
    margin-right: 5px;
    
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
}

.connecting_line_button {
    position: absolute;
    top: 15px;
}

.position_inbound, .position_outbound {
    position: relative;
    
    width: calc(50% - 50px);
}

.position_line {
    position: relative;
    
    display: inline-block;
    
    width: 25px;
    height: 82px;
}

.position_row:first-child .position_line {
    height: 80px;
    border-bottom: 2px solid;
}

.position_row:not(:first-child) .position_line:after {
    content: "";
    
    position: absolute;
    top: -10px;
    left: 3px;
    
    width: 15px;
    height: 15px;
    
    background-color: #ffffff;
    
    border: 2px solid #eeeeee;
    border-radius: 9.5px;
}

.dark_mode .position_row:not(:first-child) .position_line:after {
    background-color: #101010;
    
    border-color: #181818;
}

.position_inbound span, .position_outbound span {
    display: inline-block;
    
    position: absolute;
    
    height: 50px;
    
    line-height: 25px;
}

.position_inbound .train_icon, .position_outbound .train_icon {
    margin-top: 5px;
}

.position_inbound b, .position_outbound b {
    color: #101010;
}

.dark_mode .position_inbound b, .dark_mode .position_outbound b {
    color: #ffffff;
}

.position_inbound span:before, .position_outbound span:after {
    position: absolute;
    
    line-height: 12px;
    font-size: 12px;
}

.position_inbound span {
    top: 0;
    right: 0;
    
    text-align: right;
}

.position_inbound span:before {
    content: "▲";
    
    top: -12px;
    right: 20px;
}

.position_inbound .train_icon {
    float: right;
}

.position_outbound span {
    bottom: 0;
    left: 0;
}

.position_outbound span:after {
    content: "▼";
    
    bottom: -12px;
    left: 20px;
}

.multiple_trains .train_icon {
    float: none;
}

.position_inbound .multiple_trains .train_icon {
    margin-left: -4px;
}

.position_outbound .multiple_trains .train_icon {
    margin-right: -4px;
}

#direction_radio_area {
    display: none;
    
    padding-top: 10px;
    
    text-align: center;
}

#direction_radio_area h3 {
    position: relative;
    
    margin: 0 0 5px 0
}

#direction_radio_area .previous_button {
    position: absolute;
    left: 0;
    
    height: 30px;
    
    background-size: 10px 20px;
}

#timetable_area h4 {
    margin: 10px 0 5px 0;
    padding: 5px;
    
    background-color: #eeeeee;
}

.dark_mode #timetable_area h4 {
    background-color: #202020;
}

.timetable_train {
    display: inline-block;
    margin: 5px 2px;
    
    line-height: 18px;
    text-decoration: none;
    color: #000000;
}

.dark_mode .timetable_train {
    color: #ffffff;
}

.timetable_train b {
    line-height: 20px;
    font-size: 20px;
}
article input[type="checkbox"] + label {
    background-color: #eeeeee;
    height: 25px;
    
    margin: 5px 0;
    padding: 10px;
    
    line-height: 25px;
    font-weight: bold;
    
    z-index: 1;
}

.dark_mode article input[type="checkbox"] + label {
    background-color: #202020;
}

article input[type="checkbox"] + label::before {
    display: none;
}

article input[type="checkbox"] + label:after {
    top: 0;
    left: calc(100% - 45px) !important;
    
    width: 45px;
    height: 45px;
    
    background-image: url(data:image/webp;base64,UklGRtwCAABXRUJQVlA4TM8CAAAvMUAMEPfDppEkR3Xp80fx/D4za0GoaRtJ8rbHH8Xxu+6JmraRJG97/FEcv+ueOG4kSZF2e8XMhqz/OmPuzTRUmmq1aRsweHbKG0juvYvnHInqo1xUjj5KAAALcuRRAsBECXLkuAEDAhQKBaFQRLC8WYAvtFhL8AVhoCAIBUAQEZxRMwPPWQLiC8IAwJlJIciQ44YI4kSOBg1yNMiRo0H+/885AYMrgDc8IgDCgXAgblGCJ0wUcEQZPL/3BP69V661LjCAKMm2aWfHNue82PZDbNu2bTz+fG7uO/fkByL6PwGiMXF9rKe5trS0tvlkbDFPnE/aaSXKtukPZ9KGS9DoOsvQlzKkACqPbza+v4qLv7Kf57yVAOrgU9NDDaC8y0GxHbviUUDto46YK4D+HNH41gewHxOVvwdoeRXNL82A2x9FfCdw6Rft8YdA2G8r5hTUpDh6oyAStHMF6lbsA9iTBQX7NlaAOXFKroG1P1JqYECck0uozrcagha/CYEmGLHIVfAqJsgWqLdfR3AkZsg5XIhIkguVY0qmwpUosgNeMUVOYUakFZbNWYV2SYSqoDmhCvi5A6+YI264H4Mbk7Zhrwc2THqC00bIMikbmusgwQLHLQqgvgxiTApC+X+ogwSTCqC+Eb4tov0lOlOhuQc2THqC03GYM2kWJu7Aa9IJ3CdCZaw5RRWQLG2wYs4DdIhMg8ccN8yKfLhQb6a8K0oSRaQf+kzxwYCISKaCFzM2QaX9kgNojjehsBFGxfKzFi5MGITaOCtZBmacmwKW5O99UAtOzQNjYrPYA+zai/4G6I6xI/4wMBDQV9gPdPnFvt8NNG3p2mwAPH6JNmYfoDdTx7sPYKxYND7WAup0NWQv9OBWQN2y6P0cUQAV7u2n1ISYmITUp9mTCgA1Gifac4ZL0Og6SxdHE6/bo+mYyRPnf+733K11ZWV1racT98miEQA=);
    background-repeat: no-repeat;
    background-size: 25px;
    background-position: center;
    background-color: transparent;
    
    box-shadow: none;
}

article input[type="checkbox"]:checked + label:after {
    transform: rotate(45deg);
}

article input[type="checkbox"] + label + div {
    height: 0;
    
    margin: -45px 0 45px 0;
    
    opacity: 0;
    
    overflow: hidden;
    
    transition: margin 0.1s, opacity 0.3s;
}

article input[type="checkbox"]:checked + label + div {
    height: auto;
    
    margin: 0;
    
    opacity: 1;
}

.formation_box {
    min-height: 60px;
    
    padding-left: 10px;
    
    line-height: 26px;
}

.formation_box .train_icon {
    margin-top: 10px;
}

.formation_box span {
    display: inline-block;
    
    margin: 0 1px;
    padding: 1px 3px;
    
    border: 1px solid #dddddd;
}

.dark_mode .formation_box span {
    border-color: #333333;
}

.formation_box span:first-of-type {
    border-radius: 14px 0 0 14px;
    
    padding-left: 12px;
}

.formation_box span:last-of-type {
    border-radius: 0 14px 14px 0;
    
    padding-right: 12px;
}

footer {
    position: absolute;
    bottom: 0;
    
    width: 100%;
    height: 50px;
    
    background-color: #f7f7f7;
    
    line-height: 50px;
    font-size: 26px;
    color: #333333;
    
    box-shadow: 0 0 2px 2px rgba(0,0,0,0.2);
    
    overflow: hidden;
    
    z-index: 2;
}

.dark_mode footer {
    background-color: #181818;
    
    color: #dddddd;
}

footer div {
    display: none;
    
    width: 100%;
    height: 50px;
    
    text-align: center;
}

.previous_button, .next_button {
    width: 40px;
    height: 50px;
    
    padding: 0;
    
    border: none;
    
    background-image: url(data:image/webp;base64,UklGRoQAAABXRUJQVlA4THgAAAAvHcAOEG9gkG2k5vwN3vWnYSBtmzD/Du71NZC2TZh/B/f6KgoAwvETQf+PIDsMCbgRgLuj/78oNB4+pPrbEFz9aqoEm8i26ryeFifLxwcSsBIJMRApERFLeT1dRP+FBAkmr0wo8W9DTbxwR9Lh7ANXYsGXmFDO5AM=);
    background-repeat: no-repeat;
    background-size: 15px 30px;
    background-position: center;
    background-color: transparent !important;
    
    vertical-align: top;
}

.previous_button {
    transform: scale(-1, 1);
}

.popup {
    position: fixed;
    top: 0;
    
    display: none;
    
    width: 100%;
    height: 100%;
    
    box-sizing: border-box;
    
    padding: 10px;
    padding-top: 50px;
    
    background-color: #ffffff;
    
    overflow: scroll;
    
    z-index: 10;
}

.dark_mode .popup {
    background-color: #101010;
}

.popup_close_button {
    position: fixed;
    top: 10px;
    right: 10px;
    
    width: 40px;
    height: 40px;
    
    background-image: url(data:image/webp;base64,UklGRhwBAABXRUJQVlA4TA8BAAAvO8AOEJegEJIkp+v8SU7sCXLUUNC2kWMdfyRH7BHsqaBtI8c6/kiO2CPYU1HbSM52/lo8+1xO1+cClJlRa5W11kABAD4A/P8ZAoVEBGP9/xuzlJIOR24kKdLAMu/+/7VNlZm9pznxVET/HbmRJEXVDokTzNrwhmYoWz/yRZHzfXTMtLcPV+/Hjcl95YqYAqYUHmM8p+MnyLZ6Omf0ZMvV80P82ON3yKNSINKAUwHTgVIC0jJTM1I73IvpFZOyE7NSu+Tz1Dcvaz6vTd/NC+u4VahMnqVGzzeP2tiWK4vcE4v0GdSZtAGUQXSBVME0Ef7xHvrltphlcidv/PnuhMrCpRsbY+WfkRhr3WezgWzNAA==);
    background-repeat: no-repeat;
    background-size: 30px;
    background-position: center;
    
    border: none;
}

h2 {
    margin: 10px 0;
}

h4 {
    margin-bottom: 10px;
}

a {
    color: #999999;
}

.popup input, .popup select {
    display: block;
    
    width: 90%;
    
    margin: 10px auto;
    
    background-color: transparent;
    
    font-size: 18px;
}

.popup input[type="number"] {
    display: inline-block;
    
    width: 50px;
    
    margin-left: 20px;
    
    font-size: 18px;
}

.popup select {
    margin-bottom: 30px;
    
    background-color: #ffffff;
    
    border: none;
    border-bottom: 1px solid #eeeeee;
}

.dark_mode .popup select {
    background-color: #101010;
    
    border-color: #333333;
    
    color: #ffffff;
}

.popup button {
    display: block;
    
    margin: 10px auto;
    padding: 5px 10px;
}

#popup_screen, #wait_screen {
    display: none;
    
    position: fixed;
    top:0;
    left: 0;
    
    width: 100%;
    height: 100%;
    
    background-color: rgba(0,0,0,0.75);
    
    z-index: 200;
}

#popup_screen_blank_area {
    width: 100%;
    height: 100%;
    
    z-index: 201;
}

.square_popup, .preview_popup {
    display: none;
    
    position: fixed;
    top: calc(50% - 160px);
    left: calc(50% - 160px);
    
    width: 310px;
    height: 280px;
    
    z-index: 202;
    
    padding: 40px 5px 0 5px;
    
    background-color: #ffffff;
    
    text-align: center;
}

.dark_mode .square_popup, .dark_mode .preview_popup {
    background-color: #101010;
}

.preview_popup {
    width: calc(100% - 50px);
    height: calc(100% - 70px);
    
    padding: 40px 10px 0 10px;
    
    top: 15px;
    left: 15px;
    
    overflow: scroll;
}

.square_popup input, .preview_popup input {
    width: 235px;
    
    margin: 0 2px 0 5px;
    
    background-color: transparent;
    
    line-height: 24px;
    font-size: 18px;
    text-align: center;
}

.square_popup input[type="number"], .preview_popup input[type="number"] {
    width: 60px;
    
    text-align: center;
}

.square_popup button, .preview_popup button {
    min-width: 50px;
    
    line-height: 22px;
}

.wide_button {
    display: block;
    
    width: calc(100% - 20px) !important;
    
    margin: 10px auto;
    padding: 10px 10px;
    
    background-size: 30px;
    background-repeat: no-repeat;
    background-position: 10px 50%;
    
    line-height: 26px;
    font-size: 18px;
}

.square_popup .popup_close_button {
    top: calc(50% - 150px);
    right: calc(50% - 150px);
}

.preview_popup .popup_close_button {
    top: 20px;
    right: 20px;
}

.informational_text {
    padding: 0 10px 10px 15px;
    
    color: #666666;
    text-align: left;
}

#captcha_info {
    margin-top: -30px;
}

#captcha_area {
    margin-bottom: 30px;
}

#captcha_area button {
    min-width: 0 !important;
    
    border-radius: 0;
}

#train_detail_popup h4 {
    font-size: 18px;
}

.train_detail_departure_times {
    position: relative;
    
    width: 240px;
    
    margin: 0 auto;
    padding: 0 10px;
    border-left: 20px solid #808080;
    
    line-height: 36px;
    font-size: 18px;
    text-align: left;
}

.train_detail_departure_times::before {
    content: "";
    
    position: absolute;
    top: 13px;
    left: -15px;
    
    width: 10px;
    height: 10px;
    
    background-color: #ffffff;
    
    border-radius: 5px;
}

.train_detail_departure_times:last-of-type {
    margin-bottom: 80px;
}

.dark_mode .train_detail_departure_times:before {
    background-color: #101010;
}

#train_detail_popup .wide_button {
    position: fixed;
    
    width: calc(100% - 50px) !important;
    
    bottom: 20px;
}

#wait_screen {
    background-color: rgba(0,0,0,0.9);
    
    z-index: 300 !important;
}

#wait_screen:before, .wait_icon:empty:before {
    content: "";
    
    display: block;
    
    position: fixed;
    top: calc(50vh - 60px);
    left: calc(50vw - 60px);
    
    width: 120px;
    height: 120px;
    
    background-image: url(data:image/webp;base64,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);
    background-size: 120px;
    
    animation: spin 1s steps(8) infinite;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    
    100% {
        transform: rotate(360deg);
    }
}

input[type="text"], input[type="number"], input[type="password"], input[type="search"], .line_select {
    background-color: #ffffff;
    
    border: none;
    border-bottom: 2px solid #dddddd;
}

.dark_mode input[type="text"], .dark_mode input[type="number"], .dark_mode input[type="search"], .dark_mode input[type="password"], .dark_mode select {
    background-color: #101010;
    
    border-color: #333333;
    
    color: #ffffff
}

input[type="checkbox"], input[type="radio"] {
    display: none;
}

input[type="checkbox"] + label {
    display: block;
    
    position: relative;
    
    margin: 20px 0 0 10px;
    
    padding-left: 54px;
    
    line-height: 24px;
    font-size: 18px;
}

input[type="checkbox"] + label:before {
    content: "";
    
    display: inline-block;
    
    position: absolute;
    
    top: 0;
    left: 0;
    
    width: 44px;
    height: 24px;
    
    background-color: #dddddd;
    
    border-radius: 12px;
    
    box-shadow: 1px 1px 2px rgba(0,0,0,0.25) inset;
    
    transition-duration: 0.25s;
    transition-property: all;
}

.dark_mode input[type="checkbox"] + label:before {
    background-color: #333333;
}

input[type="checkbox"]:checked + label:before {
    background-color: #66ccff;
}

.dark_mode input[type="checkbox"]:checked + label:before {
    background-color: #0088cc;
}

input[type="checkbox"] + label:after {
    content: "";
    
    display: inline-block;
    
    position: absolute;
    
    top: 2px;
    left: 2px;
    
    width: 20px;
    height: 20px;
    
    background-color: #ffffff;
    
    border-radius: 10px;
    
    box-shadow: 1px 1px 2px rgba(0,0,0,0.25);
    
    transition-duration: 0.2s;
    transition-property: all;
}

input[type="checkbox"]:checked + label:after {
    left: 22px;
}

input[type="radio"] + label {
    display: inline-block;
    
    padding: 8px 12px;
    
    background-color: #cccccc;
    
    border-radius: 5px;
    
    color: #ffffff;
}

.dark_mode input[type="radio"] + label {
    background-color: #202020;
    
    color: #666666;
}

input[type="radio"]:checked + label {
    background-color: #ffffff;
    
    box-shadow: 0 1px 3px rgba(0,0,0,0.25) inset;
    
    color: #000000;
}

.dark_mode input[type="radio"]:checked + label {
    background-color: #101010;
    
    box-shadow: 0 1px 3px rgba(0,0,0,0.5) inset;
    
    color: #ffffff;
}

button {
    background-color: rgba(255,255,255,0.75);
    
    border: 1px solid #dddddd;
    border-left-width: 3px;
    border-right-width: 3px;
    border-radius: 5px;
    
    color: #333333;
}

.dark_mode button {
    background-color: rgba(16,16,16,0.75);
    
    border-color: #333333;
    
    color: #eeeeee;
}

#unyo_icon {
    display: block;
    
    width: 96px;
    
    margin: 10px auto;
    
    filter: drop-shadow(1px 2px 1px rgba(0,0,0,0.25));
}
</style>
</head>
<body>
    <header><span id="app_name"></span><select id="railroad_select" onchange="select_railroad(this.value);"></select><button type="button" id="menu_button" onclick="menu_click();"></button></header>
    <div id="menu">
        <div id="menu_login_status"></div>
        <hr>
        <button type="button" onclick="edit_config();">各種設定</button>
        <button type="button" onclick="open_square_popup('about_popup');">このアプリについて</button>
    </div>
    <div id="splash_screen">
        <div id="splash_screen_login_status">サーバに接続しています...</div>
        <div id="splash_screen_buttons" class="wait_icon"></div>
    </div>
    <div id="tab_area"><button type="button" onclick="change_mode(0);" style="background-image: url(data:image/webp;base64,UklGRi4CAABXRUJQVlA4TCICAAAvT8ATEEfDGpIkS9n7twoHeNxHcAL7aA0GbdsIcjf+HP95/K/z77CNJEVaUu8xPeaf0QXxzHjYswGl9Yt7CJDvUeyIb/SoS9xC0Q5Vp3DxWA20QniFi2VbMKzaAIgVi0dcBDWAGABggRAwQzAIwsPAwQDwMAAMYjjVoUNfAK2IUhhoGEOFPnUHLwpfUBAvdAONsiVFHGu06BQNqi5EKEUGhHAZEueMdkTa9dg/8YEDp3Pg8zqR7/Fda5xr+792CtiSJKlW9rrfi18X3J3B3d3dHf7/F3SnF16JM3si+j8B6k99v05otY4xngppdj2m5Knv3Mqk/baQta7kDWmYG7tRQivq25aU3E7Mp424GxqpFz1SNzP8aICnjTLqQ8tDOJ5K1zppccO25YNkqM2D510qKrnKNtGPm+yVkuKSD09EjpZI85JVhjaT9m5DAnP65m/NOCDGSzN2ObaNeJjmcC3YVc1m3ygxW3fDCYK8V7cRbN/hO8BVO0G3PLO9jBP44hPXBcHnuHrwurkG8Aa4BvHsfyOm8CxXP94yVy9eC9cq3hpXI94WVxlvg+sU74LrAK+KK4UX5QrhWS4ZQ5tU7I1oDt91J5Zr+eQUq6AAD7GOEZJYEYRbrBCCLCCNeiBakdoU5A7SDkYJ6Qwjg7SPkUKKYTwj3WH4Z3FmHQwJJ74k6XI1OiLul2GFTrKuNK6TKGN/nw460bFHK+a83iutb9YcMwE=); border-color: #dd55ff;">走行位置</button><button type="button" onclick="change_mode(1);" style="background-image: url(data:image/webp;base64,UklGRpADAABXRUJQVlA4TIQDAAAvT8ATEO/juJEkKYpq8N9S3rBnlxvz7ziSJEfJvj3Jj8A2/I/AAv4n2m1tu23DDxzDVi6dQ+0pPZ8nccuKNMQvBFIDX+EtbMKHl1/3d24YfkLubjz1heLIg2KDkkBXOHDw1UchRSE6EqXQPU8UKwU5OPkXi0gUUUQEGb/FkBeLcaiRT4vwT3+xL4zbD6fzeg8aPHRMr0Kc0JFABAVQaF0URgEvig4LLHTo0JGAg0TQBQEgMBoIaAkIgB1ANIqwkYqMUjYEVhCBFQEHqWApjgcQGmloPGnphi/DC0dvt34g0ba2442ef4KpbTeoObVt2+3//rXHSCZXn78f3wuI6P8EQHdPftnit9vNo6uro83b58W60l5YHIwv37ok7W6MlwxY4bTOXJPgcl9fwi/9YjrPMS1VfkPCTwCcrwJEtNkQMCk4ekiS8wCwJEZ0WB00Jv6TpB8BOF9liPYiZrT9J5WJzMxZUrmaYUDTERl9UaQrsEzG/wto6X4gC7+GNWTekpW/vyhr3yfl3r9YZMpTRn+7FH3ZJ+VeAQDEPGW036mk+zepn4LvpDraDisIPJDGiF+JBloPyC2Qzla/PB20LNVCtlGxRNu5fac5Yq9kH70LNREHFBEI/uThZuCjeuKBxj4I/ODiMOVXTlxQpY9zw8eWkzZIfFBu2jQnkwAGzjm5GADixAkVAMu8zAO3vNyhx+XF68gnXihaxk3FIjeJZ27Wdk3qj0pHpjy5jT2ip+STIUpjnshT8ono5pjGASSswaTAOIAEnVxRH4BMeyICfQAy6dKMiI4SuWNaBpxZTZM6JgSWAWeWTvaIHpNfSbMXURfxBOgx+ZXoZpeMdCdKokrjEy5JbzybYfLaIjeJMm4q8rmJ9rq8eN245eUeGOdlHijhpRAYOOfkfADACidTANDKyXCas8nHLycNDXzUwDfwg4uDgB+quCjDh8E9HrZSH2GEhwKIrnLwBuGMU/uOvogh5trmNkN22bYkpAPrdj2F5PB5x6btMFRm/7TnIANqu/7a8jcLqvs27PjzBerD6zY89UPnpznXNHc5BM3xI7MuGqE/Z1XJcl9fQsnbFxgZu5F7AuB8ldsqhKkDY99l5gFgSeagNgWDA5VbYo8AnK9iv2pCMNzJnTwXoERm5iwJnk4NO7AxVZC88/xEvfulwhQs7hiqmH3Z2Ty7ujrb3FmbrYh2Qzc=); border-color: #ffdd55;">時刻表</button><button type="button" onclick="change_mode(2);" style="background-image: url(data:image/webp;base64,UklGRvQDAABXRUJQVlA4TOgDAAAvT8ATEGeloG0bxvxJtzsgHESS7Cq97/9Pjo7wrwIXGdaN20aSRFfPRPv//2268UZz2o1tq3FjTPwlj5mTLvtvs4BsKJWpSL6NRDZpsydp70ATFTdqSx3srlqPH/wO+KdXPS/okTdgFMJYKnXfJhgvcCfEkZD0OKIH0CsB0AMQZAg6CFoAgg4KQXcfkAG0AC2oKNhRQFT8EdhQsaE+Dj8lRHEE0NNAgKB0A2FwEnAQDopKAVOJAkbIKHoclQBEYXAKCgA9YBAACgDE4YRqQEJGwhO9FAAApQ0UjkAgtAETL1Yg+3uLL5yQ0L9FrLyhjKGkN2aF+9xJHkghjgBzNTy0B3k+3Ab6zuwX+iyaPyq7mp7e7v+zbHT/7goJAgCWkdS1bduevcHatm3btm3bvl+O0uTMIKL/jtw2ciQae4odqzH9BA48z8Z1ZSW9A0mxUZPTNFRIGKWTODbJvbekrM74gYMalcOGTd9lIc8sY+eGQxUo3raTF4TQQlnNOU/PNYFC6AmwewCnWrokRBJ8owroLFOILPFmYAqECOMJZh0lDCYdJQ8wZvHo5L6Dfu0mAg269ZkDzkP76jxsNLMcfN1fEmnM7VLC4QnHzFy2yWA23Izk6oaRbVFiyDw/GyGJQ9dGcnXD1G0DjJDMe9u+KmiGxqFea4uzm3dgFBZMhwkJpoIozLzdnFta9Uw1FDTvvcFnXkhAEUJEeU2W6hy0fGZNeVRICDD5zPg5N+ia8XWm28b8PwkJITwoL4IBaUW323tXx0fE7OmFIy8MHxG6v7ftWJQWKFdK+YKb30IWURKAKUXphgNL8ywqGPRFiNGgBAXmasTxyOON3wZcGwmdJ+Dvdb/IVvzqwgkRHOLYwuozmaZq9gD+kKD5TK4JH9atxekxa+BYTHrxtqGaXCO1HATg615SUKF42LQOD+rLS4dZn8voGCWYDbPS8vqDwzOFTTup8JrjuY824p3qzTlIOWdOeAPSvowc767Rv/vM43zGrKZnPBL+PhcvTySmjnR1MrvynVqCy1kn6xpJpRNToi+vTv6iN48SBZONUgyYgzV0QjEHFp1MVOKOOeBYj88jkFEHfB0i8/ynbZ8khnri044jmSaDia6X7eC9jUPBMgzL6Q76mrLPhfXRoOs+p/xFwXOSxfVtf152pBhgKCJpXv/troWCw/ClPJbPPprLbzVR1hrNCwN2ZWVTSyi+YuxCU1mrTCq95/jvyyC3xoNTDkLwQSMNhrfPN1YSB0v3rA/PVJRTOTu0riodTAzZQFU3BFmZONEnf4wSlohxtODLq7u/8s2hJPkxvcckqO4x+QXBPSaMQL7HBEEA); border-color: #55ffdd;">運用データ</button><button type="button" onclick="change_mode(3);" style="background-image: url(data:image/webp;base64,UklGRhYCAABXRUJQVlA4TAkCAAAvT8ATEGfCqG0kSa4ersP/t/cWjfl30EaSI3kTf4pHI/0Xg8i2lfDeF9xdMtGTNgQgg7u+gGKw4beLXXJ//7i41f9z0jTGwrF+A8glSQdVARl6oOIVIAY9EINDQgNjAC6cINxhJxeyEtAK4UYcgPFDQAKApIBBAAHhhwtWCISfITCVOf4nOkw15ljjT7uscVSMPb3uht/DXUN+hn04vQKCALCJGmDu45j7hru7u/7/Q3BNaTO3JhfRfweSJClRN5xL4vAF1yeoJ1kmVD5vqc7VLh6fx19faWCBxLcfY2ZjmNkQCt9WfmVSVya6caTOt/aiEC0U3T7bVAJTrtU3ijJzYhNkSPtaCnz9PDM/TkUQdurM+b6k7wn2FSR8FjOHIIphZkvOF1bimxfA6fW0lzdzCV+emf0esU/yhkZx6OU4sHiIQBDIVbS+3Mh+7Vpm/cO23qva3nbVbb/o9hv492uHVlfc5DJJR67r+8yQyH0xriNq+crtZWQ9TWNLs4ItDv+5VgfdmMGWlA9besiuK0zHRbTneyF6LguuNS5hhr0KeL4Dl713dUHDMgw53j3MEPeYhTUgQwOPKCJOEGRo4BEVxcmBDA08opI4NZChjIf75lacB5ChgUe0A6whIEMDj4hCwjUYZKjjAZnF7InOQIY6HtTF+WQZOpuCDHU8iQ62LcMbIEMd7/NSAgA=); border-color: #ff55dd;">編成表</button><button type="button" onclick="change_mode(4);" style="background-image: url(data:image/webp;base64,UklGRroAAABXRUJQVlA4TK0AAAAvT8ATEIcw/wratmE8/kDH4Stq20hyyQyO4U9nnrOHokiSmrsj/hCBD574d5NhAvLbUyqnqG2W+CB+54MoAjZARfYGAQwkSTLUa97M/f+5thXRf4Vt2zb0A93zA0BqX9CAAAA1Ml2ZCm8kABWqss5iWKKCDLQkFKWmZSHrlibx0jAtDd0fcPiyvHl0Pvyv7oO8NOXy3qnN4t7RZVzYO7+Aigv7hwCETbwMnK0AAAA=); border-color: #ddff55;">運用表</button><button type="button" class="sub_menu_tab" onclick="open_square_popup('sub_menu_popup');">サブメニュー</button></div>
    <div id="blank_article" class="wait_icon"></div>
    <article>
        <select id="position_line_select" class="line_select" onchange="position_change_lines(this.value);"></select>
        <div id="position_area" class="wait_icon"></div>
    </article>
    <article>
        <select id="timetable_line_select" class="line_select" onchange="timetable_change_lines(this.value);"></select>
        <div id="direction_radio_area">
            <h3><button type="button" class="previous_button" onclick="timetable_change_lines(timetable_line_select_elm.value, true);"></button><span id="timetable_station_name"></span></h3>
            <input type="radio" name="direction_radio" id="radio_inbound" value="inbound" checked="checked" onchange="timetable_select_station(timetable_selected_station);"><label for="radio_inbound" id="radio_inbound_label">上り方面</label>
            <input type="radio" name="direction_radio" id="radio_outbound" value="outbound" onchange="timetable_select_station(timetable_selected_station);"><label for="radio_outbound" id="radio_outbound_label">下り方面</label>
        </div>
        <div id="timetable_area" class="wait_icon"></div>
    </article>
    <article class="wait_icon"></article>
    <article id="formation_table_area" class="wait_icon"></article>
    <article class="wait_icon"></article>
    <footer>
        <div><button type="button" class="previous_button" onclick="position_change_time(-60);"></button><span id="position_hours"></span><button type="button" class="next_button" onclick="position_change_time(60);"></button><button type="button" class="previous_button" onclick="position_change_time(-5);"></button><span id="position_minutes"></span><button type="button" class="next_button" onclick="position_change_time(5);"></button></div>
        <div><button type="button" class="previous_button" onclick="timetable_operation_previous();"></button><span id="timetable_operation_name"></span><button type="button" class="next_button" onclick="timetable_operation_next();"></button></div>
        <div><button type="button" class="previous_button"></button><button type="button" class="next_button"></button></div>
        <div></div>
        <div><button type="button" class="previous_button"></button><button type="button" class="next_button"></button></div>
    </footer>
    <div class="popup" id="sign_up_popup">
        <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
        <h2>新規ユーザー登録</h2>
        <h3>ユーザーID</h3>
        <div class="informational_text">半角英数字とアンダーバーの組み合わせで5文字以上が利用可能です。</div>
        <input type="text" id="sign_up_user_id">
        <h3>ハンドルネーム</h3>
        <input type="text" id="sign_up_user_name">
        <h3>パスワード</h3>
        <div class="informational_text">大文字・小文字・数字を全て含む10文字以上を設定してください。</div>
        <input type="password" id="sign_up_password">
        <br>
        <button type="button" class="wide_button" onclick="check_sign_up();">ユーザー登録</button>
    </div>
    <div class="popup" id="config_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>各種設定</h2>
        <input type="checkbox" id="dark_mode_check" onchange="change_config();"><label for="dark_mode_check">ダークモード</label>
        <h3>運用情報の自動更新間隔</h3>
        <input type="number" id="refresh_interval" min="5" max="60" onchange="change_config();">分ごと<br>
        <h3>運用情報のキャッシュ保管日数</h3>
        <input type="number" id="operation_data_cache_period" min="2" max="14" onchange="change_config();">日前のデータまで<br>
        <br>
        <div style="text-align: right;"><a href="javascript:void(0)" onclick="reset_config_value();">デフォルト値に戻す</a></div>
        <br>
        <div class="informational_text">変更内容は自動で保存されます</div>
    </div>
    <div id="popup_screen">
        <div id="popup_screen_blank_area" onclick="close_square_popup();"></div>
        <div class="square_popup" id="login_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h4>IDまたはメールアドレス</h4>
            <input type="text" id="login_user_id">
            <h4>パスワード</h4>
            <input type="password" id="login_password">
            <br>
            <br>
            <button type="button" class="wide_button" onclick="challenge_login();">ログイン</button>
        </div>
        <div class="square_popup" id="captcha_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <div id="captcha_info">
                <h3>画像認証</h3>
                <div class="informational_text">画像に表示されている文字を入力してください。</div>
            </div>
            <div id="captcha_area" class="wait_icon"></div>
            <button type="button" id="captcha_submit_button" class="wide_button">送信</button>
        </div>
        <div class="preview_popup" id="train_detail_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <div id="train_detail_area" class="load_icon"></div>
            <button type="button" class="wide_button">運用情報を投稿</button>
        </div>
        <div class="square_popup" id="sub_menu_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <button type="button" class="wide_button">この路線系統データについて</button>
            <button type="button" class="wide_button">運用情報の一括投稿</button>
        </div>
        <div class="square_popup" id="about_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <img src="apple-touch-icon.webp" alt="" id="unyo_icon">
            <b style="font-size: 20px;"><script> document.write(UNYOHUB_APP_NAME + " " + UNYOHUB_VERSION); </script></b>
            <div style="padding: 10px; color: #999999; font-size: small;"><script> document.write("<a href='" + UNYOHUB_LICENSE_URL + "' target='_blank'>" + UNYOHUB_LICENSE_TEXT + "</a>"); </script></div>
            <button type="button" class="wide_button" onclick="window.open('README.html');">このアプリの使い方</button>
        </div>
    </div>
    <div id="wait_screen"></div>
<script>
document.getElementsByTagName("title")[0].innerText = UNYOHUB_APP_NAME;
document.getElementById("app_name").innerText = UNYOHUB_APP_NAME;


const UNYOHUB_GENERIC_TRAIN_ICON = "data:image/webp;base64,UklGRngCAABXRUJQVlA4TGwCAAAvT8AdEJVIkm07bhst/QLu7Zlm2YK2CYgQP35pmv/Uls0uAgq2bcee31a2bc5bstkct2Tbjl60ze4t2bZtPRMQ53o2pNDRH8YI4BcYfVlNvSh4lsHnZOiTzqZEzTzPErPzCSdpnudFuv2aAcWwxMQBHRES3XFCAYqI2yb9LVYokNiCsUOMFV9U1gCRbyT58wfwklUxXrzIeBT/hJhAzpP4X8NCrHfNyC3QJFEQ1ayTuGA6LbObznnkdUvfgH63jYflyhLTdynrKjFLNFlYeaEZVAQYHCljCxiRIxqS7x6/Q8TtwgsBFkr86Ltq9OvtEXZBcQmY5OqAtoMjYDQ72KHCCuV22LTCthnkMvsis5JS7ZBihWk7TNn4w5E/O+kP50/6OAd0NqTIiQlOZPzB+ERENiwn2eMJoYs7dcstnSkYXAsUMrhR5/eU/kMehCPHgIMcZYcB+PEjF/nG58iLhA85yfuLqEY34OZvBcrFDz6/qAX2chTbIvl7ci9SqCfz/5EQ5EkKLPDxJHkXuHmSXIvs4slcoPck64pXnidwC2iefFGL4M2PKaps+sFGjUk/mKjR6AcNNbL8SJk1wvyYatnkB8baHs+PFxcItWDdC9biKB1eLMdSvBfEHYvg3gPuYjCLHrAwbPGA9mEUeUDhsBTtAVHDcPYgOw17ZXkAc9gOyVt/0w45LFjtj5VoZKA/+luo7o+qFmL7SzEtyb0/3FpeRP0hbAHDd2/8/MO2BLu9sRPNTPbGRBu1vVHTlhJ7I6ENbgodXsyjFvPwra21iFGLMH3+8CrxMs4mXW1RLVE5zio9bQW2lxj5colzHQ==";

const UNYOHUB_UNKNOWN_TRAIN_ICON = "data:image/webp;base64,UklGRqADAABXRUJQVlA4TJMDAAAvT8AdELVQuq03kST1T3+OaO5eMQ8zM/OOeXbMzMwQUY6wrMGVWo2FMUWRldBVEVIACCDAyGa2bXtLNpvjlmzb0Yu22b0l27b9uAmwv+qFRQhPPi+MIP5C8vFEVGnAqwvsBoK2y7PtTt1wOHRnftjiwH04HI7cp5fEIMSoO1PXCJuZO73WooOb2fSG++pYCkXu7KBgqWyHLBvgFAoJgfwD3gojS2elHs/Of8JEoM+L839iEmwy62voS6DFfWi1hZk7V8yGVfbDJc+8r4df8OX1dZ5GZ1lhdta9MKuxoTstEia80YqQGSI4U3HCE3JCU/DfI242fZo3giRUCWDgrCc/Oz1vchHi2kVyc42wHJxdaOEkhyopVMphWwq7YtB3saWelJAuhzQpzMphRsbKSf7JCf9wXUozLixCdL/KmQufZ7InqrAYt7JHnDB6ePBsuac7hCLWBBmyuPPMZ0LmLumok5y6gpwUThEE8MdV5Be/KUodvlxJPkutOnpBzeUaZE7rwfcO2QqOrij2lRDY2m5u5kU+4Ft+4Vcad9/wHs9zAztpLQRWQnhLl/A6v9An7F7mOC0N2zvA/K8kf4k9iLqeH+gFfs81CHqYX5HZ3YuYW+mldjch5FI6Mf3PXIiIko/4FcEfUiBhoRd9JwJKvkbWV/yf7ir62F94nEOUeOPNHOVZovorSPcEMd3EW76NqMdI9zYxj+Ktv0DMW6QbxeyjvaWYr0k3HTEdaG8HMT+Tro9c9fa3ENP/9ZP592sjZlqHpZhlHZ4j5oQKN9PHPk4e21k7FXF+8Cx99JXk8Ah9yuUSbe7HlfmMrSgzfTGuzO24Mg/iunzPdbgur7AX0KR7hQvwdrPoRu/xHDewE29b3l146v9oEJJMdAiu4KdJ8K3goUlwrxRumqxVMNekMKtsVtME1QpymuyQrRgfevRWy3aqR/iVyLtIxVYd03owVUezHjTVkaNHyK4jQo9BXWGlB5Z1e8T5o8UpJOqMTS3YsCnpSiR4PFVI1IKEqcx41IAHi2ZZA5bixhrQGUeJBhTHhVgNiInDVYPCJW6zkgYoxm0S5CO/fhBnrOfHmjVkKD8Gm1CbHzVNiM8vxDUJnvnh0aTUyg/NJojwm9upw6JNjP3c2LPG87mtNqM+N+qaheTcSGqGagiPrwyTVobxG82aVixpxUT/9eHdnbc06+5nZVHrTnWa8+4Lsgz705b49Gn7qw4A";


/* Zizai CAPTCHA 23.10-2 captcha.js */

const ZIZAI_CAPTCHA_GENERATE_ID_ENDPOINT = "api/zizai_captcha/generate_id.php";
const ZIZAI_CAPTCHA_IMAGE_PATH = "api/zizai_captcha/image.php";

const ZIZAI_CAPTCHA_RELOAD_IMAGE_DARK = "data:image/webp;base64,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";
const ZIZAI_CAPTCHA_RELOAD_IMAGE_LIGHT = "data:image/webp;base64,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";

var zizai_captcha_dir;
(function(){
    var path_splitted = location.href.split("/"); //captcha.jsから改変
    path_splitted[path_splitted.length - 1] = "";
    
    zizai_captcha_dir = path_splitted.join("/");
}());

function zizai_captcha_get_id (callback_func, args = null) {
    var request_obj = new XMLHttpRequest();
    
    request_obj.onreadystatechange = function () {
        if (request_obj.readyState === 4) {
            if (request_obj.status === 200) {
                if (args === null) {
                    callback_func(JSON.parse(request_obj.responseText));
                } else {
                    callback_func(JSON.parse(request_obj.responseText), args);
                }
            } else {
                callback_func(false);
            }
        }
    };
    
    request_obj.open("GET", zizai_captcha_dir + ZIZAI_CAPTCHA_GENERATE_ID_ENDPOINT, true);
    request_obj.timeout = 10000;
    request_obj.send();
}

function zizai_captcha_get_image_path (session_id) {
    return zizai_captcha_dir + ZIZAI_CAPTCHA_IMAGE_PATH + "/" + session_id;
}

function zizai_captcha_reload_image_callback (data, args) {
    document.getElementById(args[0]).src = zizai_captcha_get_image_path(data.session_id);
    
    if (args[1] !== null) {
        document.getElementById(args[1]).value = data.session_id;
    }
}

function zizai_captcha_reload_image (image_id, session_id_id = null) {
    zizai_captcha_get_id(zizai_captcha_reload_image_callback, [image_id, session_id_id]);
}

function zizai_captcha_get_html_callback (data, args) {
    var image_path = zizai_captcha_get_image_path(data.session_id);
    var input_font_size = Math.round(data.image_height * 0.6);
    
    var rgb_sum = 0;
    for (var cnt = 0; cnt < 3; cnt++) {
        rgb_sum += parseInt(args[4].substring(cnt * 2 + 1, cnt * 2 + 3), 16);
    }
    
    if (rgb_sum > 382) {
        var button_image = ZIZAI_CAPTCHA_RELOAD_IMAGE_DARK;
    } else {
        var button_image = ZIZAI_CAPTCHA_RELOAD_IMAGE_LIGHT;
    }
    
    if (button_image.substring(0, 5) !== "data:") {
        button_image = zizai_captcha_dir + button_image;
    }
    
    args[0](`
<input type="hidden" name="${args[1]}" id="${args[1]}" value="${data.session_id}">
<img src="${image_path}" alt="" id="${args[3]}" style="vertical-align: text-bottom;"><button type="button" onclick="zizai_captcha_reload_image('${args[3]}', '${args[1]}');" style="box-sizing: border-box; width: ${data.image_height}px; height: ${data.image_height}px; background-color: ${args[4]}; background-image: url('${button_image}'); background-size: cover; border: none; margin-left: 5px; vertical-align: text-bottom; cursor: pointer;"></button><br>
<input type="text" name="${args[2]}" id="${args[2]}" style="box-sizing: border-box; width: ${data.image_width}px; height: ${data.image_height}px; font-size: ${input_font_size}px; letter-spacing: 0.5em; text-align: center;">
`);
}

function zizai_captcha_get_html (callback_func, button_color = "#dddddd", id_name = "zizai_captcha_id", characters_name = "zizai_captcha_characters", image_id = "zizai_captcha_image") {
    zizai_captcha_get_id(zizai_captcha_get_html_callback, [callback_func, id_name, characters_name, image_id, button_color]);
}

/* captcha.js ここまで */


function escape_html (text) {
    return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function escape_form_data (data) {
    return encodeURIComponent(data).replace(/%20/g, "+");
}


function get_default_config () {
    return function () {/*
{
    "guest_id" : null,
    "dark_mode" : false,
    "refresh_interval" : 30,
    "operation_data_cache_period" : 7
}
*/}.toString().split("\n").slice(1,-1).join("\n");
}

var config = new Object();
(function () {
    var config_json = localStorage.getItem("unyohub_config");
    
    if (config_json === null) {
        config_json = get_default_config();
        localStorage.setItem("unyohub_config", config_json);
    }
    config = JSON.parse(config_json);
}());

function save_config () {
    localStorage.setItem("unyohub_config", JSON.stringify(config));
}


(function () {
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onerror = function () {
        alert("ご利用のブラウザではIndexedDBが使用できないため" + UNYOHUB_APP_NAME + "は正常に動作できません");
    };
    
    open_request.onupgradeneeded = function () {
        var db = open_request.result;
        
        db.createObjectStore("railroads", {keyPath : "railroad_id"});
        db.createObjectStore("train_icons", {keyPath : "railroad_id"});
        db.createObjectStore("formations", {keyPath : "railroad_id"});
        db.createObjectStore("operations", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("line_operations", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("operation_groups", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("timetables", {keyPath : ["railroad_id", "operation_table"]});
        var operation_data_store = db.createObjectStore("operation_data", {keyPath : ["railroad_id", "operation_date"]});
        operation_data_store.createIndex("idx_od1", "operation_date");
    };
}());


var railroad_info = null;
var train_icons = {railroad_id : null};


function rgb2hsl (color_hex) {
    var r = parseInt(color_hex.substring(1, 3), 16);
    var g = parseInt(color_hex.substring(3, 5), 16);
    var b = parseInt(color_hex.substring(5), 16);
    
    var rgb_max = Math.max(r, g, b);
    var rgb_min = Math.min(r, g, b);
    
    var h = 0;
    var s = 0;
    
    var l = Math.round((rgb_max + rgb_min) / 2);
    
    if (rgb_max !== rgb_min) {
        if (r === rgb_max) {
            h = Math.round((g - b) / (rgb_max - rgb_min) * 60);
        } else if (g === rgb_max) {
            h = Math.round((b - r) / (rgb_max - rgb_min) * 60 + 120);
        } else {
            h = Math.round((r - g) / (rgb_max - rgb_min) * 60 + 240);
        }
        
        if (h < 0) {
            h += 360;
        }
        
        if (l <= 127) {
            s = Math.round((rgb_max - rgb_min) / (rgb_max + rgb_min) * 255);
        } else {
            s = Math.round((rgb_max - rgb_min) / (510 - rgb_max - rgb_min) * 255);
        }
    }
    
    return [h, s, l];
}

function hsl2rgb (h, s, l) {
    if (l <= 127) {
        var rgb_max = Math.round(l + l * (s / 255));
        var rgb_min = Math.round(l - l * (s / 255));
    } else {
        var rgb_max = Math.round(l + (255 - l) * (s / 255));
        var rgb_min = Math.round(l - (255 - l) * (s / 255));
    }
    
    if (h <= 60) {
        return [rgb_max, Math.round((h / 60) * (rgb_max - rgb_min) + rgb_min), rgb_min];
    } else if(h <= 120) {
        return [Math.round(((120 - h) / 60) * (rgb_max - rgb_min) + rgb_min), rgb_max, rgb_min];
    } else if(h <= 180) {
        return [rgb_min, rgb_max, Math.round(((h - 120) / 60) * (rgb_max - rgb_min) + rgb_min)];
    } else if(h <= 240) {
        return [rgb_min, Math.round(((240 - h) / 60) * (rgb_max - rgb_min) + rgb_min), rgb_max];
    } else if(h <= 300) {
        return [Math.round(((h - 240) / 60) * (rgb_max - rgb_min) + rgb_min), rgb_min, rgb_max];
    } else {
        return [rgb_max, rgb_min, Math.round(((360 - h) / 60) * (rgb_max - rgb_min) + rgb_min)];
    }
}

function convert_color_dark_mode (color_hex) {
    var hsl = rgb2hsl(color_hex);
    
    hsl[2] = 271 - hsl[2];
    if (hsl[2] > 255) {
        hsl[2] = 255;
    }
    
    var rgb = hsl2rgb(hsl[0], hsl[1], hsl[2]);
    
    return "rgb(" + rgb[0] + "," + rgb[1] + "," + rgb[2] + ")";
}

function switch_dark_mode () {
    if (config["dark_mode"]) {
        document.getElementsByTagName("body")[0].className = "dark_mode";
        
        if (railroad_info !== null) {
            header_elm.style.backgroundColor = convert_color_dark_mode(railroad_info["main_color"]);
        }
    } else {
        document.getElementsByTagName("body")[0].className = "";
        
        if (railroad_info !== null) {
            header_elm.style.backgroundColor = railroad_info["main_color"];
        }
    }
    
    switch (mode_val) {
        case 0:
            position_mode();
            break;
        case 1:
            if (timetable_selected_station !== null) {
                timetable_select_station(timetable_selected_station);
            }
            break;
    }
}

switch_dark_mode();


var header_elm = document.getElementsByTagName("header")[0];

var menu_elm = document.getElementById("menu");
var menu_button_elm = document.getElementById("menu_button");

function menu_click (force_close = false) {
    if (menu_elm.className === "menu_open" || force_close) {
        menu_elm.className = "";
        menu_button_elm.className = "";
    } else {
        menu_elm.className = "menu_open";
        menu_button_elm.className = "menu_button_active";
    }
}

var popup_history = new Array();
var square_popup_is_open = false;

function open_popup (id) {
    var elm = document.getElementById(id);
    
    if (elm.style.display !== "block") {
        elm.style.display = "block";
        elm.style.zIndex = popup_history.length + 10;
        
        popup_history.push(id);
        
        menu_click(true);
    }
}

function popup_close() {
    var id = popup_history.pop();
    
    document.getElementById(id).style.display = "none";
}

var screen_elm = document.getElementById("popup_screen");
var wait_screen_elm = document.getElementById("wait_screen");

function open_square_popup (id) {
    screen_elm.style.display = "block";
    document.getElementById(id).style.display = "block";
    
    popup_history.push(id);
    square_popup_is_open = true;
}

function close_square_popup () {
    var id = popup_history.pop();
    
    screen_elm.style.display = "none";
    
    document.getElementById(id).style.display = "none";
    
    square_popup_is_open = false;
    
    menu_click(true);
}

function open_wait_screen () {
    wait_screen_elm.style.display = "block";
    screen_elm.style.backgroundColor = "transparent";
}

function close_wait_screen () {
    wait_screen_elm.style.display = "none";
    screen_elm.style.backgroundColor = "";
}


var user_data = null;

function update_user_data (user_data_next = null) {
    user_data = user_data_next;
    
    if (user_data !== null) {
        splash_screen_login_status_elm.innerHTML = "ようこそ <b>" + escape_html(user_data["user_name"]) + "</b> さん<br><a href='javascript:void(0)' onclick='user_logout();'>ログアウト</a>";
    } else {
        splash_screen_login_status_elm.innerHTML = "<b>ログインしていません</b><br><a href='javascript:void(0)' onclick='open_square_popup(\"login_popup\");'>ログイン</a>　<a href='javascript:void(0)' onclick='open_popup(\"sign_up_popup\");'>新規登録</a>";
    }
}


function get_holiday_list (toshi) {
    var holiday_list = ["1/1", "2/11", "2/23", "4/29", "5/3", "5/4", "5/5", "8/11", "11/3", "11/23"];
    var happy_monday_list = ["1-2", "7-3", "9-3", "10-2"];
    
    holiday_list.push("3/" + String(Math.floor(20.8431 + 0.242194 * (toshi - 1980)) - Math.floor((toshi - 1980) / 4)));
    var shubun = Math.floor(23.2488 + 0.242194 * (toshi - 1980)) - Math.floor((toshi - 1980) / 4);
    holiday_list.push("9/" + String(shubun));
    
    var dt2;
    var bunkatsu;
    var yobi_val;
    for (var hm_cnt = 0; hm_cnt < happy_monday_list.length; hm_cnt++) {
        bunkatsu = happy_monday_list[hm_cnt].split("-");
        dt2 = new Date(String(toshi) + "-" + ("0" + bunkatsu[0]).slice(-2) + "-01 12:00:00");
        
        yobi_val = dt2.getDay();
        if (yobi_val <= 1) {
            yobi_val += 7;
        }
        holiday_list.push(bunkatsu[0] + "/" + String((2 - yobi_val) + (7 * Number(bunkatsu[1]))));
    }
    
    var furikae_cnt;
    var hizuke;
    for (var h_cnt = 0; h_cnt < holiday_list.length; h_cnt++) {
        bunkatsu = holiday_list[h_cnt].split("/");
        dt2 = new Date(String(toshi) + "-" + ("0" + bunkatsu[0]).slice(-2) + "-" + ("0" + bunkatsu[1]).slice(-2) + " 12:00:00");
        
        if (dt2.getDay() === 0) {
            furikae_cnt = 0;
            do {
                furikae_cnt++;
                hizuke = bunkatsu[0] + "/" + String(Number(bunkatsu[1]) + furikae_cnt);
            } while (holiday_list.indexOf(hizuke) !== -1);
            
            holiday_list.push(hizuke);
        }
    }
    
    if (holiday_list.indexOf("9/" + String(shubun - 2)) !== -1) {
        holiday_list.push("9/" + String(shubun - 1));
    }
    
    return holiday_list;
}

function get_days_operation (ts) {
    var dt = new Date(ts * 1000);
    today = String(dt.getMonth() + 1) + "/" + String(dt.getDate());
    today_mm_dd = "00" + String(dt.getMonth() + 1).substring(0,2) + "00" + String(dt.getDate()).substring(0,2);
    
    if (today_mm_dd in railroad_info["operations_by_date"]) {
        return railroad_info["operations_by_date"][today_mm_dd];
    } else if (today in get_holiday_list(dt.getFullYear())) {
        return railroad_info["operations_by_day"][0];
    } else {
        return railroad_info["operations_by_day"][dt.getDay()];
    }
}


var splash_screen_elm = document.getElementById("splash_screen");
var splash_screen_login_status_elm = document.getElementById("splash_screen_login_status");

function update_railroad_list (railroads) {
    var select_html = "";
    var buttons_html = "";
    
    var keys = Object.keys(railroads);
    for (var cnt = 0; cnt < keys.length; cnt++) {
        select_html += "<option value='" + keys[cnt] + "'>" + escape_html(railroads[keys[cnt]]["railroad_name"]) + "</option>";
        buttons_html += "<button type='button' class='wide_button' onclick='select_railroad(\"" + keys[cnt] + "\");' style='background-image: url(" + railroads[keys[cnt]]["railroad_icon"] + ");'>" + escape_html(railroads[keys[cnt]]["railroad_name"]) + "</button>";
    }
    
    document.getElementById("railroad_select").innerHTML = select_html;
    document.getElementById("splash_screen_buttons").innerHTML = buttons_html;
    
    splash_screen_elm.className = "splash_screen_loaded";
}

window.onload = function () {
    var cache_json = localStorage.getItem("unyohub_common_caches");
    
    if (cache_json !== null) {
        var common_caches = JSON.parse(cache_json);
    } else {
        var common_caches = {
            railroads : [],
            last_modified_timestamp : 0
        };
    }
    
    
    if (navigator.onLine) {
        var check_logged_in_request = new XMLHttpRequest();
        check_logged_in_request.onreadystatechange = function () {
            if (check_logged_in_request.readyState === 4) {
                if (check_logged_in_request.status === 200) {
                    if (check_logged_in_request.responseText !== "NOT_LOGGED_IN"){
                        update_user_data(JSON.parse(check_logged_in_request.responseText));
                    } else {
                        update_user_data();
                    }
                } else {
                    splash_screen_login_status_elm.innerText = "【!】ログイン状態の確認に失敗しました";
                }
            }
        };
        
        check_logged_in_request.ontimeout = function () {
            splash_screen_login_status_elm.innerText = "【!】ネットワークが不安定です";
        }
        
        check_logged_in_request.open("POST", "api/check_logged_in.php", true);
        check_logged_in_request.timeout = 5000;
        check_logged_in_request.send();
        
        
        var railroads_request = new XMLHttpRequest();
        railroads_request.onreadystatechange = function () {
            if (railroads_request.readyState === 4) {
                if (railroads_request.responseText.substring(0,6) === "ERROR:") {
                    alert(railroads_request.responseText);
                } else if (railroads_request.status === 200 && railroads_request.responseText !== "NO_UPDATES_AVAILABLE") {
                    common_caches["railroads"] = JSON.parse(railroads_request.responseText);
                    
                    var last_modified_date = new Date(railroads_request.getResponseHeader("last-modified"));
                    common_caches["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                    
                    localStorage.setItem("unyohub_common_caches", JSON.stringify(common_caches));
                }
                
                update_railroad_list(common_caches["railroads"]);
            }
        };
        
        check_logged_in_request.ontimeout = function () {
            update_railroad_list(common_caches["railroads"]);
        }
        
        railroads_request.open("POST", "api/railroads.php", true);
        railroads_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
        railroads_request.timeout = 3000;
        railroads_request.send("last_modified_timestamp=" + common_caches["last_modified_timestamp"]);
    } else {
        splash_screen_login_status_elm.innerHTML = "<b>端末がオフラインです</b><br>前回アクセス時のデータを表示します";
        update_railroad_list(common_caches["railroads"]);
    }
    
    
    /*
    
    ここに古い運用データキャッシュの削除処理
    
    */
}


function select_railroad (railroad_id) {
    splash_screen_elm.style.display = "none";
    
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onsuccess = function () {
        var transaction = open_request.result.transaction("railroads", "readonly");
        
        var railroads_store = transaction.objectStore("railroads");
        var get_request = railroads_store.get(railroad_id);
        
        get_request.onsuccess = function (evt) {
            if (evt.target.result !== undefined) {
                var railroad_info_next = evt.target.result;
                var last_modified_timestamp = railroad_info_next["last_modified_timestamp"];
            } else {
                var railroad_info_next = null;
                var last_modified_timestamp = 0;
            }
            
            if (navigator.onLine) {
                if (railroad_info_next !== null){
                    switch_railroad(railroad_info_next);
                    var icon_loaded = true;
                } else {
                    var icon_loaded = false;
                }
                
                var railroad_info_request = new XMLHttpRequest();
                railroad_info_request.onreadystatechange = function () {
                    if (railroad_info_request.readyState === 4) {
                        if (railroad_info_request.responseText.substring(0,6) === "ERROR:") {
                            alert(railroad_info_request.responseText);
                        } else if (railroad_info_request.status === 200 && railroad_info_request.responseText !== "NO_UPDATES_AVAILABLE") {
                            railroad_info_next = JSON.parse(railroad_info_request.responseText);
                            
                            railroad_info_next["railroad_id"] = railroad_id;
                            
                            var last_modified_date = new Date(railroad_info_request.getResponseHeader("last-modified"));
                            railroad_info_next["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            var transaction = open_request.result.transaction("railroads", "readwrite");
                            
                            var railroads_store = transaction.objectStore("railroads");
                            railroads_store.put(railroad_info_next);
                        }
                        
                        switch_railroad(railroad_info_next, !icon_loaded);
                    }
                };
                
                railroad_info_request.open("POST", "api/railroad_info.php", true);
                railroad_info_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                railroad_info_request.timeout = 5000;
                railroad_info_request.send("railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp);
            } else {
                switch_railroad(railroad_info_next);
            }
        }
    };
}

function switch_railroad (railroad_info_next, load_icon = true) {
    if (railroad_info_next === null){
        alert("路線系統情報が取得できません");
        return;
    }
    
    railroad_info = railroad_info_next;
    
    var select_elm = document.getElementById("railroad_select");
    if (select_elm.value !== railroad_info["railroad_id"]) {
        select_elm.value = railroad_info["railroad_id"];
    }
    
    switch_dark_mode();
    
    header_elm.className = "railroad_select_mode";
    header_elm.style.backgroundImage = "url(" + railroad_info["railroad_icon"] + ")";
    
    if (load_icon) {
        var railroad_id = railroad_info["railroad_id"];
        
        var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
        
        open_request.onsuccess = function () {
            var transaction = open_request.result.transaction("train_icons", "readonly");
            
            var railroads_store = transaction.objectStore("train_icons");
            var get_request = railroads_store.get(railroad_id);
            
            get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    train_icons = evt.target.result;
                    var last_modified_timestamp = train_icons["last_modified_timestamp"];
                } else {
                    train_icons = {railroad_id : null};
                    var last_modified_timestamp = 0;
                }
                
                if (navigator.onLine) {
                    var icon_request = new XMLHttpRequest();
                    icon_request.onreadystatechange = function () {
                        if (icon_request.readyState === 4) {
                            if (icon_request.responseText.substring(0,6) === "ERROR:") {
                                alert(icon_request.responseText);
                            } else if (icon_request.status === 200 && icon_request.responseText !== "NO_UPDATES_AVAILABLE") {
                                train_icons = {icons : JSON.parse(icon_request.responseText)};
                                
                                train_icons["railroad_id"] = railroad_id;
                                
                                var last_modified_date = new Date(icon_request.getResponseHeader("last-modified"));
                                train_icons["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                                
                                var transaction = open_request.result.transaction("train_icons", "readwrite");
                                
                                var icons_store = transaction.objectStore("train_icons");
                                icons_store.put(train_icons);
                            }
                        }
                    };
                    
                    icon_request.open("POST", "api/train_icons.php", true);
                    icon_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                    icon_request.timeout = 5000;
                    icon_request.send("railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp);
                }
            }
        };
        
        schedule_change_mode();
    }
}

function schedule_change_mode (cnt = 0) {
    if (railroad_info["railroad_id"] !== train_icons["railroad_id"] && cnt < 100) {
        setTimeout(schedule_change_mode, 50, cnt + 1);
    } else {
        for (var cnt_2 = 0; cnt_2 < railroad_info["train_color_rules"].length; cnt_2++) {
            railroad_info["train_color_rules"][cnt_2]["regexp"] = new RegExp(railroad_info["train_color_rules"][cnt_2]["pattern"]);
        }
        
        for (var cnt_2 = 0; cnt_2 < train_icons["icons"].length; cnt_2++) {
            train_icons["icons"][cnt_2]["regexp"] = new RegExp(train_icons["icons"][cnt_2]["pattern"]);
        }
        
        change_mode(0);
    }
}


var tab_area_elm = document.getElementById("tab_area");
var article_elms = document.getElementsByTagName("article");
var footer_elm = document.getElementsByTagName("footer")[0];

tab_area_elm.onselectstart = function () { return false; };

var mode_val = -1;

function change_mode (num) {
    document.getElementById("blank_article").style.display = "none";
    
    var tab_buttons = tab_area_elm.getElementsByTagName("button");
    var footer_boxes = footer_elm.getElementsByTagName("div");
    for (var cnt = 0; cnt < article_elms.length; cnt++) {
        if (cnt === num) {
            article_elms[cnt].style.display = "block";
            tab_buttons[cnt].className = "active_tab";
            footer_boxes[cnt].style.display = "block";
        } else {
            article_elms[cnt].style.display = "none";
            tab_buttons[cnt].className = "";
            footer_boxes[cnt].style.display = "none";
        }
    }
    
    switch (num) {
        case 0:
            position_mode();
            break;
        case 1:
            timetable_mode();
            break;
        case 3:
            formation_table_mode();
            break;
    }
    
    mode_val = num;
}


var operations = null;
var line_operations = null;
var operation_groups = null;
var operation_last_modified_timestamp = null;

function load_operation_table (operation_table, update_operations, update_line_operations, update_operation_groups) {
    var tables = [];
    
    if (update_operations) {
        operations = null;
        tables.push("operations")
    }
    if (update_line_operations) {
        line_operations = null;
        tables.push("line_operations")
    }
    if (update_operation_groups) {
        operation_groups = null;
        tables.push("operation_groups")
    }
    operation_last_modified_timestamp = null;
    
    var railroad_id = railroad_info["railroad_id"];
    
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onsuccess = function () {
        var transaction = open_request.result.transaction(tables, "readonly");
        
        if (update_operations) {
            var operations_store = transaction.objectStore("operations");
            var operations_get_request = operations_store.get([railroad_id, operation_table]);
            
            operations_get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    operations = evt.target.result;
                    var last_modified_timestamp = operations["last_modified_timestamp"];
                } else {
                    var last_modified_timestamp = 0;
                }
                
                update_operation_table(operation_table, last_modified_timestamp);
            }
        }
        
        if (update_line_operations) {
            var line_operations_store = transaction.objectStore("line_operations");
            var line_operations_get_request = line_operations_store.get([railroad_id, operation_table]);
            
            line_operations_get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    line_operations = evt.target.result;
                    var last_modified_timestamp = line_operations["last_modified_timestamp"];
                } else {
                    var last_modified_timestamp = 0;
                }
                
                update_operation_table(operation_table, last_modified_timestamp);
            }
        }
        
        if (update_operation_groups) {
            var operation_groups_store = transaction.objectStore("operation_groups");
            var operation_groups_get_request = operation_groups_store.get([railroad_id, operation_table]);
            
            operation_groups_get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    operation_groups = evt.target.result;
                    var last_modified_timestamp = operation_groups["last_modified_timestamp"];
                } else {
                    var last_modified_timestamp = 0;
                }
                
                update_operation_table(operation_table, last_modified_timestamp);
            }
        }
    };
}

function update_operation_table(operation_table, last_modified_timestamp){
    if (operation_last_modified_timestamp != null) {
        return;
    }
    
    operation_last_modified_timestamp = last_modified_timestamp;
    
    var railroad_id = railroad_info["railroad_id"];
    
    if (navigator.onLine) {
        var operation_request = new XMLHttpRequest();
        
        operation_request.onreadystatechange = function () {
            if (operation_request.readyState === 4) {
                if (operation_request.responseText.substring(0,6) === "ERROR:") {
                    alert(operation_request.responseText);
                } else if (operation_request.status === 200 && operation_request.responseText !== "NO_UPDATES_AVAILABLE") {
                    var operation_response = JSON.parse(operation_request.responseText);
                    
                    var last_modified_date = new Date(operation_request.getResponseHeader("last-modified"));
                    operation_last_modified_timestamp = Math.floor(last_modified_date.getTime() / 1000);
                    
                    var operations_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : operation_last_modified_timestamp, operations : {}};
                    var operation_groups_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : operation_last_modified_timestamp, operation_groups : {}};
                    var line_operations_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : operation_last_modified_timestamp, lines : {}};
                    
                    var lines = Object.keys(railroad_info["lines"]);
                    for (var cnt = 0; cnt < lines.length; cnt++) {
                        line_operations_data["lines"][lines[cnt]] = {
                            inbound_trains : {},
                            outbound_trains : {}
                        };
                    }
                    
                    var groups = Object.keys(operation_response);
                    for (cnt = 0; cnt < groups.length; cnt++) {
                        operation_groups_data["operation_groups"][groups[cnt]] = {
                            operation_numbers : [],
                            color : operation_response[groups[cnt]]["color"]
                        };
                        
                        var operation_numbers = Object.keys(operation_response[groups[cnt]]["operations"]);
                        for (var cnt_2 = 0; cnt_2 < operation_numbers.length; cnt_2++) {
                            operation_groups_data["operation_groups"][groups[cnt]]["operation_numbers"].push(operation_numbers[cnt_2]);
                            
                            operations_data["operations"][operation_numbers[cnt_2]] = {
                                trains : {},
                                starting_location : operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["starting_location"],
                                terminal_location : operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["terminal_location"],
                                terminal_location : operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["car_count"]
                            }
                            
                            var train_numbers = Object.keys(operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["trains"]);
                            for (var cnt_3 = 0; cnt_3 < train_numbers.length; cnt_3++) {
                                var train_initial = train_numbers[cnt_3].substring(0, 1);
                                
                                if (train_initial !== "_") {
                                    operations_data["operations"][operation_numbers[cnt_2]]["trains"][train_numbers[cnt_3]] = [];
                                }
                                
                                for_4: for (var cnt_4 = 0; cnt_4 < operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["trains"][train_numbers[cnt_3]].length; cnt_4++) {
                                    var train_data = operation_response[groups[cnt]]["operations"][operation_numbers[cnt_2]]["trains"][train_numbers[cnt_3]][cnt_4];
                                    
                                    if (train_initial !== "_") {
                                        operations_data["operations"][operation_numbers[cnt_2]]["trains"][train_numbers[cnt_3]].push(train_data);
                                    }
                                    
                                    if (train_data["direction"] === "inbound") {
                                        var train_direction = "inbound_trains";
                                    } else if (train_data["direction"] === "outbound") {
                                        var train_direction = "outbound_trains";
                                    } else {
                                        break;
                                    }
                                    
                                    if (!(train_numbers[cnt_3] in line_operations_data["lines"][train_data["line_id"]][train_direction])) {
                                        line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]] = [];
                                        var train_index = 0;
                                    } else {
                                        for (var cnt_5 = 0; cnt_5 < line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]].length; cnt_5++) {
                                            if (line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]][cnt_5]["first_departure_time"] === train_data["first_departure_time"]) {
                                                var train_operations = line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]][cnt_5]["operation_numbers"];
                                                
                                                for_6: for (var cnt_6 = 0; cnt_6 < train_operations.length; cnt_6++){
                                                    for (var cnt_7 = 0; cnt_7 < operations_data["operations"][train_operations[cnt_2]]["trains"][train_numbers[cnt_3]].length; cnt_7++){
                                                        if (operations_data["operations"][train_operations[cnt_2]]["trains"][train_numbers[cnt_3]][cnt_7]["first_departure_time"] === train_data["first_departure_time"]) {
                                                            if (operations_data["operations"][train_operations[cnt_2]]["trains"][train_numbers[cnt_3]][cnt_7]["position_forward"] < train_data["position_forward"]) {
                                                                break for_6;
                                                            }
                                                        }
                                                    }
                                                }
                                                
                                                line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]][cnt_5]["operation_numbers"].splice(cnt_6, 0,operation_numbers[cnt_2]);
                                                
                                                continue for_4;
                                            } else if (line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]][cnt_5]["first_departure_time"] > train_data["first_departure_time"]) {
                                                break;
                                            }
                                        }
                                        
                                        var train_index = cnt_5;
                                    }
                                    
                                    line_operations_data["lines"][train_data["line_id"]][train_direction][train_numbers[cnt_3]].splice(train_index, 0, {
                                        first_departure_time : train_data["first_departure_time"],
                                        final_arrival_time : train_data["final_arrival_time"],
                                        starting_station : train_data["starting_station"],
                                        terminal_station : train_data["terminal_station"],
                                        operation_numbers : [operation_numbers[cnt_2]]
                                    });
                                }
                            }
                        }
                    }
                    
                    operations = operations_data;
                    operation_groups = operation_groups_data;
                    line_operations = line_operations_data;
                    
                    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
                    open_request.onsuccess = function () {
                        var transaction = open_request.result.transaction(["operations", "operation_groups", "line_operations"], "readwrite");
                        
                        var operations_store = transaction.objectStore("operations");
                        operations_store.put(operations_data);
                        
                        var operation_groups_store = transaction.objectStore("operation_groups");
                        operation_groups_store.put(operation_groups_data);
                        
                        var line_operations_store = transaction.objectStore("line_operations");
                        line_operations_store.put(line_operations_data);
                    };
                }
            }
        };
        
        operation_request.open("POST", "api/operation_table.php", true);
        operation_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
        operation_request.timeout = 5000;
        operation_request.send("railroad_id=" + escape_form_data(railroad_id) + "&operation_table=" + escape_form_data(operation_table) + "&last_modified_timestamp=" + last_modified_timestamp);
    } else if (last_modified_timestamp == 0) {
        alert("オフラインのためダウンロードが完了していない運用データは利用できません");
    }
}


var timetable = null;

var timetable_operation_table;
var timetable_operation_name_elm = document.getElementById("timetable_operation_name");

function update_timetable (operation_table) {
    timetable = null;
    
    var railroad_id = railroad_info["railroad_id"];
    
    timetable_operation_table = operation_table;
    timetable_operation_name_elm.innerText = railroad_info["operations"][operation_table]["operation_name"];
    
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onsuccess = function () {
        var transaction = open_request.result.transaction("timetables", "readonly");
        
        var formations_store = transaction.objectStore("timetables");
        var get_request = formations_store.get([railroad_id, operation_table]);
        
        get_request.onsuccess = function (evt) {
            if (evt.target.result !== undefined) {
                timetable = evt.target.result;
                var last_modified_timestamp = timetable["last_modified_timestamp"];
            } else {
                var last_modified_timestamp = 0;
            }
            
            if (navigator.onLine) {
                var timetable_request = new XMLHttpRequest();
                timetable_request.onreadystatechange = function () {
                    if (timetable_request.readyState === 4) {
                        if (timetable_request.responseText.substring(0,6) === "ERROR:") {
                            alert(timetable_request.responseText);
                        } else if (timetable_request.status === 200 && timetable_request.responseText !== "NO_UPDATES_AVAILABLE") {
                            timetable = {timetable : JSON.parse(timetable_request.responseText)};
                            
                            timetable["railroad_id"] = railroad_id;
                            timetable["operation_table"] = operation_table;
                            
                            var last_modified_date = new Date(timetable_request.getResponseHeader("last-modified"));
                            timetable["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            var transaction = open_request.result.transaction("timetables", "readwrite");
                            
                            var timetable_store = transaction.objectStore("timetables");
                            timetable_store.put(timetable);
                        }
                    }
                };
                
                timetable_request.open("POST", "api/timetable.php", true);
                timetable_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                timetable_request.timeout = 5000;
                timetable_request.send("railroad_id=" + escape_form_data(railroad_id) + "&operation_table=" + escape_form_data(operation_table) + "&last_modified_timestamp=" + last_modified_timestamp);
            } else if (timetable == null) {
                alert("オフラインのためダウンロードが完了していない時刻表データは利用できません");
            }
        }
    };
}


var position_line_select_elm = document.getElementById("position_line_select");
var position_area_elm = document.getElementById("position_area");

function position_mode () {
    var operation_table = get_days_operation(Date.now() / 1000 - 10800);
    
    load_operation_table(operation_table, true, true, false);
    update_timetable(operation_table);
    
    var keys = Object.keys(railroad_info["lines"]);
    
    position_line_select_elm.innerHTML = "";
    for (var cnt = 0; cnt < keys.length; cnt++) {
        position_line_select_elm.innerHTML += "<option value='" + keys[cnt] + "'>" + escape_html(railroad_info["lines"][keys[cnt]]["line_name"]) + "</option>";
    }
    
    position_change_time(null, false);
    position_change_lines(keys[0]);
}

function position_change_lines (line_id, cnt_0 = 0) {
    if ((operations === null || line_operations === null || timetable === null) && cnt_0 < 100) {
        setTimeout(position_change_lines, 50, line_id, cnt + 1);
        
        return;
    }
    
    if (position_line_select_elm.value !== line_id) {
        position_line_select_elm.value = line_id;
    }
    
    position_area_elm.innerHTML = "";
    
    var station_list = Object.keys(railroad_info["lines"][line_id]["stations"]);
    
    if (!config["dark_mode"]) {
        var line_color = railroad_info["lines"][line_id]["line_color"];
    } else {
        var line_color = convert_color_dark_mode(railroad_info["lines"][line_id]["line_color"]);
    }
    
    var buf = "";
    for (var cnt = 0; cnt <= station_list.length; cnt++) {
        buf += "<div class='position_row'><div class='position_station'>";
        
        if (cnt !== 0){
            buf += "<h4 onclick='position_click_station(\"" + station_list[cnt - 1] + "\")'>";
            if (station_list[cnt - 1].length > 5) {
                buf += escape_html(station_list[cnt - 1].substring(0, 4) + "..");
            } else{
                buf += escape_html(station_list[cnt - 1]);
            }
            buf += "</h4>";
            
            for (var cnt_2 = 0; cnt_2 < railroad_info["lines"][line_id]["stations"][station_list[cnt - 1]]["connecting_lines"].length; cnt_2++) {
                buf += "<button type='button' class='connecting_line_button' onclick='position_change_lines(\"" + railroad_info["lines"][line_id]["stations"][station_list[cnt - 1]]["connecting_lines"][cnt_2] + "\")'>" + escape_html(railroad_info["lines"][railroad_info["lines"][line_id]["stations"][station_list[cnt - 1]]["connecting_lines"][cnt_2]]["line_name"]) + "</button>";
            }
        }
           
        buf += "</div><div class='position_inbound'></div>";
        
        if (cnt !== 0 && cnt != station_list.length){
            buf += "<div class='position_line' style='background-color: " + line_color + ";'></div>";
        } else {
            buf += "<div class='position_line' style='border-color: " + line_color + ";'></div>";
        }
        
        buf += "<div class='position_outbound'></div></div>";
    }
    
    position_area_elm.innerHTML = buf;
    
    position_change_time(0);
}
    
function draw_train_position (hh_and_mm) {
    var line_id = position_line_select_elm.value;
    
    var line_inbound = get_train_positions(line_operations["lines"][line_id]["inbound_trains"], line_id, hh_and_mm, true);
    var line_outbound = get_train_positions(line_operations["lines"][line_id]["outbound_trains"], line_id, hh_and_mm, false);
    
    var position_inbound_elms = document.getElementsByClassName("position_inbound");
    var position_outbound_elms = document.getElementsByClassName("position_outbound");
    
    for (cnt = 0; cnt < line_inbound.length; cnt++) {
        if (line_inbound[cnt].length === 1) {
            position_inbound_elms[line_inbound.length - cnt].innerHTML = "<span onclick='train_detail(\"" + line_id + "\", \"" + line_inbound[cnt][0]["train_number"] + "\", \"" + line_inbound[cnt][0]["first_departure_time"] + "\", \"inbound_trains\");' style='color : " + get_train_color(line_inbound[cnt][0]["train_number"]) + ";'><img src='" + get_icon("****") + "' alt='' class='train_icon'>" + line_inbound[cnt][0]["train_number"] + "<br><b>?</b>";
        } else if (line_inbound[cnt].length >= 2) {
            buf = "<span class='multiple_trains'>";
            for (var cnt_2 = 0; cnt_2 < line_inbound[cnt].length; cnt_2++) {
                buf += "<img src='" + get_icon("****") + "' alt='' class='train_icon' onclick='train_detail(\"" + line_id + "\", \"" + line_inbound[cnt][0]["train_number"] + "\", \"" + line_inbound[cnt][0]["first_departure_time"] + "\", \"inbound_trains\");'>";
            }
            buf += "</span>";
            
            position_inbound_elms[line_inbound.length - cnt].innerHTML = buf;
        } else {
            position_inbound_elms[line_inbound.length - cnt].innerHTML = "";
        }
    }
    
    for (cnt = 0; cnt < line_outbound.length; cnt++) {
        if (line_outbound[cnt].length === 1) {
            position_outbound_elms[cnt].innerHTML = "<span onclick='train_detail(\"" + line_id + "\", \"" + line_outbound[cnt][0]["train_number"] + "\", \"" + line_outbound[cnt][0]["first_departure_time"] + "\", \"outbound_trains\");' style='color : " + get_train_color(line_outbound[cnt][0]["train_number"]) + ";'><img src='" + get_icon("****") + "' alt='' class='train_icon'>" + line_outbound[cnt][0]["train_number"] + "<br><b>?</b>";
        } else if (line_outbound[cnt].length >= 2) {
            buf = "<span class='multiple_trains'>";
            for (var cnt_2 = 0; cnt_2 < line_outbound[cnt].length; cnt_2++) {
                buf += "<img src='" + get_icon("****") + "' alt='' class='train_icon' onclick='train_detail(\"" + line_id + "\", \"" + line_outbound[cnt][0]["train_number"] + "\", \"" + line_outbound[cnt][0]["first_departure_time"] + "\", \"outbound_trains\");'>";
            }
            buf += "</span>";
            
            position_outbound_elms[cnt].innerHTML = buf;
        } else {
            position_outbound_elms[cnt].innerHTML = "";
        }
    }
}

function hh_mm_to_minutes (hh_and_mm) {
    h_and_m = hh_and_mm.split(":");
    return Number(h_and_m[0]) * 60 + Number(h_and_m[1]);
}

function calculate_train_position (minutes_now, previous_station_index, next_station_index, previous_station_time, next_station_time) {
    if (next_station_time === previous_station_time) {
        return next_station_index;
    }
    
    return Math.ceil((next_station_index - previous_station_index) * ((minutes_now - previous_station_time) / (next_station_time - previous_station_time))) + previous_station_index;
}

function get_train_positions (trains, line_id, hh_and_mm, is_inbound) {
    var station_list = Object.keys(railroad_info["lines"][line_id]["stations"]);
    
    if (is_inbound) {
        station_list.reverse();
    }
    
    var minutes_now = hh_mm_to_minutes(hh_and_mm);
    
    var line_positions = [];
    for (var cnt = 0; cnt < station_list.length; cnt++) {
        line_positions.push([]);
    }
    
    if (is_inbound) {
        var train_direction = "inbound_trains";
    } else {
        var train_direction = "outbound_trains";
    }
    
    var train_numbers = Object.keys(trains);
    for (cnt = 0; cnt < train_numbers.length; cnt++) {
        if (trains[train_numbers[cnt]][0]["first_departure_time"] > hh_and_mm) {
            continue;
        }
        
        for (var cnt_2 = 0; cnt_2 < trains[train_numbers[cnt]].length; cnt_2++) {
            if (trains[train_numbers[cnt]][cnt_2]["final_arrival_time"] <= hh_and_mm){
                continue;
            }
            
            if (train_numbers[cnt].substring(0, 1) !== "_" && train_numbers[cnt] in timetable["timetable"][line_id][train_direction]){
                for_3: for (var cnt_3 = 0; cnt_3 < timetable["timetable"][line_id][train_direction][train_numbers[cnt]].length; cnt_3++) {
                    if (timetable["timetable"][line_id][train_direction][train_numbers[cnt]][cnt_3]["first_departure_time"] === trains[train_numbers[cnt]][cnt_2]["first_departure_time"]) {
                        var last_stopped = null;
                        var last_stopped_time = null;
                        
                        for (var cnt_4 = 0; cnt_4 < station_list.length; cnt_4++) {
                            var departure_time = timetable["timetable"][line_id][train_direction][train_numbers[cnt]][cnt_3]["departure_times"][cnt_4];
                            
                            if (departure_time !== null) {
                                if (departure_time >= hh_and_mm) {
                                    if (last_stopped != null) {
                                        var train_positon = calculate_train_position(minutes_now, last_stopped, cnt_4, hh_mm_to_minutes(last_stopped_time), hh_mm_to_minutes(departure_time));
                                    } else {
                                        var train_positon = cnt_4;
                                    }
                                    
                                    break for_3;
                                }
                                
                                last_stopped = cnt_4;
                                last_stopped_time = departure_time;
                            }
                        }
                    }
                }
            } else {
                var train_positon = calculate_train_position(minutes_now, station_list.indexOf(trains[train_numbers[cnt]][cnt_2]["starting_station"]), station_list.indexOf(trains[train_numbers[cnt]][cnt_2]["terminal_station"]), hh_mm_to_minutes(trains[train_numbers[cnt]][cnt_2]["first_departure_time"]), hh_mm_to_minutes(trains[train_numbers[cnt]][cnt_2]["final_arrival_time"]));
            }
            
            if (train_positon < 0 || train_positon > station_list.length) {
                break;
            }
            
            line_positions[train_positon].push({
                train_number : train_numbers[cnt],
                first_departure_time : trains[train_numbers[cnt]][cnt_2]["first_departure_time"],
                operation_numbers : trains[train_numbers[cnt]][cnt_2]["operation_numbers"]
            });
            
            break;
        }
    }
    
    return line_positions;
}


function get_train (line_id, train_number, first_departure_time) {
    if (train_number in timetable["timetable"][line_id]["inbound_trains"]) {
        for(var cnt = 0; cnt < timetable["timetable"][line_id]["inbound_trains"][train_number].length; cnt++) {
            if (timetable["timetable"][line_id]["inbound_trains"][train_number][cnt]["first_departure_time"] >= first_departure_time) {
                var train_data = timetable["timetable"][line_id]["inbound_trains"][train_number][cnt];
                train_data["is_inbound"] = true;
                
                break;
            }
        }
    } else if (train_number in timetable["timetable"][line_id]["outbound_trains"]) {
        for(var cnt = 0; cnt < timetable["timetable"][line_id]["outbound_trains"][train_number].length; cnt++) {
            if (timetable["timetable"][line_id]["outbound_trains"][train_number][cnt]["first_departure_time"] >= first_departure_time) {
                var train_data = timetable["timetable"][line_id]["outbound_trains"][train_number][cnt];
                train_data["is_inbound"] = false;
                
                break;
            }
        }
    } else {
        return null;
    }
    
    train_data["line_id"] = line_id;
    train_data["train_number"] = train_number;
    
    return train_data;
}

var position_time;
function position_change_time (position_time_additions = null, draw_train_position_now = true) {
    if (position_time_additions === null) {
        position_time = Date.now() / 60000;
    } else {
        position_time += position_time_additions;
    }
    
    var position_date_time = new Date(position_time * 60000);
    
    var hours = position_date_time.getHours();
    if (hours < 3) {
        hours += 24
    }
    hours = ("00" + hours).slice(-2);
    
    var minutes = ("00" + position_date_time.getMinutes()).slice(-2);
    
    var hh_and_mm = hours + ":" + minutes;
    
    document.getElementById("position_hours").innerText = hours + "時";
    document.getElementById("position_minutes").innerText = minutes + "分";
    
    if (draw_train_position_now) {
        draw_train_position(hh_and_mm);
    }
}

function train_detail (line_id, train_number, first_departure_time, train_direction = null) {
    open_square_popup("train_detail_popup");
    
    var previous_trains = [];
    var next_trains = [];
    
    var train_data = [get_train(line_id, train_number, first_departure_time)];
    
    buf = "";
    if (train_data[0] !== null) {
        if (train_data[0]["previous_trains"].length >= 1) {
            previous_trains.push(...train_data[0]["previous_trains"]);
        }
        
        for (var cnt = 0; cnt < previous_trains.length; cnt++) {
            train_data.unshift(get_train(previous_trains[cnt]["line_id"], previous_trains[cnt]["train_number"], previous_trains[cnt]["first_departure_time"]));
            
            if (train_data[0]["previous_trains"].length >= 1) {
                previous_trains.push(...train_data[0]["previous_trains"][0]);
            }
        }
        
        if (train_data[train_data.length - 1]["next_trains"].length >= 1) {
            next_trains.push(...train_data[train_data.length - 1]["next_trains"]);
        }
        
        for (cnt = 0; cnt < next_trains.length; cnt++) {
            train_data.push(get_train(next_trains[cnt]["line_id"], next_trains[cnt]["train_number"], next_trains[cnt]["first_departure_time"]));
            
            if (train_data[train_data.length - 1]["next_trains"].length >= 1) {
                next_trains.push(...train_data[train_data.length - 1]["next_trains"]);
            }
        }
        
        for (cnt = 0; cnt < train_data.length; cnt++) {
            var stations = Object.keys(railroad_info["lines"][train_data[cnt]["line_id"]]["stations"]);
            
            buf += "<h4>" + escape_html(railroad_info["lines"][train_data[cnt]["line_id"]]["line_name"]) + "　";
            
            if (train_data[cnt]["is_inbound"]) {
                buf += "上り";
                
                var stations = stations.reverse();
            } else {
                buf += "下り";
            }
            
            buf += escape_html(train_data[cnt]["train_type"] + "　" + train_data[cnt]["train_number"]) + "</h4>";
            
            for (var cnt_2 = 0; cnt_2 < train_data[cnt]["departure_times"].length; cnt_2++) {
                if (train_data[cnt]["departure_times"][cnt_2] !== null) {
                    var border_color = railroad_info["lines"][train_data[cnt]["line_id"]]["line_color"];
                    
                    if (config["dark_mode"]) {
                        border_color = convert_color_dark_mode(border_color);
                    }
                    
                    buf += "<div class='train_detail_departure_times' style='border-color: " + border_color + ";'><u onclick='close_square_popup(); timetable_change_lines(\"" + train_data[cnt]["line_id"] + "\", true); timetable_select_station(\"" + stations[cnt_2] + "\");'>" + escape_html(stations[cnt_2]) + "</u><span style='float: right;'>" + train_data[cnt]["departure_times"][cnt_2] + "</span></div>";
                }
            }
        }
    }
    
    document.getElementById("train_detail_area").innerHTML = buf;
}

function position_click_station (station_name) {
    change_mode(1);
    
    timetable_change_lines(position_line_select_elm.value);
    
    timetable_select_station(station_name);
}


var timetable_line_select_elm = document.getElementById("timetable_line_select");
var timetable_area_elm = document.getElementById("timetable_area");

function update_timetable_line_select (lines) {
    timetable_line_select_elm.innerHTML = "";
    for (var cnt = 0; cnt < lines.length; cnt++) {
        timetable_line_select_elm.innerHTML += "<option value='" + lines[cnt] + "'>" + escape_html(railroad_info["lines"][lines[cnt]]["line_name"]) + "</option>";
    }
}

function timetable_mode () {
    update_timetable(get_days_operation(Date.now() / 1000 - 10800));
    
    timetable_change_lines(Object.keys(railroad_info["lines"])[0], true);
}

var timetable_selected_station = null;
var direction_radio_area_elm = document.getElementById("direction_radio_area");

function timetable_change_lines(line_id, force_station_select_mode = false) {
    var keys = Object.keys(railroad_info["lines"][line_id]["stations"]);
    
    document.getElementById("radio_inbound_label").innerText = "上り(" + keys[0] + "方面)";
    document.getElementById("radio_outbound_label").innerText = "下り(" + keys[keys.length - 1] + "方面)";
    
    if (timetable_selected_station === null || force_station_select_mode) {
        update_timetable_line_select(Object.keys(railroad_info["lines"]));
        
        if (timetable_line_select_elm.value !== line_id) {
            timetable_line_select_elm.value = line_id;
        }
        
        buf = "";
        for (cnt = 0; cnt < keys.length; cnt++) {
            buf += "<button class='wide_button' onclick='timetable_select_station(\"" + keys[cnt] + "\")'>" + escape_html(keys[cnt]) + "</button>";
        }
        
        timetable_area_elm.innerHTML = buf;
        direction_radio_area_elm.style.display = "none";
        timetable_selected_station = null;
    } else {
        timetable_select_station(timetable_selected_station);
    }
}

function timetable_select_station (station_name, cnt = 0) {
    timetable_area_elm.innerHTML = "";
    
    timetable_selected_station = station_name;
    
    if (timetable === null && cnt < 100) {
        setTimeout(timetable_select_station, 50, station_name, cnt + 1);
        return;
    }
    
    direction_radio_area_elm.style.display = "block";
    
    document.getElementById("timetable_station_name").innerText = station_name;
    
    var line_id = timetable_line_select_elm.value;
    
    update_timetable_line_select([line_id].concat(railroad_info["lines"][line_id]["stations"][station_name]["connecting_lines"]));
    
    if (document.getElementById("radio_inbound").checked) {
        train_direction = "inbound_trains";
        station_index = Object.keys(railroad_info["lines"][line_id]["stations"]).reverse().indexOf(station_name);
    } else {
        train_direction = "outbound_trains";
        station_index = Object.keys(railroad_info["lines"][line_id]["stations"]).indexOf(station_name);
    }
    
    var keys = Object.keys(timetable["timetable"][line_id][train_direction]);
    var departure_times = {};
    var first_departure_times = {};
    
    for (var cnt = 0; cnt < keys.length; cnt++) {
        for (var cnt_2 = 0; cnt_2 < timetable["timetable"][line_id][train_direction][keys[cnt]].length; cnt_2++){
            var departure_time = timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["departure_times"][station_index];
            
            if (departure_time !== null){
                hh_and_mm = departure_time.split(":");
                
                if (!(hh_and_mm[0] in departure_times)) {
                    departure_times[hh_and_mm[0]] = {};
                    first_departure_times[hh_and_mm[0]] = {};
                }
                
                departure_times[hh_and_mm[0]][hh_and_mm[1]] = keys[cnt];
                first_departure_times[hh_and_mm[0]][hh_and_mm[1]] = timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["first_departure_time"];
            }
        }
    }
    
    keys = Object.keys(departure_times);
    keys.sort();
    
    var bgcolor = railroad_info["operations"][timetable_operation_table]["main_color"];
    
    if (config["dark_mode"]) {
        bgcolor = convert_color_dark_mode(bgcolor);
    }
    
    if (timetable_operation_table === get_days_operation(Date.now() / 1000 - 10800)) {
        var is_today = true;
    } else {
        var is_today = false;
    }
    
    var buf = "";
    for (cnt = 0; cnt < keys.length; cnt++) {
        buf += "<h4 style='background-color:" + bgcolor + "'>" + Number(keys[cnt]) + "時</h4>";
        
        var keys_2 = Object.keys(departure_times[keys[cnt]]);
        keys_2.sort();
        
        for (cnt_2 = 0; cnt_2 < keys_2.length; cnt_2++) {
            buf += "<a href='javascript:void(0)' onclick='train_detail(\"" + line_id + "\", \"" + departure_times[keys[cnt]][keys_2[cnt_2]] + "\", \"" + first_departure_times[keys[cnt]][keys_2[cnt_2]] + "\");' class='timetable_train'>";
            if (is_today) {
                buf += "<img src='" + get_icon("****") + "' alt='' class='train_icon'>"; //動作検証用仮指定
            } else {
                buf += "<img src='" + UNYOHUB_GENERIC_TRAIN_ICON + "' alt='' class='train_icon'>";
            }
            
            if (!config["dark_mode"]) {
                buf += "<b style='color: " + get_train_color(departure_times[keys[cnt]][keys_2[cnt_2]]) + ";'>" + Number(keys_2[cnt_2]) + "</b><br>";
            } else {
                buf += "<b style='color: " + convert_color_dark_mode(get_train_color(departure_times[keys[cnt]][keys_2[cnt_2]])) + ";'>" + Number(keys_2[cnt_2]) + "</b><br>";
            }
            
            if (is_today) {
                buf += "?";//動作検証用仮指定
            }
            
            buf += "</a>";
        }
    }
    
    timetable_area_elm.innerHTML = buf;
    
    article_elms[1].scrollTop = 0;
}

function timetable_operation_previous () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(timetable_operation_table) - 1;
    
    if (key_index < 0) {
        key_index = keys.length - 1;
    }
    
    update_timetable(keys[key_index]);
    if (timetable_selected_station !== null) {
        timetable_select_station(timetable_selected_station);
    }
}

function timetable_operation_next () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(timetable_operation_table) + 1;
    
    if (key_index >= keys.length) {
        key_index = 0;
    }
    
    update_timetable(keys[key_index]);
    if (timetable_selected_station !== null) {
        timetable_select_station(timetable_selected_station);
    }
}


function formation_table_mode () {
    var railroad_id = railroad_info["railroad_id"];
    
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onsuccess = function () {
        var transaction = open_request.result.transaction("formations", "readonly");
        
        var formations_store = transaction.objectStore("formations");
        var get_request = formations_store.get(railroad_id);
        
        get_request.onsuccess = function (evt) {
            if (evt.target.result !== undefined) {
                var formations = evt.target.result;
                var last_modified_timestamp = formations["last_modified_timestamp"];
            } else {
                var formations = null;
                var last_modified_timestamp = 0;
            }
            
            if (navigator.onLine) {
                if (formations !== null){
                    draw_formation_table(formations["formations"]);
                }
                
                var formations_request = new XMLHttpRequest();
                formations_request.onreadystatechange = function () {
                    if (formations_request.readyState === 4) {
                        if (formations_request.responseText.substring(0,6) === "ERROR:") {
                            alert(formations_request.responseText);
                        } else if (formations_request.status === 200 && formations_request.responseText !== "NO_UPDATES_AVAILABLE") {
                            formations = {formations : JSON.parse(formations_request.responseText)};
                            
                            formations["railroad_id"] = railroad_id;
                            
                            var last_modified_date = new Date(formations_request.getResponseHeader("last-modified"));
                            formations["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            var transaction = open_request.result.transaction("formations", "readwrite");
                            
                            var formations_store = transaction.objectStore("formations");
                            formations_store.put(formations);
                        }
                        
                        draw_formation_table(formations["formations"]);
                    }
                };
                
                formations_request.open("POST", "api/formations.php", true);
                formations_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
                formations_request.timeout = 5000;
                formations_request.send("railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp);
            } else {
                draw_formation_table(formations["formations"]);
            }
        }
    };
}


function get_icon (formation_name) {
    for (var cnt = 0; cnt < train_icons["icons"].length; cnt++) {
        if (train_icons["icons"][cnt]["regexp"].test(formation_name)) {
            return train_icons["icons"][cnt]["icon"];
        }
    }
    
    return UNYOHUB_GENERIC_TRAIN_ICON;
}

function get_train_color (train_name) {
    for (var cnt = 0; cnt < railroad_info["train_color_rules"].length; cnt++) {
        if (railroad_info["train_color_rules"][cnt]["regexp"].test(train_name)) {
            return railroad_info["train_color_rules"][cnt]["color"];
        }
    }
    
    return "currentColor";
}


function draw_formation_table (formations) {
    if (formations === null){
        alert("編成表が取得できません");
        return;
    }
    
    var buf = ""
    var keys = Object.keys(formations);
    for (var cnt = 0; cnt < keys.length; cnt++) {
        buf += "<input type='checkbox' id='" + keys[cnt] + "'><label for='" + keys[cnt] + "'>" + escape_html(keys[cnt]) + "</label><div>";
        
        var keys_2 = Object.keys(formations[keys[cnt]]);
        for (var cnt_2 = 0; cnt_2 < keys_2.length; cnt_2++){
            buf += "<div class='formation_box'><img src='" + get_icon(keys_2[cnt_2]) + "' alt='' class='train_icon'>";
            
            buf += "<b>" + escape_html(keys_2[cnt_2]) + "</b><br>";
            
            for (var cnt_3 = 0; cnt_3 < formations[keys[cnt]][keys_2[cnt_2]]["cars"].length; cnt_3++) {
                buf += "<span>" + escape_html(formations[keys[cnt]][keys_2[cnt_2]]["cars"][cnt_3]) + "</span>";
            }
            
            buf += "</div>";
        }
        
        buf += "</div>";
    }
    
    document.getElementById("formation_table_area").innerHTML = buf;
}


var captcha_submit_button_elm = document.getElementById("captcha_submit_button");

function show_captcha () {
    var info_elm = document.getElementById("captcha_info");
    
    info_elm.style.display = "none";
    captcha_submit_button_elm.style.display = "none";
    open_square_popup("captcha_popup");
    
    if (!config["dark_mode"]) {
        var button_color = "#eeeeee";
    } else {
        var button_color = "#202020";
    }
    
    zizai_captcha_get_html(function (html) {
            document.getElementById("captcha_area").innerHTML = html;
            info_elm.style.display = "block";
            captcha_submit_button_elm.style.display = "block";
        }, button_color);
}


function challenge_login () {
    open_wait_screen();
    
    var user_id = document.getElementById("login_user_id").value;
    var password = document.getElementById("login_password").value;
    
    var login_request = new XMLHttpRequest();
    login_request.onreadystatechange = function () {
        if (login_request.readyState === 4) {
            close_wait_screen();
            
            if (login_request.status === 200) {
                if (login_request.responseText.substring(0,6) === "ERROR:"){
                    alert(login_request.responseText);
                } else {
                    alert("ログインしました");
                    
                    update_user_data(JSON.parse(login_request.responseText));
                    close_square_popup();
                }
            } else {
                alert("【!】サーバへのアクセスに失敗しました");
            }
        }
    };
    
    login_request.ontimeout = function () {
        close_wait_screen();
        
        alert("【!】ネットワークが不安定です");
    }
    
    login_request.open("POST", "api/login.php", true);
    login_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
    login_request.timeout = 5000;
    login_request.send("user_id=" + escape_form_data(user_id) + "&password=" + escape_form_data(password));
}

function user_logout () {
    open_wait_screen();
    
    var logout_request = new XMLHttpRequest();
    logout_request.onreadystatechange = function () {
        if (logout_request.readyState === 4) {
            close_wait_screen();
            
            if (logout_request.status === 200) {
                if (logout_request.responseText.substring(0,6) === "ERROR:"){
                    alert(logout_request.responseText);
                } else {
                    alert("ログアウトしました");
                    
                    update_user_data();
                }
            } else {
                alert("【!】サーバへのアクセスに失敗しました");
            }
        }
    };
    
    logout_request.ontimeout = function () {
        close_wait_screen();
        
        alert("【!】ネットワークが不安定です");
    }
    
    logout_request.open("POST", "api/logout.php", true);
    logout_request.timeout = 5000;
    logout_request.send();
}

function check_sign_up () {
    open_wait_screen();
    
    var check_sign_up_request = new XMLHttpRequest();
    check_sign_up_request.onreadystatechange = function () {
        if (check_sign_up_request.readyState === 4) {
            close_wait_screen();
            
            if (check_sign_up_request.status === 200) {
                if (check_sign_up_request.responseText === "OK"){
                    show_captcha();
                    
                    captcha_submit_button_elm.onclick = challenge_sign_up;
                } else {
                    alert(check_sign_up_request.responseText);
                }
            } else {
                alert("【!】サーバへのアクセスに失敗しました");
            }
        }
    };
    
    check_sign_up_request.ontimeout = function () {
        close_wait_screen();
        
        alert("【!】ネットワークが不安定です");
    }
    
    check_sign_up_request.open("POST", "api/check_sign_up.php", true);
    check_sign_up_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
    check_sign_up_request.timeout = 5000;
    check_sign_up_request.send("user_id=" + escape_form_data(document.getElementById("sign_up_user_id").value) + "&password=" + escape_form_data(document.getElementById("sign_up_password").value));
}

function challenge_sign_up () {
    open_wait_screen();
    
    var sign_up_request = new XMLHttpRequest();
    sign_up_request.onreadystatechange = function () {
        if (sign_up_request.readyState === 4) {
            close_wait_screen();
            
            if (sign_up_request.status === 200) {
                if (sign_up_request.responseText.substring(0,6) === "ERROR:"){
                    alert(sign_up_request.responseText);
                    
                    zizai_captcha_reload_image("zizai_captcha_image", "zizai_captcha_id");
                } else {
                    update_user_data(JSON.parse(sign_up_request.responseText));
                    
                    close_square_popup();
                    popup_close();
                    
                    alert("アカウントの作成に成功しました");
                }
            } else {
                alert("【!】サーバへのアクセスに失敗しました");
            }
        }
    };
    
    sign_up_request.ontimeout = function () {
        close_wait_screen();
        
        alert("【!】ネットワークが不安定です");
    }
    
    sign_up_request.open("POST", "api/sign_up.php", true);
    sign_up_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
    sign_up_request.timeout = 5000;
    sign_up_request.send("user_id=" + escape_form_data(document.getElementById("sign_up_user_id").value) + "&password=" + escape_form_data(document.getElementById("sign_up_password").value) + "&user_name=" + escape_form_data(document.getElementById("sign_up_user_name").value) + "&zizai_captcha_id=" + escape_form_data(document.getElementById("zizai_captcha_id").value) + "&zizai_captcha_characters=" + escape_form_data(document.getElementById("zizai_captcha_characters").value));
}


var dark_mode_check_elm = document.getElementById("dark_mode_check");
var refresh_interval_elm = document.getElementById("refresh_interval");
var operation_data_cache_period_elm = document.getElementById("operation_data_cache_period");

function edit_config () {
    open_popup("config_popup");
    
    dark_mode_check_elm.checked = config["dark_mode"];
    refresh_interval_elm.value = config["refresh_interval"];
    operation_data_cache_period_elm.value = config["operation_data_cache_period"];
}

function change_config () {
    config["dark_mode"] = dark_mode_check_elm.checked;
    config["refresh_interval"] = refresh_interval_elm.value;
    config["operation_data_cache_period"] = operation_data_cache_period_elm.value;
    
    switch_dark_mode();
    
    save_config();
}

function reset_config_value () {
    if (confirm("設定をリセットしますか？")) {
        var dafault_config = JSON.parse(get_default_config());
        
        dark_mode_check_elm.checked = dafault_config["dark_mode"];
        refresh_interval_elm.value = dafault_config["refresh_interval"];
        operation_data_cache_period_elm.value = dafault_config["operation_data_cache_period"];
        
        change_config();
    }
}


history.pushState(null, null, location.href + "#");

window.onpopstate = function () {
    if (square_popup_is_open) {
        close_square_popup();
    } else if (popup_history.length >= 1) {
        popup_close();
    } else if (menu_elm.className === "menu_open") {
        menu_click(true);
    } else{
        switch (mode_val) {
            case 1:
                if (timetable_selected_station !== null) {
                    timetable_change_lines(timetable_line_select_elm.value, true);
                }
                break;
        }
    }
    
    history.pushState(null, null, null);
};


if (("serviceWorker" in navigator) && (window.location.protocol.substring(0, 4) === "http")) {
    navigator.serviceWorker.register("service_worker.js");
}
</script>
</body>
</html>
