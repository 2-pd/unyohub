<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,interactive-widget=resizes-content">
<script>
    const UNYOHUB_APP_NAME = "鉄道運用Hub";
    const UNYOHUB_VERSION = "24.03-8";
    const UNYOHUB_INDEXEDDB_VERSION = 2310001;
    const UNYOHUB_LICENSE_TEXT = "このアプリケーションは無権利創作宣言に準拠して著作権放棄されています。";
    const UNYOHUB_LICENSE_URL = "https://www.2pd.jp/license/";
    const UNYOHUB_REPOSITORY_URL = "https://fossil.2pd.jp/unyohub/";
</script>
    <title></title>
    <link rel="apple-touch-icon" href="apple-touch-icon.webp">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
<style>
* {
    font-family: "Noto Sans CJK JP", "Meiryo", "Hiragino Kaku Gothic ProN", sans-serif;
    
    outline: 0 !important;
    
    cursor: default;
}

*::-webkit-scrollbar {
    display: none;
}

html, body {
    position: relative;
    
    height: 100%;
    margin: 0;
    
    color: #333333;
    
    overscroll-behavior-y: none;
}

body {
    background-color: #222222;
}

.dark_mode {
    color: #ffffff;
}

*[onclick], *[onclick] *, a, a *, button, select, label {
    cursor: pointer;
    
    -webkit-tap-highlight-color: rgba(153, 153, 153, 0.2);
}

*[onclick]:hover, *[onclick]:hover *, a:hover, a:hover *, button:hover, select:hover, label:hover {
    text-decoration: none !important;
}

*[disabled] {
    background-image: repeating-linear-gradient(-45deg, transparent, transparent 8px, rgba(153, 153, 153, 0.1) 8px, rgba(153, 153, 153, 0.1) 12px);
    
    color: #999999 !important;
    
    cursor: no-drop !important;
}

input, textarea {
    cursor: text;
}

header {
    position: relative;
    
    height: 40px;
    
    background-color: #333333;
    
    line-height: 40px;
    font-size: 18px;
    color: #ffffff;
    
    box-shadow: 0 0 3px 3px rgba(0,0,0,0.2);
    
    z-index: 6;
}

.dark_mode header {
    background-color: #111111;
}

#railroad_icon {
    display: none;
    
    position: absolute;
    left: 0;
    
    width: 64px;
    height: 40px;
    
    background-size: 30px, contain;
    background-repeat: no-repeat, no-repeat;
    background-position: 8px 5px, 0 0;
    
    overflow: hidden;
}

#railroad_icon:before, #railroad_icon:after {
    content: "";
    
    display: block;
    
    position: absolute;
    top: -0.5px;
    
    border-top: 20.5px solid #333333;
    border-bottom: 20.5px solid #333333;
    border-left: 15px solid transparent;
}

#railroad_icon:before {
    left: 45px;
    
    width: 4px;
    
    border-top-color: #f7f7f7;
    border-bottom-color: #f7f7f7;
}

#railroad_icon:after {
    left: 49px;
    
    width: 1px;
}

.dark_mode #railroad_icon:after {
    border-top-color: #111111;
    border-bottom-color: #111111;
}

#app_name {
    display: inline-block;
    
    width: calc(100% - 100px);
    
    margin-left: 50px;
    
    text-align: center;
}

.railroad_select_mode #app_name {
    display: none;
}

#railroad_name {
    display: none;
    
    position: absolute;
    left: 70px;
    
    width: calc(100vw - 120px);
    height: 40px;
    
    background-image: url(data:image/webp;base64,UklGRnACAABXRUJQVlA4TGMCAAAvd8AdELVAsG03bTT73xRj9DQ860HZcSwNMzMzR8C5bdvU89m2nfwAu7LN0pV6Jx1Lq7RtJ5WdyrbN7ciNJEVyam8DOUz7goO9jEIh36Al/FAS3AIRs3hqvOZJNW0yzjK/HE54TLM/OLJMBf6Or2l7eH/6eD6NZ1Kg0ZQzzzNI87LcRLzyFdLcMidlRMEPpJehKUwdgXzmOcuGuPkK+Vwxqcl/MTyQzRVojXiurNx8hdZwqZm/ATT27IGCnNw/4P2dr1AQdrFxhxuvwCm8NC7e+zFXwC1cfPnSPOAYcnyx5okVXz+eePEFXLN1if4pdbbImEYHDT40fJ5mexxJJJ+gqFwMTy1NGq1Bba4IdaCoXAxlm1zycw7LNubOZ3Gvg785Wh/3Onj1lF8SGTK+JTK97hP1DYrKrd77ul1qas4lrbl6rd5BtkAcHHCeQJlfB9k1kRRJM6FKcNZDcA99CQ2sRYMS0uvvMKF5HZXU9HeUrrha6E8Q4K9RpN9HOu7jhbthmAG7KRoy0oBVIsEBhvTaQynIDRlhQJcQEEGjqCwz5MYtEmc3nJSVo8L20phwRpgcGtwjKTci4tbgZJqdF2h+pHVpRoZtRm4wT7wa7EDtopfCpsH7hD4WbQKG+nbrJp62Gw2hNC78G9pT50x+oe6BLJB0Aazga9y6q+dv+6H7Nw5JBIYWde9Hqe2n8WEMcTk3uIJfoeCl/dvIVxRSDAxJqNFQk21DCqsJtLv8ymKyA8bwBwx1r3rA0R3ChIf90VirJS22pfoE8M9G5dNfo+XNYPvOH+nVb5gosD0ltYew10gOAAA=);
    background-repeat: no-repeat;
    background-size: 40px;
    background-position: calc(100vw - 165px) 0;
    background-color: transparent;
    
    line-height: 40px;
    font-size: 22px;
    color: #ffffff;
    text-indent: 10px;
    text-decoration: none;
}

#railroad_name small {
    font-size: 16px;
}

.railroad_select_mode #railroad_name, .railroad_select_mode #railroad_icon {
    display: block;
}

#menu_button {
    display: block;
    
    position: absolute;
    top: 0;
    right: 0;
    
    width: 50px;
    height: 40px;
    
    background-image: url(data:image/webp;base64,UklGRjYAAABXRUJQVlA4TCoAAAAvY8ATEA8wzMM8zPMf8DAUwMyaqa7ZFcC+Ef2fgHupQQleaVCCVxqU4Kc=);
    background-size: 50px 40px;
    background-color: transparent;
}

.menu_button_active {
    background-color: #555555 !important;
}

.dark_mode .menu_button_active {
    background-color: #444444 !important;
}

.menu_button_with_notification:before {
    content: "";
    
    display: block;
    
    position: absolute;
    top: 4px;
    right: 10px;
    
    padding: 6px;
    
    border-radius: 6px;
    
    background-color: #ee3333;
}

#menu {
    position: absolute;
    top: 40px;
    right: 0;
    
    width: 250px;
    max-height: 0;
    
    opacity: 0.5;
    
    background-color: #ffffff;
    
    line-height: 40px;
    
    overflow-y: scroll;
    
    z-index: 8;
    
    transition-duration: 0.25s;
    transition-property: all;
}

.dark_mode #menu {
    border-color: #444444;
    
    background-color: #666666;
}

.menu_open {
    max-height: calc(100% - 60px) !important;
    
    opacity: 1.0 !important;
    
    padding: 9px 0;

    border: 1px solid #555555;
    
    box-shadow: 0 4px 4px 0 rgba(0,0,0,0.3);
}

#menu div {
    display: none;
}

#menu b {
    display: block;
    
    width: 90%;
    height: 30px;
    
    margin: 0 5% 10px 5%;
    
    background-color: #eeeeee;
    
    line-height: 30px;
    text-align: center;
}

.dark_mode #menu b {
    background-color: #777777;
}

#menu a {
    display: block;
    
    width: 100%;
    height: 40px;
    
    line-height: 40px;
    font-size: 15px;
    color: inherit;
    text-align: center;
    text-decoration: none;
}

.dark_mode #menu a {
    color: #eeeeee;
}

#menu hr {
    width: 90%;
    height: 2px;
    
    margin: 9px auto;
    
    border: none;
    
    background-color: #cccccc;
}

.dark_mode #menu hr {
    background-color: #999999;
}

.beginner:before {
    content: "";
    
    display: inline-block;
    
    width: 12px;
    height: 1lh;
    
    margin-right: 3px;
    
    background-image: url(data:image/webp;base64,UklGRtYAAABXRUJQVlA4TMkAAAAvF8AIEN9AkG3T+avd6RoE2TY90/3ZZiBtm2z+DdzsxzCSJCXvj5N/BMREEO7wMgGxH0gAEwAAGQAy8MuXko0ICBRYWGy1pqYQENBTcMORJLltgwUk55zD/z9qYhc4+hjRf4NJ26QJ7IBd8Zqni5X7Lte3BeCHiqsDa2AHf2vugTQbFhFJGZMVCUhKwaYkwl8NbA93VPCJJvZnscK+x/rp2Hfwr90D25L0ZMoiqU4rK6Q+pnYccnqPwH4QD6t2DL4bpjo7rTdnYwwA);
    background-repeat: no-repeat;
    background-size: 12px 18px;
    background-position: center;
    
    vertical-align: top;
}

.off_line_message {
    background-image: url(data:image/webp;base64,UklGRoQCAABXRUJQVlA4THgCAAAvL8ALELfDOLJtGU3+8VkpCcws/8cfg2AQSZKTJuMH/05wgIM4bCNJctJP/vFhUSSgwXy1jhtJUqTt7cnWio6ZbD3b7nlaX45xSG3aBgxenXIHilQEMp8b4a4Z9n2DVMDr/yeYpwKu8KnMUAMMYRigwRoA1BiCVCIMDgIwhEEBFCUUghLSeQ0oBAqFg3QnYAA1DgA16lQUAgeBg2EKAMAQAAxRYz2Oyz+VHgEJEQkeAQEJERkhlRNu3zde/z/9/08fn/ZZryNPxxqSFEniO3RNkpGv+T0v+94/0++jdk9DKlzSkGqoHCXQrm0z3GxYt0FtpLa5qW3btvv/TzM77ztbfpymb42J6L8Dt5EUqZKSFg7q4BXas4uw7uGkrMKahsZgUXbyYm+IYKLj35t0gBbfbAw6ttgpiSR3bQeT0NUyXYDqNycYz4suiFq3crOVIU1gepOTzn/dFGr7DRlqlmYxZyGij1loTPnElzvc6afPt7+vjwpoUwpp1AN8nYkdGoArUUkuXo1ohJPSQYeGwKF+OPlilqywaZzZ0ZC0ftWzmSciYg/3j/I22BGW9vfUnJrDk6Avbdll+LH/8w3HRvdv1DmzoG2pIDBp/0YdyVuKFyKZOTvp/NKFuuWSyJFQJw01KOsTtwPL9sahMv6V6MbylFV9WgBElTrmFFCO7QK5UpxhQNWBNDDpx4usjMNfUvu8ElTwEMFZ12sF599khtdE5I+tZI9xwmWIygwcY0WVyN5LZIanvrqv39EIEuRCKegP0pT4IlpYOSBYhN+CBRUvQpN6zXufS3NKxNWcCgsM+0XsEPQXs0PMX8wOMX/hHaJ/2iBixxMFAQ==);
    background-repeat: no-repeat;
    background-size: 24px;
    background-color: #444444 !important;
    
    color: #ffffff;
}

.dark_mode .off_line_message {
    background-color: #808080 !important;
}

#menu .off_line_message {
    background-position: 50% 4px;
    
    padding-top: 28px;
}

#splash_screen, #railroad_select_popup {
    position: fixed;
    top: 0;
    
    width: 100%;
    height: 100%;
    
    background-color: #ffffff;
    
    text-align: center;
    
    overflow: scroll;
    
    z-index: 10;
}

#splash_screen.splash_screen_loading {
    background-image: none;
    background-color: #222222;
}

#splash_screen.splash_screen_loading *, #splash_screen.splash_screen_loading:after {
    display: none;
}

.dark_mode #splash_screen, .dark_mode #railroad_select_popup {
    background-color: #666666;
}

.splash_screen_loaded {
    z-index: 4 !important;
}

#splash_screen:after, #railroad_select_popup:after {
    content: "";
    
    display: block;
    
    position: fixed;
    top: 0;
    left: 0;
    
    width: 100%;
    height: 100%;
    
    background-image: url("splash_screen_image.webp");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: right bottom;
    
    transition-duration: 1s;
    transition-property: opacity;
}

.splash_screen_loaded:after, #railroad_select_popup:after {
    opacity: 0.25;
}

#splash_screen_inner, #railroad_select_area {
    position: relative;
    
    width: 100%;
    min-height: calc(100% - 150px);
    
    z-index: 5;
}

#splash_screen_inner {
    padding: 60px 0 90px 0;
}

#splash_screen_login_status {
    height: 60px;
}

#splash_screen_login_status b {
    display: inline-block;
    
    line-height: 30px;
    font-size: 20px;
}

#splash_screen_login_status .off_line_message {
    padding: 0 10px 0 40px;
    
    background-position: 6px 50%;
    
    border-radius: 4px;
    
    font-size: 18px;
}

#announcements_overview, #announcements_heading {
    background-image: url(data:image/webp;base64,UklGRpQBAABXRUJQVlA4TIcBAAAvR8AREHVAkiTJkfL1/cmioQItrzxN01hV5Yqj3oyAKgCgwWi2je4tLdlJcR3R1Yhb8pL+AN1ortvZtn2Pjdu2gejZh5ta9wurpTcf0OuMiHcENYCGOzpda0DBviV8QAnxZQkImdgK3tCR4AOgYH3tZNdWEBZWtgKUDG0BE1g46NoCzkiEOLT7AQ9LNHi1+91IrzOc2+52gg9r5NgB2M0eiaEmxogvgN0HLHzk6K+dkabJLv8A23XOqdduWmx4/e+f/DeVwEaUB9vud8ljakuAz4k1bJhbBDErsH1O5UFFeKyClgx2ZPAyd7Alg7aMa7cMaDyqWEVUxhSzs5XOq7lyfq5WUwzhg4jV6pyKizZrXlKk7jup+3fW9gDXHgVm6z5hNIS+dS9FZeja27rfwjd0XW7dk9eGIYat+xbmENe1eztZLN3/yWLpeyRbLMiVgPEfyWLpey1ZLH0/ZotFgUYH4FW2WPa+juqXimLNJyK7ShcLky1WyhYrpYuFSRcLpYuFFndxvmcFAA==);
    background-repeat: no-repeat;
}

#announcements_overview {
    display: block;
    
    width: 250px;
    height: 30px;
    
    margin: 20px auto;
    
    padding: 4px 4px 4px 46px;
    
    border-radius: 20px;
    
    background-size: 24px;
    background-position: 12px, 8px;
    background-color: #eeeeee;
    
    line-height: 32px;
    font-size: 16px;
    color: inherit;
    text-decoration: none;
}

.dark_mode #announcements_overview {
    background-color: #777777;
}

#announcements_overview:empty {
    display: none;
}

#announcements_overview b {
    text-decoration: underline;
}

#splash_screen_bottom {
    position: absolute;
    bottom: 10px;
    
    width: 100%;
    
    line-height: 40px;
    color: #999999;
}

#splash_screen_bottom a {
    color: #666666;
}

.dark_mode #splash_screen_bottom a {
    color: #cccccc;
}

#blank_article {
    position: fixed;
    top: 40px;
    
    width: 100%;
    height: calc(100% - 40px);
    
    background-color: #ffffff;
    
    z-index: 3;
}

#tab_area {
    display: block;
    
    width: 100%;
    height: 50px;
    
    background-color: #dddddd;
    
    line-height: 50px;
    white-space: nowrap;
    text-align: center;
    
    overflow: scroll;
    overflow-y: hidden;
    
    box-shadow: 0 -5px 3px -2px rgba(0,0,0,0.1) inset;
}

.dark_mode #tab_area {
    background-color: #222222;
}

#tab_area button {
    position: relative;
    
    box-sizing: content-box;
    
    width: 80px;
    height: 18px;
    
    padding: 0;
    padding-top: 32px;
    
    background-repeat: no-repeat;
    background-size: 27px;
    background-position: 26.5px 5px;
    background-color: transparent;
    
    border: none;
    border-radius: 0;
    
    overflow: hidden;
    line-height: 18px;
    font-size: 14px;
    color: #444444;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.dark_mode #tab_area button {
    color: #eeeeee;
}

#tab_area .active_tab {
    padding-top: 30px;
    
    background-position-y: 3px;
    background-color: #ffffff !important;
    
    border-top: 2px solid transparent;
    
    box-shadow: 0 0 8px 0 rgba(0,0,0,0.5);
    
    z-index: 7;
}

.dark_mode #tab_area .active_tab {
    background-color: #444444 !important;
}

article {
    display: none;
    
    width: calc(100vw - 10px);
    height: calc(100% - 240px);
    
    padding: 55px 5px 50px 5px;
    
    background-color: #ffffff;
    
    overflow-x: hidden;
    overflow-y: scroll;
}

.dark_mode article, .dark_mode #blank_article {
    background-color: #444444;
}

.wide_button {
    display: block;
    
    position: relative;
    
    width: calc(100% - 40px) !important;
    
    max-width: 460px;
    
    margin: 10px auto;
    padding: 10px 10px;
    
    background-image: linear-gradient(315deg, #666666 14px, transparent 14px) !important;
    
    line-height: 26px;
    font-size: 18px;
    overflow: hidden;
}

.dark_mode .wide_button {
    background-image: linear-gradient(315deg, #cccccc 14px, transparent 14px) !important;
}

.wide_button img {
    position: absolute;
    top: -1px;
    left: -1px;
    
    width: 30px;
    
    padding: 9px;
    padding-right: 8px;
    
    background-color: #333333;
}

.line_select_wrapper, .search_wrapper {
    position: fixed;
    top: 92px;
    left: calc(50% - 165px);
    
    width: 300px;
    
    padding: 8px 15px;
    
    border-radius: 8px;
    
    background-color: rgba(255,255,255,0.9);
    
    z-index: 19;
}

.dark_mode .line_select_wrapper, .dark_mode .search_wrapper {
    background-color: rgba(68,68,68,0.9);
}

.wide_select, .line_select_wrapper select {
    display: block;
    
    width: 300px;
    height: 36px;
    
    margin: 0 auto;
    
    line-height: 36px;
    font-size: 20px;
    text-align: center;
}

.line_select_wrapper select {
    background-image: url(data:image/webp;base64,UklGRlIBAABXRUJQVlA4TEUBAAAvL8ALEGfBKJIkRdn+Ta2ffeEx2GAUSZKibP+m1s++8BgYRZKkKNu/qfWzLzwGxpFkpeLheiMgAiU8zg7fJYD+/4dSCqm1/iBrLfw8j4cDgwZL8n3fZ5H+/8/Yvu+zCEkAGAQbbtxJJBg8MBwwABoCGAyQ5MONHQszybnve3zfV7XWOlxJkqQqAw9/7q79HO5/QIfGfiP6z8ht20gSettn7E/InzPdsEHjmWSAOliTAfrDiQxQ7NgADz645ecdXrZ1jzcs4wYcu3C+GiN4lupJxAbVQbcaNj5I3AlAcYE6paPReCY7J+wc0nPO7tEn9zSx5GWNSagenRZMVloFEFnsS4DJNgOYGBNupX1eltWZOezAM7/6vEwjfQDV1mDji5zUkkiqCHVK6yu3G7mEjbo8Mp7IyRtyiDfkHG/o0Rt6StZK5L8pAA==);
    background-repeat: no-repeat;
    background-size: 24px;
    background-position: calc(100% - 4px) 50%;
    
    appearance: none;
    -webkit-appearance: none;
}

.position_row, .position_row_no_station {
    width: 100%;
    height: 82px;
    
    max-width: 500px;
    
    margin: 0 auto;
}

.position_inbound, .position_outbound {
    display: inline-block;
    
    height: 80px;
    
    border-top: 2px dotted #eeeeee;
    
    vertical-align: top;
}

.dark_mode .position_inbound, .dark_mode .position_outbound {
    border-color: #555555;
}

.position_row:first-child .position_inbound, .position_row:first-child .position_outbound, .position_row_no_station .position_inbound, .position_row_no_station .position_outbound {
    border-top-color: transparent;
}

.position_station {
    display: inline-block;
    
    position: relative;
    
    width: 70px;
    height: 82px;
}

.position_station h4 {
    position: absolute;
    top: -13px;
    left: -5px;
    
    width: 85px;
    height: 28px;
    
    margin: 0;
    padding-left: 5px;
    
    border-radius: 0 13px 13px 0;
    
    background-color: #eeeeee;
    
    line-height: 28px;
    font-size: 15px;
    text-decoration: underline;
    
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
    
    z-index: 2;
}

.dark_mode .position_station h4 {
    background-color: #555555;
}

h4.position_signal_station {
    width: 84px;
    height: 26px;
    
    padding-left: 4px;
    
    border: 1px solid #eeeeee;
    
    background-color: #ffffff;
    
    line-height: 26px;
    color: #999999;
    text-decoration: none;
    
    filter: none;
}

.dark_mode h4.position_signal_station {
    border-color: #555555;
    
    background-color: #444444;
}

.train_icon {
    float: left;
    
    max-width: 40px;
    max-height: 40px;
    
    margin-left: 5px;
    margin-right: 5px;
    
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
}

.position_inbound b, .position_outbound b {
    display: inline-block;
    
    max-width: calc(100% - 45px);
    
    line-height: 20px;
}

.connecting_line_button {
    display: block;
    
    position: absolute;
    top: 20px;
    left: -5px;
    
    width: 100%;
    height: 36px;
    
    padding-left: 5px;
    
    border-color: #999999;
    
    line-height: 18px;
    font-size: 14px;
    color: #666666;
    
    overflow-y: hidden;
}

.dark_mode .connecting_line_button {
    color: #eeeeee;
}

.connecting_line_button:before, .connecting_line_button:after {
    content: "";
    
    display: block;
    
    position: absolute;
    top: 0;
    left: 0;
    
    width: 4px;
    height: 36px;
    
    border-left: 4px solid;
}

.connecting_line_button:before {
    border-color: inherit;
}

.connecting_line_button:after {
    border-image: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.5)) 1;
}

.position_inbound, .position_outbound {
    position: relative;
    
    width: calc(50% - 45px);
}

.position_line {
    position: relative;
    
    display: inline-block;
    
    width: 20px;
    height: 82px;
}

.position_row:not(:first-child):not(:last-child) .position_line, .position_row_no_station .position_line {
    background-color: currentColor;
}

.position_row:last-child .position_line {
    height: 80px;
    
    border-top: 2px solid currentColor;
}

.position_row:not(:first-child) .position_line:after {
    content: "";
    
    position: absolute;
    top: -4px;
    left: 5px;
    
    width: 8px;
    height: 8px;
    
    background-color: #ffffff;
    
    border: 1px solid #eeeeee;
    border-radius: 5px;
}

.dark_mode .position_row:not(:first-child) .position_line:after {
    background-color: #444444;
    
    border-color: #555555;
}

.position_row:last-child .position_line:after {
    top: -6px;
}

.position_row .position_line.position_line_signal_station:after {
    display: none;
}

.position_row:not(:first-child) .position_line.position_line_major_station:after {
    top: -6px;
    left: 3px;
    
    width: 10px;
    height: 10px;
    
    border-width: 2px;
    border-radius: 8px;
}

.position_row:last-child .position_line.position_line_major_station:after {
    top: -8px;
}

.position_inbound span:not(.train_type), .position_outbound span:not(.train_type) {
    display: inline-block;
    
    position: absolute;
    
    width: 100%;
    height: 50px;
    
    line-height: 25px;
    
    z-index: 1;
}

.position_inbound .train_icon, .position_outbound .train_icon {
    margin-top: 5px;
    margin-bottom: 20px;
}

.position_inbound b, .position_outbound b {
    color: #333333;
}

.dark_mode .position_inbound b, .dark_mode .position_outbound b {
    color: #ffffff;
}

.position_inbound span:not(.train_type):before, .position_outbound span:not(.train_type):after {
    position: absolute;
}

.position_inbound span {
    top: 0;
    right: 0;
    
    text-align: right;
}

.position_inbound span:not(.train_type):before {
    content: "";
    
    top: -6px;
    right: 12px;
    
    border-bottom: 6px solid currentColor;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
}

.position_inbound .train_icon {
    float: right;
}

.position_outbound span {
    bottom: 0;
    left: 0;
}

.position_outbound span:not(.train_type):after {
    content: "";
    
    bottom: -6px;
    left: 12px;
    
    border-top: 6px solid currentColor;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
}

.train_type {
    display: inline-block;
    
    height: 1em;
    
    padding: 1px 7px 1px 5px;
    
    border: 1px solid;
    border-radius: 3px;
    
    background-image: linear-gradient(315deg, #ffffff 5px, transparent 5px);
    
    line-height: 1em;
    color: #ffffff;
}

.dark_mode .train_type {
    background-image: linear-gradient(315deg, #444444 5px, transparent 5px);
    
    color: #333333;
}

.multiple_trains .train_icon {
    float: none;
}

.position_inbound .multiple_trains .train_icon {
    margin-left: -4px;
}

.position_outbound .multiple_trains .train_icon {
    margin-right: -4px;
}

#position_area:empty + div {
    display: none;
}

#direction_radio_area {
    display: none;
    
    padding-top: 10px;
    
    text-align: center;
}

#direction_radio_area h2 {
    margin: 0 auto 5px auto;
}

#timetable_area {
    margin-top: 10px;
}

#timetable_area a {
    display: block;
    
    margin: 0 12px;
    padding: 8px;
}

#timetable_area a b {
    font-size: 18px;
    color: #333333;
    text-decoration: underline;
    text-decoration-thickness: 1px;
}

.dark_mode #timetable_area a b {
    color: #ffffff;
}

input[type="checkbox"] + label.drop_down {
    max-width: 480px;
    min-height: 25px;
    
    margin: 5px auto;
    padding: 10px;
    
    background-color: #444444;
    
    line-height: 25px;
    font-weight: bold;
    color: #ffffff;
    
    z-index: 1;
}

.dark_mode input[type="checkbox"] + label.drop_down {
    background-color: #808080;
}

input[type="checkbox"] + label.drop_down:after {
    top: calc(50% - 22.5px);
    left: calc(100% - 45px) !important;
    
    width: 45px;
    height: 45px;
    
    background-image: url(data:image/webp;base64,UklGRnoAAABXRUJQVlA4TG4AAAAvJ8AFECcw//M//2LBFPcNs0AfAINBJElOtsAAEqKEN8DX+hcFG5AQ0X+Fbds2GWX3IdhX5JSzOVrMgZ3MyNkkC9/Zw5ci740vRS4QioDQhFI0ik40EE0EI8FM0f4xC24+VjNmwWyIFbHzQ2APAg==);
    background-repeat: no-repeat;
    background-size: 20px 12px;
    background-position: center;
    background-color: transparent !important;
    
    box-shadow: none;
}

input[type="checkbox"]:checked + label.drop_down:after {
    transform: scaleY(-1);
}

input[type="checkbox"] + label.drop_down + div {
    display: none;
    
    max-width: 500px;
    
    margin: 0 auto 10px auto;
    
    overflow: hidden;
}

input[type="checkbox"]:checked + label.drop_down + div {
    display: block;
    
    animation: drop_down_open 0.1s ease-out;
}

@keyframes drop_down_open {
    0% {
        transform: translateY(-45px);
        
        opacity: 0;
    }
    
    100% {
        transform: translateY(0);
        
        opacity: 1;
    }
}

article input[type="checkbox"] + label {
    margin-top: 10px;
    
    text-align: left;
}

.no_data {
    height: 50px;
    
    margin-bottom: 60px;
    padding-top: 190px;
    
    background-image: url(data:image/webp;base64,UklGRgIKAABXRUJQVlA4TPUJAAAvs8AsEF/FKrLtJhsd+PeBH757eUnoOGDURpIjD47jz+P43DuHbkZtJDny4Dj+PI7PvXPodhhJslI9qS3cIVMiJoHv8mpPFLZtg4wZ3kBAzG1o1zV32+bIy/PUkWhu60gU/9wOqIHc/nMLADWAFjm3DoKYUAMAgIwKNabcOgx6lVDw7EOBwqAgCOIL5jYBAID24gFIiEg/vTTjcBgUBoOfHhSERRJAfKEwlPMVELz04Qvim2YMvGAkCwCgR4sWPabcXniggLjlluiB3Ca8I3nv/9/ktuz/n/p9L7BmWQ4ASDOP7ftOAC3sDwC0Oo00CbUN11SuTb1HvVhJQ4VtcKm7d2kgYfJqt3UcHit4X+quAS7Y5s9cmXkz38vZLxH9nwD4v/JU8F3VhqJjW+7FYq2IrbHY/JZjRRuq3gVTOYpzqKbpkoXs1qXGdYec3GLxgU0Xkyiw7ULP4FSOEKzZaqFg6/G6oOdNv76ICi/UTHtY3prjSdRasDrtTd9qY6g6tmHOe5Y1WKg+sXnUW541JtGMx796x1hnEo2ZbJz2Bqf/Bho10fPJfP5919G4d1b7DPd0Oxr59JjJMjVZNHR8b8ZYS06hwbc8NdT+FhTYdnlXX3l0OLjISQGknEXB4Wh535HLSQHYEjJRqh5dv7e5ajYNzOkPaxuuuoVYnGecJefQ3daOfePgev6rXa3u4JY5wwxfRzfjhdGFIDQ92Bh3A5tHjPIyiy4W7HNAtPPqnAsYHzTIQBLZrcIPoHBpocWGyYgpfLXInt04B0q/vbnBhVjmM4L/DXJbJR9B8dwmiws3+g3gr0funWOgPHiMC+v96nxvkHl+BRjw3VUm3OjTVou8Vm0ajJjeY/FgmbIB5L0yAsZcPs+DEVUvkzz1ATBooIsnOahoOIuc2bdg2FCcA+MjapZcR86rX8G4y+5yYPOcktRZ5Dz/EQy86CwHPkzpqEfOjjQYOb2LA4tV7EfOrgwYOlPEgSEF4y0cPX4wtq+P4+ZTcZmtyFjiA4P7ShjwdEZaDTJ2+cH9AWQfcA/8RQy4V9hYlqEjAwLL+coFQOYIQ3xalP8U0gvSIHEV368SYOEWGm7zSdqH9KuLQGSILyQCJu7S8K0g5w4tvgxkRvmiMuBLnHZ7Sk4p0v8OQlfwvRACv9KwVsxYglYPUiv4KqRAEe3GtJROJF8JiJnley5mcp6EhUJGkyRrBMQ+4wuKgWGL1DYj4yiSa0FuPt+4HOgj4WERy5A8nxb0hG+RoMBdUvKLhAbaChA8yRcQBEMkLBLwzSIdBckL+DKSYAcpMedeLVKtMVFgcSVA9IxFwTLXUjFSCchu4bolC7pJt1NuhZB645uw37h+EPbtBgVfunWKtBGEX+G6LAw2kU66NI1Ua07aBa4H0sYtSjLfHZvUANK3cJ2RBk0UHHDnImlW3Emuk+JGSOddCSK1AMTv5GoXB48o+NmN16R98pq4muRVkfa6sZUSd+R1cXXJm4pTtrmw2KIUgvwSrjfyoJNiOXwHkBpVUMtVq+AABaN8xZTWtIL1XOsVpOOUOr6LlA5QOMA1oACOUs6zOW2UfRrKuco1rKW0OVyHkDquYRXXrxqmKfiCq4YyDxpDXCENcI0ywNVE2awiyhVVUUgp5LpEqVKxguuFil8oF5lSFmVWRQVXhYqlFCvFE0RiW1rFLNdzFYEkAT/zvKPcB5XPuIIq4B7lIE8VZZeOfK5xHe2UVzwbKH06nnAt0tFLKePZTCnXMckV0FFN6eI5RonqWMCV0bGG0s5TQBnWARZPAnRWULbwzFOCSlp4bil5RrnC00xZpOQ3nh+UTFD+yXOLElByheeyEocS44lTUkou8DxQspDSymNR/Eq28JxRkqFYBjvJc9IMCZ44JaVkJ0+7koWUGM8tSkBJE0+TEodyjaeZ8kRJF0+Xku8ol3iuUIJKSnjeKHlGecRzljKspJanVsl7yimeY5SokvU865WsoeziKaKUKxngGVBSTSnl2UDpU1LOU66kl1LNU0U5omQVz69K2imDPO8oV5SEeEJK7lE+8AQpyYCOKE9URyBJmeBJWQSc1bGC54WOESS2+HngEmWtjgqeCh3llG3A3Ehp0DHL81xHE2UPVw3lno5nPEEdP1JCXCsomK8in2dcxWekBrmcNsorFU94Fqn4hdKa4YILlF0qJnkCKtop24G9h9Ka1rCAJ6MhEKf8xHeAgoMazFmJ1L/xTVmURi/bTWn288FjStzxrqkspQhcrKHgK++qQmrIjSDpnHc9pGSn3IALFFzqVcNI3Q2u1pAavWo3aaU700mK9c2b8i1KLM8d2EbBOm/qRmoPuFxJujHnReMJ0nK3UjEKbhKHrOLqkXoOXN9AsoLeM2ORKt37mKDgCe85jtRr/3IPNpPwndesRHIEBI4mSffS3hK4S7rpSIBdJNzjLaVI7geRX5Ika7mXVLSRbjsyoImEVwLeMXkPyT+D0OkECbu8owHJV1NSoJaGb73iFdJDINa5Q8su84bZLO2cXw6spuHVJ14wcRfJ1igI9m+j4bm0+RZuQXo/iP4cp+GujOkyR5F+PyUL9jJgkd9s/iKkJ78H4ZnTDFjiE6HW14OMp0D8eAsDbvKby1eKrP3iIMSBRRlTZTYjsy0OijnwH2kzpY8iuy0ubwsHnv9ooicF6GK/NJhr5sC7z80zexddtaXB81YOzP5imtU30OV+aTCY5EAsmjTJZAO6b0uDCA/OD5uj4ipKtKVBGQ9afQEzBErbUKYtzbeRB/HukAlWXkOxtjDw1zMhHn+mbeYESraFgX8jF1rdSzSN11so2xYGvjIuxMSmcS353QkUbwsDiCS5EK2mEQ3LOy3UaEuDwTgbIj6qcmRNVT1ErbY0GGl2ATHeeSAtJfBydxYV29JgbosbiBhvr5p27/MvO+Oo3JYGecXu/P5a4y9LA1yBkV8af0QT2tIAQi1u/eF8e2/1YMWzCScNkHYmnlUMVvfunEdz2uJg/LQEtcnTUtAWB5m9cVPd/x5sKWiLA8g/YSSrLw0AthTslwe+t83mOTcKf2hLQVseQNrOmuXu6gz8qS0F+xUATBe2meN2dQr+qi0FbQ0AMx1JM9zsd4BoS0FbBcCXooS+axEH6LYUtHUAfCy7retc5QJgtaWgrQQgVXkyqSW2aTmw21LQ1gIA+QPnFWQPr8wDN23zAcDnvacsSc2bQw64bcuwQb2zpu5Bm4TW7T+N+kGiLcEGM06+GCi8aPG1bNsTCmZArO2eDSbNG3vxqqyr/czl67GbaMXuXi44faS0enDphB+E227ZkJtG3AlDrhpxIwy5a4QvDLlshCsMuW2EJwy5boQjDLlvhBaGXDhCCUNuHPlrYciVI38lDLlz5M/CkEtH/igMuXXkd2HItSOIYci9bRs4AQA=);
    background-repeat: no-repeat;
    background-size: 90px;
    background-position: center;
    
    text-align: center;
}

.timetable_train {
    border-bottom: 1px solid #eeeeee;
    
    line-height: 18px;
    color: inherit;
    text-decoration: none;
    word-break: break-all;
}

.timetable_train:last-child {
    border: none;
}

.dark_mode .timetable_train {
    color: #ffffff;
    
    border-color: #555555;
}

.timetable_train:after {
    content: "";
    
    display: inline-block;
    
    clear: both;
}

.timetable_train .train_icon {
    margin-right: 20px;
}

.timetable_train b {
    margin-left: -10px;
    margin-right: 10px;
    
    line-height: 20px;
    font-size: 20px !important;
    color: inherit !important;
}

.timetable_train small, #operation_data_area small {
    font-size: 14px;
    
    color: #666666;
    font-weight: normal;
}

.timetable_train b small {
    color: inherit !important;
}

.dark_mode .timetable_train small, .dark_mode #operation_data_area small {
    color: #cccccc;
}

#operation_data_area h2 {
    margin-top: -40px;
}

#operation_data_area h3 {
    margin: 12px auto 3px auto;
    
    max-width: 500px;
}

#operation_data_area table {
    width: calc(100% - 10px);
    
    max-width: 500px;
    
    margin: 0 auto;
    
    border-collapse: collapse;
}

#operation_data_area th, #operation_data_area td {
    height: 24px;
    
    padding: 2px 0;
    
    border: 2px solid #eeeeee;
    
    line-height: 24px;
    text-align: center;
}

.dark_mode #operation_data_area th, .dark_mode #operation_data_area td {
    border-color: #555555;
}

#operation_data_area th {
    width: 100px;
}

#operation_data_area .train_icon, .formation_data_area .train_icon, .key_and_value .train_icon {
    max-width: 24px;
    max-height: 24px;
    
    vertical-align: text-top;
    
    float: none;
}

.formation_box {
    min-height: 60px;
    
    padding-left: 10px;
    
    line-height: 26px;
}

.formation_box .train_icon {
    margin-top: 10px;
}

.formation_box b {
    text-decoration: underline;
}

.formation_box span {
    display: inline-block;
    
    margin: 0 1px;
    padding: 1px 3px;
    
    border: 1px solid #dddddd;
}

.dark_mode .formation_box span {
    border-color: #666666;
}

.formation_box span:first-of-type {
    border-radius: 14px 0 0 14px;
    
    padding-left: 12px;
}

.formation_box span:last-of-type {
    border-radius: 0 14px 14px 0;
    
    padding-right: 12px;
}

.train_icon_large {
    display: block;
    
    max-width: 120px;
    max-height: 120px;
    
    margin: 0 auto;
    
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));
}

.descriptive_text {
    max-width: 460px;
    
    margin: 0 auto;
    padding: 10px 20px;
    
    color: #666666;
}

.descriptive_text:empty {
    display: none;
}

.dark_mode .descriptive_text {
    color: #cccccc;
}

.car_info {
    max-width: 480px;
    
    margin: 0 auto;
    padding: 10px;
    
    border-bottom: 1px solid #dddddd;
}

.dark_mode .car_info {
    border-color: #666666;
}

.car_info:after {
    content: "";
    
    display: block;
    
    clear: both;
}

.car_info span {
    display: block;
    
    width: fit-content;
    
    float: right;
}

.car_info .descriptive_text {
    padding: 0;
}

.search_highlight {
    background-color: #ffff33;
}

.dark_mode .search_highlight {
    background-color: #999900;
}

#operation_search_area {
    padding-bottom: 5px;
}

.operation_table {
    width: min(100%, 500px);
    
    margin: 0 auto;
    
    border-collapse: collapse;
    
    text-align: center;
}

.operation_table th, .operation_table td {
    padding: 5px 0;
    
    border: none;
}

.operation_table tr:nth-child(2n):not(:first-child) {
    border-top: 1px solid #cccccc;
}

.dark_mode .operation_table tr:nth-child(2n):not(:first-child) {
    border-top: 1px solid #666666;
}

.operation_table th {
    width: 30%;
    
    font-size: 14px;
    color: #666666;
    font-weight: normal;
}

.dark_mode .operation_table th {
    color: #cccccc;
}

.operation_table tr:first-child th {
    padding: 10px 0;
    
    font-size: 16px;
    font-weight: bold;
}

.operation_table tr th:not(:first-child) {
    width: 35%;
}

.operation_table th b {
    display: block;
    
    font-size: 18px;
    color: #333333;
    text-decoration: underline;
}

.dark_mode .operation_table th b {
    color: #ffffff;
}

.operation_table td {
    width: 35%;
    
    padding-bottom: 2px;
    
    line-height: 20px;
    font-size: 16px;
}

.operation_table .operation_overview {
    width: calc(70% - 5px);
    
    padding: 3px 0 5px 5px;
    
    background-color: #eeeeee;
    
    line-height: 20px;
    text-align: left;
}

.dark_mode .operation_table .operation_overview {
    background-color: #555555;
}

.operation_table td small {
    font-size: 14px;
}

.operation_table td time {
    display: block;
    
    font-size: 16px;
    color: #666666;
}

.dark_mode .operation_table td time {
    color: #cccccc;
}

.operation_table .operation_overview small {
    display: inline-block;
    
    position: relative;
    
    width: 16px;
    height: 18px;
    
    margin-right: 5px;
    
    border-radius: 3px;
    
    line-height: 18px;
    color: #ffffff !important;
    text-align: center;
}

.dark_mode .operation_table .operation_overview small {
    color: #333333 !important;
}

.operation_table .operation_overview small:not(:last-child):after {
    content: "";
    
    display: block;
    
    position: absolute;
    top: 5px;
    right: -4px;
    
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    border-left: 3px solid #cccccc;
}

.dark_mode .operation_table .operation_overview small:not(:last-child):after {
    border-left-color: #808080;
}

.operation_table .operation_overview span:not(.search_highlight) {
    display: inline-block;
    
    margin: 0 8px 0 0;
    
    line-height: 20px;
}

.operation_table .operation_overview span:not(:last-child):after {
    content: ",";
}

.sorting_criteria, .sorting_criteria_desc {
    background-color: #eeeeee;
    
    color: #333333 !important;
}

.dark_mode .sorting_criteria, .dark_mode .sorting_criteria_desc {
    background-color: #666666;
    
    color: #ffffff !important;
}

.sorting_criteria:after, .sorting_criteria_desc:after {
    margin-left: 5px;
    
    opacity: 0.5;
    
    font-size: 10px;
    vertical-align: middle;
}

.sorting_criteria:after {
    content: "▲";
}

.sorting_criteria_desc:after {
    content: "▼";
}

h2 {
    position: relative;
    
    width: calc(100% - 100px);
    
    max-width: 400px;
    
    margin: 5px auto 15px auto;
    
    padding: 5px 0;
    
    line-height: 30px;
    font-size: 22px;
    text-align: center;
}

h2 small {
    display: block;
    
    width: fit-content;
    
    margin: 0 auto;
    
    line-height: 20px;
    font-size: 16px;
    color: #555555;
}

.dark_mode h2 small {
    color: #dddddd;
}

h2 .previous_button, h2 .next_button {
    position: absolute;
    top: 0;
    
    height: 40px;
    
    margin: 0 !important;
}

h2 .previous_button {
    left: -50px;
}

h2 .next_button {
    right: -50px;
}

#formation_table_area h3, #operation_table_area h3 {
    margin: 30px auto 20px auto;
    
    max-width: 500px;
}

.key_and_value {
    width: calc(100% - 60px);
    
    max-width: 440px;
    
    margin: 10px auto;
    
    border-bottom: 2px solid #dddddd;
    
    text-align: right;
    font-size: 18px;
}

.dark_mode .key_and_value {
    border-color: #666666;
}

.key_and_value b, .key_and_value u {
    display: block;
    
    width: fit-content;
    
    float: left;
    
    font-weight: bold;
}

.key_and_value a {
    color: inherit;
}

.formation_operation_data, .formation_operation_data_last_seen {
    margin: 6px 4px;
    padding: 3px 11px;
    
    border: 1px solid #dddddd;
    border-radius: 4px;
}

.dark_mode .formation_operation_data, .dark_mode .formation_operation_data_last_seen {
    border-color: #666666;
}

.formation_operation_data_last_seen {
    background-color: #eeeeee;
}

.dark_mode .formation_operation_data_last_seen {
    background-color: #555555;
}

.formation_operation_data h4, .formation_operation_data_last_seen h4 {
    margin: 4px 0 0 0;
}

footer {
    position: absolute;
    bottom: 0;
    
    width: 100%;
    height: 45px;
    
    background-color: #f7f7f7;
    
    line-height: 45px;
    font-size: 25px;
    
    box-shadow: 0 0 2px 2px rgba(0,0,0,0.2);
    
    overflow: hidden;
    
    z-index: 2;
}

.dark_mode footer {
    background-color: #555555;
    
    color: #eeeeee;
}

footer div {
    display: none;
    
    position: relative;
    
    width: 100%;
    height: 45px;
    
    max-width: 500px;
    
    margin: 0 auto;
    
    text-align: center;
}

.footer_select {
    display: inline-block;
    
    width: 75px;
    
    font-size: 23px;
    color: #999999;
    text-align: center;
}

.previous_button, .next_button, .reload_button, .back_button, .date_button, .time_button {
    width: 35px;
    height: 45px;
    
    padding: 0;
    
    border: none;
    
    background-image: url(data:image/webp;base64,UklGRoQAAABXRUJQVlA4THgAAAAvHcAOEG9gkG2k5vwN3vWnYSBtmzD/Du71NZC2TZh/B/f6KgoAwvETQf+PIDsMCbgRgLuj/78oNB4+pPrbEFz9aqoEm8i26ryeFifLxwcSsBIJMRApERFLeT1dRP+FBAkmr0wo8W9DTbxwR9Lh7ANXYsGXmFDO5AM=) !important;
    background-repeat: no-repeat;
    background-size: 15px 30px;
    background-position: center;
    background-color: transparent !important;
    
    vertical-align: top;
}

.previous_button {
    transform: scale(-1, 1);
    
    margin-right: -10px;
}

.next_button {
    margin-left: -10px;
}

footer .previous_button, footer .next_button {
    z-index: 3;
    
    background-position: 12px 50%;
}

.footer_value, .footer_value_wide {
    display: inline-block;
}

.footer_value {
    width: 55px;
}

.footer_value_wide {
    width: 180px;
}

.footer small {
    font-size: 15px;
}

.reload_button, .back_button, .date_button, .time_button {
    position: absolute;
    bottom: 0;
    left: 0;
    
    width: 45px;
    
    background-size: 30px;
}

.date_button, .time_button {
    left: unset !important;
    right: 0;
    
    text-indent: -100px;
    
    cursor: pointer;
    
    -webkit-tap-highlight-color: rgba(153, 153, 153, 0.2);
    appearance: none;
    -webkit-appearance: none;
}

.date_button {
    background-image: url(data:image/webp;base64,UklGRkwAAABXRUJQVlA4TD8AAAAvO8AOEA8wmZM5mfMf8FASAGhDg0UmCtXmsOBQ+//4iP5PQGy7j0EtSzxh0KtqWWFMGPQmqGWFMeFdUC9pXwQA) !important;
}

.time_button {
    background-image: url(data:image/webp;base64,UklGRjoDAABXRUJQVlA4TC0DAAAvO8AOEA+koJGkZgTgXwQKO08TwaBtI0kGsPxBLML3LgzaNpJkAMsfxCJ87+KwjSRFes2pn5lS+Pzj+QCYjqF3etSmbcCQqecPjPKc47IW5vc5puv/PQpRc6wAbIAoQwYDAGQw7AEAAHDEBsAGAICogBAgBCF+hvQfYEDCDQGhh8Mh5CDeyNEgB0EQxICAEAgEAg59SxCq10OFgJAgRJSBH9CgwQ0EcYNAOATC0SOPMmxwBaOIc1QDoprfZ+jHe5bGuECiJMmmbfW1bdu2fe/sd65t27bvt5/d6+w17wci+j8B8Dj4rj1ra2V+YmJ+ZaspPS4Yeocu8sclwPGCzk8d/Tn/xNN/5c/2YnfEYn6MnaFGsXz4YSF5RqzP9nkV0iIqT388+coVpXkjHryui/l0aXvC4NvY2NvgbUfZtJlsvAY0si6mTunVL4xDkkodE9n4DiAkT0xrouAvFP6P1Say/2PWIoZrsXAPALhfM5BToyQxrAmFVwirN5Beg5cZ5rTBMDCgzWGzQ+xYqJMCO+hxiNSTWOFtsIUzJs9u26we9lDL9lz6ha6FafheJfLgl8NioQFx7BDAkI/UQAeOiO8VSBP6pOXRcZNUIJ+UQgsOSCGCJ0iSnmQyERwn7tO/en6n3OS+nZRCD0rIeRZJ15ROTrbIrQVjtwSyvUQGNQ2S5QUSrmmYLE6QIE0/ZPL/WiDhmobJ4hJ51xRJlnfJraYbstNEOjyw2E6a20mZplxyHkemQ/SMTpHY0Qk3SdJzKe4ToyggpXpKSBFwQZwBLX8O6QI+fW5SraVS3MdfAZQTudcRL7QCAJ7ZWpiGkRUW7YcCIsca6oUWwTWGSZu9DKHOgxuymdNjq1t4A+jQLBHnzE6G8LlPhj4mUh3qXVidGCbC9NRAVuO8il8Ww0wY/+wbiFT9efFUKabFQWb43jAR5yD51+z3ssQR080wBPq6YSIiUyXpN5HhQUHhkTftuVNivvmKwL9KzGzuf8PLn1YdmUHwuG/W3tw1vP9sdCwdRsDq856NwgdYfzj0eeOriIbK19TCyUAmi7peoXf0vqN5e2VhYmJhZbu5434UHgMA) !important;
}

.date_button::-webkit-calendar-picker-indicator, .time_button::-webkit-calendar-picker-indicator {
    position: absolute;
    top: 0;
    right: 0;
    
    width: 100%;
    height: 100%;
    
    opacity: 0;
}

.reload_button {
    background-image: url(data:image/webp;base64,UklGRtACAABXRUJQVlA4TMQCAAAvO8AOELVIsm3JkRr2P5DBVbzAM2STch1ZkVVH88CjL4/3RMABAIBg4mZbb7Zt23XZtm18rsu2bdu2++bMCajkfYiZkuR1rHIFg8/n+/M7aj3RTY6WeHJNOwWSRfkiX/yPfLZ5IjYICWTQn4CeD/GjVL5twHXGXGqcG7Kkjiyg13SpUZCoV2cbWKNFlxrlrrDVHZY5LrrUmB0gVZokZcuAqrrkf8wa1Mc1UaaX4XXJ/5gBz47a4fqQxbvlusg6CsH7N0TNigSG/7aJLYo0BgQ7auWPYZyWAdW8A3Tn35ctjcG5z6iVdqQqcUOazg5UqZFzM1jiSTYjLrLcWY2HJ5W+BaMpZ6DAjvjzxOpK8mWGtSm8tIDqbAMJbqj4qjqTrgRfjGitzhavBPQUcn7U6VEZPhSZQfV95D8DEt+Bd1TfR6V4jBZfItWHDOW8Bb+r66NyjvgKcOri4TByvdlNtBjOMqBLOknBc83R6wKLnwWrgVvOgpvAhWcBPdhEz4LP4EDouwM9eJvFbbAuMgtbCcxqFmfBzSxICn7Pwk0CuDvAOQB+XiR3nkOxEDAyC4sK+EN+DmtEvheJrjkUg4HMaBpuxuSPpkE34mILNoUdJI/ih4pVTEP5YqDHCXzitTZJgkEYgtGGfiSS+1meFnN8G9RjdElgrwvFNESQYAXiz1K6nJKvmOdNdFQ4RRKty/C8dRTtajSrarXyBnHpJlm3PKqR4mpeBthUg0SPy2a4kg+p1XsP+Nvqhe0W8Wej7voO1LYFMzcm1Oxrf2rsgGe7RRKvjF2ZzYbYJvpA6PcWeZA89exb3tRuK2Br/NF1W0/6/lTmMoCyaXjJUyXjBKsfz1hUPiSaennzKqa6Dro234NhVKq7adsA3zl8WPeG6hLPJAe8hzN3OuaXTZn3OqqmC9iMSKCaZa6g88kbTxwcUW+hpvYOVMk=) !important;
}

.back_button {
    background-image: url(data:image/webp;base64,UklGRmgBAABXRUJQVlA4TFsBAAAvO8AOEJVAkiTJkbJPnzcsqqMGfdxPIqvprUSfEq2xCLcNAKBJHXempjt9APnARz2A9ATcfa33B9wmrrDd3WYHBm4bKUo6u8cMf3Bf8vw7knOBjyFVIi/uzGmRnB0TNFCVsqE2E1dVsTxDxNyterlGuIdCJFBpYoQypcUkYbzCpIMheiRfHvZYtW0JJyzrblrIIzOj7nWcIAIsOnDDPDi4lnsaem/Zxrs+r9AZHjOhSGeQmgX5ZJf4f1WESD66HZsFWcFsEsR9bvlO4RLRsAWDzZNgaoUvCS4SttT5yZLgt+StylIrnQwpXS18CSYSGp+fZwUTkt8jogqg8pphVazNLsHyBKzntQ1yT0VQwXS+k3t4/dzO8Fsw5TuCYtf7C2+aSl94yOZB+H7r2fxDr1eZcBbCcEKEtAHKBaAD7tcyODe/rYJHMNsGq2BFZQ+3BfDkxuST6PvZa/fg0gA=) !important;
}

#popup_background {
    display: none;
    
    position: fixed;
    top:0;
    left: 0;
    
    width: 100%;
    height: 100%;
    
    background-color: #ffffff;
    
    z-index: 19;
}

.dark_mode #popup_background {
    background-color: #444444;
}

.popup_active {
    display: block !important;
    
    opacity: 1;
}

@keyframes fade_in {
    0% {
        opacity: 0;
    }
    
    100% {
        opacity: 1;
    }
}

.popup {
    position: fixed;
    top: 0;
    
    display: none;
    
    width: 100%;
    height: 100%;
    
    box-sizing: border-box;
    
    padding: 10px max(10px, calc(50% - 240px));
    padding-top: 50px;
    
    background-color: #ffffff;
    
    overflow: scroll;
    
    z-index: 20;
}

.dark_mode .popup {
    background-color: #444444;
}

.popup.popup_active {
    animation: fade_in 0.3s ease-out, popup_up 0.05s ease-out;
}

@keyframes popup_up {
    0% {
        top: 50px;
    }
    
    100% {
        top: 0;
    }
}

.popup_close_button, .message_close_button {
    background-image: url(data:image/webp;base64,UklGRhwBAABXRUJQVlA4TA8BAAAvO8AOEJegEJIkp+v8SU7sCXLUUNC2kWMdfyRH7BHsqaBtI8c6/kiO2CPYU1HbSM52/lo8+1xO1+cClJlRa5W11kABAD4A/P8ZAoVEBGP9/xuzlJIOR24kKdLAMu/+/7VNlZm9pznxVET/HbmRJEXVDokTzNrwhmYoWz/yRZHzfXTMtLcPV+/Hjcl95YqYAqYUHmM8p+MnyLZ6Omf0ZMvV80P82ON3yKNSINKAUwHTgVIC0jJTM1I73IvpFZOyE7NSu+Tz1Dcvaz6vTd/NC+u4VahMnqVGzzeP2tiWK4vcE4v0GdSZtAGUQXSBVME0Ef7xHvrltphlcidv/PnuhMrCpRsbY+WfkRhr3WezgWzNAA==) !important;
    background-repeat: no-repeat;
    background-position: center;
    
    border: none;
    
    z-index: 2;
}

.popup_close_button {
    position: fixed;
    top: 0;
    right: 10px;
    
    width: 40px;
    height: 40px;
    
    background-size: 30px;
}

.popup .popup_close_button {
    animation: popup_up 0.05s ease-out;
}

.popup h3 {
    padding: 5px 10px;
    
    background-color: #444444;
    
    color: #ffffff;
}

.dark_mode .popup h3 {
    background-color: #808080;
}

h3 a {
    color: inherit !important;
}

h4 {
    margin-bottom: 10px;
}

a {
    color: #999999;
}

.dark_mode a {
    color: #cccccc;
}

.external_link:after {
    content: "";
    
    display: inline-block;
    
    width: 18px;
    height: 1lh;
    
    margin-left: 2px;
    
    background-image: url(data:image/webp;base64,UklGRqYAAABXRUJQVlA4TJkAAAAvI8AIEDdAkG2z+hMc9h4Ekjazf4KHPRBI2sz+CR72QCRAAs1HVv+fMiq2HfsvilTCUSNJjlR77n0ptQbHQfAAhkEffxhjas4AiOj/BEiila70ZxQLrjOb+rHguiA7bDPFS7ziJV5pXlMJUBUzpTnqOpEAVVKMSnOSlIMLwFvtQAEcjStUGQqO1rXK0q5zZqb//+xvsb/E/RoA);
    background-repeat: no-repeat;
    background-size: 18px;
    background-position: center;
    
    vertical-align: top;
}

.value_and_button b {
    margin-left: 20px;
    margin-right: 5px;
    
    line-height: 32px;
    font-size: 24px;
}

.value_and_button button {
    float: right;
    
    margin: 0 20px !important;
}

.popup h4 {
    margin-top: 15px;
    
    padding-left: 6px;
    
    border-left: 4px solid #666666;
    
    line-height: 32px;
    font-size: 18px;
}

.dark_mode .popup h4 {
    border-left-color: #cccccc;
}

.popup input {
    display: block;
    
    width: calc(90% - 4px);
    
    margin: 10px auto;
    
    padding-block: 0;
    padding-inline: 2px;
    
    background-color: transparent;
    
    font-size: 18px;
}

.popup input[type="number"] {
    display: inline-block;
    
    width: 50px;
    
    margin-left: 20px;
    
    font-size: 18px;
}

.popup button {
    display: block;
    
    margin: 10px auto;
    padding: 5px 10px;
}

.additional_setting_link {
    display: block;
    
    width: fit-content;
    
    margin: 20px auto 10px auto;
}

#popup_screen, #wait_screen {
    display: none;
    
    position: fixed;
    top:0;
    left: 0;
    
    width: 100%;
    height: 100%;
    
    background-color: rgba(0,0,0,0.75);
    
    overflow: hidden;
    
    z-index: 200;
}

.popup_screen_active {
    display: block !important;
    
    animation: fade_in 0.75s ease-out;
}

#popup_screen_blank_area {
    width: 100%;
    height: 100%;
    
    z-index: 201;
    
    cursor: default;
}

.square_popup, .preview_popup {
    display: none;
    
    position: fixed;
    top: calc(50% - 160px);
    left: calc(50% - 160px);
    
    width: 310px;
    height: 280px;
    
    z-index: 202;
    
    padding: 40px 5px 0 5px;
    
    background-color: #ffffff;
    
    text-align: center;
}

.dark_mode .square_popup, .dark_mode .preview_popup {
    background-color: #666666;
}

.square_popup.popup_active {
    animation: square_popup_up 0.05s ease-out;
}

@keyframes square_popup_up {
    0% {
        top: calc(50% - 110px);
    }
    
    100% {
        top: calc(50% - 160px);
    }
}

.preview_popup {
    width: calc(100% - 50px);
    height: calc(100% - 70px);
    
    max-width: 450px;
    
    padding: 40px 10px 0 10px;
    
    top: 15px;
    left: max(15px, calc(50% - 235px));
    
    overflow: scroll;
}

.preview_popup.popup_active {
    animation: preview_popup_up 0.05s ease-out;
}

@keyframes preview_popup_up {
    0% {
        top: 65px;
    }
    
    100% {
        top: 15px;
    }
}

.square_popup input, .preview_popup input {
    width: 235px;
    
    margin: 0 2px 0 5px;
    
    background-color: transparent;
    
    line-height: 24px;
    font-size: 18px;
    text-align: center;
}

.square_popup input[type="number"], .preview_popup input[type="number"] {
    width: 60px;
    
    text-align: center;
}

.square_popup button, .preview_popup button {
    min-width: 50px;
    
    line-height: 22px;
}

.dark_mode #splash_screen .wide_button, .dark_mode #railroad_select_popup .wide_button, .dark_mode #railroad_select_popup .popup_close_button, .dark_mode .square_popup button, .dark_mode .preview_popup button {
    background-color: rgba(102,102,102,0.85);
}

.square_popup .popup_close_button {
    top: calc(50% - 150px);
    right: calc(50% - 150px);
}

.square_popup.popup_active .popup_close_button {
    animation: square_popup_close_button_up 0.05s ease-out;
}

@keyframes square_popup_close_button_up {
    0% {
        top: calc(50% - 100px);
    }
    
    100% {
        top: calc(50% - 150px);
    }
}

.preview_popup .popup_close_button {
    top: 20px;
    right: max(20px, calc(50% - 230px));
}

.preview_popup.popup_active .popup_close_button {
    animation: preview_popup_close_button_up 0.05s ease-out;
}

@keyframes preview_popup_close_button_up {
    0% {
        top: 70px;
    }
    
    100% {
        top: 20px;
    }
}

.informational_text, .warning_text {
    max-width: 480px;
    
    margin: 10px auto;
    padding: 0 10px 10px 15px;
    
    color: #666666;
    text-align: left;
}

.dark_mode .informational_text {
    color: #999999;
}

.warning_text {
    color: #ee3333;
}

#announcements_heading {
    margin-top: -20px;
    
    padding-top: 48px;
    
    background-size: 36px;
    background-position: 50% 0;
}

#announcements_area input[type="checkbox"] + label.drop_down {
    padding: 10px 40px;
}

.important_announcement {
    background-image: url(data:image/webp;base64,UklGRnIBAABXRUJQVlA4TGYBAAAvNUANELfBKpJkJ/3IGQQggT/8K0trg1EbSY68EcDy53i6/wRWkSQ76UfOIAAJ/OFfWVpWsW0ruffh/kskshKCCJRwd7cToHRwubTBAJ8bAHAAAIACAAySwkgMDIaEA7dBi7BmIi4KIBflj6SA9mWETVFR8PtFRqavv7aN1q+6+i0KvDLKJimly1Tfun3iCZe3BMM/POMYqdXSMQ5ax0rnOuneN8G1bdtms5PL1LZtt///bw1OTo2HiP5PAAKnnU3KyFhNatOZIuIwJ5nW5mFEU0m2qiUC1gXJOj/2EXnJvOheNSX7OoClojkcfQ80qg/kJe3F8b3QyCom8hbktH0bvc1tVLK3kbS3YeVt0P9HOZ19T9xeQI9qt/fdUSUyVBfH90KVqt5GqXMb3dFtrJC7hSqw0DSHo++BRvUBtGjibQCAyHErulcY53nlxvAXdcVHN7YIOStzqQ4QcdSrpGw8Nl3qjRAI);
    background-repeat: no-repeat;
    background-size: 27px;
    background-position: 9px 50%;
}

.new_icon:before, .new_icon_red:before {
    content: "";
    
    display: inline-block;
    
    margin: calc(0.5lh - 5px) 5px calc(0.5lh - 5px) 0;
    
    padding: 5px;
    
    border-radius: 5px;
    
    background-color: #33cc99;
    
    vertical-align: top;
}

.new_icon_red:before {
    background-color: #ee3333;
}

.announcement {
    padding: 15px;
    
    background-color: #eeeeee;
    
    font-size: 18px;
    text-align: left;
}

.dark_mode .announcement {
    background-color: #777777;
}

.announcement small {
    display: block;
    
    margin-top: 10px;
    
    font-size: 16px;
    color: #666666;
    text-align: right;
}

.dark_mode .announcement small {
    color: #cccccc;
}

#about_railroad_data_popup, #about_railroad_data_popup .informational_text {
    text-align: center;
}

#about_railroad_data_popup h2 {
    font-size: 20px;
    color: #ffffff;
}

#about_railroad_data_popup img {
    display: block;
    
    width: 40px;
    
    margin: 5px auto;
}

.long_text {
    margin: 20px 0 40px 0;
    
    line-height: 1.8em;
    text-align: left;
    word-break: break-all;
}

#captcha_info {
    margin-top: -30px;
}

#captcha_area {
    margin-bottom: 20px;
}

#captcha_area button {
    min-width: 0 !important;
    
    border-radius: 0;
}

.operation_data_detail {
    margin: 0 5px;
    
    padding: 5px 0;
    
    line-height: 24px;
    text-align: left;
}

.operation_data_detail:not(:last-child) {
    border-bottom: 1px solid #dddddd;
}

.dark_mode .operation_data_detail {
    border-bottom-color: #808080;
}

.operation_data_detail:after {
    content: "";
    
    display: block;
    
    clear: both;
}

.operation_data_detail b {
    display: block;
    
    font-size: 18px;
}

.operation_data_detail span {
    float: right;
    
    font-size: 16px;
    font-weight: normal;
}

.operation_data_detail small {
    font-size: 14px;
    color: #666666;
}

.dark_mode .operation_data_detail small {
    color: #cccccc;
}

.operation_data_detail a small {
    color: inherit !important;
}

.operation_data_detail .descriptive_text {
    padding: 0 5px;
}

.operation_data_detail button {
    display: inline-block;
    
    height: 24px;
    
    margin: 0 0 0 10px;
    padding: 0 6px;
    
    vertical-align: top;
}

.formation_data_area {
    margin: 5px 0 10px 0;
    
    font-weight: bold;
}

.formation_data_area a {
    color: inherit;
}

#train_detail_day {
    position: absolute;
    top: 12px;
    left: 16px;
    
    padding: 4px 20px;
    
    border-radius: 4px;
    
    line-height: 24px;
    font-size: 16px;
}

#train_detail_popup h4, #operation_detail_popup h4 {
    margin-top: 30px;
    margin-bottom: 10px;
    
    line-height: 18px;
    font-size: 18px;
}

.train_detail_departure_times {
    position: relative;
    
    width: 240px;
    
    margin: 0 auto;
    padding: 0 10px;
    border-left: 20px solid #808080;
    
    line-height: 36px;
    font-size: 18px;
    text-align: left;
}

.train_detail_departure_times_highlight {
    font-weight: bold;
}

.train_detail_departure_times:before {
    content: "";
    
    position: absolute;
    top: 14px;
    left: -14px;
    
    width: 8px;
    height: 8px;
    
    background-color: #ffffff;
    
    border-radius: 4px;
}

.train_detail_departure_times_highlight:before {
    top: 11px;
    left: -17px;
    
    width: 12px;
    height: 12px;
    
    background-color: #ffff33;
    
    border: 1px solid #ffffff;
    border-radius: 7px;
}

.dark_mode .train_detail_departure_times:before {
    background-color: #666666;
}

.dark_mode .train_detail_departure_times_highlight:before {
    background-color: #cccc33;
    
    border-color: #666666;
}

.train_detail_departure_times:last-of-type {
    margin-bottom: 60px;
}

#train_detail_popup .informational_text {
    margin-top: 20px;
    margin-bottom: 80px;
}

#train_detail_popup .wide_button, #operation_detail_popup .wide_button {
    position: fixed;
    bottom: 20px;
    left: max(25px, calc(50% - 225px));
    
    width: calc(100% - 50px) !important;
    
    max-width: 450px;
}

.train_overview, .operation_table_train, .location_overview {
    position: relative;
    
    margin-bottom: 14px;
    
    padding: 0 15px;
    
    font-size: 18px;
}

.train_overview:after, .operation_table_train:after, .location_overview:after {
    content: "";
    
    display: block;
    
    position: absolute;
    bottom: -10px;
    left: calc(50% - 12px);
    
    width: 0;
    
    border: 12px solid transparent;
    border-top: 6px solid #dddddd;
    border-bottom: none;
}

.dark_mode .train_overview:after, .dark_mode .operation_table_train:after, .dark_mode .location_overview:after {
    border-top-color: #808080;
}

.train_overview:last-of-type:after, .operation_table_train:last-of-type:after, .location_overview:last-of-type:after {
    border-top: none;
}

#operation_detail_area {
    text-align: center;
}

#operation_detail_area h2 .previous_button, #operation_detail_area h2 .next_button {
    height: 60px;
}

#operation_trains_area {
    margin: 20px 0 80px 0;
}

.operation_table_train {
    margin-bottom: 32px;
    
    padding: 7px 11px;
    
    border: 1px solid #dddddd;
    border-radius: 4px;
}

.dark_mode .operation_table_train {
    border-color: #666666;
}

.operation_table_train:first-child, .operation_table_train:last-child {
    border-color: transparent !important;
}

.operation_table_train.operation_table_deposited_train {
    background-color: #eeeeee;
}

.dark_mode .operation_table_train.operation_table_deposited_train {
    background-color: #555555;
}

.operation_table_train:after {
    bottom: -21px;
    left: calc(50% - 16px);
    
    border-width: 16px;
    border-top-width: 8px;
}

.train_overview a, .operation_table_train a {
    color: inherit;
    text-decoration: none;
}

.train_overview b {
    display: inline-block;
    
    width: 38%;
}

.operation_table_train b:not(.train_overview_location) {
    display: block;
    
    width: 100%;
    
    padding-bottom: 8px;
    
    text-align: left;
}

.location_overview b {
    margin-right: 40px;
}

.train_overview .train_overview_location, .train_overview time {
    width: fit-content !important;
}

.train_overview b small, .operation_table_train b small {
    font-size: 16px;
    color: #999999;
    font-weight: normal;
}

.operation_table_train b:not(.train_overview_location) small {
    float: right;
}

.train_overview span, .train_overview time {
    display: inline-block;
    
    width: 26%;
}

.train_overview span:nth-of-type(2), .operation_table_train span:nth-of-type(2) {
    width: 10%;
}

.train_overview time, .operation_table_train time {
    margin-left: 16px;
}

.operation_table_train span {
    display: inline-block;
    
    width: 45%;
}

.operation_table_train div {
    padding: 8px 8px 0 0;
    
    text-align: right;
    color: #666666;
}

.dark_mode .operation_table_train div {
    color: #cccccc;
}

.operation_table_train div a {
    color: #333333;
    text-decoration: underline;
}

.dark_mode .operation_table_train div a {
    color: #ffffff;
}

.suggestion_area {
    position: relative;
    
    width: 90%;
    
    margin: -10px auto 10px auto;
}

.suggestion_area div {
    position: absolute;
    top: 0;
    left: 0;
    
    width: calc(100% - 2px);
    max-height: 180px;
    
    background-color: #ffffff;
    
    font-size: 18px;
    
    overflow-y: scroll;
}

.suggestion_area div:not(:empty) {
    border: 1px solid #cccccc;
    
    box-shadow: 1px 2px 2px rgba(0, 0, 0, 0.25);
}

.suggestion_area div:not(:empty):before {
    content: "候補:";
    
    display: block;
    
    position: absolute;
    top: 0;
    left: 10px;
    
    line-height: 40px;
    color: #999999;
}

.suggestion_area a {
    display: block;
    
    position: relative;
    
    padding: 5px 0 5px 60px;
    
    line-height: 30px;
    color: inherit;
    text-decoration: none;
    
    z-index: 2;
}

.dark_mode .suggestion_area div {
    background-color: #666666;
    
    border-color: #808080;
}

.suggestion_area .train_icon {
    max-width: 30px;
    max-height: 30px;
}

#wait_screen {
    background-color: rgba(0,0,0,0.9);
    
    z-index: 300 !important;
}

#wait_screen:before, .wait_icon:empty:before, .splash_screen_loading:before {
    content: "";
    
    display: block;
    
    position: fixed;
    top: calc(50vh - 60px);
    left: calc(50vw - 60px);
    
    width: 120px;
    height: 120px;
    
    background-image: url(data:image/webp;base64,UklGRvoJAABXRUJQVlA4TO4JAAAv78A7EBVZmwBaldsmP32/eyagWHrn3Ldy8JP/RH5a0lbSnnveffeWewpaO8was62VyxCOIZyoo5FGr6DZTwGpISkM2vFI4zWE2bBlbhUGbXGT4nZHGo3LDSfrMBmmFGZ5JkIOZNumbdW5b1/r2Taun23btm3btm3btq3/f2RFj+n3BEjojmfy5TEW2nAXP+Iz/rrhz6/jzjKMaYrBxG3LylQN/Rn/J/hnHASTsrtU4zERf6RJUyqhEucmMQBx+JQmx8ehPzsIqOJdWiveorJrbA+p6BvSmvE35sRgToEYnE0zVDMbox1iC2bcT7PEE2R3hovwIs00f5EjjEfgapotblUg3QBb04yh0QnQMc0a3RygkhtfeeGLz2V/MJBmjn3W56njP27fecH2YCXNXi1ani+f5v8dZNhdMgBp1Wx1W6AuCwI+j9gcWKcDCZY2p+qCgdU2h2+C0WlxZ+DfYDxymL0BNR1Qj2Rv4BAUsLM3DA6KCrS3fwel3t4gIyg99vbvoNTbRkMVBY3QBjw8+882VbEwmBaUh21iC2blhLVwmqq9E9vB1+PT9GRQTrcH0IIO/JxKFL/hhGcbAzp8SlCUnC14eutStHAEzhHdGY8E45HD7KCad0KKHuY9EpngfTA6xQpL8DalE79gfES1RzCwygb2wxT4ntK8rAJJpKyCoSwsYDzTupT+XavxNIddFgR8Hgm/7SGsSHGEhQyJJIOATRL+t6V4QndE8nYAvuPRw08ZwHcmKYwhEVzmhwsS+pPxXYorfB0keeE73L7jq4TfhBTfieMRFIL93FSvhH5XijOEkfRdxuuyvvBTi6y+VYmjEHTkdamE/kCKNwaTiGrmhPXCdntoE+aXULDvIiNNYIaH+5Eg/Nd8YHOEy2HdnnHhXUG/Smo7YJwtmOETs5QvTyIX5bng+UXCtEoUzAq179FnGuWU4o7ZNLIFM+zx+N2DwrS7UOdTPGHDzGB3M5FsjMZpDjB1hjAFiUKCp/SZ5Wh2tyKRSPabhz91fS0XCdMKgmeRSGGPUZM0wHd2KV+eSsRX6dSDN4PCVikWEleSJulO8R+hkxjAGHykw4d5fxa2MYRnQdBhEjQKAEZpEGn4N36nOf2NrbHC+JsFygaDgF0AME2LSFkZY3+USHRHqSyslSRJn0EuDQAWahKRGMyjz8MWtY3vd1q7dqfFrdjSomiRcG8kqRQwyJMBwEx9gT+M5CWDfDQAGGu8OSSzDQIKAQAP422MpihtDxlkC+YAgKrxBDUIkCwm7eTncZpvLFtiYLYFyijYzg4OJATvSmhzETFqPzssDYNIqSXQJmb95q3cusJAouV1GaoUF9PuyqwzBkJB5MGDaxqqVGwQ43q2zDBNQvOMG6qkGkFi8rAYuLyC1evPhofJwZmVlyMuGMEco4FtCU4g9RfyQRtxxIfZQKW44n7LmMDaGc4gwzDCAo49TnHIanwzg1VxIXHKLVBHavv8s+KY+2EAfNEzIyPuOXivBrwGa3HS0en4hgg+fPwicdUx2GmXEAw0VXCI0x6F2Z+/tS4rDvX1/izue6cv39CCaaoEMpaAx6Rn5UP+t/lo8gu94IXenmfvC5M3glxo78egDDbytd+CpYWM48SFIGtFPtEVx89xmDhrDs/ylAc9vcFVPgvbeWrYKjnJcE9eJ6TGgHucoeryeu/OuEYFclleN7Tu7hbRK3n9WBY5BfjnOXo+LtF2EIuj621oDHasUKVMJW3puoy26Jk8TxiIbKfskXoxqGa08UhlPafnuT5mOddc2lVXcPVFdETNbGCmbDW+fFeikzaC6DryfFHXZpR2V+KgRXcjo3Mtxqd0UbZRVeJ+x2hVxlpmryFZswUz0UCes6duLaUu2oVELawg0lYqCF3UF9FADSusspVesjaar7La1VYWky2mgS1Wt9gKOJMpJ5pVrPDIVvrJ+p1L+dA0ssJ1W2kg85xovspqV1tZTKZMaaCG1TpbaSPzSDQtrDDCVp4nu4hmgNUkW5GFRB1Cu/fvGB2VsZbn15CsuZNI1jGCcrHXNpJGofb1GHk6FiMDBANCHn2Vzd/LNiO+fEJxpSKdoA2bgtjtanCtk3LxhEVnBL1MsD+yHCnXNz5cw8ON9ZHorT+axe+WigVn5qD07d+bkxH9l7P4krhk9DIDKCk6hex+j7bWGEIcc2M01GmCxow455/31+IllcVFS7BFdlqHOOqG4w8iORrTZ4u73tAzMaGJT/n84rYZNMfiz9fh81C0OCMOXESeQbQBD/T+c+PgFUX5kP/f/3lxzkkjB2N4v+/q68TFyy4UvQ1x2I9ztavRHl9zd8cp/3JZNtEzRjIuo+SwIUuJPZc7S6Tc/5QlXnKYmwyr5Cz9d0fDZ/cqqbh66RRl4KusLhtsGPKzOlXzFszhEvUuUBm5mm9T9ihmqmJjVu+NW6DCREmqsFzdwesKM/l2Wd3/Do/IN8slrLJOMtHqZm3ZuHpYbIzuz1H61mXjFF/O6lfdZ4RD+eAc7ReME1fKcvQdwuGUHLVSNM3LLLA/hgiDKqkc+fGjZrkhy/OkEIiuosslzbKAyVMh0JvTiNnPGkWVM9m5bL4FOnK7meSYZibZ9cbb/T4tGGqSL2a5ejrGS+f0Pm+QQTYNxouraxonapDd2PQbr6Sp2yAlNtOMN0PT2wZZw+Zg4/mGmtoMAgpsnjSer6IJBQ3yTTaTjLdaT/vGaIOU1TiXTxmv3KjF9xWTYh6TO4rGk2VaJhkFbZhgjJh/vY77njfKqJrhUU0NAVGeGhaKWTGNhWreLwyuaCfDpDMM8zkWHRKKL1C1f05Mi4kMvltmNOprKr+n1mHT3eue+mmV5gZ2ErckGhTjjqohbc2HCdeiT1nSiq11bF3SXWQWKVOK9pPEwD1qVhc6CtdvqdRkwpgyh5dIj8pIaL9xomJk31UTJG8PMSl23J0kHCrsx0tmF9rrdPxnzxBDd2lRucPCMwYeThKrkGFeIs/6et+uqf2nkyoIYu4DXqbD+O2A8Iz88CT5VREzEXl+Trcv75HGCp0hZl/5DFHzsqIwBY+kRnTjF5IblrxMgcXrhKunlNR6lJ2I/OsHaiaRPzYJ2zFYrNCDVXtbisiGL+RwrJZmLD3ym8J4JKl5mbWISHTFUZf/cs0gCo4K671Vna49jrGYgPp6Se1rXAOT9P3bMSqQd+tTjSNusT7J8Bq3mMTBV3GLEoeFbjGDwwy3KHFY6BaTODzgFus5rHaLkRZ9LSNuIZio7w1xTNTVp7RdY+89dO1xjGsIOupaJs55zLl6zs24h/ToaRIX9dx1gKs4aYThdNMjN5EYwACqacPiqsWOuymGCttD4rDjBO5KDJM+JY4bJ2FMa11ahxrFgbdgjqv3+2mqsqWlC9P6j/mLfBC6);
    background-size: 120px;
    
    animation: spin 1s steps(8) infinite;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    
    100% {
        transform: rotate(360deg);
    }
}

#message_area {
    position: fixed;
    top: 100px;
    left: calc(50% - 150px);
    
    width: 300px;
    
    z-index: 299;
}

#message_area:empty {
    display: none;
}

#message_area div {
    position: relative;
    
    width: 250px;
    
    margin-bottom: 5px;
    
    padding: 5px 20px 5px 30px;
    
    border-radius: 5px;
    
    background-image: url(data:image/webp;base64,UklGRhoBAABXRUJQVlA4TA0BAAAvJ8AJEP9AkG3T+Rtc9hoE2Ta97P0NhqBt27jjz/UMHgaNJCk6Jjmn9KSRF3zogLjk/n68uAAAgAro5agMBiazXx9AgqWD/yPZQ5kVpqq3SHz8Bw5r200bGcJJOUz7r5k6+pImiOi/I7eNHEmWJm04LfYRhLfWMdYLqedePtnktD38bT+njlMZryqkIqw4E93Xp4T2WvDpeqe4LomISu4SvwrhRK8yxPNa9Mx6J/w22ZexaWXSe8vG9AcseAvaRKtPwV8Et1dWzNGKIrOi7KxoFysOmmz4ELnRgoHorwhcqgTYXQEoTgyIF8KHRLBBe/B/IEn4ZVwyRUkVJBemEaSTTek75Un6bXNeNAdBCAA=);
    background-repeat: no-repeat;
    background-size: 20px;
    background-position: 5px 50%;
    background-color: #ffffff;
    
    line-height: 24px;
    font-size: 16px;
    
    box-shadow: 2px 4px 6px rgba(0, 0, 0, 0.25);
    
    animation: fade_in_out 10s ease-out;
}

.dark_mode #message_area div {
    background-color: #666666;
}

@keyframes fade_in_out {
    0% {
        opacity: 0;
        margin-top: 10px;
        margin-bottom: -5px;
    }
    
    1% {
        opacity: 1;
        margin-top: 0;
        margin-bottom: 5px;
    }
    
    60% {
        opacity: 1;
        margin-top: 0;
        margin-bottom: 5px;
    }
    
    100% {
        opacity: 0;
        margin-top: 0;
        margin-bottom: 5px;
    }
}

#message_area .error_message {
    background-image: url(data:image/webp;base64,UklGRh4BAABXRUJQVlA4TBEBAAAvJ8AJEP9gkG2k7pXeX+1fw0DaNql/sVdwZiBtm/SW7t/ar6CNJOXunvwbegnv4GUwTUCM7u3HxQYAABTzExLOIcdUHPQEHJIBJOR870x+r9AxV2Jfg8PadtNGUhwuM3f/NQP6X5ogov+O3LaRJFnqdWZu8wnB+21L2X4kPH3aYmeNdrHV9hrOM5hvKGQgLF2KerAl1W5aZctdNXDdiYh03iV+C/FE38Bw6sUIKPViDIx6MQpCvRgH4dMysLP8LAd7b7IYShZtnUXXZ7H7ZPGVcw5HEb1lcBeZvC4B/w+mxSUebm1K+GX5Tysw7xJ+xA+JgPkvwdeYyB/z4qRiJeKFRQTFdAv6WHKS+F5D045fgQgA);
    background-color: #ffcccc;
}

.dark_mode #message_area .error_message {
    background-color: #996666;
}

.message_close_button {
    position: absolute;
    top: -5px;
    right: -5px;
    
    width: 40px;
    height: 40px;
    
    background-size: 20px;
    background-color: transparent !important;
}

input[type="text"], input[type="number"], input[type="password"], input[type="search"], .wide_select, .line_select_wrapper select {
    background-color: #ffffff;
    
    border: none;
    border-bottom: 2px solid #cccccc;
    
    color: #333333;
}

.dark_mode input[type="text"], .dark_mode input[type="number"], .dark_mode input[type="search"], .dark_mode input[type="password"], .dark_mode select {
    background-color: #444444;
    
    border-color: #666666;
    
    color: #ffffff;
}

.dark_mode .square_popup input[type="text"], .dark_mode .square_popup input[type="password"] {
    background-color: #666666;
    
    border-color: #808080;
}

.search_wrapper {
    top: 100px;
    left: max(calc(5% - 15px), calc(50% - 240px));
    
    width: min(90%, 450px);
}

.search_icon {
    display: block;
    
    width: 28px;
    height: 28px;
    
    padding-right: 2px;
    
    background-image: url(data:image/webp;base64,UklGRqACAABXRUJQVlA4TJQCAAAvN8ANEF+jJpKkqH3g3wd+iCmi445HBJpGkjI+8O8DP9SE6lk0jSRlfODfB36oCdWzriPJVpV7z3n7XHD5IyHSJB1CcT9WByTkrNT35nFOrPdm+3/DN2vIAh5ZCwxAFgG44QvJagEAQIsaexAYAMCowAAIQEYBBoFByFkJGQZHwOEwGH5wBPQDoAgIHG/c8IZAILjhDcEt64AWLVoAFRg9GBVWmNBmnfCG4ALJ6gFsss4xIzHTZP1ihua9P3hb64gBBKAGbNu2zUin7LZt3lTbtm3b//8FdyfZ96b1GNF/CG4kKZKc1ctQe9fwB/lXJXJVvnJXcPto2cbipKMwQzXbL9bcfPUo75xWPViRPupR/mldtWCrTXH52DR1kVdsJu7NVPQql6a3nbK1i6XPAeXKWMLo2S7szVmIiSvRi1FX1YcNPm0IO5u89u7mtfIM21nkHWFf85v+E+IUdF/R86UHVDMdrfdDR9OsL3w2QrWUxf9TMTmp4dq5Fi6H4JOzqLQFIcX7tM4HyiSICZt36CrL2HRgmgktCw4YV0rbN9gH8toXYxvsCJ9hbYRRCIoMNMDuwTgHawZmtUFqCYKcgXH6TilYMtAGk5jxiDORF8PthupoSOt4oe2CZUoNdHTBCjWCdeEnTvMraVVpJ0J5wV2hkvPQAnaFyx7o2qIeq1Va+xPpoRWPhXViHCj3tdEfT/VnfX/HHPbTkxE6H9hY92Hc89HVFuXK4BVtc9LVWd/7ZQSn2a7+Vgv1PObRW755qq4RDik7lahXfrFX4UUnqJLUtL/23cyglZLiz05PTbtPIleWSh6yBzPNQ4PNkx93MPv8y2rWT72qxFYxN5NB3TyOiu3yGtbLPQIoHIFUQEMkGZX/TwQ=);
    background-repeat: no-repeat;
    background-size: 28px;
    
    text-indent: 30px;
    white-space: nowrap;
    
    overflow: hidden;
    
    float: left;
}

input[type="search"] {
    width: calc(100% - 40px);
    
    padding: 2px 2px 1px 2px;
    
    line-height: 24px;
    font-size: 18px;
}

input[type="search"]::-webkit-search-cancel-button {
   -webkit-appearance: none;
}

textarea {
    display: block;
    
    box-sizing: content-box;
    
    width: calc(100% - 60px);
    height: 60px;
    
    max-width: 440px;
    
    margin: 10px auto;
    padding: 9px;
    
    background-color: transparent;
    
    border: 1px solid #cccccc;
    border-radius: 5px;

    font-size: 16px;
    
    resize: none;
}

.dark_mode textarea {
    border-color: #808080;
    
    color: #ffffff;
}

input[type="checkbox"], input[type="radio"] {
    display: none;
}

input[type="checkbox"] + label {
    display: block;
    
    position: relative;
    
    margin: 20px 0 0 max(20px, 50% - 230px);
    
    padding-left: 54px;
    
    line-height: 24px;
    font-size: 18px;
}

input[type="checkbox"] + label:not(.drop_down) {
    text-align: left;
}

input[type="checkbox"] + label:not(.drop_down):before {
    content: "";
    
    display: inline-block;
    
    position: absolute;
    
    top: 0;
    left: 0;
    
    width: 44px;
    height: 24px;
    
    background-color: #dddddd;
    
    border-radius: 12px;
    
    box-shadow: 1px 1px 2px rgba(0,0,0,0.25) inset;
    
    transition-duration: 0.25s;
    transition-property: all;
}

input[type="checkbox"]:checked + label:not(.drop_down):before {
    background-color: #333333;
}

.dark_mode input[type="checkbox"] + label:not(.drop_down):before {
    background-color: #333333;
}

.dark_mode input[type="checkbox"]:checked + label:not(.drop_down):before {
    background-color: #ffffff;
}

input[type="checkbox"] + label:after {
    content: "";
    
    display: inline-block;
    
    position: absolute;
    
    top: 2px;
    left: 2px;
    
    width: 20px;
    height: 20px;
    
    background-color: #ffffff;
    
    border-radius: 10px;
    
    box-shadow: 1px 1px 2px rgba(0,0,0,0.25);
    
    transition-duration: 0.2s;
    transition-property: all;
}

.dark_mode input[type="checkbox"] + label:after {
    background-color: #444444;
}

input[type="checkbox"]:checked + label:after {
    left: 22px;
}

button, a.wide_button, input[type="radio"] + label {
    background-color: rgba(255,255,255,0.9);
    background-image: linear-gradient(315deg, #666666 8px, transparent 8px);
    
    border: 1px solid #666666;
    border-radius: 4px;
    
    color: #333333;
    text-decoration: none;
}

button {
    font-size: 14px;
}

.dark_mode button, .dark_mode a.wide_button, .dark_mode input[type="radio"] + label {
    background-color: rgba(68,68,68,0.85);
    background-image: linear-gradient(315deg, #cccccc 8px, transparent 8px);
    
    border-color: #cccccc;
    
    color: #eeeeee;
}

input[type="radio"] + label {
    display: inline-block;
    
    padding: 8px 8px 8px 22px;
    
    background-image: none;
    background-color: #666666;
    
    color: #ffffff;
}

.dark_mode input[type="radio"] + label {
    background-color: #cccccc;
    
    color: #333333;
}

input[type="radio"]:checked + label {
    padding-top: 5px;
    
    border-top-width: 4px;
    
    background-image: url(data:image/webp;base64,UklGRp4AAABXRUJQVlA4TJEAAAAvH8AHEC9AkG3Tyd6f4BwE2Tad7P0JHoJsm072/gQPmbRNLVTyXO9rgG1hqPp/wSCSrTYvTQBFAJGAg1gA/2p+eT9NQET/1bZtwzgDt7Qz8G3NKC0dQXIakSkgS0Zk6pFpu+PkmlFMOyoypcPrR9EuNSn2ZjLuNK6Ah77k8tkAC9FB5HSA4GQYKUZOINBW/KYAAA==);
    background-repeat: no-repeat;
    background-size: 16px;
    background-position: 4px 50%;
    background-color: transparent;
    
    color: #333333;
}

.dark_mode input[type="radio"]:checked + label {
    background-image: url(data:image/webp;base64,UklGRqAAAABXRUJQVlA4TJMAAAAvH8AHEC9AkG3T+aud6RwE2Tadv9qZHoJsm85f7UwPmYDF9qkurQgCbDuKVfkvWEWS7GRJAl4SQPrHwnMA/t3c3dsjCYjov9q2bRhn4JZ2Br6t3csZeiclzJ7BoUhmz1A9w3jHnWtGMe0ozxD61nYU7ZKCYm8m4y7jBLTQlxxtRsBCbCByKkBoZBgpRo4jcE74TQEA);
    
    color: #ffffff;
}

input[type="radio"] + label small {
    font-size: 14px;
}

#unyo_icon {
    display: block;
    
    width: 96px;
    
    margin: 10px auto;
    
    filter: drop-shadow(1px 2px 1px rgba(0,0,0,0.25));
}

#app_version {
    margin: 15px 0 10px 0;
}

#license_text {
    display: block;
    
    width: calc(100% - 20px);
    
    padding: 0 10px 15px 10px;
    
    font-size: 14px;
    color: #666666;
}

.dark_mode #license_text {
    color: #cccccc;
}
</style>
</head>
<body>
    <header><a id="railroad_icon" href="javascript:void(0);" onclick="about_railroad_data();"></a><span id="app_name"></span><a id="railroad_name" href="javascript:void(0);" onclick="open_popup('railroad_select_popup');"></a><a id="menu_button" href="javascript:void(0);" onclick="menu_click();"></a></header>
    <div id="menu">
        <div id="menu_logged_in">
            <b id="menu_user_name"></b>
            <a href="javascript:void(0);" onclick="edit_user_data();">ユーザー情報の編集</a>
            <a href="javascript:void(0);" onclick="user_logout();">ログアウト</a>
        </div>
        <div id="menu_admin">
            <a href="javascript:void(0);" onclick="window.open('admin/index.php');">管理画面を開く</a>
        </div>
        <div id="menu_not_logged_in">
            <a href="javascript:void(0);" onclick="open_square_popup('login_popup');">ログイン</a>
            <a href="javascript:void(0);" onclick="open_popup('sign_up_popup');">新規登録</a>
        </div>
        <div id="menu_off_line">
            <b class="off_line_message">端末がオフラインです</b>
        </div>
        <hr>
        <a id="menu_announcements" href="javascript:void(0);" onclick="show_announcements();">お知らせ</a>
        <hr>
        <a href="javascript:void(0);" onclick="edit_config();">各種設定</a>
        <hr>
        <a href="javascript:void(0);" onclick="open_square_popup('about_popup');">このアプリについて</a>
        <a href="javascript:void(0);" onclick="window.open('README.html');">このアプリの使い方</a>
        <a href="javascript:void(0);" onclick="show_rules();">ルールとポリシー</a>
    </div>
    <div id="splash_screen" class="splash_screen_loading">
        <div id="splash_screen_inner">
            <div id="splash_screen_login_status">サーバに接続しています...</div>
            <a id="announcements_overview" href="javascript:void(0);" onclick="show_announcements();"></a>
            <div id="splash_screen_buttons" class="wait_icon"></div>
            <div id="splash_screen_bottom">
                <a href="javascript:void(0);" onclick="window.open('README.html');">使い方</a>　<a href="javascript:void(0);" onclick="show_rules();">ルールとポリシー</a>
                <div id="splash_screen_app_version"></div>
            </div> 
        </div>
    </div>
    <div id="blank_article" class="wait_icon"></div>
    <div id="tab_area"><button type="button" onclick="position_mode();" style="background-image: url(data:image/webp;base64,UklGRuICAABXRUJQVlA4TNYCAAAvNUANEP/jIJJkV+n9gZxBAq6xyn9rA1Jk266q3o/MFHRQqMYJcxzgIP4c7jkOG0lylJo3eA8hkDWp8jeuattWlXUe7trASUAUK8SgBbXsn8/nLjuAZrCvb2dvr/l9nne0zHeKtVYZYgUNW2QKgqZAqCEIQo0GDYQCFQRBEBIIJSoUEAJhmoss4qCj/eGLpOrAMIHB0BIGgw9VHa0jhto5yUYxsTfXGRnm3ykdRdSpXcMaNplqSHS0ISxTfv68d9nF/gURtv9teHg7JBnhUx96aPt+vr+WWiZO2MYWtTv7///jz/5zmWczSbgf73Qqp68T6XD4OZDkOWq4v93vIbBiAhdoaChouEHDL1yhkLeg0C4QBEG4J9Go4aADM0AQALaQ1LNvbZxt27Zt2/bb77ZNk9wHphH9h+BGkiLJmbnMe/AHgctSX1Nhl9PqMo39S4Itc9UBG5CuqjkmQ2GbJtERDnGVdps2pj6ezJTYUCknt86GTBv1HjYs+yjtiaJoVjiVosZGSBXBUgCQeXpxay7OMgGdS3iTNlXG9Z2UqwybmgG8duD035RmqhrwClSnd0DOVB14AdUl5By4As+luoXcqtx4XpQblQ8vh3YmF69MdYa6SSneBPBAV5gHmsDrdQA/XVf6ny5HksCnGPpJPju/NRb4k1wkCMZshAxTJHbiBRIEJa14RpB0+7F8yf/z96pWEPV4cTxJgpp2nCZBNuXFMFOCnmaMFpb/SVG9UIrgyITeuGARn6+Tx/Wvc1Dz38wMCiYfJ7DjH669P6RD0u7ffpj2bK4g18b8lmnmcUE1//gcK8+eNneyZNm7209SyVNeW4WsXVif8kvhmTUdiQl2C6DUvW4cxbIcsyy9hLVXqdR7HMhZtFnmQI5yB5ZZ+7Mzewe64veyfghkxToEsipfiX808veDH7nYMRT1aMRsPen6pY6p+rFVN8aqe/sWbH8ppELj7Q8=); border-color: #ee3333;">走行位置</button><button type="button" onclick="timetable_mode();" style="background-image: url(data:image/webp;base64,UklGRmgEAABXRUJQVlA4TFsEAAAvNUANEA8GOZIkRZLn8n9t9RdiNcJ7MWOlGo4jSXKU7JO/swabsJvghwFabEOOJNlVVP2QDmAJRnHGZU6a1fv1FNzatlVV8+BEN6MWOqRJIo/0u9z3doCW+np1I2ohQlWQsdbKNGgWCJX+P42xlcTvd9Kq1f9/MaPMKK1WW6myO3oIlRKka1+9ojQL9Ds+lWpUBf3rKF7uTxQRGr0qlBJFiijWFMnany8yQ8sVsRIxQ21j7rBogUTTUZWffkEqFCFoFkg1JvAHgT8IBAIjBAJ/EBigQyDBDFrLf8NfsIfgJFqpHQ6DSiiYwhcMEDJV5glz8QdecCii9CJKh1dY0Bq+F0gllQizoMLS/EIr5srVxC0stVeeI0kyW4Q338z+lmkdNMkspSlbMgibsP4ndnN8H9/scnAYXZjtnb8jYqujSVfa8N+jSYBQx0p/ay2I+YNoVVK02u47SSSxmBpzJxPub53T9aLVz2f0/R7cnU/T4+k4QKK2bWcjff8/tjJaj7G2beNb27Zt27a928039rHlTfrn3xOI6P8EkMn2B0cPbFm7ceHCjeu2HDj6QJGN7Td3ruAoVx680R7WyxNr2ei6qy/DUJdWsfHVZ5Wx+9s51C0vDF1fxiEvvmBCHeGAc/q8+/474rp/f31/22+2H/MTFdXr3ew/8FNERKSptbVJRCTycbAf73odhTrIvoN+iIi49QUdHR0dsUnZuYX17pchPrxHBTvCeMYHV0Rq85K19miYnFf7fhbiJ4FOMx75U0Rqc7Q3iNbaaRiF+FyA+4vRgD8ikfxYbULHdhqBlrzwUVsZ9v8nUpOlfaPROnMC4O0KXWY48o9IXbI2p9OnAT4P3qwCM3+K1CXpMHTXeWDzS89xhh9EapJ1OLoS8Bkial8LBrkSydJhxU0B6xXRI4Y/RPJ1aLoY8EOinWCgSG2sBTGTwTNSK8EnkRxtga4Am9Rd9s6JSK22InWBh28fBb1F8uzQ48C1veCduMmW9AT7toFvUq8tKQU7NoDfUmBLEVi7HPxtanKMBNdaO66TDlYuBG5rW7MNLW3NiWDR/7Ic/GlyHRuciJMBVm4AvyVWW1oE1m4DnyXJljKw4wB4K9m29AL7j4K+4tgyFly7C2ZHCi1JXQDuqJUe/lhvSQV7Nyk6CIa7SVbETAF7iW4C/ppnRQnDW0Tt68DQWhviJ4H1ioiuAn7vWFDN8CQR0cvVYG5jbGjd5oE1rzx0EfDozmFlTGd4hfAOwMMyw0mZyHCb8nmxBPD4jDBSxzBceo/8TyGe1t1cj+mML1DQJ4jnV8b7OS0tjl981XzGTymweo6YJxXHILetzUUxJVPZ95AKRq93+TBPLk/1OC3Njie1Ygr7H3xN0aonfswLxvUsLUpLSEjrUtZz7AIO+FSRwcfL/EwvuUJmX2wNZ8c9Mq3ObTa35gqF+erMOjPrT76ikNXDZ5ui2XT4liIb1e1j+3asX75w4Yr1O/Zdu6PIJAA=); border-color: #eebb33;">時刻表</button><button type="button" onclick="operation_data_mode();" style="background-image: url(data:image/webp;base64,UklGRr4AAABXRUJQVlA4TLIAAAAvNUANEEdAJmCxGFJp7qSKKmYCkNFB/yI6OP0SeHdOTSMp0Kk5/0au5BVAcEDJ/AeA323Mu/i3jVikZhIYRZKkaC0cGTgJ6+RIABugsbC6eXqPfxH9Z+C2bSN27/buF0IHpZRgHfAgkkRLkiR4AK7SiiQJHRADEWmBA6Louk4LHBADMzyORYekX3zhLOD3/Id/IUlKEyRiBUhidlsll1UCVjZTAlY+XQJWgCTA5kGMEIEA); border-color: #33cc66;">運用データ</button><button type="button" onclick="formation_table_mode();" style="background-image: url(data:image/webp;base64,UklGRpQBAABXRUJQVlA4TIcBAAAvNUANEK/BoJEkRbUn4wWeitf6eQfMtDYYNJKkqPa0nJLX/xo+74CZlkEjSYpqz8D7F/NSyAEzLdta2158cuhypoqdWQxiOwNYwD+ANlNSpjdAVYPaDtR1rTgMw4sXPy5kmVkjL6UAKtLMNMDDhZ6ZXynle9+3zczzPM97WRZpnufnOI7q//8/M0fcAIAPPb6IAKTv+5rMpIhI5nmeMpP6vg/+/+ewYgPAIgJg//8DQ0SgbequqRUZXEmSpCoLPFfc3d25/+FWnj/gryei/4zctnEknabtassr2Be03SBkUGWbGsgWSLPKMbQWNHIEUquq+RqCnniOk1JVp67pHgPgGlrTEkilKlS8K5u0UCR+VVZkNchoSzYXyvrvqv4cvgFIVwJSihD4ANKVAKQT8YdRMCs/hvS1ZOdTBl4YrllwY7hnwYPhuRtRV1NJI9qriZX1YjisR9RX0ifaqImVdWTAmASn6gRJJMlaiSyVCRJIlDWYcWZbZYIEkmVtFxPMh+oEScTO+mICAA==); border-color: #0066dd;">編成表</button><button type="button" onclick="operation_table_mode();" style="background-image: url(data:image/webp;base64,UklGRmQAAABXRUJQVlA4TFcAAAAvNUANEB8gECDs6xFnRUhA+P9NtEUVEhD+D1VFdf4D8C9pwCiSrFYEDehJGliP1LOBLarmDD8eI/ovICj0wAx3mQVMIC8gPj23ZZhZk5S6JP/0fuifqzgA); border-color: #9933cc;">運用表</button></div>
    <article>
        <div class='line_select_wrapper'><select id="position_line_select" onchange="position_change_lines(this.value);"></select></div>
        <div id="position_area" class="wait_icon"></div>
        <div id="position_area_supplement">
            <input type="checkbox" id="show_train_types_check" onchange="change_show_train_types(this.checked);"><label for="show_train_types_check">列車番号の代わりに<span id="show_train_types_label_train_type">種別</span><span id="show_train_types_label_final_destination">行き先</span>を表示</label>
            <br>
            <div class="informational_text">列車の走行位置は時刻表に基づく推定であり、遅延や不定期列車の情報は反映されません</div>
        </div>
    </article>
    <article>
        <div class='line_select_wrapper'><select id="timetable_line_select" onchange="timetable_change_lines(this.value);"></select></div>
        <div id="direction_radio_area">
            <h2 id="timetable_station_name"></h2>
            <input type="radio" name="direction_radio" id="radio_inbound" value="inbound" checked="checked" onchange="timetable_select_station(timetable_selected_station);"><label for="radio_inbound" id="radio_inbound_label">上り</label>
            <input type="radio" name="direction_radio" id="radio_outbound" value="outbound" onchange="timetable_select_station(timetable_selected_station);"><label for="radio_outbound" id="radio_outbound_label">下り</label>
            <input type="checkbox" id="show_arriving_trains_check" onchange="change_show_arriving_trains(this.checked);"><label for="show_arriving_trains_check">当駅止まりを表示</label>
        </div>
        <div id="timetable_area" class="wait_icon"></div>
    </article>
    <article id="operation_data_area" class="wait_icon"></article>
    <article id="formation_table_wrapper" onscroll="formation_table_wrapper_onscroll();">
        <div id="formation_search_area">
            <div class='search_wrapper'><label for="car_number_search" class="search_icon">車両番号で検索</label><input type="search" id="car_number_search" onkeyup="draw_formation_table();" autocomplete="off" placeholder="車両番号で検索"></div>
        </div>
        <div id="formation_table_area" class="wait_icon"></div>
    </article>
    <article>
        <div id="operation_search_area">
            <div class='search_wrapper'><label for="train_number_search" class="search_icon">列車番号で検索</label><input type="search" id="train_number_search" onkeyup="operation_table_list_number();" autocomplete="off" placeholder="列車番号で検索"></div>
            <input type="checkbox" id="operation_search_menu"><label for="operation_search_menu" class="drop_down">絞り込み条件 <span id="operation_search_filter_count"></span></label>
            <div>
                <select class="wide_select" id="operation_search_group_name" onchange="operation_table_list_number();"><option value="" selected="selected"></option></select>
                <select class="wide_select" id="operation_search_car_count" onchange="operation_table_list_number();"><option value="" selected="selected"></option></select>
                <select class="wide_select" id="operation_search_starting_location" onchange="operation_table_list_number();"><option value="" selected="selected"></option></select>
                <select class="wide_select" id="operation_search_terminal_location" onchange="operation_table_list_number();"><option value="" selected="selected"></option></select>
                <a href="javascript:void(0);" class="additional_setting_link" onclick="reset_operation_narrow_down(false);">絞り込み条件のリセット</a>
            </div>
        </div>
        <div id="operation_table_area" class="wait_icon"></div>
        <br>
        <div id="operation_table_info" class="informational_text"></div>
    </article>
    <footer>
        <div>
            <button id="position_reload_button" class="reload_button" onclick="position_reload();"></button>
            <span class="footer_select">今日</span><button type="button" class="previous_button" onclick="position_change_time(-60);"></button><span id="position_hours" class="footer_value"></span><button type="button" class="next_button" onclick="position_change_time(60);"></button><button type="button" class="previous_button" onclick="position_change_time(-5);"></button><span id="position_minutes" class="footer_value"></span><button type="button" class="next_button" onclick="position_change_time(5);"></button>
            <input type="time" id="position_time_button" class="time_button" onchange="position_time_button_change();">
        </div>
        <div>
            <button id="timetable_back_button" class="back_button" onclick="timetable_change_lines(timetable_line_select_elm.value, true);"></button>
            <button type="button" class="previous_button" onclick="timetable_operation_previous();"></button><span id="timetable_operation_name" class="footer_value_wide"></span><button type="button" class="next_button" onclick="timetable_operation_next();"></button>
        </div>
        <div>
            <button class="reload_button" onclick="operation_data_change_date(null);"></button>
            <button type="button" class="previous_button" onclick="operation_data_change_date(-1);"></button><span id="operation_data_date" class="footer_value_wide"></span><button type="button" class="next_button" onclick="operation_data_change_date(1);"></button>
            <input type="date" id="operation_date_button" class="date_button" onchange="operation_date_button_change();">
        </div>
        <div>
            <button id="formation_back_button" class="back_button" onclick="draw_formation_table();"></button>
        </div>
        <div>
            <button type="button" class="previous_button" onclick="operation_table_previous();"></button><span id="operation_table_name" class="footer_value_wide"></span><button type="button" class="next_button" onclick="operation_table_next();"></button>
        </div>
    </footer>
    <div id="popup_background"></div>
    <div class="popup" id="railroad_select_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>路線系統の切り替え</h2>
        <div id="railroad_select_area"></div>
    </div>
    <div class="popup" id="operation_detail_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <div id="operation_detail_area" class="wait_icon"></div>
    </div>
    <div class="popup" id="sign_up_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>新規ユーザー登録</h2>
        <h3>ユーザーID</h3>
        <div class="informational_text">半角英数字とアンダーバーの組み合わせで5文字以上が利用可能です。</div>
        <input type="text" id="sign_up_user_id" autocomplete="username">
        <h3>ハンドルネーム</h3>
        <input type="text" id="sign_up_user_name" autocomplete="nickname">
        <h3>パスワード</h3>
        <div class="informational_text">大文字・小文字・数字を全て含む10文字以上を設定してください。</div>
        <input type="password" id="sign_up_password" autocomplete="new-password">
        <br>
        <button type="button" class="wide_button" onclick="check_sign_up();">ユーザー登録</button>
    </div>
    <div class="popup" id="edit_user_data_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>ユーザー情報の編集</h2>
        <h3>ユーザーID</h3>
        <input type="text" id="edit_user_data_user_id" disabled="disabled">
        <div class="informational_text">ユーザーIDを変更することはできません。</div>
        <h3>パスワード</h3>
        <div class="value_and_button">
            <b>＊＊＊＊＊＊</b>
            <button onclick="open_square_popup('change_password_popup');">変更</button>
        </div>
        <h3>ハンドルネーム</h3>
        <input type="text" id="edit_user_data_user_name" autocomplete="nickname">
        <h3>メールアドレス(省略可能)</h3>
        <input type="text" id="edit_user_data_email_address" autocomplete="email">
        <div class="informational_text">メールアドレスは他のユーザーには公開されません。</div>
        <h3>webサイトのURL(省略可能)</h3>
        <input type="text" id="edit_user_data_website_url" autocomplete="url">
        <div class="informational_text">ブログやSNSのURLを登録することができます。</div>
        <br>
        <button type="button" class="wide_button" onclick="change_user_data();">保存</button>
    </div>
    <div class="popup" id="config_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>各種設定</h2>
        <input type="checkbox" id="dark_mode_check" onchange="change_config();"><label for="dark_mode_check">ダークモード</label>
        <input type="checkbox" id="colorize_beginners_posts_check" onchange="change_config();"><label for="colorize_beginners_posts_check">ビギナーの方の投稿を区別する</label>
        <h3>運用情報の自動更新間隔</h3>
        <input type="number" id="refresh_interval" min="1" max="60" onchange="change_config();">分ごと<br>
        <h3>運用情報のキャッシュ保管日数</h3>
        <input type="number" id="operation_data_cache_period" min="1" max="30" onchange="change_config();">日前以降のキャッシュを保管<br>
        <a href="javascript:void(0);" class="additional_setting_link" onclick="reset_config_value();">デフォルト値に戻す</a>
        <a href="javascript:void(0);" class="additional_setting_link" onclick="reset_cache_db();">キャッシュデータベースの初期化</a>
        <div class="informational_text">変更内容は自動で保存されます</div>
    </div>
    <div class="popup" id="about_railroad_data_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <div id="about_railroad_data_area"></div>
    </div>
    <div class="popup" id="write_operation_data_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>運用情報の投稿</h2>
        <div id="write_operation_data_area"></div>
    </div>
    <div class="popup" id="edit_operation_data_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>運用情報の取り消し</h2>
        <div id="edit_operation_data_area"></div>
    </div>
    <div class="popup" id="rules_popup">
        <button type="button" class="popup_close_button" onclick="popup_close();"></button>
        <h2>ルールとポリシー</h2>
        <div id="rules_area" class="wait_icon long_text"></div>
    </div>
    <div id="popup_screen">
        <div id="popup_screen_blank_area" onclick="close_square_popup();"></div>
        <div class="preview_popup" id="announcements_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h3 id="announcements_heading">お知らせの一覧</h3>
            <div id="announcements_area" class="wait_icon"></div>
        </div>
        <div class="square_popup" id="login_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h4>IDまたはメールアドレス</h4>
            <input type="text" id="login_user_id" autocomplete="username">
            <h4>パスワード</h4>
            <input type="password" id="login_password" autocomplete="current-password">
            <br>
            <br>
            <button type="button" class="wide_button" onclick="challenge_login();">ログイン</button>
        </div>
        <div class="square_popup" id="change_password_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h4>現在のパスワード</h4>
            <input type="password" id="old_password" autocomplete="current-password">
            <h4>新しいパスワード</h4>
            <input type="password" id="new_password" autocomplete="new-password">
            <br>
            <br>
            <button type="button" class="wide_button" onclick="change_password();">保存</button>
        </div>
        <div class="square_popup" id="captcha_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <div id="captcha_info">
                <h3>画像認証</h3>
                <div class="informational_text">画像に表示されている文字を入力してください。</div>
            </div>
            <div id="captcha_area" class="wait_icon"></div>
            <button type="button" id="captcha_submit_button" class="wide_button">送信</button>
        </div>
        <div class="square_popup" id="select_lines_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h3>路線の選択</h3>
            <div id="select_lines_area"></div>
        </div>
        <div class="preview_popup" id="train_detail_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <span id="train_detail_day"></span>
            <div id="train_detail_area" class="wait_icon"></div>
        </div>
        <div class="square_popup" id="select_operation_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <h3>情報を投稿する運用の選択</h3>
            <div id="select_operation_area"></div>
        </div>
        <div class="square_popup" id="about_popup">
            <button type="button" class="popup_close_button" onclick="close_square_popup();"></button>
            <img src="apple-touch-icon.webp" alt="" id="unyo_icon">
            <h3 id="app_version"></h3>
            <small id="license_text"></small>
            <a id="license_link" target="_blank" class="external_link">ライセンス</a>　<a id="repository_link" target="_blank" class="external_link">ソースコード</a>
        </div>
    </div>
    <div id="wait_screen"></div>
    <div id="message_area"></div>
<script>
document.getElementsByTagName("title")[0].innerText = UNYOHUB_APP_NAME;
document.getElementById("app_name").innerText = UNYOHUB_APP_NAME;
document.getElementById("app_version").innerText = UNYOHUB_APP_NAME + " " + UNYOHUB_VERSION;
document.getElementById("license_text").innerText = UNYOHUB_LICENSE_TEXT;
document.getElementById("license_link").href = UNYOHUB_LICENSE_URL;
document.getElementById("repository_link").href = UNYOHUB_REPOSITORY_URL;
document.getElementById("splash_screen_app_version").innerText = "v" + UNYOHUB_VERSION;


const UNYOHUB_GENERIC_TRAIN_ICON = "data:image/webp;base64,UklGRngCAABXRUJQVlA4TGwCAAAvT8AdEJVIkm07bhst/QLu7Zlm2YK2CYgQP35pmv/Uls0uAgq2bcee31a2bc5bstkct2Tbjl60ze4t2bZtPRMQ53o2pNDRH8YI4BcYfVlNvSh4lsHnZOiTzqZEzTzPErPzCSdpnudFuv2aAcWwxMQBHRES3XFCAYqI2yb9LVYokNiCsUOMFV9U1gCRbyT58wfwklUxXrzIeBT/hJhAzpP4X8NCrHfNyC3QJFEQ1ayTuGA6LbObznnkdUvfgH63jYflyhLTdynrKjFLNFlYeaEZVAQYHCljCxiRIxqS7x6/Q8TtwgsBFkr86Ltq9OvtEXZBcQmY5OqAtoMjYDQ72KHCCuV22LTCthnkMvsis5JS7ZBihWk7TNn4w5E/O+kP50/6OAd0NqTIiQlOZPzB+ERENiwn2eMJoYs7dcstnSkYXAsUMrhR5/eU/kMehCPHgIMcZYcB+PEjF/nG58iLhA85yfuLqEY34OZvBcrFDz6/qAX2chTbIvl7ci9SqCfz/5EQ5EkKLPDxJHkXuHmSXIvs4slcoPck64pXnidwC2iefFGL4M2PKaps+sFGjUk/mKjR6AcNNbL8SJk1wvyYatnkB8baHs+PFxcItWDdC9biKB1eLMdSvBfEHYvg3gPuYjCLHrAwbPGA9mEUeUDhsBTtAVHDcPYgOw17ZXkAc9gOyVt/0w45LFjtj5VoZKA/+luo7o+qFmL7SzEtyb0/3FpeRP0hbAHDd2/8/MO2BLu9sRPNTPbGRBu1vVHTlhJ7I6ENbgodXsyjFvPwra21iFGLMH3+8CrxMs4mXW1RLVE5zio9bQW2lxj5colzHQ==";

const UNYOHUB_UNKNOWN_TRAIN_ICON = "data:image/webp;base64,UklGRqADAABXRUJQVlA4TJMDAAAvT8AdELVQuq03kST1T3+OaO5eMQ8zM/OOeXbMzMwQUY6wrMGVWo2FMUWRldBVEVIACCDAyGa2bXtLNpvjlmzb0Yu22b0l27b9uAmwv+qFRQhPPi+MIP5C8vFEVGnAqwvsBoK2y7PtTt1wOHRnftjiwH04HI7cp5fEIMSoO1PXCJuZO73WooOb2fSG++pYCkXu7KBgqWyHLBvgFAoJgfwD3gojS2elHs/Of8JEoM+L839iEmwy62voS6DFfWi1hZk7V8yGVfbDJc+8r4df8OX1dZ5GZ1lhdta9MKuxoTstEia80YqQGSI4U3HCE3JCU/DfI242fZo3giRUCWDgrCc/Oz1vchHi2kVyc42wHJxdaOEkhyopVMphWwq7YtB3saWelJAuhzQpzMphRsbKSf7JCf9wXUozLixCdL/KmQufZ7InqrAYt7JHnDB6ePBsuac7hCLWBBmyuPPMZ0LmLumok5y6gpwUThEE8MdV5Be/KUodvlxJPkutOnpBzeUaZE7rwfcO2QqOrij2lRDY2m5u5kU+4Ft+4Vcad9/wHs9zAztpLQRWQnhLl/A6v9An7F7mOC0N2zvA/K8kf4k9iLqeH+gFfs81CHqYX5HZ3YuYW+mldjch5FI6Mf3PXIiIko/4FcEfUiBhoRd9JwJKvkbWV/yf7ir62F94nEOUeOPNHOVZovorSPcEMd3EW76NqMdI9zYxj+Ktv0DMW6QbxeyjvaWYr0k3HTEdaG8HMT+Tro9c9fa3ENP/9ZP592sjZlqHpZhlHZ4j5oQKN9PHPk4e21k7FXF+8Cx99JXk8Ah9yuUSbe7HlfmMrSgzfTGuzO24Mg/iunzPdbgur7AX0KR7hQvwdrPoRu/xHDewE29b3l146v9oEJJMdAiu4KdJ8K3goUlwrxRumqxVMNekMKtsVtME1QpymuyQrRgfevRWy3aqR/iVyLtIxVYd03owVUezHjTVkaNHyK4jQo9BXWGlB5Z1e8T5o8UpJOqMTS3YsCnpSiR4PFVI1IKEqcx41IAHi2ZZA5bixhrQGUeJBhTHhVgNiInDVYPCJW6zkgYoxm0S5CO/fhBnrOfHmjVkKD8Gm1CbHzVNiM8vxDUJnvnh0aTUyg/NJojwm9upw6JNjP3c2LPG87mtNqM+N+qaheTcSGqGagiPrwyTVobxG82aVixpxUT/9eHdnbc06+5nZVHrTnWa8+4Lsgz705b49Gn7qw4A";

const UNYOHUB_CANCELED_TRAIN_ICON = "data:image/webp;base64,UklGRjoEAABXRUJQVlA4TC4EAAAvT8AdEEfEKJJsJ73k6IIz/r1gAAUcMyLYRratZHHJ6b8W6iB0J3dHkSTLStbf2F1wxr8XDKCA4x+3se06ivS+8JB5E0EEFWwN9EcH1ERGF2uF9mkdIFA/ga4+29Jq2EWJR/SM8jJX3C+j0Q4LKDZQrFGgUGi+foi8Gc4ut9L6BZECgEbiR4wR/ASJLK+1K9/1f1T/6nR+lvpdd+f17TFWtnLlU+b29SqDNfOV53fKuD/afDkc/KCHo0aACBBx/VMj4Nc/hFfxpgCAHgQRvw8CRAUAMBgMhjkAAJgCmAIApjAABiQoQQSIFjV6EAThIByRIAcRCapBRIL6BEURLp4gDuW935qv7NMvHNK2bTsbKWPbWO+ObWtt22ZmbXt/9zbN+zz3m2M+P32iiP5DcNtGkqRIM3vv3FOo/oGzUc/PA+yJwRx94rInDaGcfiSAeXwKyLkFkWsHVEXuKmFCEVVNRZJzMPJuibwKVVXkjRImFVFVvSFy+wKKK57rzObvoisfUX9h3X12yuGjpx/J+gHMX3gm60cdJn7X9zSC6yJ71cNJkfm3t+++iJ+nj12J03Q+F95+G7tyUj2zV+Qd5PNHK3mq5w+vzbmMCdfS86p58fNvChp5/RjwsE++KW7Chy5kZi7gOC6gSXB8QLEHx30UL3CvQgKbGMUlHJ9QLOG4Q6Wkoqa5fqC0wMv5H09wpFHopaB0oD6pqYgz5Jc1tXimqvPU/vd3Zl3w5F6u7Q87U+8lj8vyHS2X7Nk54VqaXOJz0dUpbvRBuiyZ62rxIYwqRPy1nUhUKyZtJ1GDGLWcNNSJWbtJMiAErSZhqVC0maQFlSQtlqTa307SWrE6qsM9hMuzYwzBZDfl4g45/zkwSdNO4wc8uESt5GZB1UbZkMXnA110fjDE5gtHZP6wxGWAJyoTTDEZ4YrIDFt+BPhyowCQFwmEnGhApEcEIzUqEDdtpkUGIy06NCExIAqIA1V2LMgy40GXFROGjLhwJMeG4xYK21I3YGwfs8hkN/GTmA0vqlxY0WXCiSMPRjxZ0OPKgRxfBtQQ0sG0dRdJFoDFjPaQZAFYzBBlwV7MkGXBXMwwpPAVshCEeTDDEcS6Emcuw3fAuhLooQzH+CE95tmeZQc1l+EsN6y/M/xhBvavk5lpVmCTrG1QTmgTL8uM4N728o4e3lUvl8lZ8LKXEWo2HPVQ2EbMiq1F/+mvDtI+UrU6wdvnCt4+XPD2CYO3jxm8fdbg7QMHb586ePvoWm7Iuup7HKJ30rU2mvgch8g+TtLRNzjlWpwo7ks9x0l85p5rfWI1zE37RCZ22+eqiS/22WfisH2+mzhjn18mLjy1zZN/apoHtnmgRpZtc9vMe9usmblom89mfh/wHxERNQ33cuUc5mRAX66NnsciMf9yYdktchVwubBzQgCXa4MeBQ==";


/* Zizai CAPTCHA 23.10-2 captcha.js */

const ZIZAI_CAPTCHA_GENERATE_ID_ENDPOINT = "api/zizai_captcha/generate_id.php";
const ZIZAI_CAPTCHA_IMAGE_PATH = "api/zizai_captcha/image.php";

const ZIZAI_CAPTCHA_RELOAD_IMAGE_DARK = "data:image/webp;base64,UklGRkQCAABXRUJQVlA4TDgCAAAvX8AXENXIkSTJkZx5zKkg01FzC479xP7/MbR3tkCkswJpDZxzjmMSeCkJuwg4AAAQTGZv2bZt87Jt27brsm3btm132babgNgrYE83KONCItmUUk++pRBdzEwUPHfOUOFstZzzvzJ/rJNmmlOEH+eRxZohflWTh1I0yPkwweHJqeqzYhYz8GqJzxZMIYfca7OsFZlV0qbvjW+QZENcMkfLPRpsjF0+a+l+Ke9JlqRNa3S3Skhpez3QxGKgPZ/Zlhpuqkg/TH5BNo3uLL7Z9HSx5q2i+IfnGuKHsA4YMcHZtEb3bEIWNS9izZvDChKFLye4pvG9jMovH3FcQdbetAUb/E4wr+st9SLiLL31eBdRrHn2LnZZWfIuduCUeBdxyI93UQz58i5MhTfvklXnkhn5lvvyLfflW+7Lt9yXcwMX+lV7CU9ufr94V/WfJ/dUk8VTBM7ZdIZvLcO3luFby/DtUYZzfKDlnfjG0jvxZ1Ed0Dnp53fvxKZxeydezMY7iZGX3unbV1CutNK4nsQJdkBrTSFb0HIGfltB4gjfrALFeeT4WkaEBZxUkP5S1ivNwOsMjI/Ai9G1jHmkv9SQxK3VfjaBV0vuF2u6in8HitHZdMbiXSIr5q/KPJ8cMPH+Xmm7zbVYNdEY/b2WsWIvcbvW0mNcbsX48clYuQOaxv4GOCfoR7h4Qj53Vfih/88U0QHc3IGjWpJZ4Xc1Tqkq9gN5ePu/CJlxiSTJ8u5RYpkkmGNRnFDHXgEB";
const ZIZAI_CAPTCHA_RELOAD_IMAGE_LIGHT = "data:image/webp;base64,UklGRgACAABXRUJQVlA4TPQBAAAvX8AXEFVActtIkpT//zR7rY7O9iynQVRMhCTYtk27OrF3bNu22bJt27aTlm3btnHi5Jst2/aZgP4rIFFWolVo0mNMm2pFfOlgjUNQlBEvkMP+u6GWA/ocGATZ9G8qfdTJNAOQ4BlS74o/qmNA8gegluAD8l7XGR8BsLH9GLiJeOXEtDHjdt3zq2r814f7CYCR7VDJNsuX8EKP0VAVYtjbkhnPmD0AMLIdNsFE+0VULPT4UjH+ykWxUAMY2Q493q7EIsmjghkdqAGM7Hd28SnYk4IxByMf8EYMsnx77WmKbmKW03UL8iVdk3GRrtHpTtctwd90zcPvdM3a93TAtXDA0WQD52QD52QD52QD54SjyK2UfpLf7+FWSjHJP1LpHHs4GHQ2GHQ2GHQ2GHQ218BC4fzkmG78EZBu/FeIItyMYQzpxi1K6cZXwelmbJNJN77JxhgFNvHajKdC0VSh/gAYoNJUMOOxlP8S/Bj2g0F3S/enYMZXvSxRvUJCMNbeDgZ9z8jjipnxzohQ6miekBBkURrKhbaDQT/Gqcv/knu/PLRvwphZF96Ma3QW2t4YDPogfRdVT70Tjar3lwz6MAr2jt7ghUysC0VkpM37En+tCUC/UEx0bFS58u+YZwaF4VsoLRaavBSo1GpMtwblIlgQWuivgA==";

var zizai_captcha_dir;
(function(){
    var path_splitted = location.href.split("/"); //captcha.jsから改変
    path_splitted[path_splitted.length - 1] = "";
    
    zizai_captcha_dir = path_splitted.join("/");
}());

function zizai_captcha_get_id (callback_func, args = null) {
    var request_obj = new XMLHttpRequest();
    
    request_obj.onreadystatechange = function () {
        if (request_obj.readyState === 4) {
            if (request_obj.status === 200) {
                if (args === null) {
                    callback_func(JSON.parse(request_obj.responseText));
                } else {
                    callback_func(JSON.parse(request_obj.responseText), args);
                }
            } else {
                callback_func(false);
            }
        }
    };
    
    request_obj.open("GET", zizai_captcha_dir + ZIZAI_CAPTCHA_GENERATE_ID_ENDPOINT, true);
    request_obj.timeout = 10000;
    request_obj.send();
}

function zizai_captcha_get_image_path (session_id) {
    return zizai_captcha_dir + ZIZAI_CAPTCHA_IMAGE_PATH + "/" + session_id;
}

function zizai_captcha_reload_image_callback (data, args) {
    document.getElementById(args[0]).src = zizai_captcha_get_image_path(data.session_id);
    
    if (args[1] !== null) {
        document.getElementById(args[1]).value = data.session_id;
    }
}

function zizai_captcha_reload_image (image_id, session_id_id = null) {
    zizai_captcha_get_id(zizai_captcha_reload_image_callback, [image_id, session_id_id]);
}

function zizai_captcha_get_html_callback (data, args) {
    var image_path = zizai_captcha_get_image_path(data.session_id);
    var input_font_size = Math.round(data.image_height * 0.6);
    
    var rgb_sum = 0;
    for (var cnt = 0; cnt < 3; cnt++) {
        rgb_sum += parseInt(args[4].substring(cnt * 2 + 1, cnt * 2 + 3), 16);
    }
    
    if (rgb_sum > 382) {
        var button_image = ZIZAI_CAPTCHA_RELOAD_IMAGE_DARK;
    } else {
        var button_image = ZIZAI_CAPTCHA_RELOAD_IMAGE_LIGHT;
    }
    
    if (button_image.substring(0, 5) !== "data:") {
        button_image = zizai_captcha_dir + button_image;
    }
    
    args[0](`
<input type="hidden" name="${args[1]}" id="${args[1]}" value="${data.session_id}">
<img src="${image_path}" alt="" id="${args[3]}" style="vertical-align: text-bottom;"><button type="button" onclick="zizai_captcha_reload_image('${args[3]}', '${args[1]}');" style="box-sizing: border-box; width: ${data.image_height}px; height: ${data.image_height}px; background-color: ${args[4]}; background-image: url('${button_image}'); background-size: cover; border: none; margin-left: 5px; vertical-align: text-bottom; cursor: pointer;"></button><br>
<input type="text" name="${args[2]}" id="${args[2]}" style="box-sizing: border-box; width: ${data.image_width}px; height: ${data.image_height}px; font-size: ${input_font_size}px; letter-spacing: 0.5em; text-align: center;">
`);
}

function zizai_captcha_get_html (callback_func, button_color = "#dddddd", id_name = "zizai_captcha_id", characters_name = "zizai_captcha_characters", image_id = "zizai_captcha_image") {
    zizai_captcha_get_id(zizai_captcha_get_html_callback, [callback_func, id_name, characters_name, image_id, button_color]);
}

/* captcha.js ここまで */


function escape_html (text) {
    return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function escape_form_data (data) {
    return encodeURIComponent(data).replace(/%20/g, "+");
}

function add_slashes (text) {
    return text.replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "\\\"");
}

function convert_to_html (text) {
    var text_splitted = escape_html(text).replace(/https?:\/\/[^\s\\`\|\[\]\{\}\^]+/g, " <a href='$&' target='_blank' class='external_link'>$&</a> ").split("\n");
    
    for (var cnt = 0; cnt < text_splitted.length; cnt++) {
        if (text_splitted[cnt].substring(0, 2) === "# ") {
            text_splitted[cnt] = "<h4>" + text_splitted[cnt].substring(2) + "</h4>";
        } else if (cnt + 1 < text_splitted.length && text_splitted[cnt + 1].substring(2) !== "# ") {
            text_splitted[cnt] += "<br>";
        }
    }
    
    return text_splitted.join("");
}


function get_timestamp () {
    return Math.floor(Date.now() / 1000);
}

function get_date_string (ts) {
    var dt = new Date((ts - 10800) * 1000);
    return dt.getFullYear() + "-" + ("0" + String(dt.getMonth() + 1)).slice(-2) + "-" + ("0" + dt.getDate()).slice(-2);
}

function get_hh_mm (ts = null) {
    if (ts === null) {
        var dt = new Date();
    } else {
        var dt = new Date(ts * 1000);
    }
    
    var hours = dt.getHours();
    var minutes = ("0" + dt.getMinutes()).slice(-2);

    if (hours < 3) {
        hours += 24;
    }
    hours = ("0" + hours).slice(-2);

    return hours + ":" + minutes;
}

function get_date_and_time (ts_or_date_str) {
    if (typeof ts_or_date_str === "string") {
        var dt = new Date(ts_or_date_str);
    } else if (ts_or_date_str === null) {
        return "データなし";
    } else {
        var dt = new Date(ts_or_date_str * 1000);
    }
    
    var date_str = dt.getFullYear() + "/" + (dt.getMonth() + 1) + "/" + dt.getDate();
    
    var now_ts = get_timestamp();
    var dt_2 = new Date(now_ts * 1000);
    if (date_str === dt_2.getFullYear() + "/" + (dt_2.getMonth() + 1) + "/" + dt_2.getDate()) {
        date_str = "今日";
    } else {
        dt_2 = new Date((now_ts - 86400) * 1000);
        if (date_str === dt_2.getFullYear() + "/" + (dt_2.getMonth() + 1) + "/" + dt_2.getDate()) {
            date_str = "昨日";
        } else {
            dt_2 = new Date((now_ts - 172800) * 1000);
            if (date_str === dt_2.getFullYear() + "/" + (dt_2.getMonth() + 1) + "/" + dt_2.getDate()) {
                date_str = "一昨日";
            }
        }
    }
    
    return date_str + " " + ("0" + dt.getHours()).slice(-2) + ":" + ("0" + dt.getMinutes()).slice(-2);
}


function get_default_config () {
    return {
        "unyohub_version" : UNYOHUB_VERSION,
        "guest_id" : null,
        "dark_mode" : false,
        "refresh_interval" : 5,
        "operation_data_cache_period" : 7,
        "show_train_types_in_position_mode" : false,
        "show_arriving_trains_on_timetable" : false,
        "colorize_beginners_posts" : false,
        "simplify_operation_details" : false
    };
}

function save_config () {
    localStorage.setItem("unyohub_config", JSON.stringify(config));
}

var config = new Object();
(function () {
    var config_json = localStorage.getItem("unyohub_config");
    
    if (config_json !== null) {
        config = JSON.parse(config_json);
    }
    
    if (!("unyohub_version" in config) || config["unyohub_version"] !== UNYOHUB_VERSION) {
        var default_config = get_default_config();
        
        config = Object.assign({}, default_config, config);
        
        Object.keys(config).forEach(function (key) {
            if (!(key in default_config)) {
                delete config[key];
            }
        });
        
        config["unyohub_version"] = UNYOHUB_VERSION;
        
        save_config();
    }
}());


function get_guest_id () {
    if (config["guest_id"] === null) {
        config["guest_id"] = "*" + Math.floor(Math.random() * 1000000000000);
        
        save_config();
    }
    
    return config["guest_id"];
}


var message_area_elm = document.getElementById("message_area");
var message_elm_list = [];

function mes (message_text, is_error = false, display_time = 10) {
    var box_elm = document.createElement("div");
    
    box_elm.innerText = message_text;
    
    var close_button_elm = document.createElement("button");
    
    box_elm.appendChild(close_button_elm);
    close_button_elm.className = "message_close_button";
    close_button_elm.onclick = function () {
        delete_mes(box_elm);
    }
    
    if (is_error) {
        box_elm.className = "error_message";
        
        console.error(UNYOHUB_APP_NAME + ": " + message_text);
    }
    
    if (message_elm_list.length >= 3) {
        delete_mes(message_elm_list[0]);
    }
    
    message_area_elm.prepend(box_elm);
    message_elm_list.push(box_elm);
    
    setTimeout(delete_mes, display_time * 1000, box_elm);
}

function delete_mes (box_elm) {
    var message_index = message_elm_list.indexOf(box_elm);
    
    if (message_index !== -1) {
        message_area_elm.removeChild(box_elm);
        message_elm_list.splice(message_index, 1);
    }
}


(function () {
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onerror = function () {
        mes("ご利用のブラウザではIndexedDBが使用できないため" + UNYOHUB_APP_NAME + "は正常に動作できません", true);
    };
    
    open_request.onupgradeneeded = function () {
        var db = open_request.result;
        
        db.createObjectStore("railroads", {keyPath : "railroad_id"});
        db.createObjectStore("train_icons", {keyPath : "railroad_id"});
        db.createObjectStore("formations", {keyPath : "railroad_id"});
        db.createObjectStore("operations", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("line_operations", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("operation_groups", {keyPath : ["railroad_id", "operation_table"]});
        db.createObjectStore("timetables", {keyPath : ["railroad_id", "operation_table"]});
        var operation_data_store = db.createObjectStore("operation_data", {keyPath : ["railroad_id", "operation_date"]});
        operation_data_store.createIndex("idx_od1", "operation_date");
    };
    
    open_request.onsuccess = function () {
        var transaction = open_request.result.transaction("operation_data", "readwrite");
        open_request.result.close();
        
        var operation_data_store = transaction.objectStore("operation_data");
        var idx_od1 = operation_data_store.index("idx_od1");
        
        cursor_request = idx_od1.openCursor(IDBKeyRange.upperBound(get_date_string(get_timestamp() - 10800 - 86400 * (config["operation_data_cache_period"])), true), "next");
        
        cursor_request.onsuccess = function () {
            var cursor = cursor_request.result;
            
            if (cursor !== null) {
                operation_data_store.delete([cursor.value["railroad_id"], cursor.value["operation_date"]]);
                cursor.continue();
            }
        };
    };
}());


var railroad_info = null;
var train_icons = null;
var formations = null;


function ajax_fetch (end_point_url, query_str, callback_func) {
    var ajax_request = new XMLHttpRequest();
    ajax_request.onloadend = function () {
        if (ajax_request.responseText.substring(0, 6) === "ERROR:") {
            mes(ajax_request.responseText, true);
            callback_func(false, null);
        } else if (ajax_request.status === 0) {
            mes("ERROR: ネットワークが不安定です", true);
            callback_func(false, null);
        } else if (ajax_request.status !== 200) {
            mes("ERROR: データの取得に失敗しました(" + ajax_request.status + ")", true);
            callback_func(false, null);
        } else {
            callback_func(ajax_request.responseText, ajax_request.getResponseHeader("last-modified"));
        }
    };
    
    if (query_str !== null) {
        ajax_request.open("POST", end_point_url, true);
        ajax_request.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");
        ajax_request.timeout = 10000;
        ajax_request.send(query_str);
    } else {
        ajax_request.open("GET", end_point_url, true);
        ajax_request.timeout = 10000;
        ajax_request.send();
    }
}


function idb_start_transaction (tables, writable, callback_func) {
    var open_request = indexedDB.open("unyohub_caches", UNYOHUB_INDEXEDDB_VERSION);
    
    open_request.onsuccess = function () {
        if (writable) {
            var transaction = open_request.result.transaction(tables, "readwrite");
        } else {
            var transaction = open_request.result.transaction(tables, "readonly");
        }
        
        open_request.result.close();
        
        callback_func(transaction);
    };
}


function rgb2hsl (color_hex) {
    var r = parseInt(color_hex.substring(1, 3), 16);
    var g = parseInt(color_hex.substring(3, 5), 16);
    var b = parseInt(color_hex.substring(5), 16);
    
    var rgb_max = Math.max(r, g, b);
    var rgb_min = Math.min(r, g, b);
    
    var h = 0;
    var s = 0;
    
    var l = Math.round((rgb_max + rgb_min) / 2);
    
    if (rgb_max !== rgb_min) {
        if (r === rgb_max) {
            h = Math.round((g - b) / (rgb_max - rgb_min) * 60);
        } else if (g === rgb_max) {
            h = Math.round((b - r) / (rgb_max - rgb_min) * 60 + 120);
        } else {
            h = Math.round((r - g) / (rgb_max - rgb_min) * 60 + 240);
        }
        
        if (h < 0) {
            h += 360;
        }
        
        if (l <= 127) {
            s = Math.round((rgb_max - rgb_min) / (rgb_max + rgb_min) * 255);
        } else {
            s = Math.round((rgb_max - rgb_min) / (510 - rgb_max - rgb_min) * 255);
        }
    }
    
    return [h, s, l];
}

function convert_color_dark_mode (color_hex) {
    var hsl = rgb2hsl(color_hex);
    
    return "hsl(" + hsl[0] + "deg " + Math.round(Math.min(hsl[1] * 0.75, 127) / 2.55) + "% " + Math.round(Math.min(Math.max(319 - hsl[2], 255), 95) / 2.55) + "%)";
}

function convert_font_color_dark_mode (color_hex) {
    var hsl = rgb2hsl(color_hex);
    
    return "hsl(" + hsl[0] + "deg " + Math.round(hsl[1] / 2.55) + "% " + Math.round(Math.min(Math.max(255 - hsl[2], 170), 255) / 2.55) + "%)";
}

function switch_dark_mode () {
    if (config["dark_mode"]) {
        document.getElementsByTagName("body")[0].className = "dark_mode";
    } else {
        document.getElementsByTagName("body")[0].className = "";
    }
    
    switch (mode_val) {
        case 0:
            position_change_lines(position_line_select_elm.value);
            break;
        case 1:
            if (timetable_selected_station !== null) {
                timetable_select_station(timetable_selected_station);
            }
            break;
        case 2:
            operation_data_draw();
            break;
        case 4:
            operation_table_list_number();
            break;
    }
}


var splash_screen_elm = document.getElementById("splash_screen");

switch_dark_mode();
splash_screen_elm.classList.remove("splash_screen_loading");


var header_elm = document.getElementsByTagName("header")[0];
var railroad_icon_elm = document.getElementById("railroad_icon");

var menu_elm = document.getElementById("menu");
var menu_button_elm = document.getElementById("menu_button");

function menu_click (force_close = false) {
    if (menu_elm.className === "menu_open" || force_close) {
        menu_elm.className = "";
        menu_button_elm.classList.remove("menu_button_active");
    } else {
        menu_elm.className = "menu_open";
        menu_button_elm.classList.add("menu_button_active");
    }
}

var popup_background_elm = document.getElementById("popup_background");
var popup_history = new Array();
var square_popup_is_open = false;

function open_popup (id) {
    if (square_popup_is_open) {
        close_square_popup();
    }
    
    popup_background_elm.style.display = "block";
    
    var elm = document.getElementById(id);
    
    if (!elm.classList.contains("popup_active")) {
        elm.classList.add("popup_active");
        elm.style.zIndex = popup_history.length + 20;
        
        popup_history.push(id);
        
        menu_click(true);
    }
}

function popup_close (close_all = false) {
    var id = popup_history.pop();
    
    if (popup_history.length === 0) {
        popup_background_elm.style.display = "none";
    }
    
    document.getElementById(id).classList.remove("popup_active");
    
    if (close_all && popup_history.length >= 1) {
        popup_close(true);
    }
}

var screen_elm = document.getElementById("popup_screen");
var wait_screen_elm = document.getElementById("wait_screen");

function open_square_popup (id) {
    if (square_popup_is_open) {
        close_square_popup();
    }
    
    screen_elm.className = "popup_screen_active";
    document.getElementById(id).classList.add("popup_active");
    
    popup_history.push(id);
    square_popup_is_open = true;
}

function close_square_popup () {
    var id = popup_history.pop();
    
    screen_elm.className = "";
    document.getElementById(id).classList.remove("popup_active");
    
    square_popup_is_open = false;
    
    menu_click(true);
}

function open_wait_screen () {
    wait_screen_elm.style.display = "block";
    screen_elm.style.backgroundColor = "transparent";
}

function close_wait_screen () {
    wait_screen_elm.style.display = "none";
    screen_elm.style.backgroundColor = "";
}


var user_data = null;

var menu_admin_elm = document.getElementById("menu_admin");
var menu_logged_in_elm = document.getElementById("menu_logged_in");
var menu_not_logged_in_elm = document.getElementById("menu_not_logged_in");

function update_user_data (user_data_next = null) {
    user_data = user_data_next;
    
    menu_admin_elm.style.display = "none";
    
    if (user_data !== null) {
        menu_logged_in_elm.style.display = "block";
        menu_not_logged_in_elm.style.display = "none";
        
        var menu_user_name_elm = document.getElementById("menu_user_name");
        menu_user_name_elm.className = "";
        
        if (user_data["role"] === "ADMIN" || user_data["role"] === "MODERATOR") {
            menu_admin_elm.style.display = "block";
            var honorific = "(管)";
        } else {
            var honorific = "さん";
            
            if (user_data["is_beginner"]) {
                menu_user_name_elm.className = "beginner";
            }
        }
        
        menu_user_name_elm.innerText = user_data["user_name"] + " " + honorific;
        
        splash_screen_login_status_elm.innerHTML = "ようこそ <b>" + escape_html(user_data["user_name"]) + "</b> さん<br><a href='javascript:void(0);' onclick='user_logout();'>ログアウト</a>　<a href='javascript:void(0);' onclick='edit_user_data();'>登録情報編集</a>";
    } else {
        menu_logged_in_elm.style.display = "none";
        menu_not_logged_in_elm.style.display = "block";
        
        splash_screen_login_status_elm.innerHTML = "<b>ログインしていません</b><br><a href='javascript:void(0);' onclick='open_square_popup(\"login_popup\");'>ログイン</a>　<a href='javascript:void(0);' onclick='open_popup(\"sign_up_popup\");'>新規登録</a>";
    }
}

function check_logged_in () {
    ajax_fetch("api/check_logged_in.php", null, function (response) {
        if (response !== false) {
            if (response !== "NOT_LOGGED_IN"){
                update_user_data(JSON.parse(response));
            } else {
                update_user_data();
            }
        } else {
            splash_screen_login_status_elm.innerText = "【!】ログイン状態の確認に失敗しました";
        }
    });
}


function get_holiday_list (toshi) {
    var holiday_list = ["1/1", "2/11", "2/23", "4/29", "5/3", "5/4", "5/5", "8/11", "11/3", "11/23"];
    var happy_monday_list = ["1-2", "7-3", "9-3", "10-2"];
    
    holiday_list.push("3/" + String(Math.floor(20.8431 + 0.242194 * (toshi - 1980)) - Math.floor((toshi - 1980) / 4)));
    var shubun = Math.floor(23.2488 + 0.242194 * (toshi - 1980)) - Math.floor((toshi - 1980) / 4);
    holiday_list.push("9/" + String(shubun));
    
    var dt2;
    var bunkatsu;
    var yobi_val;
    for (var hm_cnt = 0; hm_cnt < happy_monday_list.length; hm_cnt++) {
        bunkatsu = happy_monday_list[hm_cnt].split("-");
        dt2 = new Date(String(toshi) + "-" + ("0" + bunkatsu[0]).slice(-2) + "-01 12:00:00");
        
        yobi_val = dt2.getDay();
        if (yobi_val <= 1) {
            yobi_val += 7;
        }
        holiday_list.push(bunkatsu[0] + "/" + String((2 - yobi_val) + (7 * Number(bunkatsu[1]))));
    }
    
    var furikae_cnt;
    var hizuke;
    for (var h_cnt = 0; h_cnt < holiday_list.length; h_cnt++) {
        bunkatsu = holiday_list[h_cnt].split("/");
        dt2 = new Date(String(toshi) + "-" + ("0" + bunkatsu[0]).slice(-2) + "-" + ("0" + bunkatsu[1]).slice(-2) + " 12:00:00");
        
        if (dt2.getDay() === 0) {
            furikae_cnt = 0;
            do {
                furikae_cnt++;
                hizuke = bunkatsu[0] + "/" + String(Number(bunkatsu[1]) + furikae_cnt);
            } while (holiday_list.includes(hizuke));
            
            holiday_list.push(hizuke);
        }
    }
    
    if (holiday_list.includes("9/" + String(shubun - 2))) {
        holiday_list.push("9/" + String(shubun - 1));
    }
    
    return holiday_list;
}

function get_days_operation (ts) {
    var dt = new Date((ts - 10800) * 1000);
    today = String(dt.getMonth() + 1) + "/" + String(dt.getDate());
    today_mm_dd = ("0" + String(dt.getMonth() + 1)).slice(-2) + "-" + ("0" + String(dt.getDate())).slice(-2);
    
    if (today_mm_dd in railroad_info["operations_by_date"]) {
        return railroad_info["operations_by_date"][today_mm_dd];
    } else if (get_holiday_list(dt.getFullYear()).includes(today)) {
        return railroad_info["operations_by_day"][0];
    } else {
        return railroad_info["operations_by_day"][dt.getDay()];
    }
}


var splash_screen_login_status_elm = document.getElementById("splash_screen_login_status");

function update_railroad_list (railroads) {
    var buttons_html = "";
    
    for (var cnt = 0; cnt < railroads["railroads_order"].length; cnt++) {
        buttons_html += "<a href='javascript:void(0);' class='wide_button' onclick='select_railroad(\"" + railroads["railroads_order"][cnt] + "\");'><img src='" + railroads["railroads"][railroads["railroads_order"][cnt]]["railroad_icon"] + "' alt='' style='background-color: " + railroads["railroads"][railroads["railroads_order"][cnt]]["main_color"] + ";'>" + escape_html(railroads["railroads"][railroads["railroads_order"][cnt]]["railroad_name"]) + "</a>";
    }
    
    if (cnt === 0) {
        buttons_html = "<div class='no_data'>利用可能なデータがありません</div>";
    }
    
    document.getElementById("railroad_select_area").innerHTML = buttons_html;
    document.getElementById("splash_screen_buttons").innerHTML = buttons_html;
    
    splash_screen_elm.className = "splash_screen_loaded";
}


var menu_off_line_elm = document.getElementById("menu_off_line");

window.ononline = function () {
    menu_off_line_elm.style.display = "none";
    
    menu_announcements_elm.style.display = "block";
    
    check_logged_in();
}

function on_off_line () {
    splash_screen_login_status_elm.innerHTML = "<b class='off_line_message'>端末がオフラインです</b><br>前回アクセス時のデータを表示します";
    
    menu_off_line_elm.style.display = "block";
    
    menu_admin_elm.style.display = "none";
    menu_logged_in_elm.style.display = "none";
    menu_not_logged_in_elm.style.display = "none";
    menu_announcements_elm.style.display = "none";
    
    announcements_overview_elm.innerHTML = "";
}

window.onoffline = on_off_line;


window.onload = function () {
    var cache_json = localStorage.getItem("unyohub_railroads_caches");
    
    if (cache_json !== null) {
        var railroads_caches = JSON.parse(cache_json);
    } else {
        var railroads_caches = {
            railroads : {},
            railroads_order : [],
            last_modified_timestamp : 0
        };
    }
    
    if (navigator.onLine) {
        check_logged_in();
        
        ajax_fetch("api/railroads.php", "last_modified_timestamp=" + railroads_caches["last_modified_timestamp"], function (response, last_modified) {
            if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                railroads_caches = JSON.parse(response);
                
                var last_modified_date = new Date(last_modified);
                railroads_caches["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                
                localStorage.setItem("unyohub_railroads_caches", JSON.stringify(railroads_caches));
            }
            
            update_railroad_list(railroads_caches);
        });
        
        check_announcements(true);
    } else {
        update_railroad_list(railroads_caches);
        on_off_line();
    }
};


var announcements_overview_elm = document.getElementById("announcements_overview");
var menu_announcements_elm = document.getElementById("menu_announcements");

function check_announcements (show_important_announcements = false) {
    announcement_last_checked = get_timestamp();
    
    var announcements_last_modified = localStorage.getItem("unyohub_latest_announcement_timestamp");
    
    if (announcements_last_modified === null) {
        announcements_last_modified = "0";
    }
    
    ajax_fetch("api/check_announcements.php", "last_modified_timestamp=" + announcements_last_modified, function (response) {
        if (response !== false) {
            if (response === "NEW_ANNOUNCEMENTS_NOT_EXIST") {
                announcements_overview_elm.innerHTML = "新しいお知らせはありません";
                menu_announcements_elm.className = "";
                menu_button_elm.classList.remove("menu_button_with_notification");
            } else {
                announcements_overview_elm.innerHTML = "<b class='new_icon'>新しいお知らせがあります</b>";
                
                if (response === "NEW_IMPORTANT_ANNOUNCEMENTS_EXIST") {
                    menu_button_elm.classList.add("menu_button_with_notification");
                    menu_announcements_elm.className = "new_icon_red";
                    
                    if (show_important_announcements) {
                        show_announcements(true);
                    }
                } else {
                    menu_button_elm.classList.remove("menu_button_with_notification");
                    menu_announcements_elm.className = "new_icon";
                }
            }
        }
    });
}

function show_announcements (important_announcements_exist = false) {
    open_square_popup("announcements_popup");
    
    announcements_overview_elm.innerHTML = "新しいお知らせはありません";
    menu_button_elm.classList.remove("menu_button_with_notification");
    menu_announcements_elm.className = "";
    
    var heading_elm = document.getElementById("announcements_heading");
    if (important_announcements_exist) {
        if (!config["dark_mode"]) {
            var color = "#cc0000";
        } else {
            var color = "#ff3333";
        }
        
        heading_elm.innerHTML = "<span style='color: " + color + ";'>重要なお知らせがあります</span>";
    } else {
        heading_elm.innerHTML = "お知らせの一覧";
    }
    
    ajax_fetch("api/announcements.php", null, function (response) {
        if (response !== false) {
            draw_announcements(JSON.parse(response));
        }
    });
}

function draw_announcements (announcements_data) {
    var buf = "";
    
    var announcements_last_modified = localStorage.getItem("unyohub_latest_announcement_timestamp");
    
    if (announcements_last_modified === null) {
        announcements_last_modified = "0";
    }
    
    for (var cnt = 0; cnt < announcements_data.length; cnt++) {
        if (cnt === 0) {
            localStorage.setItem("unyohub_latest_announcement_timestamp", announcements_data[cnt]["last_modified_timestamp"]);
        }
        
        buf += "<input type='checkbox' id='announcement_" + cnt + "'><label for='announcement_" + cnt + "' class='drop_down";
        
        if (announcements_data[cnt]["is_important"]) {
            buf += " important_announcement";
        }
        
        if (announcements_data[cnt]["last_modified_timestamp"] > announcements_last_modified) {
            buf += " new_icon";
        }
        
        buf += "'>" + escape_html(announcements_data[cnt]["title"]) + "</label>";
        
        var dt = new Date(announcements_data[cnt]["last_modified_timestamp"] * 1000);
        
        buf += "<div><div class='announcement'>" + convert_to_html(announcements_data[cnt]["content"]) + "<small>" + escape_html(announcements_data[cnt]["user_name"]) + "　" + dt.getFullYear() + "/" + (dt.getMonth() + 1) + "/" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() + "</small></div></div>";
    }
    
    if (buf.length === 0) {
        buf = "<div class='no_data'>お知らせはありません</div>";
    }
    
    document.getElementById("announcements_area").innerHTML = buf;
}


function update_railroad_info () {
    var railroad_name_splitted = escape_html(railroad_info["railroad_name"]).split(" ");
    railroad_name_splitted[0] += "<small>";
    
    document.getElementById("railroad_name").innerHTML = railroad_name_splitted.join(" ") + "</small>";
    
    var main_color_hsl = rgb2hsl(railroad_info["main_color"]);
    railroad_icon_elm.style.backgroundImage = "url(" + railroad_info["railroad_icon"] + "), linear-gradient(to right, " + railroad_info["main_color"] + ", hsl(" + main_color_hsl[0] + "deg " + Math.round(main_color_hsl[1] / 2.55) + "% " + Math.round(Math.min(main_color_hsl[2] * 1.2, 255) / 2.55) + "%))";
    
    railroad_info["deadhead_train_number_regexp"] = new RegExp(railroad_info["deadhead_train_number"]);
    
    for (var cnt_2 = 0; cnt_2 < railroad_info["train_color_rules"].length; cnt_2++) {
        railroad_info["train_color_rules"][cnt_2]["regexp"] = new RegExp(railroad_info["train_color_rules"][cnt_2]["pattern"]);
    }
    
    header_elm.className = "railroad_select_mode";
}


var blank_article_elm = document.getElementById("blank_article");

function select_railroad (railroad_id) {
    splash_screen_elm.style.display = "none";
    if (popup_history.length >= 1) {
        popup_close();
    }
    
    change_mode(-1);
    
    header_elm.className = "";
    
    var promise_1 = new Promise(function (resolve, reject) {
        var resolved = false;
        
        idb_start_transaction("railroads", false, function (transaction) {
            var railroads_store = transaction.objectStore("railroads");
            var get_request = railroads_store.get(railroad_id);
            
            get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    railroad_info = evt.target.result;
                    
                    update_railroad_info();
                    
                    var last_modified_timestamp = railroad_info["last_modified_timestamp"];
                    
                    resolve();
                    resolved = true;
                } else {
                    var last_modified_timestamp = 0;
                }
                
                if (navigator.onLine) {
                    ajax_fetch("api/railroad_info.php", "railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
                        if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                            railroad_info = JSON.parse(response);
                            
                            railroad_info["railroad_id"] = railroad_id;
                            
                            var last_modified_date = new Date(last_modified);
                            railroad_info["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            var railroad_info_new = {...railroad_info};
                            
                            update_railroad_info();
                            
                            idb_start_transaction("railroads", true, function (transaction) {
                                var railroads_store = transaction.objectStore("railroads");
                                railroads_store.put(railroad_info_new);
                            });
                            
                            if (!resolved) {
                                resolve();
                            }
                        } else if (!resolved) {
                            reject();
                        }
                    });
                } else if (!resolved) {
                    reject();
                }
            };
        });
    });
    
    var promise_2 = new Promise(function (resolve, reject) {
        var resolved = false;
        
        idb_start_transaction("train_icons", false, function (transaction) {
            var railroads_store = transaction.objectStore("train_icons");
            var get_request = railroads_store.get(railroad_id);
            
            get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    train_icons = evt.target.result;
                    var last_modified_timestamp = train_icons["last_modified_timestamp"];
                    
                    resolve();
                    resolved = true;
                } else {
                    train_icons = {railroad_id : null};
                    var last_modified_timestamp = 0;
                }
                
                if (navigator.onLine) {
                    ajax_fetch("api/train_icons.php", "railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
                        if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                            train_icons = {icons : JSON.parse(response)};
                            
                            train_icons["railroad_id"] = railroad_id;
                            
                            var last_modified_date = new Date(last_modified);
                            train_icons["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            idb_start_transaction("train_icons", true, function (transaction) {
                                var icons_store = transaction.objectStore("train_icons");
                                icons_store.put(train_icons);
                            });
                            
                            if (!resolved) {
                                resolve();
                            }
                        } else if (!resolved) {
                            reject();
                        }
                    });
                } else if (!resolved) {
                    reject();
                }
            };
        });
    });
    
    var promise_3 = new Promise(function (resolve, reject) {
        var resolved = false;
        
        idb_start_transaction("formations", false, function (transaction) {
            var formations_store = transaction.objectStore("formations");
            var get_request = formations_store.get(railroad_id);
            
            get_request.onsuccess = function (evt) {
                if (evt.target.result !== undefined) {
                    formations = evt.target.result;
                    var last_modified_timestamp = formations["last_modified_timestamp"];
                    
                    resolve();
                    resolved = true;
                } else {
                    var last_modified_timestamp = 0;
                }
                
                if (navigator.onLine) {
                    ajax_fetch("api/formations.php", "railroad_id=" + escape_form_data(railroad_id) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
                        if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                            formations = JSON.parse(response);
                            
                            formations["railroad_id"] = railroad_id;
                            
                            var last_modified_date = new Date(last_modified);
                            formations["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            idb_start_transaction("formations", true, function (transaction) {
                                var formations_store = transaction.objectStore("formations");
                                formations_store.put(formations);
                            });
                            
                            if (!resolved) {
                                resolve();
                            }
                        } else if (!resolved) {
                            reject();
                        }
                    });
                } else if (!resolved) {
                    reject();
                }
            };
        });
    });
    
    Promise.all([promise_1, promise_2, promise_3]).then(function () {
        position_mode();
    }).catch(function () {
        mes("選択された路線系統はデータが利用できません", true);
        
        open_popup('railroad_select_popup');
        blank_article_elm.innerHTML = "<div class='no_data'><a href='javascript:void(0);' onclick='open_popup(\"railroad_select_popup\");'>路線系統を選択</a>してください</div>";
    });
}


var tab_area_elm = document.getElementById("tab_area");
var article_elms = document.getElementsByTagName("article");
var footer_elm = document.getElementsByTagName("footer")[0];

tab_area_elm.onselectstart = function () { return false; };

var mode_val = -1;

function change_mode (num) {
    if (num === -1) {
        blank_article_elm.innerHTML = "";
        blank_article_elm.style.display = "block";
    } else {
        if (num === mode_val) {
            return;
        }
        
        blank_article_elm.style.display = "none";
    }
    
    mode_val = num;
    
    var tab_buttons = tab_area_elm.getElementsByTagName("button");
    var footer_boxes = footer_elm.getElementsByTagName("div");
    for (var cnt = 0; cnt < article_elms.length; cnt++) {
        if (cnt === num) {
            article_elms[cnt].style.display = "block";
            tab_buttons[cnt].className = "active_tab";
            footer_boxes[cnt].style.display = "block";
        } else {
            article_elms[cnt].style.display = "none";
            tab_buttons[cnt].className = "";
            footer_boxes[cnt].style.display = "none";
        }
    }
}


var operations = null;
var line_operations = null;
var operation_groups = null;

function load_operation_table (resolve_func, reject_func, operation_table, update_operations, update_line_operations, update_operation_groups) {
    var tables = [];
    
    if (update_operations) {
        tables.push("operations")
    }
    if (update_line_operations) {
        tables.push("line_operations")
    }
    if (update_operation_groups) {
        tables.push("operation_groups")
    }
    
    var railroad_id = railroad_info["railroad_id"];
    
    idb_start_transaction(tables, false, function (transaction) {
        var promise_list = [];
        var last_modified_timestamp = 0;
        
        if (update_operations) {
            var operations_store = transaction.objectStore("operations");
            var operations_get_request = operations_store.get([railroad_id, operation_table]);
            
            promise_list.push(new Promise(function (resolve, reject) {
                operations_get_request.onsuccess = function (evt) {
                    if (evt.target.result !== undefined) {
                        operations = evt.target.result;
                        last_modified_timestamp = operations["last_modified_timestamp"];
                    }
                    
                    resolve();
                };
            }));
        }
        
        if (update_line_operations) {
            var line_operations_store = transaction.objectStore("line_operations");
            var line_operations_get_request = line_operations_store.get([railroad_id, operation_table]);
            
            promise_list.push(new Promise(function (resolve, reject) {
                line_operations_get_request.onsuccess = function (evt) {
                    if (evt.target.result !== undefined) {
                        line_operations = evt.target.result;
                        last_modified_timestamp = line_operations["last_modified_timestamp"];
                    }
                    
                    resolve();
                };
            }));
        }
        
        if (update_operation_groups) {
            var operation_groups_store = transaction.objectStore("operation_groups");
            var operation_groups_get_request = operation_groups_store.get([railroad_id, operation_table]);
            
            promise_list.push(new Promise(function (resolve, reject) {
                operation_groups_get_request.onsuccess = function (evt) {
                    if (evt.target.result !== undefined) {
                        operation_groups = evt.target.result;
                        last_modified_timestamp = operation_groups["last_modified_timestamp"];
                    }
                    
                    resolve();
                };
            }));
        }
        
        Promise.all(promise_list).then(function () {
            if (last_modified_timestamp > 0) {
                resolve_func();
            }
            
            update_operation_table(resolve_func, reject_func, operation_table, last_modified_timestamp);
        });
    });
}

function update_operation_table(resolve_func, reject_func, operation_table, last_modified_timestamp){
    var railroad_id = railroad_info["railroad_id"];
    
    if (navigator.onLine) {
        ajax_fetch("api/operation_table.php", "railroad_id=" + escape_form_data(railroad_id) + "&operation_table=" + escape_form_data(operation_table) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
            if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                var operation_response = JSON.parse(response);
                
                var last_modified_date = new Date(last_modified);
                last_modified_timestamp = Math.floor(last_modified_date.getTime() / 1000);
                
                var operations_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : last_modified_timestamp, operations : {}};
                var operation_groups_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : last_modified_timestamp, operation_groups : []};
                var line_operations_data = {railroad_id : railroad_id, operation_table : operation_table, last_modified_timestamp : last_modified_timestamp, lines : {}};
                
                var lines = railroad_info["lines_order"];
                for (var cnt = 0; cnt < lines.length; cnt++) {
                    line_operations_data["lines"][lines[cnt]] = {
                        inbound_trains : {},
                        outbound_trains : {}
                    };
                }
                
                for (cnt = 0; cnt < operation_response.length; cnt++) {
                    operation_groups_data["operation_groups"][cnt] = {"operation_group_name" : operation_response[cnt]["operation_group_name"], "operation_numbers" : []};
                    
                    for (var cnt_2 = 0; cnt_2 < operation_response[cnt]["operations"].length; cnt_2++) {
                        var operation_number = operation_response[cnt]["operations"][cnt_2]["operation_number"];
                        
                        operation_groups_data["operation_groups"][cnt]["operation_numbers"].push(operation_number);
                        
                        operations_data["operations"][operation_number] = {
                            trains : [],
                            operation_group_name : operation_response[cnt]["operation_group_name"],
                            starting_location : operation_response[cnt]["operations"][cnt_2]["starting_location"],
                            starting_track : operation_response[cnt]["operations"][cnt_2]["starting_track"],
                            starting_time : operation_response[cnt]["operations"][cnt_2]["starting_time"],
                            terminal_location : operation_response[cnt]["operations"][cnt_2]["terminal_location"],
                            terminal_track : operation_response[cnt]["operations"][cnt_2]["terminal_track"],
                            ending_time : operation_response[cnt]["operations"][cnt_2]["ending_time"],
                            car_count : operation_response[cnt]["operations"][cnt_2]["car_count"],
                            main_color : operation_response[cnt]["operations"][cnt_2]["main_color"]
                        }
                        
                        var trains = operation_response[cnt]["operations"][cnt_2]["trains"];
                        
                        var previous_train_number = null;
                        for_3: for (var cnt_3 = 0; cnt_3 < trains.length; cnt_3++) {
                            if (trains[cnt_3]["starting_station"] !== trains[cnt_3]["terminal_station"] || trains[cnt_3]["train_number"].substring(0, 1) === ".") {
                                operations_data["operations"][operation_number]["trains"].push(trains[cnt_3]);
                            }
                            
                            if (trains[cnt_3]["direction"] === "inbound") {
                                var train_direction = "inbound_trains";
                            } else if (trains[cnt_3]["direction"] === "outbound") {
                                var train_direction = "outbound_trains";
                            } else {
                                continue;
                            }
                            
                            if (!(trains[cnt_3]["train_number"] in line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction])) {
                                line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]] = [];
                            }
                            
                            for (var cnt_4 = 0; cnt_4 < line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]].length; cnt_4++) {
                                if (line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]][cnt_4]["first_departure_time"] === trains[cnt_3]["first_departure_time"]) {
                                    var train_operations = line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]][cnt_4]["operation_numbers"];
                                    
                                    for_5: for (var cnt_5 = 0; cnt_5 < train_operations.length; cnt_5++){
                                        for (var cnt_6 = 0; cnt_6 < operations_data["operations"][train_operations[cnt_5]]["trains"].length; cnt_6++){
                                            if (operations_data["operations"][train_operations[cnt_5]]["trains"][cnt_6]["first_departure_time"] === trains[cnt_3]["first_departure_time"]) {
                                                if (operations_data["operations"][train_operations[cnt_5]]["trains"][cnt_6]["position_forward"] > trains[cnt_3]["position_forward"]) {
                                                    break for_5;
                                                }
                                            }
                                        }
                                    }
                                    
                                    line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]][cnt_4]["operation_numbers"].splice(cnt_5, 0,operation_number);
                                    
                                    continue for_3;
                                } else if (line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]][cnt_4]["first_departure_time"] > trains[cnt_3]["first_departure_time"]) {
                                    break;
                                }
                            }
                            
                            line_operations_data["lines"][trains[cnt_3]["line_id"]][train_direction][trains[cnt_3]["train_number"]].splice(cnt_4, 0, {
                                first_departure_time : trains[cnt_3]["first_departure_time"],
                                final_arrival_time : trains[cnt_3]["final_arrival_time"],
                                starting_station : trains[cnt_3]["starting_station"],
                                terminal_station : trains[cnt_3]["terminal_station"],
                                operation_numbers : [operation_number]
                            });
                        }
                    }
                }
                
                operations = operations_data;
                operation_groups = operation_groups_data;
                line_operations = line_operations_data;
                
                idb_start_transaction(["operations", "operation_groups", "line_operations"], true, function (transaction) {
                    var operations_store = transaction.objectStore("operations");
                    operations_store.put(operations_data);
                    
                    var operation_groups_store = transaction.objectStore("operation_groups");
                    operation_groups_store.put(operation_groups_data);
                    
                    var line_operations_store = transaction.objectStore("line_operations");
                    line_operations_store.put(line_operations_data);
                });
                
                resolve_func();
            } else if (last_modified_timestamp === 0) {
                reject_func();
            }
        });
    } else if (last_modified_timestamp === 0) {
        mes("オフラインのためダウンロードが完了していない運用データは利用できません", true);
        
        reject_func();
    }
}


var timetable = null;

var timetable_operation_table;
var timetable_operation_name_elm = document.getElementById("timetable_operation_name");

function update_timetable (resolve_func, reject_func, operation_table) {
    timetable = null;
    
    var railroad_id = railroad_info["railroad_id"];
    
    timetable_operation_table = operation_table;
    timetable_operation_name_elm.innerText = railroad_info["operations"][operation_table]["operation_name"];
    
    idb_start_transaction("timetables", false, function (transaction) {
        var timetables_store = transaction.objectStore("timetables");
        var get_request = timetables_store.get([railroad_id, operation_table]);
        
        get_request.onsuccess = function (evt) {
            if (evt.target.result !== undefined) {
                timetable = evt.target.result;
                var last_modified_timestamp = timetable["last_modified_timestamp"];
                
                resolve_func();
            } else {
                var last_modified_timestamp = 0;
            }
            
            if (navigator.onLine) {
                ajax_fetch("api/timetable.php", "railroad_id=" + escape_form_data(railroad_id) + "&operation_table=" + escape_form_data(operation_table) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
                    if (response !== false && response !== "NO_UPDATES_AVAILABLE") {
                        timetable = {timetable : JSON.parse(response)};
                        
                        timetable["railroad_id"] = railroad_id;
                        timetable["operation_table"] = operation_table;
                        
                        var last_modified_date = new Date(last_modified);
                        timetable["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                        
                        idb_start_transaction("timetables", true, function (transaction) {
                            var timetable_store = transaction.objectStore("timetables");
                            timetable_store.put(timetable);
                        });
                        
                        resolve_func();
                    } else if (timetable === null) {
                        reject_func();
                    }
                });
            } else {
                if (timetable === null) {
                    mes("オフラインのためダウンロードが完了していない時刻表データは利用できません", true);
                    
                    reject_func();
                }
            }
        };
    });
}


var operation_data = null;
var operation_date_last;
var operation_data_last_updated = null;

function update_operation_data (resolve_func, reject_func, remote_data_only = false, operation_date = null) {
    if (operation_date === null) {
        operation_date = operation_date_last;
    } else {
        operation_data = null;
        operation_date_last = operation_date;
    }
    
    var railroad_id = railroad_info["railroad_id"];
    
    idb_start_transaction("operation_data", false, function (transaction) {
        var operation_data_store = transaction.objectStore("operation_data");
        var get_request = operation_data_store.get([railroad_id, operation_date]);
        
        get_request.onsuccess = function (evt) {
            if (evt.target.result !== undefined) {
                operation_data = evt.target.result;
                var last_modified_timestamp = operation_data["last_modified_timestamp"];
                
                if (!remote_data_only) {
                    resolve_func();
                }
            } else {
                var last_modified_timestamp = 0;
            }
            
            if (navigator.onLine) {
                ajax_fetch("api/operation_data.php", "railroad_id=" + escape_form_data(railroad_id) + "&date=" + escape_form_data(operation_date) + "&last_modified_timestamp=" + last_modified_timestamp, function (response, last_modified) {
                    if (response !== false) {
                        if (operation_data === null) {
                            operation_data = {railroad_id : railroad_id, operation_date : operation_date, operations : {}, last_modified_timestamp : null};
                        }
                        
                        if (response !== "NO_UPDATES_AVAILABLE") {
                            Object.assign(operation_data["operations"], JSON.parse(response));
                            
                            var last_modified_date = new Date(last_modified);
                            operation_data["last_modified_timestamp"] = Math.floor(last_modified_date.getTime() / 1000);
                            
                            idb_start_transaction("operation_data", true, function (transaction) {
                                var operation_data_store = transaction.objectStore("operation_data");
                                operation_data_store.put(operation_data);
                            });
                        }
                        
                        resolve_func();
                    } else if (operation_data === null || remote_data_only) {
                        reject_func();
                    }
                });
            } else if (operation_data === null || remote_data_only) {
                operation_data = {railroad_id : railroad_id, operation_date : operation_date, operations : {}, last_modified_timestamp : null};
                
                resolve_func();
            }
        };
    });
    
    operation_data_last_updated = get_timestamp();
}


var background_updater_last_execution = null;
var announcement_last_checked = null;
var position_last_updated = null;

function background_updater () {
    var date_now = new Date();
    var now_ts = Math.floor(date_now.getTime() / 1000);
    
    if (background_updater_last_execution !== null) {
        if (now_ts < background_updater_last_execution + 60) {
            if (announcement_last_checked !== null && announcement_last_checked < now_ts - 1800) {
                check_announcements();
            }
            
            var hh_and_mm = ("0" + date_now.getHours()).slice(-2) + ":" + ("0" + date_now.getMinutes()).slice(-2);
            
            if (mode_val === 0 && position_last_updated !== null && position_last_updated < hh_and_mm) {
                position_change_time();
            }
            
            if (navigator.onLine && operation_data_last_updated !== null && operation_data_last_updated < now_ts - config["refresh_interval"] * 60) {
                update_operation_data(function () {
                    switch (mode_val) {
                        case 0:
                            position_change_time(0);
                            break;
                        case 2:
                            operation_data_draw();
                            break;
                    }
                }, function () {}, true);
            }
        } else if (mode_val === 0) {
            mes("情報を更新しています...", false, 2);
        }
    }
    
    background_updater_last_execution = now_ts;
}

var background_updater_interval_id = null;

function background_updater_start_stop () {
    if (background_updater_interval_id !== null) {
        clearInterval(background_updater_interval_id);
    }
    
    if (document.visibilityState === "visible") {
        background_updater();
        background_updater_interval_id = setInterval(background_updater, 2000);
    } else {
        background_updater_interval_id = null;
    }
}

document.onvisibilitychange = background_updater_start_stop;
background_updater_start_stop();


var position_line_select_elm = document.getElementById("position_line_select");
var position_area_elm = document.getElementById("position_area");
var position_reload_button_elm = document.getElementById("position_reload_button");
var position_time_button_elm = document.getElementById("position_time_button");

function position_mode () {
    change_mode(0);
    
    position_area_elm.innerHTML = "";
    position_line_select_elm.style.display = "block";
    position_reload_button_elm.style.display = "none";
    
    var position_area_supplement_elm = document.getElementById("position_area_supplement");
    position_area_supplement_elm.style.display = "none";
    
    var operation_table = get_days_operation(get_timestamp());
    
    var all_resolved = false;
    
    var promise_1_resolved = false;
    var promise_1 = new Promise(function (resolve, reject) {
        load_operation_table(function () {
            if (!promise_1_resolved) {
                promise_1_resolved = true;
                resolve();
            } else if (all_resolved) {
                position_change_time(0);
            }
        }, reject, operation_table, true, true, false);
    });
    
    var promise_2_resolved = false;
    var promise_2 = new Promise(function (resolve, reject) {
        update_timetable(function () {
            if (!promise_2_resolved) {
                promise_2_resolved = true;
                resolve();
            } else if (all_resolved) {
                position_change_time(0);
            }
        }, reject, operation_table);
    });
    
    var promise_3_resolved = false;
    var promise_3 = new Promise(function (resolve, reject) {
        update_operation_data(function () {
            if (!promise_3_resolved) {
                promise_3_resolved = true;
                resolve();
            } else if (all_resolved) {
                position_change_time(0);
            }
        }, reject, false, get_date_string(get_timestamp()));
    });
    
    var keys = railroad_info["lines_order"];
    
    if (position_line_select_elm.innerHTML.length === 0 || !(position_line_select_elm.value in railroad_info["lines"])) {
        var buf = "";
        
        for (var cnt = 0; cnt < keys.length; cnt++) {
            buf += "<option value='" + keys[cnt] + "'>" + escape_html(railroad_info["lines"][keys[cnt]]["line_name"]) + "</option>";
        }
        
        position_line_select_elm.innerHTML = buf;
        
        var line_id = keys[0];
    } else {
        var line_id = position_line_select_elm.value;
    }
    
    document.getElementById("show_train_types_check").checked = config["show_train_types_in_position_mode"];
    
    position_change_time(null, false);
    
    Promise.all([promise_1, promise_2, promise_3]).then(function () {
        all_resolved = true;
        
        position_change_lines(line_id);
        
        position_area_supplement_elm.style.display = "block";
    }).catch(function () {
        position_area_elm.innerHTML = "<div class='no_data'>表示に必要なデータが利用できません</div>";
        position_line_select_elm.style.display = "none";
    });
}

function position_change_lines (line_id) {
    if (position_line_select_elm.value !== line_id) {
        position_line_select_elm.value = line_id;
    }
    
    if (!config["dark_mode"]) {
        var line_color = railroad_info["lines"][line_id]["line_color"];
        
        var line_color_hsl = rgb2hsl(line_color);
        var station_color = "hsl(" + line_color_hsl[0] + "deg " + Math.round(line_color_hsl[1] / 2.55) + "% " + Math.round((line_color_hsl[2] + 1275) / 6 / 2.55) + "%)";
        var major_station_row_color = "hsl(" + line_color_hsl[0] + "deg " + Math.round(line_color_hsl[1] / 2.55) + "% " + Math.round((line_color_hsl[2] + 2295) / 10 / 2.55) + "%)";
    } else {
        var line_color = convert_color_dark_mode(railroad_info["lines"][line_id]["line_color"]);
        
        var line_color_hsl = rgb2hsl(railroad_info["lines"][line_id]["line_color"]);
        var station_color = "hsl(" + line_color_hsl[0] + "deg " + Math.round(line_color_hsl[1] / 4 / 2.55) + "% " + Math.round(Math.min(255 - line_color_hsl[2] + 32, 127) / 2.55) + "%)";
        var major_station_row_color = "hsl(" + line_color_hsl[0] + "deg " + Math.round(line_color_hsl[1] / 16 / 2.55) + "% " + Math.round(Math.min(Math.max(255 - line_color_hsl[2] + 16, 255), 85) / 2.55) + "%)";
    }
    
    var buf = "";
    for (var cnt = 0; cnt <= railroad_info["lines"][line_id]["stations"].length; cnt++) {
        buf += "<div class='position_row'><div class='position_station'>";
        
        var border_style = "";
        var position_station_class = "";
        
        if (cnt !== 0){
            buf += "<h4";
            
            if ("is_signal_station" in railroad_info["lines"][line_id]["stations"][cnt - 1] && railroad_info["lines"][line_id]["stations"][cnt - 1]["is_signal_station"]) {
                buf += " class='position_signal_station'";
                
                border_style = " style='border-top-color: transparent;'";
                position_station_class = " position_line_signal_station";
            } else {
                buf += " onclick='show_station_timetable(\"" + line_id + "\", \"" + railroad_info["lines"][line_id]["stations"][cnt - 1]["station_name"] + "\");'";
                
                if ("is_major_station" in railroad_info["lines"][line_id]["stations"][cnt - 1] && railroad_info["lines"][line_id]["stations"][cnt - 1]["is_major_station"]) {
                    buf += " style='background-color: " + station_color + ";'";
                    
                    border_style = " style='border-top: 2px solid " + major_station_row_color + ";'";
                    position_station_class = " position_line_major_station";
                }
            }
            
            buf += ">";
            
            if (railroad_info["lines"][line_id]["stations"][cnt - 1]["station_name"].length > 5) {
                buf += escape_html(railroad_info["lines"][line_id]["stations"][cnt - 1]["station_name"].substring(0, 4) + "..");
            } else{
                buf += escape_html(railroad_info["lines"][line_id]["stations"][cnt - 1]["station_name"]);
            }
            
            buf += "</h4>";
            
            if ("connecting_lines" in railroad_info["lines"][line_id]["stations"][cnt - 1]) {
                if (railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"].length === 1) {
                    var connecting_line_color = railroad_info["lines"][railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"][0]]["line_color"];
                    
                    if (config["dark_mode"]) {
                        connecting_line_color = convert_color_dark_mode(connecting_line_color);
                    }
                    
                    buf += "<a href='javascript:void(0);' class='connecting_line_button' onclick='position_change_lines(\"" + railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"][0] + "\")' style='border-color: " + connecting_line_color + ";'>" + escape_html(railroad_info["lines"][railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"][0]]["line_name"]) + "</a>";
                } else if (railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"].length >= 2) {
                    buf += "<a href='javascript:void(0);' class='connecting_line_button' onclick='position_select_lines(" + JSON.stringify(railroad_info["lines"][line_id]["stations"][cnt - 1]["connecting_lines"]) + ");'>複数の路線</a>";
                }
            }
        }
        
        buf += "</div><div class='position_inbound'" + border_style + "></div><div class='position_line" + position_station_class + "' style='color: " + line_color + ";'></div><div class='position_outbound'" + border_style + "></div></div>";
        
        if ("double_station_spacing" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["double_station_spacing"] && cnt !== 0 && cnt !== railroad_info["lines"][line_id]["stations"].length) {
                buf += "<div class='position_row_no_station'><div class='position_station'></div><div class='position_inbound'></div><div class='position_line" + position_station_class + "' style='color: " + line_color + ";'></div><div class='position_outbound'></div></div>";
        }
    }
    
    position_area_elm.innerHTML = buf;
    
    article_elms[0].scrollTop = 0;
    
    var label_train_type_elm = document.getElementById("show_train_types_label_train_type");
    var label_final_destination_elm = document.getElementById("show_train_types_label_final_destination");
    
    if ("show_final_destinations_in_position_mode" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["show_final_destinations_in_position_mode"]) {
        label_train_type_elm.style.display = "none";
        label_final_destination_elm.style.display = "inline";
    } else {
        label_train_type_elm.style.display = "inline";
        label_final_destination_elm.style.display = "none";
    }
    
    position_change_time(0);
}

function position_select_lines (lines) {
    open_square_popup("select_lines_popup");
    
    var buf = "";
    for (var cnt = 0; cnt < lines.length; cnt++) {
        buf += "<button type='button' class='wide_button' onclick='close_square_popup(); position_change_lines(\"" + lines[cnt] + "\")'>" + escape_html(railroad_info["lines"][lines[cnt]]["line_name"]) + "</button>";
    }
    
    document.getElementById("select_lines_area").innerHTML = buf;
}

function convert_train_position_data (train_data) {
    if (train_data["train_number"].substring(0, 1) === "_") {
        train_data["train_title"] = train_data["train_number"].substring(1).split("__")[0];
    } else {
        train_data["train_title"] = train_data["train_number"].split("__")[0];
    }
    
    train_data["formation_html"] = escape_html(train_data["formation_text"]).replace(/\+/g, "<wbr>+");
    
    if (train_data["comment_exists"]) {
        train_data["formation_html"] += "*";
    }
    
    if (train_data["posts_count"] === 0) {
        if (!config["dark_mode"]) {
            var color = "#0000cc";
        } else {
            var color = "#9999ff";
        }
        
        train_data["formation_html"] = "<b style='color: " + color + ";'>" + train_data["formation_html"] + "</b>";
    } else if (train_data["variant_exists"]) {
        if (!config["dark_mode"]) {
            var color = "#cc0000";
        } else {
            var color = "#ff9999";
        }
        
        train_data["formation_html"] = "<b style='color: " + color + ";'>" + train_data["formation_html"] + "</b>";
    } else if (config["colorize_beginners_posts"] && train_data["from_beginner"]) {
        var color = "#33cc99";
        
        train_data["formation_html"] = "<b style='color: " + color + ";'>" + train_data["formation_html"] + "</b>";
    } else {
        train_data["formation_html"] = "<b>" + train_data["formation_html"] + "</b>";
    }
    
    return train_data;
}

function draw_train_position (hh_and_mm) {
    var line_id = position_line_select_elm.value;
    
    var directions = ["inbound", "outbound"];
    var line_positions = [get_train_positions(line_operations["lines"][line_id]["inbound_trains"], line_id, hh_and_mm, true), get_train_positions(line_operations["lines"][line_id]["outbound_trains"], line_id, hh_and_mm, false)];
    var position_elms = [document.getElementsByClassName("position_inbound"), document.getElementsByClassName("position_outbound")];
    
    for (var direction_cnt = 0; direction_cnt <= 1; direction_cnt++) {
        for (var cnt = 0; cnt < line_positions[direction_cnt].length; cnt++) {
            if (line_positions[direction_cnt][cnt].length === 1) {
                var train = convert_train_position_data(line_positions[direction_cnt][cnt][0]);
                
                var train_color = get_train_color(train["train_title"], "#333333");
                if (config["dark_mode"]) {
                    train_color = convert_font_color_dark_mode(train_color);
                }
                
                var buf = "<span onclick='train_detail(\"" + line_id + "\", \"" + train["train_number"] + "\", \"" + train["first_departure_time"] + "\", \"" + directions[direction_cnt] + "_trains\");' style='color: " + train_color + ";'><img src='" + get_icon(train["first_formation"]) + "' alt='' class='train_icon'";
                
                if (railroad_info["deadhead_train_number_regexp"].test(train["train_title"])) {
                    buf += " style='opacity: 0.5;'";
                    train["train_type"] = "回送";
                }
                
                buf += "><span class='train_type' style='background-color: " + train_color + "; border-color: " + train_color + ";'>";
                
                if (config["show_train_types_in_position_mode"]) {
                    if (train["train_type"] !== "回送" && "show_final_destinations_in_position_mode" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["show_final_destinations_in_position_mode"]) {
                        buf += get_final_destination(line_id, train["train_number"], train["first_departure_time"], 4);
                    } else {
                        buf += train["train_type"];
                    }
                } else {
                    buf += train["train_title"];
                }
                
                buf += "</span><br>" + train["formation_html"] + "</span>";
            } else if (line_positions[direction_cnt][cnt].length >= 2) {
                var buf = "<span class='multiple_trains'>";
                for (var cnt_2 = 0; cnt_2 < line_positions[direction_cnt][cnt].length; cnt_2++) {
                    var train = convert_train_position_data(line_positions[direction_cnt][cnt][cnt_2]);
                    buf += "<img src='" + get_icon(train["first_formation"]) + "' alt='' class='train_icon' onclick='train_detail(\"" + line_id + "\", \"" + train["train_number"] + "\", \"" + train["first_departure_time"] + "\", \"" + directions[direction_cnt] + "_trains\");'";
                    
                    if (railroad_info["deadhead_train_number_regexp"].test(train["train_title"])) {
                        buf += " style='opacity: 0.5;'"
                    }
                    
                    buf += ">";
                }
                buf += "</span>";
            } else {
                var buf = "";
            }
            
            if (direction_cnt === 0){
                position_elms[0][line_positions[direction_cnt].length - cnt].innerHTML = buf;
            } else {
                position_elms[1][cnt].innerHTML = buf;
            }
        }
    }
}

function hh_mm_to_minutes (hh_and_mm) {
    h_and_m = hh_and_mm.split(":");
    return Number(h_and_m[0]) * 60 + Number(h_and_m[1]);
}

function calculate_train_position (line_id, minutes_now, previous_station_index, next_station_index, previous_station_time, next_station_time) {
    if ("double_station_spacing" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["double_station_spacing"]) {
        var station_spacing = 2;
    } else {
        var station_spacing = 1;
    }
    
    if (next_station_time === previous_station_time) {
        return next_station_index * station_spacing;
    }
    
    return Math.ceil(((next_station_index - previous_station_index) * (minutes_now - previous_station_time) / (next_station_time - previous_station_time) + previous_station_index) * station_spacing);
}

function get_train_positions (trains, line_id, hh_and_mm, is_inbound) {
    var station_list = [...railroad_info["lines"][line_id]["stations"]];
    
    if (is_inbound) {
        station_list.reverse();
    }
    
    var minutes_now = hh_mm_to_minutes(hh_and_mm);
    
    if ("double_station_spacing" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["double_station_spacing"]) {
        var line_rows_count = station_list.length * 2 - 1;
    } else {
        var line_rows_count = station_list.length;
    }
    
    var line_positions = [];
    for (var cnt = 0; cnt < line_rows_count; cnt++) {
        line_positions.push([]);
    }
    
    if (is_inbound) {
        var train_direction = "inbound_trains";
    } else {
        var train_direction = "outbound_trains";
    }
    
    var train_numbers = Object.keys(trains);
    for (cnt = 0; cnt < train_numbers.length; cnt++) {
        if (trains[train_numbers[cnt]][0]["first_departure_time"] > hh_and_mm) {
            continue;
        }
        
        for (var cnt_2 = 0; cnt_2 < trains[train_numbers[cnt]].length; cnt_2++) {
            if (trains[train_numbers[cnt]][cnt_2]["final_arrival_time"] <= hh_and_mm){
                continue;
            }
            
            var train_type = null;
            
            if (train_numbers[cnt].substring(0, 1) !== "_" && train_numbers[cnt] in timetable["timetable"][line_id][train_direction]){
                for_3: for (var cnt_3 = 0; cnt_3 < timetable["timetable"][line_id][train_direction][train_numbers[cnt]].length; cnt_3++) {
                    if (timetable["timetable"][line_id][train_direction][train_numbers[cnt]][cnt_3]["first_departure_time"] >= trains[train_numbers[cnt]][cnt_2]["first_departure_time"]) {
                        var last_stopped = null;
                        var last_stopped_time = null;
                        
                        for (var cnt_4 = 0; cnt_4 < station_list.length; cnt_4++) {
                            var departure_time = timetable["timetable"][line_id][train_direction][train_numbers[cnt]][cnt_3]["departure_times"][cnt_4];
                            
                            if (departure_time !== null) {
                                departure_time = departure_time.slice(-5);
                                
                                if (departure_time >= hh_and_mm) {
                                    if (last_stopped !== null) {
                                        var train_positon = calculate_train_position(line_id, minutes_now, last_stopped, cnt_4, hh_mm_to_minutes(last_stopped_time), hh_mm_to_minutes(departure_time));
                                    } else {
                                        if ("double_station_spacing" in railroad_info["lines"][line_id] && railroad_info["lines"][line_id]["double_station_spacing"]) {
                                            var train_positon = cnt_4 * 2;
                                        } else {
                                            var train_positon = cnt_4;
                                        }
                                    }
                                    
                                    train_type = timetable["timetable"][line_id][train_direction][train_numbers[cnt]][cnt_3]["train_type"];
                                    
                                    break for_3;
                                }
                                
                                last_stopped = cnt_4;
                                last_stopped_time = departure_time;
                            }
                        }
                    }
                }
            }
            
            if (train_type === null) {
                train_type = "＊＊＊";
                
                if (train_numbers[cnt].substring(0, 1) === "_") {
                    var train_number = train_numbers[cnt].substring(1).split("__")[0];
                    
                    if (train_number in timetable["timetable"][line_id][train_direction]) {
                        train_type = timetable["timetable"][line_id][train_direction][train_number][0]["train_type"];
                    }
                }
                
                for (var cnt_3 = 0; cnt_3 < station_list.length; cnt_3++) {
                    if (station_list[cnt_3]["station_name"] === trains[train_numbers[cnt]][cnt_2]["starting_station"]) {
                        var starting_station_index = cnt_3;
                    }
                    if (station_list[cnt_3]["station_name"] === trains[train_numbers[cnt]][cnt_2]["terminal_station"]) {
                        var terminal_station_index = cnt_3;
                    }
                }
                
                var train_positon = calculate_train_position(line_id, minutes_now, starting_station_index, terminal_station_index, hh_mm_to_minutes(trains[train_numbers[cnt]][cnt_2]["first_departure_time"]), hh_mm_to_minutes(trains[train_numbers[cnt]][cnt_2]["final_arrival_time"]));
            }
            
            if (train_positon < 0 || train_positon > line_rows_count) {
                break;
            }
            
            var operation_list = get_operations(line_id, train_numbers[cnt], trains[train_numbers[cnt]][cnt_2]["first_departure_time"], train_direction);
            
            var formation_data = convert_formation_data(line_id, operation_list, is_inbound);
            
            line_positions[train_positon].push({
                train_number : train_numbers[cnt],
                train_type : train_type,
                first_departure_time : trains[train_numbers[cnt]][cnt_2]["first_departure_time"],
                final_arrival_time : trains[train_numbers[cnt]][cnt_2]["final_arrival_time"],
                operation_numbers : trains[train_numbers[cnt]][cnt_2]["operation_numbers"],
                formation_text : formation_data["formation_text"],
                posts_count : formation_data["posts_count"],
                variant_exists : formation_data["variant_exists"],
                comment_exists : formation_data["comment_exists"],
                from_beginner : formation_data["from_beginner"],
                first_formation : formation_data["first_formation"]
            });
            
            break;
        }
    }
    
    return line_positions;
}

function convert_formation_data (line_id, operation_list, is_inbound) {
    var first_formation = null;
    var posts_count = null;
    var variant_exists = false;
    var comment_exists = false;
    var from_beginner = false;
    
    if (operation_list !== null) {
        var formation_text = "";
        
        for (var cnt = 0; cnt < operation_list.length; cnt++) {
            if (operation_list[cnt] in operation_data["operations"] && operation_data["operations"][operation_list[cnt]] !== null) {
                if (operation_data["operations"][operation_list[cnt]]["formations"] !== "") {
                    var operation_formation_text = operation_data["operations"][operation_list[cnt]]["formations"];
                } else {
                    var operation_formation_text = "運休";
                }
                
                if (railroad_info["lines"][line_id]["inbound_forward_direction"] === is_inbound) {
                    if (cnt === 0) {
                        first_formation = operation_data["operations"][operation_list[cnt]]["formations"].split("+")[0];
                    } else {
                        formation_text += "+";
                    }
                    
                    formation_text += operation_formation_text;
                } else {
                    if (cnt === 0) {
                        var formation_data = operation_data["operations"][operation_list[cnt]]["formations"].split("+");
                        
                        first_formation = formation_data[formation_data.length - 1];
                    } else {
                        formation_text = "+" + formation_text;
                    }
                    
                    formation_text = operation_formation_text + formation_text;
                }
                
                posts_count = Number(posts_count) + operation_data["operations"][operation_list[cnt]]["posts_count"];
                variant_exists = variant_exists || operation_data["operations"][operation_list[cnt]]["variant_exists"];
                comment_exists = comment_exists || operation_data["operations"][operation_list[cnt]]["comment_exists"];
                from_beginner = from_beginner || operation_data["operations"][operation_list[cnt]]["from_beginner"];
            } else {
                if (railroad_info["lines"][line_id]["inbound_forward_direction"] === is_inbound) {
                    if (cnt === 0) {
                        formation_text += "?";
                    } else {
                        formation_text += "+?";
                    }
                } else {
                    if (cnt === 0) {
                        formation_text = "?" + formation_text;
                    } else {
                        formation_text = "?+" + formation_text;
                    }
                }
            }
        }
    } else {
        var formation_text = "?";
    }
    
    return {
        formation_text : formation_text,
        posts_count : posts_count,
        variant_exists : variant_exists,
        comment_exists : comment_exists,
        from_beginner : from_beginner,
        first_formation : first_formation
    };
}


function get_train (line_id, train_number, first_departure_time) {
    var train_data = { line_id : line_id, train_number : train_number };
    
    if (train_number in timetable["timetable"][line_id]["inbound_trains"]) {
        for(var cnt = 0; cnt < timetable["timetable"][line_id]["inbound_trains"][train_number].length; cnt++) {
            if (timetable["timetable"][line_id]["inbound_trains"][train_number][cnt]["first_departure_time"] >= first_departure_time) {
                Object.assign(train_data, timetable["timetable"][line_id]["inbound_trains"][train_number][cnt]);
                train_data["is_inbound"] = true;
                
                return train_data;
            }
        }
    } else if (train_number in timetable["timetable"][line_id]["outbound_trains"]) {
        for(var cnt = 0; cnt < timetable["timetable"][line_id]["outbound_trains"][train_number].length; cnt++) {
            if (timetable["timetable"][line_id]["outbound_trains"][train_number][cnt]["first_departure_time"] >= first_departure_time) {
                Object.assign(train_data, timetable["timetable"][line_id]["outbound_trains"][train_number][cnt]);
                train_data["is_inbound"] = false;
                
                return train_data;
            }
        }
    }
    
    return null;
}

function get_operations (line_id, train_number, first_departure_time, train_direction) {
    if (train_number in line_operations["lines"][line_id][train_direction]) {
        var trains = line_operations["lines"][line_id][train_direction][train_number];
        for (var cnt = 0; cnt < trains.length; cnt++) {
            if (trains[cnt]["first_departure_time"] === first_departure_time) {
                return [...trains[cnt]["operation_numbers"]];
            }
        }
    }
    
    return null;
}

function get_final_destination (line_id, train_number, first_departure_time, max_length = 10) {
    if (train_number.substring(0, 1) !== "_") {
        var next_trains = [{line_id : line_id, train_number : train_number, first_departure_time : first_departure_time}];
    } else {
        if (train_number in line_operations["lines"][line_id]["inbound_trains"]) {
            first_departure_time = line_operations["lines"][line_id]["inbound_trains"][train_number][0]["final_arrival_time"];
        } else if (train_number in line_operations["lines"][line_id]["outbound_trains"]) {
            first_departure_time = line_operations["lines"][line_id]["outbound_trains"][train_number][0]["final_arrival_time"];
        } else {
            return "＊＊＊";
        }
        
        var next_trains = [{line_id : line_id, train_number : train_number.substring(1).split("__")[0], first_departure_time : first_departure_time}];
    }
    
    var buf = "";
    
    for (var cnt = 0; cnt < next_trains.length; cnt++) {
        var train_data = get_train(next_trains[cnt]["line_id"], next_trains[cnt]["train_number"], next_trains[cnt]["first_departure_time"]);
        
        if (train_data !== null) {
            if (train_data["next_trains"].length >= 1) {
                next_trains.push(...train_data["next_trains"]);
            } else {
                var last_stopped_index = 0;
                
                for (var cnt_2 = 0; cnt_2 < train_data["departure_times"].length; cnt_2++) {
                    if (train_data["departure_times"][cnt_2] !== null) {
                        last_stopped_index = cnt_2;
                    }
                }
                
                if (buf.length >= 1) {
                    buf += " / ";
                }
                
                var station_list = [...railroad_info["lines"][next_trains[cnt]["line_id"]]["stations"]];
                
                if (train_data["is_inbound"]) {
                    station_list.reverse();
                }
                
                buf += escape_html(station_list[last_stopped_index]["station_name"]);
            }
        }
    }
    
    if (buf.length > max_length) {
        return buf.substring(0, max_length - 1) + "..";
    } else if (buf === "") {
        return "＊＊＊";
    }
    
    return buf;
}

var position_time;

function position_change_time (position_time_additions = null, draw_train_position_now = true) {
    if (position_time_additions === null) {
        position_time = Date.now() / 60000;
    } else if (position_time_additions !== 0) {
        position_time += position_time_additions;
        
        position_last_updated = null;
        position_reload_button_elm.style.display = "block";
    }
    
    var position_date_time = new Date(position_time * 60000);
    
    var hours = position_date_time.getHours();
    var minutes = ("0" + position_date_time.getMinutes()).slice(-2);
    var hh_and_mm_24 = ("0" + hours).slice(-2) + ":" + minutes;
    
    if (position_time_additions === null) {
        position_last_updated = hh_and_mm_24;
    }
    
    if (hours < 3) {
        hours += 24;
    }
    hours = ("0" + hours).slice(-2);
    
    var hh_and_mm = hours + ":" + minutes;
    
    document.getElementById("position_hours").innerHTML = Number(hours) + "<small>時</small>";
    document.getElementById("position_minutes").innerHTML = Number(minutes) + "<small>分</small>";
    
    position_time_button_elm.value = hh_and_mm_24;
    
    if (draw_train_position_now) {
        draw_train_position(hh_and_mm);
    }
}

function position_time_button_change () {
    if (position_time_button_elm.value.length === 0) {
        position_reload();
        return;
    }
    
    var hours_minutes = position_time_button_elm.value.split(":");
    
    if (hours_minutes[0] < 3) {
        hours_minutes[0] += 24;
    }
    
    var hh_and_mm = hours_minutes.join(":");
    
    position_change_time(hh_mm_to_minutes(hh_and_mm) - hh_mm_to_minutes(get_hh_mm(position_time * 60)));
}

function position_reload () {
    position_change_time(null);
    
    position_reload_button_elm.style.display = "none";
}

function change_show_train_types (bool_val) {
    config["show_train_types_in_position_mode"] = bool_val;
    
    save_config();
    
    position_change_time(0);
}

function get_operation_data_detail (operation_date, operation_number_or_list, area_id) {
    var area_elm = document.getElementById(area_id)
    
    if (Array.isArray(operation_number_or_list)) {
        operation_number_list = operation_number_or_list;
    } else {
        operation_number_list = [operation_number_or_list];
    }
    
    var operation_numbers_str = "";
    var buf = "";
    for (var cnt = 0; cnt < operation_number_list.length; cnt++) {
        if (cnt >= 1) {
            operation_numbers_str += ",";
        }
        
        operation_numbers_str += operation_number_list[cnt];
        buf += "<input type='checkbox' id='" + area_id + "_detail_" + add_slashes(operation_number_list[cnt]) + "'><label for='" + area_id + "_detail_" + add_slashes(operation_number_list[cnt]) + "' class='drop_down'>" + escape_html(operation_number_list[cnt]) + "運用 目撃情報</label><div class='descriptive_text'>情報を取得しています...</div>";
    }
    
    area_elm.innerHTML = buf;
    
    ajax_fetch("api/operation_data_detail.php", "railroad_id=" + escape_form_data(railroad_info["railroad_id"]) + "&date=" + operation_date + "&operation_numbers=" + escape_form_data(operation_numbers_str), function (response) {
        if (response !== false) {
            var data = JSON.parse(response);
            
            var detail_html = "";
            var operation_numbers = Object.keys(data);
            for (var cnt = 0; cnt < operation_numbers.length; cnt++) {
                detail_html += "<input type='checkbox' id='" + area_id + "_detail_" + add_slashes(operation_numbers[cnt]) + "'><label for='" + area_id + "_detail_" + add_slashes(operation_numbers[cnt]) + "' class='drop_down'>" + escape_html(operation_numbers[cnt]) + "運用 目撃情報</label><div>";
                
                for (var cnt_2 = 0; cnt_2 < data[operation_numbers[cnt]].length; cnt_2++) {
                    if (data[operation_numbers[cnt]][cnt_2]["formations"] !== "") {
                        var formation_text = data[operation_numbers[cnt]][cnt_2]["formations"];
                    } else {
                        var formation_text = "運休";
                    }
                    
                    if (data[operation_numbers[cnt]][cnt_2]["user_name"] !== null) {
                        var user_name_html = escape_html(data[operation_numbers[cnt]][cnt_2]["user_name"]);
                        var class_html = "";
                        
                        if (!data[operation_numbers[cnt]][cnt_2]["is_moderator"]) {
                            user_name_html += " 様";
                            
                            if (data[operation_numbers[cnt]][cnt_2]["is_beginner"]) {
                                class_html = " class='beginner'";
                            }
                        }
                        
                        if (data[operation_numbers[cnt]][cnt_2]["website_url"] !== null) {
                            user_name_html = "<span" + class_html + "><a href='" + add_slashes(data[operation_numbers[cnt]][cnt_2]["website_url"]) + "' target='_blank' class='external_link'>" + user_name_html + " <small>(" + data[operation_numbers[cnt]][cnt_2]["user_id"] + ")</small></a>";
                        } else {
                            user_name_html = "<span" + class_html + ">" + user_name_html + " <small>(" + data[operation_numbers[cnt]][cnt_2]["user_id"] + ")</small>";
                        }
                    } else {
                        var user_name_html = "<span>(ゲスト様)";
                    }
                    
                    if ("ip_address" in data[operation_numbers[cnt]][cnt_2] && data[operation_numbers[cnt]][cnt_2]["ip_address"] !== null) {
                        var ip_address_str = ", \"" + add_slashes(data[operation_numbers[cnt]][cnt_2]["ip_address"]) + "\"";
                    } else {
                        var ip_address_str = "";
                    }
                    
                    if (user_data !== null && (data[operation_numbers[cnt]][cnt_2]["user_id"] === user_data["user_id"] || user_data["role"] === "MODERATOR" || user_data["role"] === "ADMIN")) {
                        user_name_html += "<button type='button' onclick='edit_operation_data(\"" + operation_date + "\", \"" + add_slashes(operation_numbers[cnt]) + "\", \"" + add_slashes(data[operation_numbers[cnt]][cnt_2]["user_id"]) + "\", \"" + add_slashes(formation_text) + "\"" + ip_address_str + ");'>取り消し</button>";
                    }
                    
                    user_name_html += "</span>";
                    
                    detail_html += "<div class='operation_data_detail'><b>" + formation_text + "<span>" + get_date_and_time(data[operation_numbers[cnt]][cnt_2]["posted_datetime"]) + "</span></b><div class='descriptive_text'>" + escape_html(data[operation_numbers[cnt]][cnt_2]["comment"]).replace(/\n/g, "<br>") + "</div>" + user_name_html + "</div>";
                }
                
                if (cnt_2 === 0) {
                    detail_html += "<div class='descriptive_text'>当日の目撃情報はありません</div>";
                }
                
                detail_html += "</div>";
            }
        } else {
            detail_html = "【!】運用情報の取得に失敗しました";
        }
        
        area_elm.innerHTML = detail_html;
    });
}

var train_detail_area_elm = document.getElementById("train_detail_area");

function train_detail (line_id, train_number, first_departure_time, train_direction, show_operation_data = true, is_today = true) {
    open_square_popup("train_detail_popup");
    train_detail_area_elm.innerHTML = "";
    
    var previous_trains = [];
    var next_trains = [];
    
    var train_operations = get_operations(line_id, train_number, first_departure_time, train_direction);
    
    if (train_number.substring(0, 1) === "_") {
        var trains = line_operations["lines"][line_id][train_direction][train_number];
        first_departure_time = trains[0]["final_arrival_time"];
        
        train_number = train_number.substring(1).split("__")[0];
    }
    
    var train_data = [get_train(line_id, train_number, first_departure_time)];
    
    buf = "<h3>";
    
    if (train_operations !== null) {
        if (railroad_info["lines"][line_id]["inbound_forward_direction"] !== (train_direction === "inbound_trains")) {
            train_operations.reverse();
        }
        
        for (var cnt = 0; cnt < train_operations.length; cnt++) {
            if (cnt >= 1) {
                buf += "+";
            }
            
            buf += "<a href='javascript:void(0);' onclick='operation_detail(\"" + train_operations[cnt] + "\",";
            if (is_today) {
                buf += " " + get_timestamp() + ", true";
            } else {
                buf += " \"" + operations["operation_table"] + "\", false";
            }
            buf += ");'>" + train_operations[cnt] + "運用(" + operations["operations"][train_operations[cnt]]["car_count"] + "両)</a>";
        }
    } else {
        buf += "不明な運用";
        
        show_operation_data = false;
    }
    
    buf += "</h3>";
    
    if (show_operation_data) {
        buf += "<div class='formation_data_area'>";
        
        for (cnt = 0; cnt < train_operations.length; cnt++) {
            if (cnt >= 1) {
                buf += " +"
            }
            
            if (train_operations[cnt] in operation_data["operations"] && operation_data["operations"][train_operations[cnt]] !== null) {
                if (operation_data["operations"][train_operations[cnt]]["formations"] !== "") {
                    var formations_data = operation_data["operations"][train_operations[cnt]]["formations"].split("+");
                    
                    for (var cnt_2 = 0; cnt_2 < formations_data.length; cnt_2++) {
                        if (cnt_2 >= 1) {
                            buf += " +"
                        }
                        
                        if (formations_data[cnt_2] in formations["formations"]) {
                            buf += "<a href='javascript:void(0);' onclick='close_square_popup(); formation_table_mode(\"" + add_slashes(formations_data[cnt_2]) + "\");'><img src='" + get_icon(formations_data[cnt_2]) + "' alt='' class='train_icon'>" + escape_html(formations_data[cnt_2]) + "</a>";
                        } else if (formations_data[cnt_2] === "?") {
                            buf += "<img src='" + UNYOHUB_UNKNOWN_TRAIN_ICON + "' alt='' class='train_icon'>" + "?";
                        } else {
                            buf += "<img src='" + get_icon(formations_data[cnt_2]) + "' alt='' class='train_icon'>" + escape_html(formations_data[cnt_2]);
                        }
                    }
                } else {
                    buf += "<img src='" + UNYOHUB_CANCELED_TRAIN_ICON + "' alt='' class='train_icon'>" + "運休";
                }
            } else {
                buf += "<img src='" + UNYOHUB_UNKNOWN_TRAIN_ICON + "' alt='' class='train_icon'>" + "?";
            }
        }
        
        buf += "</div><div id='train_operation_detail_area'></div>";
    }
    
    if (train_data[0] !== null) {
        if (train_data[0]["previous_trains"].length >= 1) {
            previous_trains.push(...train_data[0]["previous_trains"]);
        }
        
        for (cnt = 0; cnt < previous_trains.length; cnt++) {
            train_data.unshift(get_train(previous_trains[cnt]["line_id"], previous_trains[cnt]["train_number"], previous_trains[cnt]["first_departure_time"]));
            
            if (train_data[0] !== null && train_data[0]["previous_trains"].length >= 1) {
                previous_trains.push(...train_data[0]["previous_trains"][0]);
            }
        }
        
        if (train_data[train_data.length - 1]["next_trains"].length >= 1) {
            next_trains.push(...train_data[train_data.length - 1]["next_trains"]);
        }
        
        for (cnt = 0; cnt < next_trains.length; cnt++) {
            train_data.push(get_train(next_trains[cnt]["line_id"], next_trains[cnt]["train_number"], next_trains[cnt]["first_departure_time"]));
            
            if (train_data[train_data.length - 1] !== null && train_data[train_data.length - 1]["next_trains"].length >= 1) {
                next_trains.push(...train_data[train_data.length - 1]["next_trains"]);
            }
        }
        
        if (is_today){
            var now_str = get_hh_mm();
        }
        var previous_departure_times = null;
        
        for (cnt = 0; cnt < train_data.length; cnt++) {
            if (train_data[cnt] === null) {
                continue;
            }
            
            var stations = [...railroad_info["lines"][train_data[cnt]["line_id"]]["stations"]];
            
            buf += "<h4>" + escape_html(railroad_info["lines"][train_data[cnt]["line_id"]]["line_name"]) + "　";
            
            if (train_data[cnt]["is_inbound"]) {
                buf += "上り";
            } else {
                buf += "下り";
            }
            
            var color = get_train_color(train_data[cnt]["train_number"]);
            if (config["dark_mode"]) {
                color = convert_font_color_dark_mode(color);
            }
            
            buf += "<span style='color: " + color + ";'>" + escape_html(train_data[cnt]["train_type"] + "　" + train_data[cnt]["train_number"]) + "</span>";
            
            if (train_operations !== null) {
                var train_operations_2 = get_operations(train_data[cnt]["line_id"], train_data[cnt]["train_number"], train_data[cnt]["first_departure_time"], train_data[cnt]["is_inbound"] ? "inbound_trains" : "outbound_trains");
                
                if (railroad_info["lines"][train_data[cnt]["line_id"]]["inbound_forward_direction"] === train_data[cnt]["is_inbound"]) {
                    var before_train_str = "◀ ";
                    var after_train_str = " 　";
                } else {
                    train_operations_2.reverse();
                    
                    var before_train_str = "　 ";
                    var after_train_str = " ▶";
                }
                
                buf += "<div class='descriptive_text'>" + before_train_str;
                
                for (var cnt_2 = 0; cnt_2 < train_operations_2.length; cnt_2++) {
                    if (cnt_2 >= 1) {
                        buf += "+";
                    }
                    
                    buf += train_operations_2[cnt_2] + "運用";
                }
                
                buf += after_train_str + "</div>";
            }
            
            buf += "</h4>";
            
            for (cnt_2 = 0; cnt_2 < train_data[cnt]["departure_times"].length; cnt_2++) {
                if (train_data[cnt]["departure_times"][cnt_2] !== null && train_data[cnt]["departure_times"][cnt_2].substring(0, 1) !== "|") {
                    var border_color = railroad_info["lines"][train_data[cnt]["line_id"]]["line_color"];
                    
                    if (config["dark_mode"]) {
                        border_color = convert_color_dark_mode(border_color);
                    }
                    
                    if (train_data[cnt]["is_inbound"]) {
                        var station_index = stations.length - 1 - cnt_2;
                    } else {
                        var station_index = cnt_2;
                    }
                    
                    if (is_today && ((previous_departure_times !== null && previous_departure_times < now_str && train_data[cnt]["departure_times"][cnt_2] >= now_str) || train_data[cnt]["departure_times"][cnt_2] === now_str)) {
                        var highlight_str = " train_detail_departure_times_highlight";
                    } else {
                        var highlight_str = "";
                    }
                    
                    buf += "<div class='train_detail_departure_times" + highlight_str + "' style='border-color: " + border_color + ";'><u onclick='show_station_timetable(\"" + train_data[cnt]["line_id"] + "\", \"" + stations[station_index]["station_name"] + "\", " + train_data[cnt]["is_inbound"] + ");'>" + escape_html(stations[station_index]["station_name"]) + "</u><span style='float: right;'>" + train_data[cnt]["departure_times"][cnt_2] + "</span></div>";
                    
                    previous_departure_times = train_data[cnt]["departure_times"][cnt_2];
                }
            }
        }
        
        if (is_today) {
            buf += "<div class='informational_text'>現在位置は端末の現在時刻に基づく推定です</div>";
        }
    } else {
        var train_title = train_number.split("__")[0];
        
        var color = get_train_color(train_title);
        if (config["dark_mode"]) {
            color = convert_font_color_dark_mode(color);
        }
        
        buf += "<h4>" + escape_html(railroad_info["lines"][line_id]["line_name"]) + "　<span style='color: " + color + ";'>"
        if (railroad_info["deadhead_train_number_regexp"].test(train_title)) {
            buf += "回送　";
        }
        buf += escape_html(train_title) + "</span></h4>";
        buf += "<div class='no_data'>詳細情報はありません</div>";
    }
    
    if (navigator.onLine && train_operations !== null && is_today) {
        buf += "<button type='button' class='wide_button' onclick='select_operation_to_write_data(\"" + line_id + "\",\"" + add_slashes(train_number) + "\",\"" + first_departure_time + "\",\"" + train_direction + "\");'>運用情報を投稿</button>";
    }
    
    train_detail_area_elm.innerHTML = buf;
    
    var train_detail_day_elm = document.getElementById("train_detail_day");
    
    train_detail_day_elm.innerText = railroad_info["operations"][timetable["operation_table"]]["operation_name"];
    
    if (!config["dark_mode"]) {
        train_detail_day_elm.style.backgroundColor = railroad_info["operations"][timetable["operation_table"]]["main_color"];
    } else {
        train_detail_day_elm.style.backgroundColor = convert_color_dark_mode(railroad_info["operations"][timetable["operation_table"]]["main_color"]);
    }
    
    document.getElementById("train_detail_popup").scrollTop = 0;
    
    if (show_operation_data && navigator.onLine) {
        get_operation_data_detail(get_date_string(get_timestamp()), train_operations, "train_operation_detail_area");
    }
}

function show_station_timetable (line_id, station_name, is_inbound = null) {
    if (square_popup_is_open) {
        close_square_popup();
    }
    
    if (popup_history.length >= 1) {
        popup_close(true);
    }
    
    if (mode_val !== 1) {
        timetable_mode(false);
    }
    
    if (is_inbound !== null) {
        if (is_inbound) {
            radio_outbound_elm.checked = false;
            radio_inbound_elm.checked = true;
        } else {
            radio_inbound_elm.checked = false;
            radio_outbound_elm.checked = true;
        }
    }
    
    timetable_change_lines(line_id, true);
    timetable_select_station(station_name);
}


var timetable_line_select_elm = document.getElementById("timetable_line_select");
var timetable_area_elm = document.getElementById("timetable_area");
var timetable_back_button_elm = document.getElementById("timetable_back_button");
var timetable_promise_list = null;

function update_timetable_line_select (lines) {
    timetable_line_select_elm.innerHTML = "";
    for (var cnt = 0; cnt < lines.length; cnt++) {
        timetable_line_select_elm.innerHTML += "<option value='" + lines[cnt] + "'>" + escape_html(railroad_info["lines"][lines[cnt]]["line_name"]) + "</option>";
    }
}

function timetable_mode (load_data = true) {
    change_mode(1);
    
    if (load_data) {
        var ts = get_timestamp();
        
        var promise_1_resolved = false;
        var promise_2_resolved = false;
        var promise_3_resolved = false;
        
        timetable_promise_list = [
            new Promise(function (resolve, reject) {
                load_operation_table(function () {
                    if (!promise_1_resolved) {
                        promise_1_resolved = true;
                        resolve();
                    }
                }, reject, get_days_operation(ts), true, true, false);
            }),
            new Promise(function (resolve, reject) {
                update_timetable(function () {
                    if (!promise_2_resolved) {
                        promise_2_resolved = true;
                        resolve();
                    }
                }, reject, get_days_operation(ts));
            }),
            new Promise(function (resolve, reject) {
                update_operation_data(function () {
                    if (!promise_3_resolved) {
                        promise_3_resolved = true;
                        resolve();
                    }
                }, reject, false, get_date_string(ts));
            })
        ];
    } else {
        timetable_promise_list = null;
    }
    
    timetable_change_lines(railroad_info["lines_order"][0], true);
}

var timetable_selected_station = null;
var direction_radio_area_elm = document.getElementById("direction_radio_area");

function timetable_change_lines(line_id, force_station_select_mode = false) {
    document.getElementById("radio_inbound_label").innerHTML = "上り<small>(" + escape_html(railroad_info["lines"][line_id]["stations"][0]["station_name"]) + "方面)</small>";
    document.getElementById("radio_outbound_label").innerHTML = "下り<small>(" + escape_html(railroad_info["lines"][line_id]["stations"][railroad_info["lines"][line_id]["stations"].length - 1]["station_name"]) + "方面)</small>";
    
    if (timetable_selected_station === null || force_station_select_mode) {
        update_timetable_line_select(railroad_info["lines_order"]);
        
        if (timetable_line_select_elm.value !== line_id) {
            timetable_line_select_elm.value = line_id;
        }
        
        var station_indexes = {};
        for (var cnt = 0; cnt < railroad_info["lines"][line_id]["stations"].length; cnt++) {
            station_indexes[railroad_info["lines"][line_id]["stations"][cnt]["station_name_kana"]] = cnt;
        }
        
        var station_names = Object.keys(station_indexes).sort(new Intl.Collator("ja").compare);
        
        var kana_rows_regexp = [/^[あ-お]/, /^[か-こが-ご]/, /^[さ-そざ-ぞ]/, /^[た-とだ-ど]/, /^[な-の]/, /^[は-ほば-ぼぱ-ぽ]/, /^[ま-も]/, /^[や-よ]/, /^[ら-ろ]/, /^[わ-を]/, /.*/];
        var kana_rows = ["あ 行", "か 行", "さ 行", "た 行", "な 行", "は 行", "ま 行", "や 行", "ら 行", "わ 行", "その他"];
        
        var buf = "";
        var kana_rows_cnt = -1;
        for (cnt = 0; cnt < station_names.length; cnt++) {
            if ("is_signal_station" in railroad_info["lines"][line_id]["stations"][station_indexes[station_names[cnt]]] && railroad_info["lines"][line_id]["stations"][station_indexes[station_names[cnt]]]["is_signal_station"]) {
                continue;
            }
            
            for (var cnt_2 = Math.max(kana_rows_cnt, 0); kana_rows_regexp[cnt_2].exec(station_names[cnt]) === null; cnt_2++) {}
            if (cnt_2 > kana_rows_cnt) {
                if (kana_rows_cnt >= 0) {
                    buf += "</div>";
                }
                
                buf += "<input type='checkbox' id='timetable_kana_rows_" + cnt_2 + "'><label for='timetable_kana_rows_" + cnt_2 + "' class='drop_down'>" + kana_rows[cnt_2] + "の駅</label><div>";
                kana_rows_cnt = cnt_2;
            }
            
            buf += "<a href='javascript:void(0);' onclick='timetable_select_station(\"" + railroad_info["lines"][line_id]["stations"][station_indexes[station_names[cnt]]]["station_name"] + "\")'><b>" + escape_html(railroad_info["lines"][line_id]["stations"][station_indexes[station_names[cnt]]]["station_name"]) + "</b> (" + station_names[cnt] + ")" + "</a>";
        }
        buf += "</div>";
        
        timetable_area_elm.innerHTML = buf;
        timetable_back_button_elm.style.display = "none";
        direction_radio_area_elm.style.display = "none";
        timetable_selected_station = null;
    } else {
        timetable_select_station(timetable_selected_station);
    }
}

var radio_inbound_elm = document.getElementById("radio_inbound");
var radio_outbound_elm = document.getElementById("radio_outbound");

function timetable_select_station (station_name) {
    timetable_area_elm.innerHTML = "";
    
    timetable_selected_station = station_name;
    
    if (timetable_promise_list !== null) {
        Promise.all(timetable_promise_list).then(function () {
            draw_station_timetable(station_name);
        }).catch(function () {
            timetable_area_elm.innerHTML = "<div class='no_data'>表示に必要なデータが利用できません</div>";
        });
    } else {
        draw_station_timetable(station_name);
    }
}

function draw_station_timetable (station_name) {
    timetable_back_button_elm.style.display = "block";
    direction_radio_area_elm.style.display = "block";
    
    var line_id = timetable_line_select_elm.value;
    
    for (station_index = 0; station_index < railroad_info["lines"][line_id]["stations"].length; station_index++) {
        if (railroad_info["lines"][line_id]["stations"][station_index]["station_name"] === station_name) {
            break;
        }
    }
    
    document.getElementById("timetable_station_name").innerText = railroad_info["lines"][line_id]["stations"][station_index]["station_name"];
    
    if ("connecting_lines" in railroad_info["lines"][line_id]["stations"][station_index]) {
        update_timetable_line_select([line_id].concat(railroad_info["lines"][line_id]["stations"][station_index]["connecting_lines"]));
    } else {
        update_timetable_line_select([line_id]);
    }
    
    if (document.getElementById("radio_inbound").checked) {
        var train_direction = "inbound_trains";
        var is_inbound = true;
        var station_index = railroad_info["lines"][line_id]["stations"].length - 1 - station_index;
    } else {
        var train_direction = "outbound_trains";
        var is_inbound = false;
    }
    
    document.getElementById("show_arriving_trains_check").checked = config["show_arriving_trains_on_timetable"];
    
    var keys = Object.keys(timetable["timetable"][line_id][train_direction]);
    var departure_times = {};
    var first_departure_times = {};
    var train_types = {};
    var is_starting_stations = {};
    var is_terminal_stations = {};
    
    for (cnt = 0; cnt < keys.length; cnt++) {
        for (var cnt_2 = 0; cnt_2 < timetable["timetable"][line_id][train_direction][keys[cnt]].length; cnt_2++) {
            var departure_time = timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["departure_times"][station_index];
            
            if (departure_time !== null && departure_time.substring(0, 1) !== "|"){
                var is_terminal_station = true;
                
                for (var cnt_3 = station_index + 1; cnt_3 < timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["departure_times"].length; cnt_3++) {
                    if (timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["departure_times"][cnt_3] !== null) {
                        is_terminal_station = false;
                        break;
                    }
                }
                
                if (is_terminal_station) {
                    for (cnt_3 = 0; cnt_3 < timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["next_trains"].length; cnt_3++) {
                        if (timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["next_trains"][cnt_3]["line_id"] === line_id) {
                            is_terminal_station = false;
                            break;
                        }
                    }
                }
                
                if (!config["show_arriving_trains_on_timetable"] && is_terminal_station) {
                    continue;
                }
                
                if (timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["previous_trains"].length == 0) {
                    var is_starting_station = true;
                    
                    for (cnt_3 = 0; cnt_3 < station_index; cnt_3++) {
                        if (timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["departure_times"][cnt_3] !== null) {
                            is_starting_station = false;
                            break;
                        }
                    }
                } else {
                    var is_starting_station = false;
                }
                
                hh_and_mm = departure_time.split(":");
                
                if (!(hh_and_mm[0] in departure_times)) {
                    departure_times[hh_and_mm[0]] = {};
                    first_departure_times[hh_and_mm[0]] = {};
                    train_types[hh_and_mm[0]] = {};
                    is_starting_stations[hh_and_mm[0]] = {};
                    is_terminal_stations[hh_and_mm[0]] = {};
                }
                
                departure_times[hh_and_mm[0]][hh_and_mm[1]] = keys[cnt];
                first_departure_times[hh_and_mm[0]][hh_and_mm[1]] = timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["first_departure_time"];
                train_types[hh_and_mm[0]][hh_and_mm[1]] = timetable["timetable"][line_id][train_direction][keys[cnt]][cnt_2]["train_type"];
                is_starting_stations[hh_and_mm[0]][hh_and_mm[1]] = is_starting_station;
                is_terminal_stations[hh_and_mm[0]][hh_and_mm[1]] = is_terminal_station;
            }
        }
    }
    
    keys = Object.keys(departure_times);
    keys.sort();
    
    var bg_color = railroad_info["operations"][timetable_operation_table]["main_color"];
    
    if (config["dark_mode"]) {
        bg_color = convert_color_dark_mode(bg_color);
        
        var color_style = "";
    } else {
        var color_style = " color: #444444;";
    }
    
    if (timetable_operation_table === get_days_operation(get_timestamp())) {
        var is_today = true;
    } else {
        var is_today = false;
    }
    
    var buf = "";
    for (cnt = 0; cnt < keys.length; cnt++) {
        buf += "<input type='checkbox' id='timetable_hour_" + keys[cnt] + "'><label for='timetable_hour_" + keys[cnt] + "' style='background-color: " + bg_color + ";" + color_style + "' class='drop_down'>" + Number(keys[cnt]) + "時</label><div>";
        
        var keys_2 = Object.keys(departure_times[keys[cnt]]);
        keys_2.sort();
        
        for (cnt_2 = 0; cnt_2 < keys_2.length; cnt_2++) {
            buf += "<a href='javascript:void(0);' onclick='train_detail(\"" + line_id + "\", \"" + departure_times[keys[cnt]][keys_2[cnt_2]] + "\", \"" + first_departure_times[keys[cnt]][keys_2[cnt_2]] + "\", \"" + train_direction + "\", " + is_today + ", " + is_today + ");' class='timetable_train'>";
            
            var train_operations = get_operations(line_id, departure_times[keys[cnt]][keys_2[cnt_2]], first_departure_times[keys[cnt]][keys_2[cnt_2]], train_direction);
            if (is_today) {
                var formation_data = convert_formation_data(line_id, train_operations, is_inbound);
                
                buf += "<img src='" + get_icon(formation_data["first_formation"]) + "' alt='' class='train_icon'>";
            } else {
                buf += "<img src='" + UNYOHUB_GENERIC_TRAIN_ICON + "' alt='' class='train_icon'>";
            }
            
            var color = get_train_color(departure_times[keys[cnt]][keys_2[cnt_2]]);
            
            if (config["dark_mode"]) {
                color = convert_font_color_dark_mode(color);
            }
            
            buf += "<span style='color: " + color + ";'><b>" + Number(keys_2[cnt_2]);
            
            if (is_starting_stations[keys[cnt]][keys_2[cnt_2]]) {
                buf += "<small>(始)</small>";
            } else if (is_terminal_stations[keys[cnt]][keys_2[cnt_2]]) {
                buf += "(着)";
            }
            
            buf += "</b>" + escape_html(train_types[keys[cnt]][keys_2[cnt_2]]) + "</span>　";
            
            buf += get_final_destination(line_id, departure_times[keys[cnt]][keys_2[cnt_2]], first_departure_times[keys[cnt]][keys_2[cnt_2]]);
            
            if (is_today) {
                buf += "　<small>";
                if (train_operations !== null) {
                    var car_count = 0;
                    for (cnt_3 = 0; cnt_3 < train_operations.length; cnt_3++) {
                        car_count += operations["operations"][train_operations[cnt_3]]["car_count"];
                    }
                    
                    buf += "(所定" + car_count + "両)";
                } else {
                    buf += "(不明な運用)";
                }
                buf += "</small><br>";
                
                if (formation_data["comment_exists"]) {
                    formation_data["formation_text"] += "*";
                }
                
                if (formation_data["posts_count"] === 0) {
                    if (!config["dark_mode"]) {
                        var color = "#0000cc";
                    } else {
                        var color = "#9999ff";
                    }
                    
                    buf += "<span style='color: " + color + ";'>" + escape_html(formation_data["formation_text"]) + "</span>";
                } else if (formation_data["variant_exists"]) {
                    if (!config["dark_mode"]) {
                        var color = "#cc0000";
                    } else {
                        var color = "#ff9999";
                    }
                    
                    buf += "<span style='color: " + color + ";'>" + escape_html(formation_data["formation_text"]) + "</span>";
                } else if (config["colorize_beginners_posts"] && formation_data["from_beginner"]) {
                    var color = "#33cc99";
                    
                    buf += "<span style='color: " + color + ";'>" + escape_html(formation_data["formation_text"]) + "</span>";
                } else {
                    buf += escape_html(formation_data["formation_text"]);
                }
            } else if (train_operations !== null) {
                buf += "<br>";
                
                if (railroad_info["lines"][line_id]["inbound_forward_direction"] !== (train_direction === "inbound_trains")) {
                    train_operations.reverse();
                }
                
                for (cnt_3 = 0; cnt_3 < train_operations.length; cnt_3++) {
                    if (cnt_3 >= 1) {
                        buf += "+";
                    }
                    
                    buf += train_operations[cnt_3] + "運用<small>(" + operations["operations"][train_operations[cnt_3]]["operation_group_name"] + " " + operations["operations"][train_operations[cnt_3]]["car_count"] + "両)</small>";
                }
            } else {
                buf += "<br>不明な運用";
            }
            
            buf += "</a>";
        }
        
        buf += "</div>"
    }
    
    if (buf.length !== 0) {
        timetable_area_elm.innerHTML = buf;
    } else {
        timetable_area_elm.innerHTML = "<div class='no_data'>列車情報が登録されていません</div>";
    }
    
    article_elms[1].scrollTop = 0;
}

function change_show_arriving_trains (bool_val) {
    config["show_arriving_trains_on_timetable"] = bool_val;
    
    save_config();
    
    timetable_select_station(timetable_selected_station);
}

function timetable_change_operation (operation_table_name) {
    var promise_1_resolved = false;
    var promise_2_resolved = false;
    
    timetable_promise_list = [
        new Promise(function (resolve, reject) {
            load_operation_table(function () {
                if (!promise_1_resolved) {
                    promise_1_resolved = true;
                    resolve();
                }
            }, reject, operation_table_name, true, true, false);
        }),
        new Promise(function (resolve, reject) {
            update_timetable(function () {
                if (!promise_2_resolved) {
                    promise_2_resolved = true;
                    resolve();
                }
            }, reject, operation_table_name);
        })
    ];
    
    if (timetable_selected_station !== null) {
        timetable_select_station(timetable_selected_station);
    }
}

function timetable_operation_previous () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(timetable_operation_table) - 1;
    
    if (key_index < 0) {
        key_index = keys.length - 1;
    }
    
    timetable_change_operation(keys[key_index]);
}

function timetable_operation_next () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(timetable_operation_table) + 1;
    
    if (key_index >= keys.length) {
        key_index = 0;
    }
    
    timetable_change_operation(keys[key_index]);
}


var operation_data_area_elm = document.getElementById("operation_data_area");
var operation_date_button_elm = document.getElementById("operation_date_button");

var operation_data_date;
var operation_all_data_loaded = false;

function operation_data_mode () {
    operation_date_button_elm.max = get_date_string(get_timestamp() + 86400);
    
    operation_data_change_date(null);
}

function operation_data_change_date (date_additions) {
    var ts = get_timestamp();
    
    if (date_additions === null) {
        change_mode(2);
        
        operation_data_date = ts;
    } else {
        operation_data_date += date_additions * 86400;
        
        if (operation_data_date > ts + 86400) {
            operation_data_date = ts + 86400;
            
            mes("2日以上先の運用情報は表示できません");
        }
    }
    
    operation_data_area_elm.innerHTML = "";
    
    var date_string = get_date_string(operation_data_date);
    operation_date_button_elm.value = date_string;
    
    operation_all_data_loaded = false;
    
    var promise_1_resolved = false;
    var promise_2_resolved = false;
    
    var promise_1 = new Promise(function (resolve, reject) {
        load_operation_table(function () {
            if (!promise_1_resolved) {
                promise_1_resolved = true;
                resolve();
            }
        }, reject, get_days_operation(operation_data_date), true, false, true);
    });
    var promise_2 = new Promise(function (resolve, reject) {
        update_operation_data(function () {
            if (!promise_2_resolved) {
                promise_2_resolved = true;
                resolve();
            } else if (promise_1_resolved) {
                operation_data_draw();
            }
        }, reject, false, date_string);
    });
    
    document.getElementById("operation_data_date").innerHTML = date_string.replace(/-/g, "/");
    
    Promise.all([promise_1, promise_2]).then(function () {
        operation_all_data_loaded = true;
        
        operation_data_draw();
    }).catch(function () {
        operation_data_area_elm.innerHTML = "<div class='no_data'>表示に必要なデータが利用できません</div>";
    });
}

function operation_date_button_change () {
    if (operation_date_button_elm.valueAsDate !== null) {
        operation_data_date = Math.floor(operation_date_button_elm.valueAsDate.getTime() / 1000);
        
        operation_data_change_date(0);
    } else {
        operation_data_change_date(null);
    }
}

function operation_data_draw () {
    if (!operation_all_data_loaded) {
        return;
    }
    
    var operation_table_id = get_days_operation(operation_data_date);
    
    var bg_color = railroad_info["operations"][operation_table_id]["main_color"];
    
    if (config["dark_mode"]) {
        bg_color = convert_color_dark_mode(bg_color);
        
        var color_style = "";
    } else {
        var color_style = " color: #444444;";
    }
    
    var buf = "<h2 style='background-color: " + bg_color + ";" + color_style + "'>" + railroad_info["operations"][operation_table_id]["operation_name"] + " ";
    
    var show_write_operation_data_button = "true";
    
    var today_ts = get_timestamp();
    if (operation_data_date > today_ts) {
        buf += "(明日)";
    } else if (operation_data_date > today_ts - 86400) {
        buf += "(今日)";
    } else if (today_ts - operation_data_date < 172800) {
        buf += "(昨日)";
    } else if (today_ts - operation_data_date <= 259200) {
        buf += "(一昨日)";
    } else {
        buf += "(" + Math.floor((today_ts - operation_data_date) / 86400) + "日前)";
        show_write_operation_data_button = "false";
    }
    
    buf += "</h2>";
    
    for (var cnt = 0; cnt < operation_groups["operation_groups"].length; cnt++) {
        buf += "<h3>" +operation_groups["operation_groups"][cnt]["operation_group_name"] + "</h3>";
        
        buf += "<table>";
        for (var cnt_2 = 0; cnt_2 < operation_groups["operation_groups"][cnt]["operation_numbers"].length; cnt_2++) {
            var operation_number = operation_groups["operation_groups"][cnt]["operation_numbers"][cnt_2];
            
            if (!config["dark_mode"]) {
                var bg_color = operations["operations"][operation_number]["main_color"];
            } else {
                var bg_color = convert_color_dark_mode(operations["operations"][operation_number]["main_color"]);
            }
            
            buf += "<tr onclick='operation_detail(\"" + operation_number + "\", " + operation_data_date + ", " + show_write_operation_data_button + ");'><th style='background-color: " + bg_color + ";'><u>" + operation_number + "</u><small>(" + operations["operations"][operation_number]["car_count"] + ")</th>";
            
            if (operation_number in operation_data["operations"] && operation_data["operations"][operation_number] !== null) {
                if (operation_data["operations"][operation_number]["posts_count"] === 0) {
                    if (!config["dark_mode"]) {
                        var color = "#0000cc";
                    } else {
                        var color = "#9999ff";
                    }
                    
                    buf += "<td style='color: " + color + ";'>";
                } else if (operation_data["operations"][operation_number]["variant_exists"]) {
                    if (!config["dark_mode"]) {
                        var color = "#cc0000";
                    } else {
                        var color = "#ff9999";
                    }
                    
                    buf += "<td style='color: " + color + ";'>";
                } else if (config["colorize_beginners_posts"] && operation_data["operations"][operation_number]["from_beginner"]) {
                    var color = "#33cc99";
                    
                    buf += "<td style='color: " + color + ";'>";
                } else {
                    buf += "<td>";
                }
                
                if (operation_data["operations"][operation_number]["formations"] !== "") {
                    var formation_list = operation_data["operations"][operation_number]["formations"].split("+");
                    
                    for (var cnt_3 = 0; cnt_3 < formation_list.length; cnt_3++){
                        if (cnt_3 >= 1) {
                            buf += " +";
                        }
                        
                        buf += "<img src='" + get_icon(formation_list[cnt_3]) + "' alt='' class='train_icon'>" + formation_list[cnt_3];
                    }
                } else {
                    buf += "<img src='" + UNYOHUB_CANCELED_TRAIN_ICON + "' alt='' class='train_icon'>運休";
                }
                
                if (operation_data["operations"][operation_number]["comment_exists"]) {
                    buf += "*";
                }
                
                buf += "</td>";
            } else {
                buf += "<td><img src='" + UNYOHUB_UNKNOWN_TRAIN_ICON + "' alt='' class='train_icon'>?</td>";
            }
            buf += "</tr>";
        }
        buf += "</table>";
    }
    
    buf += "<br><div class='informational_text'>最新の投稿: " + get_date_and_time(operation_data["last_modified_timestamp"]) + "</div>";
    
    operation_data_area_elm.innerHTML = buf;
}

var operation_detail_area_elm = document.getElementById("operation_detail_area");
var operation_detail_write_button_enabled = false;

function operation_detail (operation_number, operation_data_date_ts_or_operation_name, show_write_operation_data_button = null, formation_text = null) {
    open_popup("operation_detail_popup");
    
    operation_detail_area_elm.innerHTML = "";
    operation_detail_area_elm.scrollTop = 0;
    
    if (show_write_operation_data_button !== null) {
        operation_detail_write_button_enabled = show_write_operation_data_button;
    }
    
    if (typeof operation_data_date_ts_or_operation_name !== "string") {
        var operation_table_name = get_days_operation(operation_data_date_ts_or_operation_name);
        
        if (operation_table_name !== operations["operation_table"] || operation_table_name !== line_operations["operation_table"] || operation_table_name !== timetable["operation_table"]) {
            var promise_1_resolved = false;
            var promise_1 = new Promise(function (resolve, reject) {
                load_operation_table(function () {
                    if (!promise_1_resolved) {
                        promise_1_resolved = true;
                        resolve();
                    }
                }, function () {}, operation_table_name, true, true, false);
            });
            
            var promise_2_resolved = false;
            var promise_2 = new Promise(function (resolve, reject) {
                update_timetable(function () {
                    if (!promise_2_resolved) {
                        promise_2_resolved = true;
                        resolve();
                    } else if (promise_1_resolved) {
                        draw_operation_detail(operation_number, operation_data_date_ts_or_operation_name, formation_text);
                    }
                }, function () {}, operation_table_name);
            });
            
            Promise.all([promise_1, promise_2]).then(function () {
                draw_operation_detail(operation_number, operation_data_date_ts_or_operation_name, formation_text);
            });
            
            return;
        }
    }
    
    draw_operation_detail(operation_number, operation_data_date_ts_or_operation_name, formation_text);
}

function draw_operation_detail (operation_number, operation_data_date_ts_or_operation_name, formation_text) {
    if (typeof operation_data_date_ts_or_operation_name === "string") {
        var operation_table_name = operation_data_date_ts_or_operation_name;
        var operation_data_date_str = null;
        var is_today = false;
        var operation_table_name_or_ts = "\"" + operation_data_date_ts_or_operation_name + "\"";
        operation_detail_write_button_enabled = false;
    } else {
        var operation_table_name = get_days_operation(operation_data_date_ts_or_operation_name);
        var operation_data_date_str = get_date_string(operation_data_date_ts_or_operation_name);
        
        if (operation_data_date_str === get_date_string(get_timestamp())) {
            var is_today = true;
        } else {
            var is_today = false;
        }
        
        var operation_table_name_or_ts = operation_data_date_ts_or_operation_name;
    }
    
    var bg_color = railroad_info["operations"][operation_table_name]["main_color"];
    
    if (config["dark_mode"]) {
        bg_color = convert_color_dark_mode(bg_color);
        
        var color_style = "";
    } else {
        var color_style = " color: #444444;";
    }
    
    var buf = "<h2 style='background-color: " + bg_color + ";" + color_style + "'><button type='button' class='previous_button' onclick='previous_operation_number(\"" + operation_number + "\", " + operation_table_name_or_ts + ");'></button>" + operation_number + "運用<small>" + operations["operations"][operation_number]["operation_group_name"] + " (" + operations["operations"][operation_number]["car_count"] + "両)</small><button type='button' class='next_button' onclick='next_operation_number(\"" + operation_number + "\", " + operation_table_name_or_ts + ");'></button></h2>";
    
    if (formation_text !== null || typeof operation_data_date_ts_or_operation_name !== "string") {
        buf += "<div class='formation_data_area'>";
        
        if (formation_text === null && operation_number in operation_data["operations"] && operation_data["operations"][operation_number] !== null) {
            formation_text = operation_data["operations"][operation_number]["formations"];
        }
        
        if (formation_text !== null) {
            if (formation_text !== "") {
                var formations_data = formation_text.split("+");
                
                for (var cnt_2 = 0; cnt_2 < formations_data.length; cnt_2++) {
                    if (cnt_2 >= 1) {
                        buf += " +"
                    }
                    
                    if (formations_data[cnt_2] in formations["formations"]) {
                        buf += "<a href='javascript:void(0);' onclick='popup_close(); formation_table_mode(\"" + add_slashes(formations_data[cnt_2]) + "\");'><img src='" + get_icon(formations_data[cnt_2]) + "' alt='' class='train_icon'>" + escape_html(formations_data[cnt_2]) + "</a>";
                    } else if (formations_data[cnt_2] === "?") {
                        buf += "<img src='" + UNYOHUB_UNKNOWN_TRAIN_ICON + "' alt='' class='train_icon'>" + "?";
                    } else {
                        buf += "<img src='" + get_icon(formations_data[cnt_2]) + "' alt='' class='train_icon'>" + escape_html(formations_data[cnt_2]);
                    }
                }
            } else {
                buf += "<img src='" + UNYOHUB_CANCELED_TRAIN_ICON + "' alt='' class='train_icon'>" + "運休";
            }
        } else {
            buf += "<img src='" + UNYOHUB_UNKNOWN_TRAIN_ICON + "' alt='' class='train_icon'>" + "?";
        }
        
        buf += "</div><div id='operation_data_detail_area'></div>";
    }
    
    buf += "<h3>充当列車一覧</h3>";
    
    if (config["simplify_operation_details"]) {
        var checked_str = " checked='checked'";
    } else {
        var checked_str = "";
    }
    buf += "<input type='checkbox' id='simplify_operation_details_check' onchange='change_simplify_operation_details(this.checked, \"" + add_slashes(operation_number) + "\", " + operation_table_name_or_ts + ", " + is_today + ");'" + checked_str + "><label for='simplify_operation_details_check'>簡略表示</label>";
    
    buf += "<div id='operation_trains_area'></div>";
    
    if (navigator.onLine && operation_detail_write_button_enabled) {
        buf += "<button type='button' class='wide_button' onclick='write_operation_data(\"" + operation_data_date_str + "\", \"" + operation_number + "\");'>運用情報を投稿</button>";
    }
    
    operation_detail_area_elm.innerHTML = buf;
    
    draw_operation_trains(operation_number, operation_table_name_or_ts, is_today);
    
    if (navigator.onLine && (formation_text !== null || typeof operation_data_date_ts_or_operation_name !== "string")) {
        get_operation_data_detail(operation_data_date_str, operation_number, "operation_data_detail_area");
    }
}

function draw_operation_trains (operation_number, operation_table_name_or_ts, is_today) {
    if (config["simplify_operation_details"]) {
        var train_div_class_name = "train_overview";
    } else {
        var train_div_class_name = "operation_table_train";
    }
    var buf 
    = "<div class='" + train_div_class_name + "'><b class='train_overview_location'>" + operations["operations"][operation_number]["starting_location"];
    if (operations["operations"][operation_number]["starting_track"] !== null) {
        buf += "<small>(" + operations["operations"][operation_number]["starting_track"] + ")</small>";
    }
    buf += " 出庫</b><time>" + operations["operations"][operation_number]["starting_time"] + "</time></div>";
    
    if (is_today){
        var now_str = get_hh_mm();
    }
    
    var trains = operations["operations"][operation_number]["trains"];
    var next_train_operation_list = null;
    var starting_station = null;
    var highlight_str = "";
    for (var cnt = 0; cnt < trains.length; cnt++) {
        if (trains[cnt]["train_number"].substring(0, 1) === ".") {
            buf += "<div class='" + train_div_class_name + " operation_table_deposited_train'>";
            buf += "<b>" + trains[cnt]["train_number"].substring(1).split("__")[0] + "<small>待機</small></b>";
            
            if (is_today && trains[cnt]["final_arrival_time"] < now_str) {
                highlight_str = "";
            }
            
            buf += "<span" + highlight_str + ">" + trains[cnt]["first_departure_time"] + "</span><span" + highlight_str + ">〜</span><span" + highlight_str + ">" + trains[cnt]["final_arrival_time"] + "</span>";
            buf += "</div>";
        } else {
            if (next_train_operation_list === null) {
                var operations_list = get_operations(trains[cnt]["line_id"], trains[cnt]["train_number"], trains[cnt]["first_departure_time"], trains[cnt]["direction"] + "_trains");
                if (operations_list !== null) {
                    operations_list.splice(operations_list.indexOf(operation_number), 1);
                } else {
                    operations_list = [];
                }
            } else {
                var operations_list = next_train_operation_list;
            }
            
            if (starting_station === null) {
                if (config["simplify_operation_details"]) {
                    var station_list_1 = railroad_info["lines"][trains[cnt]["line_id"]]["stations"];
                    for (var cnt_2 = 0; cnt_2 < station_list_1.length; cnt_2++) {
                        if (station_list_1[cnt_2]["station_name"] === trains[cnt]["starting_station"]) {
                            starting_station = station_list_1[cnt_2]["station_initial"];
                            break;
                        }
                    }
                } else {
                    starting_station = trains[cnt]["starting_station"];
                }
                
                var first_departure_time = trains[cnt]["first_departure_time"];
                
                if (is_today && first_departure_time <= now_str) {
                    highlight_str = " class='search_highlight'";
                }
            }
            
            if (cnt + 1 < trains.length && trains[cnt]["train_number"] === trains[cnt + 1]["train_number"]) {
                next_train_operation_list = get_operations(trains[cnt + 1]["line_id"], trains[cnt + 1]["train_number"], trains[cnt + 1]["first_departure_time"], trains[cnt + 1]["direction"] + "_trains");
                if (next_train_operation_list !== null) {
                    next_train_operation_list.splice(next_train_operation_list.indexOf(operation_number), 1);
                } else {
                    next_train_operation_list = [];
                }
                
                if (config["simplify_operation_details"] || operations_list.toString() === next_train_operation_list.toString() ) {
                    continue;
                }
            } else {
                next_train_operation_list = null;
            }
            
            if (!config["dark_mode"]) {
                var color = get_train_color(trains[cnt]["train_number"]);
            } else {
                var color = convert_font_color_dark_mode(get_train_color(trains[cnt]["train_number"]));
            }
            
            buf += "<div class='" + train_div_class_name + "'>";
            
            buf += "<a href='javascript:void(0);' onclick='train_detail(\"" + trains[cnt]["line_id"] + "\", \"" + trains[cnt]["train_number"] + "\", \"" + trains[cnt]["first_departure_time"] + "\", \"" + trains[cnt]["direction"] + "_trains\", false, " + is_today + ");'><b style='color: " + color + ";'><u>";
            
            if (trains[cnt]["train_number"] in timetable["timetable"][trains[cnt]["line_id"]][trains[cnt]["direction"] + "_trains"]) {
                for (var cnt_2 = 0; cnt_2 < timetable["timetable"][trains[cnt]["line_id"]][trains[cnt]["direction"] + "_trains"][trains[cnt]["train_number"]].length; cnt_2++) {
                    if (timetable["timetable"][trains[cnt]["line_id"]][trains[cnt]["direction"] + "_trains"][trains[cnt]["train_number"]][cnt_2]["first_departure_time"] === trains[cnt]["first_departure_time"]) {
                        var train_type = timetable["timetable"][trains[cnt]["line_id"]][trains[cnt]["direction"] + "_trains"][trains[cnt]["train_number"]][cnt_2]["train_type"];
                        
                        if (config["simplify_operation_details"]) {
                            buf += train_type.substring(0, 1) + " ";
                        } else {
                            buf += train_type + "　";
                        }
                        
                        break;
                    }
                }
            } else {
                if (railroad_info["deadhead_train_number_regexp"].test(trains[cnt]["train_number"])) {
                    if (config["simplify_operation_details"]) {
                        buf += "回 ";
                    } else {
                        buf += "回送　";
                    }
                }
            }
            
            buf += trains[cnt]["train_number"].split("__")[0];
            
            buf += "</u><small>(" + trains[cnt]["position_forward"] + "-" + trains[cnt]["position_rear"];
            if (!config["simplify_operation_details"]) {
                buf += "両目";
            }
            buf += ")</small></b>";
            
            if (is_today && trains[cnt]["final_arrival_time"] < now_str) {
                highlight_str = "";
            }
            
            if (config["simplify_operation_details"]) {
                var station_list_2 = railroad_info["lines"][trains[cnt]["line_id"]]["stations"];
                for (var cnt_2 = 0; cnt_2 < station_list_2.length; cnt_2++) {
                    if (station_list_2[cnt_2]["station_name"] === trains[cnt]["terminal_station"]) {
                        var terminal_station = station_list_2[cnt_2]["station_initial"];
                        break;
                    }
                }
            } else {
                var terminal_station = trains[cnt]["terminal_station"];
            }
            
            buf += "<span" + highlight_str + ">" + starting_station + " " + first_departure_time + "</span><span" + highlight_str + ">→</span><span" + highlight_str + ">" + trains[cnt]["final_arrival_time"] + " " + terminal_station + "</span></a>";
            
            if (!config["simplify_operation_details"] && operations_list.length >= 1) {
                buf += "<div>併結:";
                for (var cnt_2 = 0; cnt_2 < operations_list.length; cnt_2++) {
                    buf += " <a href='javascript:void(0);' onclick='operation_detail(\"" + operations_list[cnt_2] + "\", " + operation_table_name_or_ts + ");'>" + operations_list[cnt_2] + "運用</a>";
                }
                buf += "</div>";
            }
            
            buf += "</div>";
            
            starting_station = null;
        }
        
        if (is_today && trains[cnt]["final_arrival_time"] < now_str) {
            highlight_str = " class='search_highlight'";
        } else {
            highlight_str = "";
        }
    }
    
    buf += "<div class='" + train_div_class_name + "'><b class='train_overview_location'>" + operations["operations"][operation_number]["terminal_location"];
    if (operations["operations"][operation_number]["terminal_track"] !== null) {
        buf += "<small>(" + operations["operations"][operation_number]["terminal_track"] + ")</small>";
    }
    buf += " 入庫</b><time>" + operations["operations"][operation_number]["ending_time"] + "</time></div>";
    
    document.getElementById("operation_trains_area").innerHTML = buf;
}

function change_simplify_operation_details (bool_val, operation_number, operation_table_name_or_ts, is_today) {
    config["simplify_operation_details"] = bool_val;
    
    save_config();
    
    draw_operation_trains(operation_number, operation_table_name_or_ts, is_today);
}

function previous_operation_number (operation_number, operation_data_date_ts_or_operation_name) {
    var operation_numbers = Object.keys(operations["operations"]).toSorted();
    
    var operation_number_index = operation_numbers.indexOf(operation_number);
    if (operation_number_index >= 1) {
        operation_detail(operation_numbers[operation_number_index - 1], operation_data_date_ts_or_operation_name);
    } else {
        operation_detail(operation_numbers[operation_numbers.length - 1], operation_data_date_ts_or_operation_name);
    }
}

function next_operation_number (operation_number, operation_data_date_ts_or_operation_name) {
    var operation_numbers = Object.keys(operations["operations"]).toSorted();
    
    var operation_number_index = operation_numbers.indexOf(operation_number);
    if (operation_number_index < operation_numbers.length - 1) {
        operation_detail(operation_numbers[operation_number_index + 1], operation_data_date_ts_or_operation_name);
    } else {
        operation_detail(operation_numbers[0], operation_data_date_ts_or_operation_name);
    }
}


var formation_table_wrapper_elm = document.getElementById("formation_table_wrapper");
var formation_search_area_elm = document.getElementById("formation_search_area");
var car_number_search_elm = document.getElementById("car_number_search");
var formation_table_area_elm = document.getElementById("formation_table_area");
var formation_back_button_elm = document.getElementById("formation_back_button");

var selected_formation_name = null;

var formation_table_drop_down_status;
var formation_table_wrapper_scroll_amount;

function formation_table_mode (formation_name = null) {
    change_mode(3);
    
    car_number_search_elm.value = "";
    formation_table_area_elm.innerHTML = "";
    formation_table_drop_down_status = {};
    formation_table_wrapper_scroll_amount = 0;
    
    draw_formation_table(formation_name);
}

function formation_table_wrapper_onscroll () {
    if (selected_formation_name === null) {
        formation_table_wrapper_scroll_amount = formation_table_wrapper_elm.scrollTop;
    }
}

function draw_formation_table (formation_name = null) {
    if (formation_name !== null) {
        formation_detail(formation_name);
        return;
    }
    
    formation_back_button_elm.style.display = "none";
    
    var buf = ""
    for (var cnt = 0; cnt < formations["series_names"].length; cnt++) {
        var buf_2 = "";
        var search_hit_formation_count = 0;
        for (var cnt_2 = 0; cnt_2 < formations["series"][formations["series_names"][cnt]]["formation_names"].length; cnt_2++){
            var formation_name = formations["series"][formations["series_names"][cnt]]["formation_names"][cnt_2];
            
            var buf_3 = "<div class='formation_box' onclick='formation_detail(\"" + add_slashes(formation_name) + "\");'><img src='" + get_icon(formation_name) + "' alt='' class='train_icon'>";
            
            buf_3 += "<b>" + escape_html(formation_name) + "</b><br>";
            
            var search_hit_count = 0;
            for (var cnt_3 = 0; cnt_3 < formations["formations"][formation_name]["cars"].length; cnt_3++) {
                if (car_number_search_elm.value.length >= 1) {
                    if (formations["formations"][formation_name]["cars"][cnt_3]["car_number"].includes(car_number_search_elm.value) || formations["formations"][formation_name]["cars"][cnt_3]["abbreviated_car_number"].includes(car_number_search_elm.value)) {
                        buf_3 += "<span class='search_highlight'>" + escape_html(formations["formations"][formation_name]["cars"][cnt_3]["abbreviated_car_number"]) + "</span>";
                        
                        search_hit_count++;
                        continue;
                    }
                } else {
                    search_hit_count = 1;
                }
                
                buf_3 += "<span>" + escape_html(formations["formations"][formation_name]["cars"][cnt_3]["abbreviated_car_number"]) + "</span>";
            }
            
            buf_3 += "</div>";
            
            if (search_hit_count >= 1) {
                buf_2 += buf_3;
                search_hit_formation_count++;
            }
        }
        
        if (search_hit_formation_count >= 1) {
            var checkbox_id = "series_" + formations["series_names"][cnt];
            
            buf += "<input type='checkbox' id='" + checkbox_id + "'";
            
            if (checkbox_id in formation_table_drop_down_status && formation_table_drop_down_status[checkbox_id]) {
                buf += " checked='checked'";
            }
            
            buf += " onclick='update_formation_table_drop_down_status(this);'><label for='" + checkbox_id + "' class='drop_down'>" + escape_html(formations["series_names"][cnt]);
            if (car_number_search_elm.value.length >= 1) {
                buf += " (" + search_hit_formation_count + "編成該当)";
            }
            buf += "</label><div>" + buf_2 + "</div>";
        }
    }
    
    if (buf.length !== 0) {
        formation_table_area_elm.innerHTML = buf;
    } else {
        formation_table_area_elm.innerHTML = "<div class='no_data'>検索キーワードを含む車両が見つかりません</div>";
    }
    
    formation_search_area_elm.style.display = "block";
    selected_formation_name = null;
    
    formation_table_wrapper_elm.scrollTop = formation_table_wrapper_scroll_amount;
}

function update_formation_table_drop_down_status (elm) {
    formation_table_drop_down_status[elm.id] = elm.checked;
}

function formation_detail (formation_name) {
    formation_search_area_elm.style.display = "none";
    formation_table_area_elm.innerHTML = "";
    
    selected_formation_name = formation_name;
    
    formation_back_button_elm.style.display = "block";
    
    var buf = "<h2><button type='button' class='previous_button' onclick='previous_formation(\"" + add_slashes(formation_name) + "\");'></button>" + escape_html(formation_name) + "<button type='button' class='next_button' onclick='next_formation(\"" + add_slashes(formation_name) + "\");'></button></h2>";
    
    buf += "<img src='" + get_icon(formation_name) + "' alt='' class='train_icon_large'>";
    
    buf += "<div class='key_and_value'><b>車両形式</b>" + formations["formations"][formation_name]["series_name"] + "</div>";
    buf += "<div class='descriptive_text' id='formation_description'></div>";
    
    buf += "<input type='checkbox' id='formation_operations'><label for='formation_operations' class='drop_down'>運用情報</label><div id='formation_operations_area'><div class='descriptive_text'>情報の取得を待機しています</div></div>";
    
    buf += "<h3>検査情報</h3>";
    buf += "<div class='descriptive_text' id='inspection_information'>情報がありません</div>"
    
    buf += "<h3>車両情報</h3>";
    for (var cnt = 0; cnt < formations["formations"][formation_name]["cars"].length; cnt++) {
        buf += "<div class='car_info'><b>" + formations["formations"][formation_name]["cars"][cnt]["car_number"] + "</b><span id='car_info_" + cnt + "'></span><div class='descriptive_text' id='car_description_" + cnt + "'></div></div>";
    }
    
    formation_table_area_elm.innerHTML = buf;
    formation_table_wrapper_elm.scrollTop = 0;
    
    if (navigator.onLine) {
        ajax_fetch("api/formation_details.php", "railroad_id=" + escape_form_data(railroad_info["railroad_id"]) + "&formation_name=" + escape_form_data(formation_name), function (response) {
            if (response !== false) {
                var data = JSON.parse(response);
                
                document.getElementById("formation_description").innerText = data["description"];
                
                if (data["inspection_information"] !== "") {
                    document.getElementById("inspection_information").innerText = data["inspection_information"];
                }
                
                for (var cnt = 0; cnt < data["cars"].length; cnt++) {
                    document.getElementById("car_info_" + cnt).innerText = data["cars"][cnt]["manufacturer"] + " " + data["cars"][cnt]["constructed"];
                    document.getElementById("car_description_" + cnt).innerText = data["cars"][cnt]["description"];
                }
                
                if (data["operations_today"] !== null || data["operations_tomorrow"] !== null) {
                    var buf = "<div class='formation_operation_data'><h4>今日の運用情報</h4>";
                    if (data["operations_today"] !== null) {
                        for (cnt = 0; cnt < data["operations_today"].length; cnt++) {
                            buf += "<div class='key_and_value' onclick='operation_detail(\"" + add_slashes(data["operations_today"][cnt]["operation_number"]) + "\", " + get_timestamp() + ", false, \"" + add_slashes(data["operations_today"][cnt]["formations"]) + "\");'><u>" + escape_html(data["operations_today"][cnt]["operation_number"]) + "</u>" + data["operations_today"][cnt]["formations"] + "</div>";
                        }
                    } else {
                        buf += "<div class='descriptive_text'>情報がありません</div>";
                    }
                    buf += "</div>";
                    
                    buf += "<div class='formation_operation_data'><h4>明日の運用情報</h4>";
                    if (data["operations_tomorrow"] !== null) {
                        for (cnt = 0; cnt < data["operations_tomorrow"].length; cnt++) {
                            buf += "<div class='key_and_value' onclick='operation_detail(\"" + add_slashes(data["operations_tomorrow"][cnt]["operation_number"]) + "\", " + (get_timestamp() + 86400) + ", false, \"" + add_slashes(data["operations_tomorrow"][cnt]["formations"]) + "\");'><u>" + escape_html(data["operations_tomorrow"][cnt]["operation_number"]) + "</u>" + data["operations_tomorrow"][cnt]["formations"] + "</div>";
                        }
                    } else {
                        buf += "<div class='descriptive_text'>明日の運用情報は判明していません</div>";
                    }
                    buf += "</div>";
                } else if (data["last_seen_date"] !== null) {
                    var last_seen_date_splitted = data["last_seen_date"].split("-");
                    
                    var buf = "<div class='formation_operation_data_last_seen'><h4>最終目撃情報(" + last_seen_date_splitted[0] + "/" + Number(last_seen_date_splitted[1]) + "/" + Number(last_seen_date_splitted[2]) + ")</h4>";
                    
                    var dt = new Date(data["last_seen_date"] + " 12:00:00");
                    
                    for (cnt = 0; cnt < data["operations_last_day"].length; cnt++) {
                        buf += "<div class='key_and_value' onclick='operation_detail(\"" + add_slashes(data["operations_last_day"][cnt]["operation_number"]) + "\", " + Math.floor(dt.getTime() / 1000) + ", false, \"" + add_slashes(data["operations_last_day"][cnt]["formations"]) + "\");'><u>" + escape_html(data["operations_last_day"][cnt]["operation_number"]) + "</u>" + data["operations_last_day"][cnt]["formations"] + "</div>";
                    }
                    
                    buf += "</div>";
                } else {
                    var buf = "<div class='descriptive_text'>この編成の運用情報が投稿されたことはありません</div>";
                }
                
                document.getElementById("formation_operations_area").innerHTML = buf;
            }
        });
    }
}

function previous_formation (formation_name) {
    var formation_list = formations["series"][formations["formations"][formation_name]["series_name"]]["formation_names"];
    
    var formation_index = formation_list.indexOf(formation_name);
    if (formation_index >= 1) {
        formation_detail(formation_list[formation_index - 1]);
    } else {
        formation_detail(formation_list[formation_list.length - 1]);
    }
}

function next_formation (formation_name) {
    var formation_list = formations["series"][formations["formations"][formation_name]["series_name"]]["formation_names"];
    
    var formation_index = formation_list.indexOf(formation_name);
    if (formation_index < formation_list.length - 1) {
        formation_detail(formation_list[formation_index + 1]);
    } else {
        formation_detail(formation_list[0]);
    }
}


function get_icon (formation_name) {
    if (formation_name === null || formation_name === "?") {
        return UNYOHUB_UNKNOWN_TRAIN_ICON;
    }
    
    if (formation_name === "") {
        return UNYOHUB_CANCELED_TRAIN_ICON;
    }
    
    if (formation_name in formations["formations"]){
        if (formations["formations"][formation_name]["icon_id"] in train_icons["icons"]) {
            return train_icons["icons"][formations["formations"][formation_name]["icon_id"]];
        }
    } else if (formation_name in formations["series"]) {
        if (formations["series"][formation_name]["icon_id"] in train_icons["icons"]) {
            return train_icons["icons"][formations["series"][formation_name]["icon_id"]];
        }
    }
    
    return UNYOHUB_GENERIC_TRAIN_ICON;
}

function get_train_color (train_name, default_value = "inherit") {
    for (var cnt = 0; cnt < railroad_info["train_color_rules"].length; cnt++) {
        if (railroad_info["train_color_rules"][cnt]["regexp"].test(train_name)) {
            return railroad_info["train_color_rules"][cnt]["color"];
        }
    }
    
    return default_value;
}


var operation_search_area_elm = document.getElementById("operation_search_area");
var operation_table_area_elm = document.getElementById("operation_table_area");
var operation_table_info_elm = document.getElementById("operation_table_info");
var operation_table_name;
var operation_table_name_elm = document.getElementById("operation_table_name");

function operation_table_mode (load_data = true, table_name = null) {
    change_mode(4);
    
    operation_search_area_elm.style.display = "none";
    operation_table_area_elm.innerHTML = "";
    operation_table_info_elm.innerHTML = "";
    
    var promise_list = [];
    
    if (load_data) {
        if (table_name === null){
            table_name = get_days_operation(get_timestamp());
        }
        
        operation_table_name = table_name;
        
        var promise_1_resolved = false;
        var promise_2_resolved = false;
        
        promise_list.push(new Promise(function (resolve, reject) {
            load_operation_table(function () {
                if (!promise_1_resolved) {
                    promise_1_resolved = true;
                    resolve();
                }
            }, reject, table_name, true, true, false);
        }));
        promise_list.push(new Promise(function (resolve, reject) {
            update_timetable(function () {
                if (!promise_2_resolved) {
                    promise_2_resolved = true;
                    resolve();
                }
            }, reject, table_name);
        }));
    } else {
        operation_table_name = timetable_operation_table;
    }
    
    var promise_3_resolved = false;
    
    promise_list.push(new Promise(function (resolve, reject) {
        update_operation_data(function () {
            if (!promise_3_resolved) {
                promise_3_resolved = true;
                resolve();
            }
        }, reject, false, get_date_string(get_timestamp()));
    }));
    
    operation_table_name_elm.innerText = railroad_info["operations"][operation_table_name]["operation_name"];
    train_number_search_elm.value = "";
    operation_table_wrapper_scroll_amount = 0;
    
    Promise.all(promise_list).then(function () {
        reset_operation_narrow_down();
    }).catch(function () {
        operation_table_area_elm.innerHTML = "<div class='no_data'>表示に必要なデータが利用できません</div>";
    });
}

var train_number_search_elm = document.getElementById("train_number_search");
var search_group_name_elm = document.getElementById("operation_search_group_name");
var search_car_count_elm = document.getElementById("operation_search_car_count");
var search_starting_location_elm = document.getElementById("operation_search_starting_location");
var search_terminal_location_elm = document.getElementById("operation_search_terminal_location");

var operation_table_sorting_criteria = "operation_number";
var operation_table_ascending_order = true;

function operation_table_list_number () {
    operation_search_area_elm.style.display = "block";
    operation_table_area_elm.innerHTML = "";
    
    var search_keyword = train_number_search_elm.value;
    
    var search_filter_count = 0;
    
    var search_group_name = search_group_name_elm.value;
    var search_group_name_list = [];
    if (search_group_name.length >= 1) {
        search_filter_count++
    }
    
    var search_car_count = search_car_count_elm.value;
    var search_car_count_list = [];
    if (search_car_count.length >= 1) {
        search_filter_count++
    }
    
    var search_starting_location = search_starting_location_elm.value;
    var search_starting_location_list = [];
    if (search_starting_location.length >= 1) {
        search_filter_count++
    }
    
    var search_terminal_location = search_terminal_location_elm.value;
    var search_terminal_location_list = [];
    if (search_terminal_location.length >= 1) {
        search_filter_count++
    }
    
    var search_filter_count_elm = document.getElementById("operation_search_filter_count");
    
    if (search_filter_count >= 1) {
        search_filter_count_elm.innerText = "(" + search_filter_count + ")";
    } else {
        search_filter_count_elm.innerText = "";
    }
    
    var operation_numbers = Object.keys(operations["operations"]).toSorted();
    
    if (operation_table_sorting_criteria  !== "operation_number") {
        var tmp_operation_list = {};
        
        if (operation_table_sorting_criteria === "starting_time") {
            for (var cnt = 0; cnt < operation_numbers.length; cnt++) {
                tmp_operation_list[operations["operations"][operation_numbers[cnt]]["starting_time"] + "_" + cnt] = operation_numbers[cnt];
            }
        } else {
            for (var cnt = 0; cnt < operation_numbers.length; cnt++) {
                tmp_operation_list[operations["operations"][operation_numbers[cnt]]["ending_time"] + "_" + cnt] = operation_numbers[cnt];
            }
        }
        
        var time_keys = Object.keys(tmp_operation_list).toSorted();
        
        operation_numbers = [];
        for (cnt = 0; cnt < time_keys.length; cnt++) {
            operation_numbers[cnt] = tmp_operation_list[time_keys[cnt]];
        }
    }
    
    if (operation_table_ascending_order) {
        var sorting_criteria_class_name = "sorting_criteria";
    } else {
        operation_numbers.reverse();
        
        var sorting_criteria_class_name = "sorting_criteria_desc";
    }
    
    var ts = get_timestamp();
    if (get_days_operation(ts) === operation_table_name) {
        var operation_table_name_or_ts = ts;
        var is_today_str = "true";
    } else {
        var operation_table_name_or_ts = "\"" + operation_table_name + "\"";
        var is_today_str = "false";
    }
    
    var buf = "";
    for (var cnt = 0; cnt < operation_numbers.length; cnt++) {
        if (!search_group_name_list.includes(operations["operations"][operation_numbers[cnt]]["operation_group_name"])) {
            search_group_name_list.push(operations["operations"][operation_numbers[cnt]]["operation_group_name"]);
        }
        if (!search_car_count_list.includes(operations["operations"][operation_numbers[cnt]]["car_count"])) {
            search_car_count_list.push(operations["operations"][operation_numbers[cnt]]["car_count"]);
        }
        if (!search_starting_location_list.includes(operations["operations"][operation_numbers[cnt]]["starting_location"])) {
            search_starting_location_list.push(operations["operations"][operation_numbers[cnt]]["starting_location"]);
        }
        if (!search_terminal_location_list.includes(operations["operations"][operation_numbers[cnt]]["terminal_location"])) {
            search_terminal_location_list.push(operations["operations"][operation_numbers[cnt]]["terminal_location"]);
        }
        
        if ((search_group_name !== "" && operations["operations"][operation_numbers[cnt]]["operation_group_name"] !== search_group_name) || (search_car_count !== "" && operations["operations"][operation_numbers[cnt]]["car_count"] !== Number(search_car_count)) || (search_starting_location !== "" && operations["operations"][operation_numbers[cnt]]["starting_location"] !== search_starting_location) || (search_terminal_location !== "" && operations["operations"][operation_numbers[cnt]]["terminal_location"] !== search_terminal_location)) {
            continue;
        }
        
        if (!config["dark_mode"]) {
            var color = operations["operations"][operation_numbers[cnt]]["main_color"];
        } else {
            var color = convert_color_dark_mode(operations["operations"][operation_numbers[cnt]]["main_color"]);
        }
        
        if (operations["operations"][operation_numbers[cnt]]["starting_track"] !== null) {
            var $starting_track_text = "<small>(" + operations["operations"][operation_numbers[cnt]]["starting_track"] + ")</small>";
        } else {
            var $starting_track_text = "";
        }
        
        if (operations["operations"][operation_numbers[cnt]]["terminal_track"] !== null) {
            var $terminal_track_text = "<small>(" + operations["operations"][operation_numbers[cnt]]["terminal_track"] + ")</small>";
        } else {
            var $terminal_track_text = "";
        }
        
        var trains = operations["operations"][operation_numbers[cnt]]["trains"];
        var search_hit_count = 0;
        var buf_2 = "";
        for (var cnt_2 = 0; cnt_2 < trains.length; cnt_2++) {
            if (trains[cnt_2]["train_number"].substring(0, 1) === ".") {
                continue;
            }
            
            if (cnt_2 !== 0 && trains[cnt_2]["train_number"] === trains[cnt_2 - 1]["train_number"]) {
                continue;
            }
            
            var train_number = trains[cnt_2]["train_number"].split("__")[0];
            
            if (search_keyword === "") {
                if (trains[cnt_2]["train_number"] in timetable["timetable"][trains[cnt_2]["line_id"]][trains[cnt_2]["direction"] + "_trains"]) {
                    var train_type_initial = timetable["timetable"][trains[cnt_2]["line_id"]][trains[cnt_2]["direction"] + "_trains"][trains[cnt_2]["train_number"]][0]["train_type"].substring(0, 1);
                } else if (railroad_info["deadhead_train_number_regexp"].test(train_number)) {
                    var train_type_initial = "回";
                } else {
                    var train_type_initial = "＊";
                }
                
                var train_color = get_train_color(train_number, "#333333");
                if (config["dark_mode"]) {
                    train_color = convert_font_color_dark_mode(train_color);
                }
                buf_2 += "<small style='background-color: " + train_color + ";'>" + train_type_initial + "</small>";
            } else {
                var train_number_search_index = train_number.indexOf(search_keyword);
                
                if (train_number_search_index !== -1) {
                    if (search_hit_count < 4) {
                        var train_number_search_index_end = train_number_search_index + search_keyword.length;
                        
                        buf_2 += "<span>" + train_number.substring(0, train_number_search_index) + "<span class='search_highlight'>" + train_number.substring(train_number_search_index, train_number_search_index_end) + "</span>" + train_number.substring(train_number_search_index_end) + "</span>";
                    } else if (search_hit_count === 4) {
                        buf_2 += "<span>他</span>";
                    }
                    
                    search_hit_count++;
                }
            }
        }
        
        if (search_keyword === "" || search_hit_count >= 1) {
            buf += "<tr onclick='operation_detail(\"" + operation_numbers[cnt] + "\", " + operation_table_name_or_ts + ", " + is_today_str + ");'>";
            buf += "<th rowspan='2' style='background-color: " + color + "'><b>" + operation_numbers[cnt] + "</b>" + operations["operations"][operation_numbers[cnt]]["operation_group_name"] + "<br>(" + operations["operations"][operation_numbers[cnt]]["car_count"] + "両)</th>";
            buf += "<td>" + operations["operations"][operation_numbers[cnt]]["starting_location"] + $starting_track_text + "<time>" + operations["operations"][operation_numbers[cnt]]["starting_time"] + "</time></td>";
            buf += "<td>" + operations["operations"][operation_numbers[cnt]]["terminal_location"] + $terminal_track_text + "<time>" + operations["operations"][operation_numbers[cnt]]["ending_time"] + "</time></td>";
            buf += "</tr>";
            buf += "<tr onclick='operation_detail(\"" + operation_numbers[cnt] + "\", " + operation_table_name_or_ts + ", " + is_today_str + ");'><td colspan='2' class='operation_overview'>";
            buf += buf_2;
            buf += "</td></tr>";
        }
    }
    
    var buf_2 = "<option value=''>運用グループ 指定なし</option>";
    for (cnt = 0; cnt < search_group_name_list.length; cnt++) {
        buf_2 += "<option value='" + search_group_name_list[cnt] + "'>" + search_group_name_list[cnt] + "</option>";
    }
    search_group_name_elm.innerHTML = buf_2;
    search_group_name_elm.value = search_group_name;
    
    var buf_2 = "<option value=''>所定両数 指定なし</option>";
    for (cnt = 0; cnt < search_car_count_list.length; cnt++) {
        buf_2 += "<option value='" + search_car_count_list[cnt] + "'>" + search_car_count_list[cnt] + "両</option>";
    }
    search_car_count_elm.innerHTML = buf_2;
    search_car_count_elm.value = search_car_count;
    
    var buf_2 = "<option value=''>出庫場所 指定なし</option>";
    for (cnt = 0; cnt < search_starting_location_list.length; cnt++) {
        buf_2 += "<option value='" + search_starting_location_list[cnt] + "'>" + search_starting_location_list[cnt] + " 出庫</option>";
    }
    search_starting_location_elm.innerHTML = buf_2;
    search_starting_location_elm.value = search_starting_location;
    
    var buf_2 = "<option value=''>入庫場所 指定なし</option>";
    for (cnt = 0; cnt < search_terminal_location_list.length; cnt++) {
        buf_2 += "<option value='" + search_terminal_location_list[cnt] + "'>" + search_terminal_location_list[cnt] + " 入庫</option>";
    }
    search_terminal_location_elm.innerHTML = buf_2;
    search_terminal_location_elm.value = search_terminal_location;
    
    if (buf.length !== 0) {
        switch (operation_table_sorting_criteria) {
            case "operation_number":
                var buf_3 = "<th class='" + sorting_criteria_class_name + "' onclick='operation_table_reverse_order();'>運用番号</th><th onclick='sort_operation_table(\"starting_time\")'>出庫時刻</th><th onclick='sort_operation_table(\"ending_time\")'>入庫時刻</th>";
                break;
            case "starting_time":
                var buf_3 = "<th onclick='sort_operation_table(\"operation_number\")'>運用番号</th><th class='" + sorting_criteria_class_name + "' onclick='operation_table_reverse_order();'>出庫時刻</th><th onclick='sort_operation_table(\"ending_time\")'>入庫時刻</th>";
                break;
            case "ending_time":
                var buf_3 = "<th onclick='sort_operation_table(\"operation_number\")'>運用番号</th><th onclick='sort_operation_table(\"starting_time\")'>出庫時刻</th><th class='" + sorting_criteria_class_name + "' onclick='operation_table_reverse_order();'>入庫時刻</th>";
                break;
        }
        
        operation_table_area_elm.innerHTML = "<table class='operation_table'><tr>" + buf_3 + "</tr>" + buf + "</table>";
    } else {
        operation_table_area_elm.innerHTML = "<div class='no_data'>絞り込み条件に一致する運用が見つかりません</div>";
    }
    
    operation_table_info_elm.innerHTML = "運用表更新日時: " + get_date_and_time(operations["last_modified_timestamp"]) + "<br>時刻表更新日時: " + get_date_and_time(timetable["last_modified_timestamp"]);
}

function sort_operation_table (sorting_criteria) {
    operation_table_sorting_criteria = sorting_criteria;
    operation_table_ascending_order = true;
    
    operation_table_list_number();
}

function operation_table_reverse_order () {
    operation_table_ascending_order = !operation_table_ascending_order;
    
    operation_table_list_number();
}

function reset_operation_narrow_down (close_menu = true) {
    search_group_name_elm.value = "";
    search_car_count_elm.value = "";
    search_starting_location_elm.value = "";
    search_terminal_location_elm.value = "";
    
    if (close_menu) {
        document.getElementById("operation_search_menu").checked = false;
    }
    
    operation_table_list_number();
}

function operation_table_change () {
    operation_search_area_elm.style.display = "none";
    operation_table_area_elm.innerHTML = "";
    operation_table_info_elm.innerHTML = "";
    
    operation_table_name_elm.innerText = railroad_info["operations"][operation_table_name]["operation_name"];
    
    var promise_1_resolved = false;
    var promise_2_resolved = false;
    
    var promise_1 = new Promise(function (resolve, reject) {
        load_operation_table(function () {
            if (!promise_1_resolved) {
                promise_1_resolved = true;
                resolve();
            } else if (promise_2_resolved) {
                operation_table_list_number();
            }
        }, reject, operation_table_name, true, true, false);
    });
    
    var promise_2 = new Promise(function (resolve, reject) {
        update_timetable(function () {
            if (!promise_2_resolved) {
                promise_2_resolved = true;
                resolve();
            } else if (promise_1_resolved) {
                operation_table_list_number();
            }
        }, reject, operation_table_name);
    });
    
    Promise.all([promise_1, promise_2]).then(function () {
        operation_table_list_number();
    }).catch(function () {
        operation_table_area_elm.innerHTML = "<div class='no_data'>表示に必要なデータが利用できません</div>";
    });
}

function operation_table_previous () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(operation_table_name) - 1;
    
    if (key_index < 0) {
        key_index = keys.length - 1;
    }
    
    operation_table_name = keys[key_index];
    operation_table_change();
}

function operation_table_next () {
    var keys = Object.keys(railroad_info["operations"]);
    var key_index = keys.indexOf(operation_table_name) + 1;
    
    if (key_index >= keys.length) {
        key_index = 0;
    }
    
    operation_table_name = keys[key_index];
    operation_table_change();
}


var one_time_token = null;

function get_one_time_token () {
    ajax_fetch("api/one_time_token.php", null, function (response) {
        if (response !== false) {
            var data = JSON.parse(response);
            
            one_time_token = data["token"];
        }
    });
}

var post_yyyy_mm_dd;
var post_operation_number;

function write_operation_data (yyyy_mm_dd, operation_number) {
    open_popup("write_operation_data_popup");
    
    var yyyy_mm_dd_today = get_date_string(get_timestamp());
    
    if (yyyy_mm_dd === null) {
        post_yyyy_mm_dd = yyyy_mm_dd_today;
    } else {
        post_yyyy_mm_dd = yyyy_mm_dd;
    }
    
    post_operation_number = operation_number;
    
    var alias_of_forward_direction = escape_html(railroad_info["alias_of_forward_direction"]);
    
    var buf = "<h3>" + escape_html(operation_number) + "運用</h3>";
    
    if (post_yyyy_mm_dd > yyyy_mm_dd_today || (post_yyyy_mm_dd === yyyy_mm_dd_today && operations["operations"][operation_number]["starting_time"] > get_hh_mm())) {
        var speculative_post = true;
        
        buf += "<div class='warning_text'>【!】出庫前の運用に情報を投稿しようとしています</div>";
    } else {
        var speculative_post = false;
    }
    
    buf += "<b>編成名または車両形式</b>";
    buf += "<div class='informational_text'><b>◀ " + alias_of_forward_direction + "</b></div>";
    buf += "<input type='text' id='operation_data_formation' autocomplete='off' oninput='suggest_formation(this.value);' onblur='clear_formation_suggestion();'><div class='suggestion_area'><div id='formation_suggestion'></div></div>";
    buf += "<div class='informational_text'>複数の編成が連結している場合は、" + alias_of_forward_direction + "の編成から順に「+」で区切って入力してください。<br>不明な編成には「不明」、運休情報は「運休」を入力可能です。</div>";
    buf += "<b>運用補足情報</b><textarea id='operation_data_comment'></textarea>";
    
    if(speculative_post) {
        buf += "<div class='warning_text'>お手数ですが、この運用に充当される編成を特定した方法を補足情報にご入力ください。</div>";
    } else {
        buf += "<div class='informational_text'>差し替え等の特記事項がない場合は省略可能です。</div>";
    }
    
    buf += "<button type='button' class='wide_button' onclick='check_post_operation_data();'>投稿する</button>";
    
    document.getElementById("write_operation_data_area").innerHTML = buf;
    
    if (user_data !== null) {
        get_one_time_token();
    }
}

function suggest_formation (formations_text) {
    var formations_splitted = formations_text.split("+");
    var formation_text = formations_splitted[formations_splitted.length - 1].toUpperCase();
    
    var buf = "";
    
    if (formation_text.length >= 1) {
        var formation_names = formations["series_names"].concat(Object.keys(formations["formations"]).sort());
        
        var suggestion_list = formation_names.filter(function (formation_name) {
            return formation_name.toUpperCase().startsWith(formation_text);
        });
        
        for (var cnt = 0; cnt < suggestion_list.length; cnt++) {
            buf += "<a href='javascript:void(0);' onclick='complete_formation(\"" + add_slashes(suggestion_list[cnt]) + "\");'><img src='" + get_icon(suggestion_list[cnt]) + "' alt='' class='train_icon'>" + suggestion_list[cnt] + "</a>";
        }
    }
    
    document.getElementById("formation_suggestion").innerHTML = buf;
}

function complete_formation (formation_text) {
    var operation_data_formation_elm = document.getElementById("operation_data_formation");
    
    var formations_splitted = operation_data_formation_elm.value.split("+");
    formations_splitted[formations_splitted.length - 1] = formation_text;
    
    operation_data_formation_elm.value = formations_splitted.join("+");
    
    operation_data_formation_elm.focus();
}

function clear_formation_suggestion () {
    setTimeout(function () {
        document.getElementById("formation_suggestion").innerHTML = "";
    }, 100);
}

function select_operation_to_write_data (line_id, train_number, first_departure_time, train_direction) {
    var train_operations = get_operations(line_id, train_number, first_departure_time, train_direction)
    
    if (train_operations.length === 1) {
        write_operation_data(null, train_operations[0]);
        
        return;
    }
    
    open_square_popup("select_operation_popup");
    
    var position_operations = {};
    for (var cnt = 0; cnt < train_operations.length; cnt++) {
        for (var cnt_2 = 0; cnt_2 < operations["operations"][train_operations[cnt]]["trains"].length; cnt_2++) {
            if (operations["operations"][train_operations[cnt]]["trains"][cnt_2]["train_number"] === train_number && operations["operations"][train_operations[cnt]]["trains"][cnt_2]["first_departure_time"] === first_departure_time) {
                position_operations[operations["operations"][train_operations[cnt]]["trains"][cnt_2]["position_forward"] + "-" + operations["operations"][train_operations[cnt]]["trains"][cnt_2]["position_rear"]] = train_operations[cnt];
                
                break;
            }
        }
    }
    
    var position_keys = Object.keys(position_operations);
    position_keys.sort();
    
    var buf = "";
    for (var cnt = 0; cnt < position_keys.length; cnt++) {
        buf += "<button type='button' class='wide_button' onclick='write_operation_data(null, \"" + add_slashes(position_operations[position_keys[cnt]]) + "\");'>" + escape_html(position_operations[position_keys[cnt]]) + "運用 (" + position_keys[cnt] + "両目)</button>";
    }
    
    document.getElementById("select_operation_area").innerHTML = buf;
}

function check_post_operation_data () {
    if (user_data === null) {
        show_captcha();
        
        captcha_submit_button_elm.onclick = post_operation_data;
    } else {
        post_operation_data();
    }
}

function post_operation_data (cnt = 0) {
    open_wait_screen();
    
    if (user_data !== null && one_time_token === null) {
        close_wait_screen();
        
        mes("内部処理が完了していないため、数秒待ってから再送信してください", true);
        
        return;
    }
    
    var send_data = "railroad_id=" + escape_form_data(railroad_info["railroad_id"]) + "&date=" + escape_form_data(post_yyyy_mm_dd) + "&operation_number=" + escape_form_data(post_operation_number) + "&formations=" + escape_form_data(document.getElementById("operation_data_formation").value) + "&comment=" + escape_form_data(document.getElementById("operation_data_comment").value);
    if (user_data !== null) {
        send_data += "&one_time_token=" + escape_form_data(one_time_token);
    } else {
        send_data += "&guest_id=" + escape_form_data(get_guest_id()) + "&zizai_captcha_id=" + escape_form_data(document.getElementById("zizai_captcha_id").value) + "&zizai_captcha_characters=" + escape_form_data(document.getElementById("zizai_captcha_characters").value);
    }
    
    ajax_fetch("api/post.php", send_data, function (response) {
        close_wait_screen();
        
        if (response !== false) {
            mes("情報提供ありがとうございました");
            
            if (square_popup_is_open) {
                close_square_popup();
            }
            popup_close(true);
            
            Object.assign(operation_data["operations"], JSON.parse(response));
            
            switch (mode_val) {
                case 0:
                    position_change_time(0);
                    break;
                case 1:
                    timetable_select_station(timetable_selected_station);
                    break;
                case 2:
                    operation_data_draw();
                    break;
            }
        } else {
            if (user_data !== null) {
                get_one_time_token();
            } else {
                zizai_captcha_reload_image("zizai_captcha_image", "zizai_captcha_id");
            }
        }
    });
}

function edit_operation_data (yyyy_mm_dd, operation_number, user_id, formation_text, ip_address = null) {
    open_popup("edit_operation_data_popup");
    
    buf = "<h3>投稿内容</h3>";
    buf += "<div class='key_and_value'><b>運用番号</b>" + escape_html(operation_number) + "</div>";
    buf += "<div class='key_and_value'><b>編成名</b>" + escape_html(formation_text) + "</div>";
    
    if (user_id !== user_data["user_id"]) {
        buf += "<h3>投稿者情報</h3>";
        buf += "<div class='key_and_value'><b>ユーザーID</b>" + escape_html(user_id) + "</div>";
        if (ip_address !== null) {
            buf += "<div class='key_and_value'><b>IPアドレス</b>" + escape_html(ip_address) + "</div>";
        }
    }
    
    buf += "<br><br><button type='button' class='wide_button' onclick='revoke_operation_data(\"" + yyyy_mm_dd + "\", \"" + add_slashes(operation_number) + "\", \"" + add_slashes(user_id) + "\");'>取り消す</button>";
    
    if (user_id !== user_data["user_id"] && (user_data["role"] === "MODERATOR" || user_data["role"] === "ADMIN")) {
        buf += "<button type='button' class='wide_button' onclick='revoke_users_all_operation_data(\"" + add_slashes(user_id) + "\");'>ユーザーの投稿を全て取り消す</button>";
    }
    
    document.getElementById("edit_operation_data_area").innerHTML = buf;
    
    get_one_time_token();
}

function revoke_operation_data (yyyy_mm_dd, operation_number, user_id) {
    open_wait_screen();
    
    if (one_time_token === null) {
        close_wait_screen();
        
        mes("内部処理が完了していないため、数秒待ってから再送信してください", true);
        
        return;
    }
    
    ajax_fetch("api/revoke.php", "railroad_id=" + escape_form_data(railroad_info["railroad_id"]) + "&date=" + escape_form_data(yyyy_mm_dd) + "&operation_number=" + escape_form_data(operation_number) + "&user_id=" + escape_form_data(user_id) + "&one_time_token=" + escape_form_data(one_time_token), function (response) {
        close_wait_screen();
        
        if (response !== false) {
            mes("運用情報を取り消しました");
            
            if (square_popup_is_open) {
                close_square_popup();
            }
            popup_close(true);
            
            Object.assign(operation_data["operations"], JSON.parse(response));
            
            switch (mode_val) {
                case 0:
                    position_change_time(0);
                    break;
                case 1:
                    timetable_select_station(timetable_selected_station);
                    break;
                case 2:
                    operation_data_draw();
                    break;
                case 3:
                    if (selected_formation_name !== null) {
                        formation_detail(selected_formation_name);
                    }
                    break;
            }
        }
    });
}

function revoke_users_all_operation_data (user_id) {
    if (confirm("このユーザーの過去24時間の投稿を全て取り消しますか？")) {
        open_wait_screen();
        
        if (one_time_token === null) {
            close_wait_screen();
            
            mes("内部処理が完了していないため、数秒待ってから再送信してください", true);
            
            return;
        }
        
        ajax_fetch("api/revoke_users_all.php", "railroad_id=" + escape_form_data(railroad_info["railroad_id"]) + "&user_id=" + escape_form_data(user_id) + "&one_time_token=" + escape_form_data(one_time_token), function (response) {
            close_wait_screen();
            
            if (response === "SUCCESSFULLY_REVOKED") {
                mes("運用情報を取り消しました");
                
                if (square_popup_is_open) {
                    close_square_popup();
                }
                popup_close(true);
                
                update_operation_data(function () {
                    switch (mode_val) {
                        case 0:
                            position_change_time(0);
                            break;
                        case 1:
                            timetable_select_station(timetable_selected_station);
                            break;
                        case 2:
                            operation_data_draw();
                            break;
                        case 3:
                            if (selected_formation_name !== null) {
                                formation_detail(selected_formation_name);
                            }
                            break;
                    }
                }, function () {}, true);
            }
        });
    }
}


var captcha_submit_button_elm = document.getElementById("captcha_submit_button");

function show_captcha () {
    var info_elm = document.getElementById("captcha_info");
    
    info_elm.style.display = "none";
    captcha_submit_button_elm.style.display = "none";
    open_square_popup("captcha_popup");
    
    if (!config["dark_mode"]) {
        var button_color = "#eeeeee";
    } else {
        var button_color = "#777777";
    }
    
    zizai_captcha_get_html(function (html) {
            document.getElementById("captcha_area").innerHTML = html;
            info_elm.style.display = "block";
            captcha_submit_button_elm.style.display = "block";
        }, button_color);
}


function challenge_login () {
    open_wait_screen();
    
    var user_id = document.getElementById("login_user_id").value;
    var password = document.getElementById("login_password").value;
    
    ajax_fetch("api/login.php", "user_id=" + escape_form_data(user_id) + "&password=" + escape_form_data(password), function (response) {
        close_wait_screen();
        
        if (response !== false) {
            mes("ログインしました");
            
            update_user_data(JSON.parse(response));
            close_square_popup();
        }
    });
}

function user_logout () {
    if (confirm("ログアウトしますか？")){
        open_wait_screen();
        
        ajax_fetch("api/logout.php", null, function (response) {
            close_wait_screen();
            
            if (response !== false) {
                mes("ログアウトしました");
                
                update_user_data();
            }
        });
    }
}

function check_sign_up () {
    open_wait_screen();
    
    ajax_fetch("api/check_sign_up.php", "user_id=" + escape_form_data(document.getElementById("sign_up_user_id").value) + "&password=" + escape_form_data(document.getElementById("sign_up_password").value), function (response) {
        close_wait_screen();
        
        if (response === "OK") {
            show_captcha();
            captcha_submit_button_elm.onclick = challenge_sign_up;
        } else if (response !== false) {
            mes(response);
        }
    });
}

function challenge_sign_up () {
    open_wait_screen();
    
    ajax_fetch("api/sign_up.php", "user_id=" + escape_form_data(document.getElementById("sign_up_user_id").value) + "&password=" + escape_form_data(document.getElementById("sign_up_password").value) + "&user_name=" + escape_form_data(document.getElementById("sign_up_user_name").value) + "&zizai_captcha_id=" + escape_form_data(document.getElementById("zizai_captcha_id").value) + "&zizai_captcha_characters=" + escape_form_data(document.getElementById("zizai_captcha_characters").value), function (response) {
        close_wait_screen();
        
        if (response !== false) {
            update_user_data(JSON.parse(response));
            
            close_square_popup();
            popup_close();
            
            mes("アカウントの作成に成功しました");
        } else {
            zizai_captcha_reload_image("zizai_captcha_image", "zizai_captcha_id");
        }
    });
}

var edit_user_data_user_id_elm = document.getElementById("edit_user_data_user_id");
var edit_user_data_user_name_elm = document.getElementById("edit_user_data_user_name");
var edit_user_data_email_address_elm = document.getElementById("edit_user_data_email_address");
var edit_user_data_website_url_elm = document.getElementById("edit_user_data_website_url");

function edit_user_data () {
    open_popup("edit_user_data_popup");
    
    edit_user_data_user_id_elm.value = user_data["user_id"];
    edit_user_data_user_name_elm.value = user_data["user_name"];
    if (user_data["email_address"] !== null) {
        edit_user_data_email_address_elm.value = user_data["email_address"];
    } else {
        edit_user_data_email_address_elm.value = "";
    }
    if (user_data["website_url"] !== null) {
        edit_user_data_website_url_elm.value = user_data["website_url"];
    } else {
        edit_user_data_website_url_elm.value = "";
    }
    
    get_one_time_token();
}

function change_user_data (cnt = 0) {
    open_wait_screen();
    
    if (one_time_token === null) {
        close_wait_screen();
        
        mes("内部処理が完了していないため、数秒待ってから再送信してください", true);
        
        return;
    }
    
    ajax_fetch("api/change_user_data.php", "user_name=" + escape_form_data(edit_user_data_user_name_elm.value) + "&email_address=" + escape_form_data(edit_user_data_email_address_elm.value) + "&website_url=" + escape_form_data(edit_user_data_website_url_elm.value) + "&one_time_token=" + escape_form_data(one_time_token), function (response) {
        close_wait_screen();
        
        if (response !== false) {
            update_user_data(JSON.parse(response));
            
            mes("ユーザー情報を変更しました");
        }
        
        get_one_time_token();
    });
}

function change_password () {
    open_wait_screen();
    
    ajax_fetch("api/change_user_password.php", "old_password=" + escape_form_data(document.getElementById("old_password").value) + "&new_password=" + escape_form_data(document.getElementById("new_password").value), function (response) {
        close_wait_screen();
        
        if (response === "SUCCEEDED") {
            close_square_popup();
            
            mes("パスワードを変更しました");
        } else if (response !== false) {
            mes(response);
        }
    });
}


function about_railroad_data () {
    open_popup("about_railroad_data_popup");
    
    var main_color = railroad_info["main_color"];
    if (config["dark_mode"]) {
        main_color = convert_color_dark_mode(main_color);
    }
    
    var buf = "<h2 style='background-color: " + main_color + ";'><img src='" + railroad_info["railroad_icon"] + "' alt=''>" + railroad_info["railroad_name"] + "</h2>";
    
    if ("description" in railroad_info && railroad_info["description"].length >= 1) {
        buf += "<div class='long_text'>" + convert_to_html(railroad_info["description"]) + "</div>";
    }
    
    if ("editors" in railroad_info && railroad_info["editors"].length >= 1) {
        buf += "<h3>製作者</h3>";
        
        for (var cnt = 0; cnt < railroad_info["editors"].length; cnt++) {
            if ("editor_url" in railroad_info["editors"][cnt] && railroad_info["editors"][cnt]["editor_url"].length >= 1) {
                buf += "<b><a href='" + railroad_info["editors"][cnt]["editor_url"] + "' target='_blank' class='external_link'>" + escape_html(railroad_info["editors"][cnt]["editor_name"]) + "</a></b><br>";
            } else {
                buf += "<b>" + escape_html(railroad_info["editors"][cnt]["editor_name"]) + "</b><br>";
            }
            
            if ("introduction_text" in railroad_info["editors"][cnt] && railroad_info["editors"][cnt]["introduction_text"].length >= 1) {
                buf += "<div class='informational_text'>" + escape_html(railroad_info["editors"][cnt]["introduction_text"]).replace(/\n/g, "<br>") + "</div>";
            }
        }
    }
    
    if ("license_text" in railroad_info && railroad_info["license_text"].length >= 1) {
        buf += "<h3>ライセンス</h3><div class='long_text'>" + convert_to_html(railroad_info["license_text"]) + "</div>";
    }
    
    if ("acknowledgment" in railroad_info && railroad_info["acknowledgment"].length >= 1) {
        buf += "<h3>謝辞</h3><div class='long_text'>" + convert_to_html(railroad_info["acknowledgment"]) + "</div>";
    }
    
    if ("related_links" in railroad_info && railroad_info["related_links"].length >= 1) {
        buf += "<h3>関連リンク</h3>";
        
        for (var cnt = 0; cnt < railroad_info["related_links"].length; cnt++) {
            buf += "<b><a href='" + railroad_info["related_links"][cnt]["link_url"] + "' target='_blank' class='external_link'>" + escape_html(railroad_info["related_links"][cnt]["link_text"]) + "</a></b><br>";
            
            if ("link_description" in railroad_info["related_links"][cnt] && railroad_info["related_links"][cnt]["link_description"].length >= 1) {
                buf += "<div class='informational_text'>" + escape_html(railroad_info["related_links"][cnt]["link_description"]).replace(/\n/g, "<br>") + "</div>";
            }
        }
    }
    
    buf += "<h3>データ更新日時</h3><div class='informational_text'>";
    buf += "路線系統情報: " + get_date_and_time(railroad_info["last_modified_timestamp"]) + "<br>";
    buf += "編成表: " + get_date_and_time(formations["last_modified_timestamp"]) + "<br>";
    buf += "車両アイコン: " + get_date_and_time(train_icons["last_modified_timestamp"]);
    buf += "</div>";
    
    document.getElementById("about_railroad_data_area").innerHTML = buf;
}


var dark_mode_check_elm = document.getElementById("dark_mode_check");
var colorize_beginners_posts_check_elm = document.getElementById("colorize_beginners_posts_check");
var refresh_interval_elm = document.getElementById("refresh_interval");
var operation_data_cache_period_elm = document.getElementById("operation_data_cache_period");

function edit_config () {
    open_popup("config_popup");
    
    dark_mode_check_elm.checked = config["dark_mode"];
    colorize_beginners_posts_check_elm.checked = config["colorize_beginners_posts"];
    refresh_interval_elm.value = config["refresh_interval"];
    operation_data_cache_period_elm.value = config["operation_data_cache_period"];
}

function change_config () {
    config["dark_mode"] = dark_mode_check_elm.checked;
    config["colorize_beginners_posts"] = colorize_beginners_posts_check_elm.checked;
    
    if (Number(refresh_interval_elm.value) > 60) {
        refresh_interval_elm.value = 60;
    } else if (Number(refresh_interval_elm.value) < 1) {
        refresh_interval_elm.value = 1;
    }
    config["refresh_interval"] = Number(refresh_interval_elm.value);
    
    if (Number(operation_data_cache_period_elm.value) > 30) {
        operation_data_cache_period_elm.value = 30;
    } else if (Number(operation_data_cache_period_elm.value) < 1) {
        operation_data_cache_period_elm.value = 1;
    }
    config["operation_data_cache_period"] = Number(operation_data_cache_period_elm.value);
    
    switch_dark_mode();
    
    save_config();
}

function reset_config_value () {
    if (confirm("設定をリセットしますか？")) {
        var dafault_config = get_default_config();
        
        dark_mode_check_elm.checked = dafault_config["dark_mode"];
        colorize_beginners_posts_check_elm.checked = dafault_config["colorize_beginners_posts_check"];
        refresh_interval_elm.value = dafault_config["refresh_interval"];
        operation_data_cache_period_elm.value = dafault_config["operation_data_cache_period"];
        
        change_config();
    }
}

function reset_cache_db () {
    if (confirm("キャッシュデータの削除により運用表や時刻表のデータが再ダウンロードされるため、多くの通信容量を消費する場合があります。\n\nよろしいですか？")) {
        localStorage.removeItem("unyohub_railroads_caches");
        localStorage.removeItem("unyohub_latest_announcement_timestamp");
        
        var delete_request = indexedDB.deleteDatabase("unyohub_caches");
        
        delete_request.onsuccess = function () {
            location.reload();
        };
    }
}

function show_rules () {
    if (!navigator.onLine) {
        mes("ルールの閲覧にはネットワーク接続が必要です", true);
        return;
    }
    
    open_popup("rules_popup");
    
    ajax_fetch("rules.txt", null, function (response) {
        if (response !== false) {
            document.getElementById("rules_area").innerHTML = convert_to_html(response);
        } else {
            mes("ルール情報が表示できません", true);
        }
    });
}


history.pushState(null, null, location.href);

window.onpopstate = function () {
    if (square_popup_is_open) {
        close_square_popup();
    } else if (popup_history.length >= 1) {
        popup_close();
    } else if (menu_elm.className === "menu_open") {
        menu_click(true);
    } else{
        switch (mode_val) {
            case 1:
                if (timetable_selected_station !== null) {
                    timetable_change_lines(timetable_line_select_elm.value, true);
                }
                break;
            case 3:
                if (selected_formation_name !== null) {
                    draw_formation_table();
                }
                break;
        }
    }
    
    history.pushState(null, null, null);
};


if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service_worker.js");
}
</script>
</body>
</html>
